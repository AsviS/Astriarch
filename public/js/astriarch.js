var Astriarch=Astriarch||{Version:"1.8.3",ClientGameModel:null,PlayerGameOptions:null,GameId:null},module=module||{};module.exports=Astriarch;Astriarch=Astriarch||require("./astriarch_base");Astriarch.NextRandom=function(a,b){if(b===null||typeof b=="undefined")b=a,a=0;a<0?b+=Math.abs(a):b-=a;return Math.floor(Math.random()*b)+a};Astriarch.NextRandomFloat=function(a,b){return Math.random()*(b-a)+a};Astriarch.DecimalToFixed=function(a,b){return a?Math.round(a)!=a?a.toFixed(b).replace(/0+$/,""):a:a};Astriarch.CountObjectKeys=function(a){var b=0,c;for(c in a)b++;return b};
Number.prototype.compareTo=function(a){if(typeof a!="number")return!1;return a<this?1:a>this?-1:0};
Astriarch.GameTools={OpponentOptionToFriendlyString:function(a){var b="";switch(a.type){case -2:b="Closed";break;case -1:b="Open";break;case Astriarch.Player.PlayerType.Human:b="Human Player: "+a.name;break;case Astriarch.Player.PlayerType.Computer_Easy:b="Easy Computer";break;case Astriarch.Player.PlayerType.Computer_Normal:b="Normal Computer";break;case Astriarch.Player.PlayerType.Computer_Hard:b="Hard Computer";break;case Astriarch.Player.PlayerType.Computer_Expert:b="Expert Computer"}return b},
PlanetOwnerToFriendlyName:function(a,b){var c=a==Astriarch.Planet.PlanetType.AsteroidBelt?"None":"Natives";if(b!=null)c=b.Name;return c},PlanetTypeToFriendlyName:function(a){var b="Asteroid Belt";a==Astriarch.Planet.PlanetType.DeadPlanet?b="Dead":a==Astriarch.Planet.PlanetType.PlanetClass1?b="Arid":a==Astriarch.Planet.PlanetType.PlanetClass2&&(b="Terrestrial");return b},PlanetImprovementTypeToFriendlyName:function(a){var b="";switch(a){case Astriarch.Planet.PlanetImprovementType.Factory:b="Factory";
break;case Astriarch.Planet.PlanetImprovementType.Colony:b="Colony";break;case Astriarch.Planet.PlanetImprovementType.Farm:b="Farm";break;case Astriarch.Planet.PlanetImprovementType.Mine:b="Mine"}return b},PlanetImprovementTypeToHelpText:function(a){var b="";switch(a){case Astriarch.Planet.PlanetImprovementType.Farm:b="Farms increase amount of Food produced by each farmer.";break;case Astriarch.Planet.PlanetImprovementType.Mine:b="Mines increase the amount of Ore and Iridium produced by each miner.";
break;case Astriarch.Planet.PlanetImprovementType.Factory:b="Factories increase the production generated by each worker.\r\nAllows construction of Space Platforms and Destroyers.";break;case Astriarch.Planet.PlanetImprovementType.Colony:b="Colonies increase the planet's maximum population by one."}return b},ResearchTypeToHelpText:function(a){var b="";switch(a){case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DEFENDER:b="Create a new Custom Ship with the Defender Hull Type";break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_SCOUT:b=
"Create a new Custom Ship with the Scout Hull Type";break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DESTROYER:b="Create a new Custom Ship with the Destroyer Hull Type";break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_CRUISER:b="Create a new Custom Ship with the Cruiser Hull Type";break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_BATTLESHIP:b="Create a new Custom Ship with the Battleship Hull Type";break;case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_ATTACK:b="Improves ship attack by up to 50%";
break;case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_DEFENSE:b="Improves ship defense by up to 50%";break;case Astriarch.Research.ResearchType.PROPULSION_IMPROVEMENT:b="Improves ship speed";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FARMS:b="Boost Farm effectiveness to as much as 200% of normal";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_MINES:b="Boost Mine effectiveness to as much as 200% of normal";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_COLONIES:b=
"Increase Population growth on planets with colonies";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FACTORIES:b="Boost Farm effectiveness to as much as 200% of normal"}return b},StarShipTypeToFriendlyName:function(a){var b="";switch(a){case Astriarch.Fleet.StarShipType.SystemDefense:b="Defender";break;case Astriarch.Fleet.StarShipType.Scout:b="Scout";break;case Astriarch.Fleet.StarShipType.Destroyer:b="Destroyer";break;case Astriarch.Fleet.StarShipType.Cruiser:b="Cruiser";
break;case Astriarch.Fleet.StarShipType.Battleship:b="Battleship";break;case Astriarch.Fleet.StarShipType.SpacePlatform:b="Space Platform"}return b},StarShipTypeToHelpText:function(a){var b="";switch(a.Type){case Astriarch.Fleet.StarShipType.SystemDefense:b="Defenders protect a planet from attacking fleets but cannot move between planets.\r\n";break;case Astriarch.Fleet.StarShipType.Scout:b="Scouts are the weakest ship equipped with warp drive.\r\n";break;case Astriarch.Fleet.StarShipType.Destroyer:b=
"Destroyers require a Factory in order to build and are twice the strength of a Scout.\r\n";break;case Astriarch.Fleet.StarShipType.Cruiser:b="Cruisers require a Space Platform in order to build and are twice the strength of a Destroyer.\r\n";break;case Astriarch.Fleet.StarShipType.Battleship:b="Battleships require a Space Platform in order to build and are twice the strength of a Cruiser.\r\n";break;case Astriarch.Fleet.StarShipType.SpacePlatform:b="Space Platforms provide planetary defense.\r\nAllows construction of Cruisers and Battleships.\r\nAdvantage against: All ships, Disadvantage Against: None"}a.Type!=
Astriarch.Fleet.StarShipType.SpacePlatform&&(b+="Advantage against: "+Astriarch.GameTools.StarShipTypeToFriendlyName(a.AdvantageAgainstType)+", Disadvantage Against: "+Astriarch.GameTools.StarShipTypeToFriendlyName(a.DisadvantageAgainstType));return b},PlanetTypeToClassName:function(a){var b=null;switch(a){case Astriarch.Planet.PlanetType.PlanetClass2:b="icon-32x32-PlanetClass2";break;case Astriarch.Planet.PlanetType.PlanetClass1:b="icon-32x32-PlanetClass1";break;case Astriarch.Planet.PlanetType.DeadPlanet:b=
"icon-32x32-PlanetDead";break;case Astriarch.Planet.PlanetType.AsteroidBelt:b="icon-32x32-PlanetAsteroid"}return b},PlanetImprovementTypeToClassName:function(a){return"icon-32x32-"+Astriarch.GameTools.PlanetImprovementTypeToFriendlyName(a).replace(" ","")+"Large"},StarShipTypeToClassName:function(a,b){return"icon-32x32-"+Astriarch.GameTools.StarShipTypeToFriendlyName(a)+(b?"Custom":"")+"Large"},ResearchTypeToClassName:function(a){var b="";switch(a){case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DEFENDER:b=
"icon-32x32-DefenderCustomLarge";break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_SCOUT:b="icon-32x32-ScoutCustomLarge";break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DESTROYER:b="icon-32x32-DestroyerCustomLarge";break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_CRUISER:b="icon-32x32-CruiserCustomLarge";break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_BATTLESHIP:b="icon-32x32-BattleshipCustomLarge";break;case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_ATTACK:b=
"icon-32x32-ResearchAttack";break;case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_DEFENSE:b="icon-32x32-ResearchDefense";break;case Astriarch.Research.ResearchType.PROPULSION_IMPROVEMENT:b="icon-32x32-ResearchPropulsion";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FARMS:b="icon-32x32-FarmLarge";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_MINES:b="icon-32x32-MineLarge";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_COLONIES:b=
"icon-32x32-ColonyLarge";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FACTORIES:b="icon-32x32-FactoryLarge";break;case Astriarch.Research.ResearchType.SPACE_PLATFORM_IMPROVEMENT:b="icon-32x32-SpacePlatformLarge"}return b}};
Astriarch.Util={starshipImageData:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,128,0,255,0,128,
0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,
0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,0,0,0,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0],spaceplatformImageData:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,
0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],imageDataByColorRGBA:{},
GetImageData:function(a){var b=a.toString();b in Astriarch.Util.imageDataByColorRGBA||(Astriarch.Util.imageDataByColorRGBA[b]={starshipImageData:Astriarch.Util.ChangeImageColor(Astriarch.Util.starshipImageData,a),spaceplatformImageData:Astriarch.Util.ChangeImageColor(Astriarch.Util.spaceplatformImageData,a)});return Astriarch.Util.imageDataByColorRGBA[b]},ChangeImageColor:function(a,b){for(var c=Array(a.length),d=0;d<a.length;d+=4)a[d+3]!=0?(c[d+0]=b.r,c[d+1]=b.g,c[d+2]=b.b):(c[d+0]=a[d+0],c[d+1]=
a[d+1],c[d+2]=a[d+2]),c[d+3]=a[d+3];return c}};Astriarch.Util.ColorRGBA=function(a,b,c,d){this.r=a;this.g=b;this.b=c;this.a=d};Astriarch.Util.ColorRGBA.prototype.toString=function(){return"rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")"};Astriarch.View={jCanvasDraw:null,audioInterface:null,audioMouseInTimer:null,audioMouseOutTimer:null,CanvasBackground:null,ContextBackground:null,CanvasPlayfieldLayer:null,CanvasFleetsLayer:null,BackgroundSpriteSheetImage:null,BACKGROUND_COUNT:7,BACKGROUND_DARKNESS:30,DrawnPlanets:{},DrawnFleets:[],Colors:["white","yellow","orange","blue","green","red","purple"],ColorsRGBA:{white:null,yellow:null,orange:null,blue:null,green:null,red:null,purple:null},sendingShipsTo:!1,sendShipsFromHex:null,TurnSummaryItemsListBox:null,
SpriteSheetInfo:{filename:null,planetAsteroidY:null,planetDeadY:null,planetClass1Y:null,planetClass2Y:null,starshipDefenderY:null,starshipScoutY:null,starshipDestroyerY:null,starshipCruiserY:null,starshipBattleshipY:null},ImageCanvasStarships:{defender:null,scout:null,destroyer:null,cruiser:null,battleship:null},hotkeyElementsByScreen:{}};
Astriarch.View.PageLoadInit=function(a){Astriarch.View.SetupGraphicalDOMElements();Astriarch.View.jCanvasDraw=new jCanvas({containerSelector:"#canvasContainer",canvasNotSupportedCallback:Astriarch.View.CanvasNotSupported,layers:[{name:"canvasAstriarchBackground",x:0,y:0,width:800,height:600,zIndex:1,backgroundColor:"black"},{name:"canvasAstriarchPlayfield",x:177,y:21,width:621,height:480,zIndex:2,clickCallback:Astriarch.View.PlayfieldClicked,dblclickCallback:Astriarch.View.PlayfieldDoubleClicked,
mouseHitSelector:"#canvasMouseHitDetector"},{name:"canvasAstriarchFleets",x:177,y:21,width:621,height:480,zIndex:3,clickCallback:Astriarch.View.FleetsClicked,mouseHitSelector:"#canvasMouseHitDetector"}]});if(Astriarch.View.jCanvasDraw.canvasSupported){var b=Astriarch.View.jCanvasDraw.getLayer("canvasAstriarchBackground");Astriarch.View.CanvasBackground=b.canvas;Astriarch.View.ContextBackground=b.ctx;Astriarch.View.CanvasPlayfieldLayer=Astriarch.View.jCanvasDraw.getLayer("canvasAstriarchPlayfield");
Astriarch.View.CanvasFleetsLayer=Astriarch.View.jCanvasDraw.getLayer("canvasAstriarchFleets");Astriarch.View.CanvasPlayfieldLayer.canvas.dblclick(function(){});setTimeout(function(){Astriarch.View.loadBackgroundSpriteSheetImage()},10);Astriarch.View.ContextBackground.globalAlpha=1;setInterval(function(){Astriarch.View.jCanvasDraw.draw()},50);Astriarch.View.audioInterface=new AudioInterface(!0);Astriarch.PlayerGameOptions=new Astriarch.Player.PlayerGameOptions;Astriarch.server_comm.init(a);Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.ERROR,
function(a){var b=a.payload;typeof a.payload!="string"&&(b=JSON.stringify(a.payload));new Astriarch.Alert("Error",'<span style="color:red">'+b+"</span>")});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.NOOP,function(a){console.log("NOOP: ",a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.CHAT_ROOM_SESSIONS_UPDATED,function(a){Astriarch.CommControl.setPlayerSessions(a.payload.sessions)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.LIST_GAMES,Astriarch.LobbyControl.refreshGameList);
Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.GAME_LIST_UPDATED,Astriarch.LobbyControl.updateGameList);Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.CHANGE_GAME_OPTIONS,function(a){Astriarch.NewGameControl.OnGameOptionsChanged(a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.JOIN_GAME,function(a){Astriarch.LobbyControl.OnGameJoinMessageResponse(a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.CREATE_GAME,function(a){Astriarch.LobbyControl.OnGameCreateMessageResponse(a)});
Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.RESUME_GAME,function(a){Astriarch.LobbyControl.OnGameResumeMessageResponse(a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.START_GAME,function(a){Astriarch.NewGameControl.OnGameStartMessageResponse(a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.END_TURN,function(a){Astriarch.GameController.OnEndTurnMessageResponse(a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.GAME_OVER,function(a){Astriarch.GameController.OnGameOverMessageResponse(a)});
Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.CHAT_MESSAGE,function(a){Astriarch.CommControl.appendMessages([a.payload])});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.EXIT_RESIGN,function(a){Astriarch.GameController.OnExitResignMessageResponse(a)});Astriarch.CommControl.init();Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.LIST_GAMES,payload:{}});Astriarch.View.RegisterHotkeys();Astriarch.View.BindHotkeys()}};
Astriarch.View.GetUnderlinedHtmlForHotkey=function(a,b){var c=a.indexOf(b);return c!=-1?a.substring(0,c)+'<u class="hotkeyChar">'+b+"</u>"+a.substring(c+1):a};Astriarch.View.RegisterClickTargetToHotkey=function(a,b,c,d){d=d||function(a){a.click()};c="#"+(c||"gameControls");Astriarch.View.hotkeyElementsByScreen[c]=Astriarch.View.hotkeyElementsByScreen[c]||{};Astriarch.View.hotkeyElementsByScreen[c][b.toLowerCase()]={elm:a,fn:d}};
Astriarch.View.RegisterHotkeys=function(){var a=function(a){return a.find(".ui-button-text, .ui-corner-all, .hotkeyText").first()},b=function(b,c){var d=a(b),e=d.text();d.html(Astriarch.View.GetUnderlinedHtmlForHotkey(e,c))};$("[data-hotkey]").each(function(){var a=$(this),c=a.attr("data-hotkey");b(a,c);var d=a.parents(".screen").first();Astriarch.View.RegisterClickTargetToHotkey(a,c,d.attr("id"))});$(".ui-dialog-buttonpane").each(function(){var c=$(this).siblings(".screen").first();$(this).find(".ui-dialog-buttonset > .ui-button").each(function(){var d=
$(this),e="C";a(d).text()=="Ok"&&(d.attr("autofocus",!0),e="O");b(d,e);Astriarch.View.RegisterClickTargetToHotkey(d,e,c.attr("id"))})});var c=function(){Astriarch.View.cycleSelectedPlanet(1)},d=function(){Astriarch.View.cycleSelectedPlanet(-1)},e={h:function(){Astriarch.View.selectPlanet(Astriarch.ClientGameModel.getClientPlanetById(Astriarch.ClientGameModel.MainPlayer.HomePlanetId))},right:c,n:c,left:d,p:d,space:function(){Astriarch.View.FinishSendShips()}};Object.keys(e).forEach(function(a){Astriarch.View.RegisterClickTargetToHotkey(null,
a,null,e[a])})};Astriarch.View.BindHotkeys=function(a){Mousetrap.reset();var b=Astriarch.View.hotkeyElementsByScreen[a||"#gameControls"]||{};Object.keys(b).forEach(function(a){var d=b[a].elm,e=b[a].fn;Mousetrap.bind(a,function(){e(d)})})};
Astriarch.View.CanvasNotSupported=function(){$("#startGameOptionsContainer").hide();$("#canvasContainer").html('<p style="color:white">Astriarch HTML 5 version not supported by your browser.  You can play with the silverlight plugin by clicking <a href="silverlight.html">here</a>. In 5 seconds you will be taken to the silverlight version automatically.</p>');setTimeout(function(){window.location="silverlight.html"},5E3)};
Astriarch.View.ClearPlanetsAndFleets=function(){Astriarch.View.DrawnPlanets={};Astriarch.View.DrawnFleets=[];Astriarch.View.CanvasPlayfieldLayer.children=[];Astriarch.View.CanvasFleetsLayer.children=[];Astriarch.View.CanvasPlayfieldLayer.needsDisplay=!0;Astriarch.View.CanvasFleetsLayer.needsDisplay=!0};Astriarch.View.ShowNewGameOptions=function(){Astriarch.NewGameControl.show();Astriarch.View.ClearGameBackgroundControls()};
Astriarch.View.ClearGameBackgroundControls=function(){Astriarch.View.ClearPlanetsAndFleets();$("#TurnDisplay,#OverallPlayerStatusGrid,#SelectedItemStatus,#SelectedItemPopulationPanel,#SelectedItemImprovementSlotsPanel,#SelectedItemPopulationAssignmentsPanel,#SelectedItemBuiltImprovementsGrid,#SelectedItemPlanetaryFleetGrid,#SelectedItemStatusDetails,#BottomStatusGrid,#TurnSummaryItemsListBox,#ButtonPanel").hide();$("#PlanetViewButton,#SendShipsButton,#NextTurnButton,#ButtonOpenTradingCenter,#ButtonOpenResearch").hide()};
Astriarch.View.SetupGraphicalDOMElements=function(){Astriarch.View.ColorsRGBA.white=new Astriarch.Util.ColorRGBA(255,255,255,255);Astriarch.View.ColorsRGBA.yellow=new Astriarch.Util.ColorRGBA(255,255,0,255);Astriarch.View.ColorsRGBA.orange=new Astriarch.Util.ColorRGBA(255,165,0,255);Astriarch.View.ColorsRGBA.blue=new Astriarch.Util.ColorRGBA(0,0,255,255);Astriarch.View.ColorsRGBA.green=new Astriarch.Util.ColorRGBA(0,128,0,255);Astriarch.View.ColorsRGBA.red=new Astriarch.Util.ColorRGBA(255,0,0,255);
Astriarch.View.ColorsRGBA.purple=new Astriarch.Util.ColorRGBA(128,0,128,255);Astriarch.LobbyControl.init();Astriarch.NewGameControl.init();Astriarch.View.TurnSummaryItemsListBox=new JSListBox({containerSelector:"TurnSummaryItemsListBox",stylemap:{border:"none",background:"none"}});$("#PlanetViewButton, #SendShipsButton, #NextTurnButton, #CancelSendButton, #MainMenuButtonGameOver").button();$("#CancelSendButton").hide();$("#MainMenuButtonGameOver").hide();$("#SystemMasterVersion").text("v"+Astriarch.Version);
$("#SystemMasterVersion").attr("Title","Astriarch - Ruler of the Stars, Version: "+Astriarch.Version+"\r\nCopyright 2010 Mastered Software\r\nMusic by Resonant");Astriarch.PlanetView.init();Astriarch.SendShipsControl.init();Astriarch.PlanetaryConflictControl.init();Astriarch.GameOverControl.init();Astriarch.TradingControl.init();Astriarch.ResearchControl.init();Astriarch.ExitConfirmControl.init();$("#PlanetViewButton").click(function(){window.tour.enabled&&(window.tour.step==15||window.tour.step==
27||window.tour.step==32||window.tour.step==43||window.tour.step==53)&&window.tour.jqElm.joyride("nextTip");Astriarch.View.ShowPlanetView()});$("#SendShipsButton").click(function(){window.tour.enabled&&window.tour.step==55&&window.tour.jqElm.joyride("nextTip");Astriarch.View.StartSendShips()});$("#NextTurnButton").click(function(){window.tour.enabled&&(window.tour.step==22||window.tour.step==24||window.tour.step==26||window.tour.step==28||window.tour.step==31||window.tour.step==35||window.tour.step==
40||window.tour.step==42||window.tour.step==47)&&window.tour.jqElm.joyride("nextTip");Astriarch.View.NextTurn()});$("#CancelSendButton").click(function(){Astriarch.View.CancelSendShips()});$("#MainMenuButtonGameOver").click(function(){Astriarch.View.ShowMainMenu()});$("#MainMenuButton").button({icons:{primary:"icon-16x16-main-menu"},text:!1});$("#MainMenuButton").click(function(){Astriarch.ExitConfirmControl.show()});$("#MainMenuIcon").mouseenter(function(){Astriarch.View.mainMenuIconMouseEnter()});
$("#MainMenuButton").mouseleave(function(){Astriarch.View.mainMenuButtonMouseLeave()});$("#SpeakerIcon").mouseenter(function(){Astriarch.View.speakerIconMouseEnter()});$("#ButtonSpeakerToggleMute").mouseleave(function(){Astriarch.View.muteButtonMouseLeave()});$("#SliderVolume").mouseenter(function(){Astriarch.View.volumeSliderMouseEnter()});$("#SliderVolume").mouseleave(function(){Astriarch.View.volumeSliderMouseLeave()});$("#ButtonSpeakerToggleMute").button({icons:{primary:"icon-16x16-speaker-on"},
text:!1});$("#ButtonSpeakerToggleMute").click(function(){Astriarch.View.toggleAudioMute()});$("#ButtonOpenTradingCenter").button({icons:{primary:"icon-16x16-trading"},text:!1});$("#ButtonOpenTradingCenter").click(function(){window.tour.enabled&&window.tour.step==36&&window.tour.jqElm.joyride("nextTip");Astriarch.View.openTradingCenter()});$("#ButtonOpenResearch").button({icons:{primary:"icon-16x16-research"},text:!1});$("#ButtonOpenResearch").click(function(){Astriarch.ResearchControl.show()});$("#SliderVolume").slider({value:1,
step:0.1,min:0,max:1,orientation:"vertical",slide:Astriarch.View.volumeSliderValueChanged});var a=function(a,c){var d=$('<div class="'+a+'"></div>').hide().appendTo("body"),e=d.css(c);c=="background-image"?e=e.replace(/"/g,"").replace(/url\(|\)$/ig,""):c=="background-position"&&(e=parseFloat(e.split(" ")[1].replace(/[^0-9-]/g,"")));d.remove();return e};Astriarch.View.SpriteSheetInfo.filename=a("icon-32x32-sprite","background-image");Astriarch.View.SpriteSheetInfo.planetAsteroidY=-1*a("icon-32x32-PlanetAsteroid",
"background-position");Astriarch.View.SpriteSheetInfo.planetDeadY=-1*a("icon-32x32-PlanetDead","background-position");Astriarch.View.SpriteSheetInfo.planetClass1Y=-1*a("icon-32x32-PlanetClass1","background-position");Astriarch.View.SpriteSheetInfo.planetClass2Y=-1*a("icon-32x32-PlanetClass2","background-position");Astriarch.View.SpriteSheetInfo.starshipDefenderY=-1*a("icon-32x32-DefenderLarge","background-position");Astriarch.View.SpriteSheetInfo.starshipScoutY=-1*a("icon-32x32-ScoutLarge","background-position");
Astriarch.View.SpriteSheetInfo.starshipDestroyerY=-1*a("icon-32x32-DestroyerLarge","background-position");Astriarch.View.SpriteSheetInfo.starshipCruiserY=-1*a("icon-32x32-CruiserLarge","background-position");Astriarch.View.SpriteSheetInfo.starshipBattleshipY=-1*a("icon-32x32-BattleshipLarge","background-position");a=[Astriarch.View.ColorsRGBA.green,Astriarch.View.ColorsRGBA.yellow,Astriarch.View.ColorsRGBA.orange,Astriarch.View.ColorsRGBA.red];Astriarch.View.ImageCanvasStarships.defender=new Astriarch.View.StarshipCanvas("#CanvasDefenderLarge",
Astriarch.View.SpriteSheetInfo.filename,32,32,a,Astriarch.View.SpriteSheetInfo.starshipDefenderY);Astriarch.View.ImageCanvasStarships.scout=new Astriarch.View.StarshipCanvas("#CanvasScoutLarge",Astriarch.View.SpriteSheetInfo.filename,32,32,a,Astriarch.View.SpriteSheetInfo.starshipScoutY);Astriarch.View.ImageCanvasStarships.destroyer=new Astriarch.View.StarshipCanvas("#CanvasDestroyerLarge",Astriarch.View.SpriteSheetInfo.filename,32,32,a,Astriarch.View.SpriteSheetInfo.starshipDestroyerY);Astriarch.View.ImageCanvasStarships.cruiser=
new Astriarch.View.StarshipCanvas("#CanvasCruiserLarge",Astriarch.View.SpriteSheetInfo.filename,32,32,a,Astriarch.View.SpriteSheetInfo.starshipCruiserY);Astriarch.View.ImageCanvasStarships.battleship=new Astriarch.View.StarshipCanvas("#CanvasBattleshipLarge",Astriarch.View.SpriteSheetInfo.filename,32,32,a,Astriarch.View.SpriteSheetInfo.starshipBattleshipY)};Astriarch.View.NextTurn=function(){Astriarch.GameController.ClearTurnTimer();$("#NextTurnButton").button("disable");Astriarch.GameController.NextTurn()};
Astriarch.View.ShowMainMenu=function(){Astriarch.GameId=null;Astriarch.View.audioInterface.StartMenu();Astriarch.GameController.ClearTurnTimer();Astriarch.LobbyControl.refreshGameList({});$("#MainMenuButtonGameOver").hide();$("#MainMenuButton").hide();$("#mainMenu").show();Astriarch.View.ClearGameBackgroundControls();Astriarch.CommControl.joinChatRoom(Astriarch.LocalStorageInterface.Prefs.playerName,null);Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.LIST_GAMES,payload:{}})};
Astriarch.View.ShowPlanetView=function(){var a=Astriarch.ClientGameModel.MainPlayer.GetPlanetIfOwnedByPlayer(Astriarch.ClientGameModel.GameGrid.SelectedHex.ClientPlanetContainedInHex.Id);Astriarch.PlanetView.show(a)};Astriarch.View.StartSendShips=function(){Astriarch.View.sendingShipsTo=!0;$("#SendShipsStatus").text(" Select Planet to Send Ships to. ");$("#CancelSendButton").show();Astriarch.View.sendShipsFromHex=Astriarch.ClientGameModel.GameGrid.SelectedHex};
Astriarch.View.FinishSendShips=function(){if(Astriarch.View.sendingShipsTo){if(Astriarch.View.sendShipsFromHex!=Astriarch.ClientGameModel.GameGrid.SelectedHex){var a=Astriarch.ClientGameModel.GameGrid.GetHexDistance(Astriarch.View.sendShipsFromHex,Astriarch.ClientGameModel.GameGrid.SelectedHex),b=Astriarch.ClientGameModel.MainPlayer.GetPlanetIfOwnedByPlayer(Astriarch.View.sendShipsFromHex.ClientPlanetContainedInHex.Id);Astriarch.SendShipsControl.show(b,Astriarch.ClientGameModel.GameGrid.SelectedHex.ClientPlanetContainedInHex,
a)}Astriarch.View.CancelSendShips()}};Astriarch.View.CancelSendShips=function(){$("#SendShipsStatus").text("");$("#CancelSendButton").hide();Astriarch.View.sendingShipsTo=!1};Astriarch.View.PlanetViewDialogWindowClosed=function(){Astriarch.View.updateSelectedItemPanelForPlanet();Astriarch.View.updatePlayerStatusPanel();Astriarch.View.DrawnPlanets[Astriarch.PlanetView.planetMain.Id].UpdatePlanetDrawingForPlayer(Astriarch.ClientGameModel);Astriarch.View.CanvasPlayfieldLayer.needsDisplay=!0};
Astriarch.View.SendShipsDialogWindowClosed=function(a){a==!0&&Astriarch.SendShipsControl.CreatedFleet!=null&&Astriarch.View.DrawnPlanets[Astriarch.SendShipsControl.pSource.Id].UpdatePlanetDrawingForPlayer(Astriarch.ClientGameModel);Astriarch.View.selectPlanet(Astriarch.SendShipsControl.pSource)};
Astriarch.View.PlayfieldClicked=function(a){a=new Astriarch.Point(a.x,a.y);a=Astriarch.ClientGameModel.GameGrid.GetHexAt(a);a!=null&&a.ClientPlanetContainedInHex!=null&&(Astriarch.ClientGameModel.GameGrid.SelectHex(a),Astriarch.View.updateSelectedItemPanelForPlanet(),Astriarch.View.FinishSendShips());return!0};
Astriarch.View.PlayfieldDoubleClicked=function(a){a=new Astriarch.Point(a.x,a.y);a=Astriarch.ClientGameModel.GameGrid.GetHexAt(a);a!=null&&a.ClientPlanetContainedInHex!=null&&Astriarch.ClientGameModel.MainPlayer.GetPlanetIfOwnedByPlayer(a.ClientPlanetContainedInHex.Id)&&Astriarch.View.ShowPlanetView();return!0};Astriarch.View.FleetsClicked=function(){return!0};
Astriarch.View.cycleSelectedPlanet=function(a){var b=Astriarch.ClientGameModel.GameGrid.SelectedHex.ClientPlanetContainedInHex,c=Astriarch.ClientGameModel.MainPlayer,d=Astriarch.ClientGameModel.ClientPlanets.concat([]);d.sort(function(a,b){if(a.Id in c.OwnedPlanets)return-1;else if(b.Id in c.OwnedPlanets)return 1;if(a.Id in c.KnownClientPlanets)return-1;else if(b.Id in c.KnownClientPlanets)return 1;return a.Id<b.Id?-1:a.Id>b.Id?1:0});if(!(d<=1)){var e=-1;d.forEach(function(a,c){a.Id==b.Id&&(e=c)});
e!=-1&&(e+=a,e<0?e=d.length-1:e>=d.length&&(e=0),(a=d[e])&&Astriarch.View.selectPlanet(a))}};Astriarch.View.selectPlanet=function(a){Astriarch.ClientGameModel.GameGrid.SelectHex(a.BoundingHex);Astriarch.View.updateSelectedItemPanelForPlanet()};
Astriarch.View.updatePlayerStatusPanel=function(){var a=Astriarch.ClientGameModel.MainPlayer;if(a!==null){$("#OverallPlayerStatusGrid").css({visibility:"visible"});var b=a.GetTotalPopulation();$("#TextBlockPopulationAmount").text(b);$("#TextBlockPopulationAmount").prop("title","Total Population: "+b);var c=a.GetTotalResourceProductionPerTurn(),d=a.TotalFoodAmount(),e=c.food-b,g="";e>=0&&(g="+");var f="green";if(e<0)f=e+d<b?"red":"yellow";else if(d<b||e+d<b)f="orange";var h=d>=10?0:1;$("#TextBlockFoodAmount").css("color",
f);$("#TextBlockFoodAmount").text(Math.floor(d)+" "+g+e.toFixed(h));$("#TextBlockFoodAmount").prop("title","Food Amount: "+d.toFixed(1)+" +"+c.food.toFixed(1)+" -"+b);b=c.gold-c.foodToShip;d="";b>=0&&(d="+");e="green";b<0&&(e=b+a.Resources.GoldAmount<0?"red":"yellow");h=a.Resources.GoldAmount>=10?0:1;$("#TextBlockGoldAmount").css("color",e);$("#TextBlockGoldAmount").text(Math.floor(a.Resources.GoldAmount)+" "+d+b.toFixed(h));$("#TextBlockGoldAmount").prop("title","Gold Amount: "+a.Resources.GoldAmount.toFixed(1)+
" +"+c.gold.toFixed(1)+" -"+c.foodToShip);h=c.research>=10?0:1;$("#TextBlockResearchAmount").text("+"+c.research.toFixed(h));$("#TextBlockResearchAmount").prop("title","Research Per Turn: "+c.research.toFixed(2));b=a.TotalOreAmount();h=b>=10?0:1;$("#TextBlockOreAmount").text(Math.floor(b)+" +"+c.ore.toFixed(h));$("#TextBlockOreAmount").prop("title","Ore Amount: "+a.TotalOreAmount().toFixed(1)+" +"+c.ore.toFixed(2));b=a.TotalIridiumAmount();h=b>=10?0:1;$("#TextBlockIridiumAmount").text(Math.floor(b)+
" +"+c.iridium.toFixed(h));$("#TextBlockIridiumAmount").prop("title","Iridium Amount: "+a.TotalIridiumAmount().toFixed(1)+" +"+c.iridium.toFixed(2))}};
Astriarch.View.updateSelectedItemPanelForPlanet=function(){$("#PlanetViewButton").button("disable");$("#SendShipsButton").button("disable");$("#ButtonOpenTradingCenter").button("disable");var a="";if(Astriarch.ClientGameModel.GameGrid.SelectedHex!=null){var b=Astriarch.ClientGameModel.GameGrid.SelectedHex.ClientPlanetContainedInHex,c=Astriarch.ClientGameModel.MainPlayer;a+="--- Planet "+b.Name+" ---<br />";$("#SelectedItemBuiltImprovementsGrid").css({visibility:"hidden"});$("#SelectedItemPlanetaryFleetGrid").css({visibility:"hidden"});
$("#SelectedItemPopulationPanel").css({visibility:"hidden"});$("#SelectedItemPopulationAssignmentsPanel").css({visibility:"hidden"});$("#SelectedItemImprovementSlotsPanel").css({visibility:"hidden"});$("#SelectedItemStatusDetails").css({visibility:"hidden"});var d=c.PlanetTypeIfKnownByPlayer(b);if(d){var e=null,g=null;if(c.LastKnownPlanetFleetStrength[b.Id])e=c.LastKnownPlanetFleetStrength[b.Id],g=e.LastKnownOwner;a+=Astriarch.GameTools.PlanetTypeToFriendlyName(d)+"<br />";if(b=c.GetPlanetIfOwnedByPlayer(b.Id)){e=
b.Type==Astriarch.Planet.PlanetType.AsteroidBelt?"None":"Natives";if(b.Owner!=null)e=b.Owner.Name;a+=e+"<br />";e=b.GetNextProductionItemFromBuildQueue();d="None";g="qi-default";e&&(e instanceof Astriarch.Planet.PlanetImprovement?g="qi-planetImprovement":e instanceof Astriarch.Planet.StarShipInProduction?g="qi-starShipInProduction":e instanceof Astriarch.Planet.PlanetImprovementToDestroy&&(g="qi-planetImprovementToDestroy"),d=e.ToString()+" ("+e.TurnsToComplete+")");a+="<span class='"+g+"'>"+d+"</span>";
$("#SelectedItemBuiltImprovementsGrid").css({visibility:"visible"});$("#SelectedItemPlanetaryFleetGrid").css({visibility:"visible"});$("#SelectedItemPopulationPanel").css({visibility:"visible"});$("#SelectedItemPopulationAssignmentsPanel").css({visibility:"visible"});$("#SelectedItemImprovementSlotsPanel").css({visibility:"visible"});$("#SelectedItemStatusDetails").css({visibility:"visible"});Astriarch.View.updateSelectedItemPopulationPanel(b);var e=b.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Farm].length,
d=b.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length,g=b.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Colony].length,f=b.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length,h=b.GetSpacePlatformCount();Astriarch.View.updateSelectedItemImprovementSlotsPanel(e+d+f+g,b.MaxImprovements);var i=new Astriarch.Planet.PopulationAssignments;b.CountPopulationWorkerTypes(i);Astriarch.View.updateSelectedItemPopulationAssignmentsPanel(i.Farmers,i.Miners,i.Workers);
$("#TextBlockFarmCount").text(e);$("#TextBlockMineCount").text(d);$("#TextBlockFactoryCount").text(f);$("#TextBlockColonyCount").text(g);$("#TextBlockSpacePlatformCount").text(h);e=Astriarch.Fleet.Static.getStrengthDetailsForShips(b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]);Astriarch.View.ImageCanvasStarships.defender.drawShip(Astriarch.View.ColorsRGBA[e.color],e.percentHealthText);$(Astriarch.View.ImageCanvasStarships.defender.canvasSelector).prop("title","Defenders"+
(e.maxStrength?": "+e.damageText:""));e=Astriarch.Fleet.Static.getStrengthDetailsForShips(b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Scout]);Astriarch.View.ImageCanvasStarships.scout.drawShip(Astriarch.View.ColorsRGBA[e.color],e.percentHealthText);$(Astriarch.View.ImageCanvasStarships.scout.canvasSelector).prop("title","Scouts"+(e.maxStrength?": "+e.damageText:""));e=Astriarch.Fleet.Static.getStrengthDetailsForShips(b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Destroyer]);
Astriarch.View.ImageCanvasStarships.destroyer.drawShip(Astriarch.View.ColorsRGBA[e.color],e.percentHealthText);$(Astriarch.View.ImageCanvasStarships.destroyer.canvasSelector).prop("title","Destroyers"+(e.maxStrength?": "+e.damageText:""));e=Astriarch.Fleet.Static.getStrengthDetailsForShips(b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Cruiser]);Astriarch.View.ImageCanvasStarships.cruiser.drawShip(Astriarch.View.ColorsRGBA[e.color],e.percentHealthText);$(Astriarch.View.ImageCanvasStarships.cruiser.canvasSelector).prop("title",
"Cruisers"+(e.maxStrength?": "+e.damageText:""));e=Astriarch.Fleet.Static.getStrengthDetailsForShips(b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Battleship]);Astriarch.View.ImageCanvasStarships.battleship.drawShip(Astriarch.View.ColorsRGBA[e.color],e.percentHealthText);$(Astriarch.View.ImageCanvasStarships.battleship.canvasSelector).prop("title","Battleships"+(e.maxStrength?": "+e.damageText:""));e=b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Scout].length;d=b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length;
g=b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length;f=b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Battleship].length;$("#TextBlockDefenderCount").text(b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].length);$("#TextBlockScoutCount").text(e);$("#TextBlockDestroyerCount").text(d);$("#TextBlockCruiserCount").text(g);$("#TextBlockBattleshipCount").text(f);b.Owner==c&&($("#PlanetViewButton").button("enable"),(e!=0||d!=0||g!=0||f!=0)&&$("#SendShipsButton").button("enable"),
$("#ButtonOpenTradingCenter").button("enable"));c="";c+="<br />--- Stockpile ---<br />";c+="Production: "+Astriarch.DecimalToFixed(b.RemainderProduction,3)+"<br />";c+="Food: "+Astriarch.DecimalToFixed(b.Resources.FoodAmount,3)+"<br />";c+="Ore: "+Astriarch.DecimalToFixed(b.Resources.OreAmount,3)+"<br />";c+="Iridium: "+Astriarch.DecimalToFixed(b.Resources.IridiumAmount,3)+"<br />";c+="<br />--- Per Turn ---<br />";c+="Production: "+Astriarch.DecimalToFixed(b.ResourcesPerTurn.GetProductionAmountPerTurn(),
3)+"<br />";c+="Food: "+Astriarch.DecimalToFixed(b.ResourcesPerTurn.GetFoodAmountPerTurn(),3)+"<br />";c+="Ore: "+Astriarch.DecimalToFixed(b.ResourcesPerTurn.GetOreAmountPerTurn(),3)+"<br />";c+="Iridium: "+Astriarch.DecimalToFixed(b.ResourcesPerTurn.GetIridiumAmountPerTurn(),3)+"<br />";c+="<br />--- Per Worker ---<br />";c+="Production: "+Astriarch.DecimalToFixed(b.ResourcesPerTurn.GetExactProductionAmountPerWorkerPerTurn(),3)+"<br />";c+="Food: "+Astriarch.DecimalToFixed(b.ResourcesPerTurn.GetExactFoodAmountPerWorkerPerTurn(),
3)+"<br />";c+="Ore: "+Astriarch.DecimalToFixed(b.ResourcesPerTurn.GetExactOreAmountPerWorkerPerTurn(),3)+"<br />";c+="Iridium: "+Astriarch.DecimalToFixed(b.ResourcesPerTurn.GetExactIridiumAmountPerWorkerPerTurn(),3)+"<br />";$("#SelectedItemStatusDetails").html(c)}else if(e!=null)a+=Astriarch.GameTools.PlanetOwnerToFriendlyName(d,g)+"<br />",c=e.Fleet,b=Astriarch.ClientGameModel.Turn.Number-e.TurnLastExplored,a+="--- Known Fleet ---<br />",a+=(b==0?"Explored this turn.":b==1?"Explored last turn.":
"As of "+b+" turns ago.")+"<br />",spCount=c.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform].length,a+=spCount>1?spCount+" Space Platforms":spCount==1?"1 Space Platform":"No Space Platforms",a+="<br />",e=Astriarch.Fleet.Static.getStrengthDetailsForShips(c.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]),Astriarch.View.ImageCanvasStarships.defender.drawShip(Astriarch.View.ColorsRGBA.green,""),$(Astriarch.View.ImageCanvasStarships.defender.canvasSelector).prop("title","Defenders"+(e.maxStrength?
": "+e.damageText:"")),e=Astriarch.Fleet.Static.getStrengthDetailsForShips(c.StarShips[Astriarch.Fleet.StarShipType.Scout]),Astriarch.View.ImageCanvasStarships.scout.drawShip(Astriarch.View.ColorsRGBA.green,""),$(Astriarch.View.ImageCanvasStarships.scout.canvasSelector).prop("title","Scouts"+(e.maxStrength?": "+e.damageText:"")),e=Astriarch.Fleet.Static.getStrengthDetailsForShips(c.StarShips[Astriarch.Fleet.StarShipType.Destroyer]),Astriarch.View.ImageCanvasStarships.destroyer.drawShip(Astriarch.View.ColorsRGBA.green,
""),$(Astriarch.View.ImageCanvasStarships.destroyer.canvasSelector).prop("title","Destroyers"+(e.maxStrength?": "+e.damageText:"")),e=Astriarch.Fleet.Static.getStrengthDetailsForShips(c.StarShips[Astriarch.Fleet.StarShipType.Cruiser]),Astriarch.View.ImageCanvasStarships.cruiser.drawShip(Astriarch.View.ColorsRGBA.green,""),$(Astriarch.View.ImageCanvasStarships.cruiser.canvasSelector).prop("title","Cruisers"+(e.maxStrength?": "+e.damageText:"")),e=Astriarch.Fleet.Static.getStrengthDetailsForShips(c.StarShips[Astriarch.Fleet.StarShipType.Battleship]),
Astriarch.View.ImageCanvasStarships.battleship.drawShip(Astriarch.View.ColorsRGBA.green,""),$(Astriarch.View.ImageCanvasStarships.battleship.canvasSelector).prop("title","Battleships"+(e.maxStrength?": "+e.damageText:"")),$("#TextBlockDefenderCount").text(c.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].length),$("#TextBlockScoutCount").text(c.StarShips[Astriarch.Fleet.StarShipType.Scout].length),$("#TextBlockDestroyerCount").text(c.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length),
$("#TextBlockCruiserCount").text(c.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length),$("#TextBlockBattleshipCount").text(c.StarShips[Astriarch.Fleet.StarShipType.Battleship].length),$("#SelectedItemPlanetaryFleetGrid").css({visibility:"visible"})}else a+="Unexplored"}$("#SelectedItemStatus").html(a)};
Astriarch.View.updateSelectedItemPopulationPanel=function(a){var b=a.Population,c=a.MaxPopulation(),d=null,d=a.GetTurnsUntilPopulationGrowth(),a=a.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Riots?", population rioting":a.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Unrest?", population unrest":"",e="";d<999&&(e=", Growth in "+d+" turn",e+=d>1?"s":"");for(var g=c+1;g<=16;g++)d=$("#PopulationImage"+g),d.attr("class","popImg"),d.prop("title","Planet Population: "+b.length+" / "+c+
e+a);for(g=1;g<=c;g++)if(d=$("#PopulationImage"+g),g<=b.length){var f=b[g-1];f.ProtestLevel==0?(d.attr("class","icon-10x16-PopulationSmallFilled"),d.prop("title","Planet Population: "+b.length+" / "+c+e+a)):(f.ProtestLevel>0.5?d.attr("class","icon-10x16-PopulationSmallFilled_red"):d.attr("class","icon-10x16-PopulationSmallFilled_orange"),d.prop("title","Citizens Protesting at "+Math.round(100*f.ProtestLevel)+"%"+e+a))}else d.attr("class","icon-10x16-PopulationSmallEmpty"),d.prop("title","Planet Population: "+
b.length+" / "+c+e+a)};Astriarch.View.updateSelectedItemImprovementSlotsPanel=function(a,b){$("#SelectedItemImprovementSlotsPanel").attr("Title","Planetary Improvements: "+a+" / "+b);for(var c=1;c<=9;c++)$("#PlanetaryImprovementSlotsImage"+c).attr("class","impImg");for(c=1;c<=b;c++)c<=a?$("#PlanetaryImprovementSlotsImage"+c).addClass("icon-16x16-PlanetaryImprovementSlotFilled"):$("#PlanetaryImprovementSlotsImage"+c).addClass("icon-16x16-PlanetaryImprovementSlotEmpty")};
Astriarch.View.updateSelectedItemPopulationAssignmentsPanel=function(){var a;$("#SelectedItemPopulationAssignmentsPanel").attr("Title",farmers+(farmers==1?" Farmer, ":" Farmers, ")+miners+(miners==1?" Miner, ":" Miners, ")+workers+(workers==1?" Builder":" Builders"));for(a=1;a<=16;a++)$("#PopulationAssignmentImage"+a).attr("class","asnImg");for(a=1;a<=farmers;a++)$("#PopulationAssignmentImage"+a).addClass("icon-10x16-Farmer");for(a=farmers+1;a<=farmers+miners;a++)$("#PopulationAssignmentImage"+a).addClass("icon-10x16-Miner");
for(a=farmers+miners+1;a<=farmers+miners+workers;a++)$("#PopulationAssignmentImage"+a).addClass("icon-10x16-Builder")};
Astriarch.View.updateCanvasForPlayer=function(){var a=Astriarch.ClientGameModel.MainPlayer,b;for(b in Astriarch.View.DrawnPlanets)Astriarch.View.DrawnPlanets[b].UpdatePlanetDrawingForPlayer(Astriarch.ClientGameModel);Astriarch.View.CanvasPlayfieldLayer.needsDisplay=!0;Astriarch.View.DrawnFleets=[];Astriarch.View.CanvasFleetsLayer.children=[];for(b in a.FleetsInTransit)a.FleetsInTransit[b].CreateDrawnFleet();for(var c in a.OwnedPlanets){var d=a.OwnedPlanets[c];for(b in d.OutgoingFleets)d.OutgoingFleets[b].CreateDrawnFleet()}Astriarch.View.CanvasFleetsLayer.needsDisplay=
!0};Astriarch.View.loadBackgroundSpriteSheetImage=function(){var a=new Image;a.onload=function(){Astriarch.View.backgroundSpriteSheetImageLoaded()};a.src="img/background-sprites.jpg";Astriarch.View.BackgroundSpriteSheetImage=a};
Astriarch.View.backgroundSpriteSheetImageLoaded=function(){var a=Astriarch.View.populateStars();Astriarch.View.populateBackgroundImages();Astriarch.View.paintLargeStars(a);Astriarch.View.drawBorder();$("#loadingSpinner").hide();$("#mainMenu").show();a=$("#joyRideTipContent").joyride({scroll:!1,autoStart:!0,nextButton:!1,localStorage:!0,localStorageKey:"seentutorial",preStepCallback:function(a){window.tour.enabled=!0;window.tour.step=a},postStepCallback:function(){},preRideCallback:function(){},postRideCallback:function(){window.tour.enabled=
!1},pauseAfter:[27,32,43,48,49,50,51,53,54,56,59,63,66,68]});window.tour.jqElm=$(a)};
Astriarch.View.populateBackgroundImages=function(){for(var a={},b=0;b<Astriarch.View.BACKGROUND_COUNT;b++)a[b]=100;for(var b=Math.floor(Astriarch.View.CanvasBackground[0].height/60),c=Math.floor(Astriarch.View.CanvasBackground[0].width/80),d=0;d<b;d+=2)for(var e=0;e<c;e+=2)if(Astriarch.NextRandom(0,2)==0){var g=Astriarch.NextRandom(0,Math.floor(60)),f=Astriarch.NextRandom(0,Math.floor(80)),h=Astriarch.View.pickRandomTile(a);Astriarch.View.ContextBackground.globalAlpha=Astriarch.NextRandom(70-Astriarch.View.BACKGROUND_DARKNESS,
101-Astriarch.View.BACKGROUND_DARKNESS)/100;Astriarch.View.ContextBackground.drawImage(Astriarch.View.BackgroundSpriteSheetImage,0,h*60,80,60,e*80+f,d*60+g,80,60)}};Astriarch.View.pickRandomTile=function(a){var b=1,c;for(c in a)b+=a[c];var b=Astriarch.NextRandom(0,b),d=c=0,e;for(e in a){var g=a[e];if(b<g+c){d=e;a[e]=Math.floor(g/2);break}c+=g}return d};Astriarch.View.Star=function(a,b,c){this.X=a;this.Y=b;this.Opacity=c};
Astriarch.View.populateStars=function(){for(var a=Math.floor(Astriarch.View.CanvasBackground[0].height/40),b=Math.floor(Astriarch.View.CanvasBackground[0].width/40),c=[],d=[],e=0;e<a;e++)for(var g=0;g<b;g++)for(var f=Astriarch.NextRandom(0,20),h=0;h<f;h++){var i=Astriarch.NextRandom(0,40),j=Astriarch.NextRandom(0,40);if(h>=6||h%2==0){var k=Astriarch.NextRandom(40-Astriarch.View.BACKGROUND_DARKNESS,101-Astriarch.View.BACKGROUND_DARKNESS)/140,k=Math.floor(k*255);c.push(new Astriarch.View.Star(g*40+
j,e*40+i,k))}else d.push(new Astriarch.View.Star(g*40+j,e*40+i,null))}a=Astriarch.View.ContextBackground.createImageData(Astriarch.View.CanvasBackground[0].width,Astriarch.View.CanvasBackground[0].height);for(b=0;b<c.length;b++)e=c[b],g=(e.X+e.Y*Astriarch.View.CanvasBackground[0].width)*4,a.data[g]=255,a.data[g+1]=255,a.data[g+2]=255,a.data[g+3]=e.Opacity;Astriarch.View.ContextBackground.putImageData(a,0,0);return d};
Astriarch.View.paintLargeStars=function(a){for(var b=0;b<a.length;b++){var c=a[b],d=Astriarch.NextRandom(1,6),e=d/2,g=Astriarch.View.ContextBackground.createRadialGradient(c.X,c.Y,0,c.X,c.Y,e),f=Astriarch.NextRandom(0,Astriarch.View.Colors.length);g.addColorStop(0,"white");g.addColorStop(0.5,Astriarch.View.Colors[f]);g.addColorStop(1,"rgba(0, 0, 0, 0)");Astriarch.View.ContextBackground.globalAlpha=Astriarch.NextRandom(50-Astriarch.View.BACKGROUND_DARKNESS,101-Astriarch.View.BACKGROUND_DARKNESS)/100;
Astriarch.View.ContextBackground.fillStyle=g;Astriarch.View.ContextBackground.fillRect(c.X-e,c.Y-e,d,d)}};Astriarch.View.drawBorder=function(){Astriarch.View.ContextBackground.globalAlpha=1;Astriarch.View.ContextBackground.lineWidth=2;Astriarch.View.ContextBackground.strokeStyle="rgba(0, 128, 0, 255)";Astriarch.View.ContextBackground.strokeRect(0,0,800,600)};Astriarch.View.mainMenuIconMouseEnter=function(){$("#MainMenuIcon").hide();$("#MainMenuButton").show()};
Astriarch.View.mainMenuButtonMouseLeave=function(){$("#MainMenuButton").hide();$("#MainMenuIcon").show()};Astriarch.View.speakerIconMouseEnter=function(){$("#SpeakerIcon").hide();$("#ButtonSpeakerToggleMute").show();clearTimeout(Astriarch.View.audioMouseOutTimer);Astriarch.View.audioMouseInTimer=setTimeout(Astriarch.View.audioMouseInTimerTick,200)};
Astriarch.View.muteButtonMouseLeave=function(){$("#ButtonSpeakerToggleMute").hide();$("#SpeakerIcon").show();Astriarch.View.audioMouseOutTimer=setTimeout(Astriarch.View.audioMouseOutTimerTick,200)};Astriarch.View.volumeSliderMouseEnter=function(){clearTimeout(Astriarch.View.audioMouseOutTimer)};Astriarch.View.volumeSliderMouseLeave=function(){Astriarch.View.audioMouseOutTimer=setTimeout(Astriarch.View.audioMouseOutTimerTick,200)};Astriarch.View.audioMouseInTimerTick=function(){$("#SliderVolume").show()};
Astriarch.View.audioMouseOutTimerTick=function(){$("#SliderVolume").hide();clearTimeout(Astriarch.View.audioMouseInTimer)};
Astriarch.View.toggleAudioMute=function(){Astriarch.View.audioInterface.toggleMute();Astriarch.View.audioInterface.muted?($("#SpeakerIcon").removeClass("icon-16x16-speaker-on").addClass("icon-16x16-speaker-off"),$("#ButtonSpeakerToggleMute > .ui-icon").removeClass("icon-16x16-speaker-on").addClass("icon-16x16-speaker-off")):($("#SpeakerIcon").removeClass("icon-16x16-speaker-off").addClass("icon-16x16-speaker-on"),$("#ButtonSpeakerToggleMute > .ui-icon").removeClass("icon-16x16-speaker-off").addClass("icon-16x16-speaker-on"))};
Astriarch.View.volumeSliderValueChanged=function(a,b){Astriarch.View.audioInterface.setVolume(b.value)};Astriarch.View.openTradingCenter=function(){var a=Astriarch.ClientGameModel.MainPlayer.GetPlanetIfOwnedByPlayer(Astriarch.ClientGameModel.GameGrid.SelectedHex.ClientPlanetContainedInHex.Id);a&&Astriarch.TradingControl.show(a)};
Astriarch.View.ImageCanvas=Class.extend({init:function(a,b,c,d,e,g){this.canvasSelector=a;this.imgFilename=b;this.width=c;this.height=d;this.colorRgbaArray=e||[];this.offsetY=g||0;this.imageDataDefault=null;this.imageDataByColorRGBA={};this.canvas=$(a);this.ctx=this.canvas[0].getContext("2d");var f=this,h=new Image;h.onload=function(){f.ctx.drawImage(h,0,g,c,d,0,0,c,d);f.imageDataDefault=function(a){var b=[],c;for(c in a)b.push(a[c]);return b}(f.ctx.getImageData(0,0,c,d).data);for(var a=0;a<e.length;a++){var b=
e[a];f.imageDataByColorRGBA[b.toString()]=Astriarch.Util.ChangeImageColor(f.imageDataDefault,b)}};h.src=b},draw:function(a){this.ctx.clearRect(0,0,this.canvas[0].width,this.canvas[0].height);var a=a?this.imageDataByColorRGBA[a.toString()]:this.imageDataDefault,b=this.ctx.createImageData(this.width,this.height),c;for(c in a)b.data[c]=a[c];this.ctx.putImageData(b,0,0)}});
Astriarch.View.StarshipCanvas=Astriarch.View.ImageCanvas.extend({init:function(a,b,c,d,e,g){this._super(a,b,c,d,e,g)},drawShip:function(a,b){this.draw(a);this.ctx.textAlign="center";this.ctx.textBaseline="middle";this.ctx.fillStyle=a.toString();this.ctx.font="bold 7pt Trebuchet MS,Tahoma,Verdana,Arial,sans-serif";this.ctx.fillText(b,this.width/2,this.canvas[0].height-4)}});var Astriarch=Astriarch||require("./astriarch_base"),jCanvas=jCanvas||require("./../jCanvas");
Astriarch.Grid=function(a,b,c){this.Quadrants=[];var d,e,g,f;e=d=0;g=a/2;f=b/2;c.SystemsToGenerate==2||c.SystemsToGenerate==4?(this.Quadrants.push(new Astriarch.Grid.Rect(d,e,g,f)),d=g,this.Quadrants.push(new Astriarch.Grid.Rect(d,e,g,f)),e=f,this.Quadrants.push(new Astriarch.Grid.Rect(d,e,g,f)),d=0):(this.Quadrants.push(new Astriarch.Grid.Rect(d,e,g,f)),this.Quadrants.push(new Astriarch.Grid.Rect(g,e,g,f)),d=g/2,e=f);this.Quadrants.push(new Astriarch.Grid.Rect(d,e,g,f));for(e=0;e<this.Quadrants.length;e++){g=
this.Quadrants[e];f=g.Width/2;var h=g.Height/2,i=new Astriarch.Grid.Rect(g.X,g.Y,f,h);g.Children.push(i);i=new Astriarch.Grid.Rect(g.X+f,g.Y,f,h);e==1?g.Children.splice(0,0,i):g.Children.push(i);i=new Astriarch.Grid.Rect(g.X+f,g.Y+h,f,h);e==2?g.Children.splice(0,0,i):g.Children.push(i);f=new Astriarch.Grid.Rect(g.X,g.Y+h,f,h);e==3?g.Children.splice(0,0,f):g.Children.push(f)}this.Hexes=[];this.SelectedHex=null;g={};e=Astriarch.Model.GalaxySizeOptionToHexSizeMultiplier(c.GalaxySize);f=Astriarch.Hexagon.Static.WIDTH*
e;var h=Astriarch.Hexagon.Static.HEIGHT*e,i=Astriarch.Hexagon.Static.SIDE*e,j=0;for(e=0;e+h<=b;e+=h/2){var k=0,l=0;d=0;j%2==1&&(d=(f-i)/2+i,l=1);for(;d+f<=a;d+=f+i)c=new Astriarch.Hexagon(Astriarch.Grid.Static.Letters[j]+(l+1),d,e,f,h,i),c.PathCoOrdX=l,this.Hexes.push(c),g[l]||(g[l]=[]),g[l].push(c),k++,l+=2;j++}for(d in g)for(e in a=g[d],b=Math.floor(d/2)+d%2,a)c=a[e],c.PathCoOrdY=b++};Astriarch.Grid.Static={Letters:"ABCDEFGHIJKLMNOPQRSTUVWXYZ"};
Astriarch.Grid.prototype.SelectHex=function(a){if(this.SelectedHex!=null)this.SelectedHex.Deselect(),this.SelectedHex=null;a.Select();this.SelectedHex=a};Astriarch.Grid.prototype.GetHexAt=function(a){for(var b in this.Hexes)if(this.Hexes[b].Contains(a))return this.Hexes[b];return null};Astriarch.Grid.prototype.ShowHexGrid=function(){for(var a in this.Hexes)this.Hexes[a].Select()};Astriarch.Grid.prototype.HideHexGrid=function(){for(var a in this.Hexes)this.Hexes[a].Deselect()};
Astriarch.Grid.prototype.GetHexDistance=function(a,b){var c=a.PathCoOrdX-b.PathCoOrdX,d=a.PathCoOrdY-b.PathCoOrdY;return(Math.abs(c)+Math.abs(d)+Math.abs(c-d))/2};Astriarch.Grid.Rect=function(a,b,c,d){this.X=a;this.Y=b;this.Width=c;this.Height=d;this.Left=a;this.Right=a+c;this.Top=b;this.Bottom=b+d;this.Children=[]};Astriarch.Grid.Rect.prototype.Contains=function(a){return this.Left<a.X&&this.Right>a.X&&this.Bottom>a.Y&&this.Top<a.Y?!0:!1};
Astriarch.Grid.DrawnRect=jCanvas.DrawnObject.extend({init:function(a){this.Rect=a;this.selected=!1},draw:function(a){if(this.selected)a.strokeStyle="blue",a.lineWidth=2,a.rect(this.Rect.X,this.Rect.Y,this.Rect.Width,this.Rect.Height),a.stroke(),this.Rect.Children.forEach(function(b){a.strokeStyle="purple";a.lineWidth=1;a.rect(b.X,b.Y,b.Width,b.Height);a.stroke()})}});Astriarch=Astriarch||require("./astriarch_base");jCanvas=jCanvas||require("./../jCanvas");Astriarch.Point=function(a,b){this.X=a;this.Y=b};Astriarch.Rectangle=function(a,b,c,d){this.X=a;this.Y=b;this.Width=c;this.Height=d};Astriarch.Line=function(a,b,c,d){this.X1=a;this.Y1=b;this.X2=c;this.Y2=d};
Astriarch.Hexagon=jCanvas.DrawnObject.extend({init:function(a,b,c,d,e,g){this.Points=[];var f=(d-g)/2,h=e/2;this.Points.push(new Astriarch.Point(f+b,c));this.Points.push(new Astriarch.Point(f+g+b,c));this.Points.push(new Astriarch.Point(d+b,h+c));this.Points.push(new Astriarch.Point(f+g+b,e+c));this.Points.push(new Astriarch.Point(f+b,e+c));this.Points.push(new Astriarch.Point(b,h+c));this.Id=a;this.x=b;this.y=c;this.TopLeftPoint=new Astriarch.Point(this.x,this.y);this.TopRightPoint=new Astriarch.Point(this.x+
d,this.y);this.BottomLeftPoint=new Astriarch.Point(this.x,this.y+e);this.BottomRightPoint=new Astriarch.Point(this.x+d,this.y+e);this.MidPoint=new Astriarch.Point(this.x+d/2,this.y+e/2);this.ClientPlanetContainedInHex=this.PlanetContainedInHex=this.zIndex=this.PathCoOrdY=this.PathCoOrdX=null;this.selected=!1},draw:function(a){if(this.selected){a.strokeStyle="green";a.lineWidth=2;a.beginPath();a.moveTo(this.Points[0].X,this.Points[0].Y);for(var b=1;b<this.Points.length;b++){var c=this.Points[b];a.lineTo(c.X,
c.Y)}a.closePath();a.stroke()}},isInBounds:function(a,b){return this.Contains(new Astriarch.Point(a,b))},Select:function(){this.selected=!0;this.layer.needsDisplay=!0},Deselect:function(){this.selected=!1;this.layer.needsDisplay=!0},isInHexBounds:function(a){if(this.TopLeftPoint.X<a.X&&this.TopLeftPoint.Y<a.Y&&a.X<this.BottomRightPoint.X&&a.Y<this.BottomRightPoint.Y)return!0;return!1},Contains:function(a){var b=!1;if(this.isInHexBounds(a)){var c,d=0;c=0;for(d=this.Points.length-1;c<this.Points.length;d=
c++){var e=this.Points[c],d=this.Points[d];if((e.Y<=a.Y&&a.Y<d.Y||d.Y<=a.Y&&a.Y<e.Y)&&a.X<(d.X-e.X)*(a.Y-e.Y)/(d.Y-e.Y)+e.X)b=!b}}return b}});Astriarch.Hexagon.Static={HEIGHT:40,WIDTH:71,SIDE:29,X:21};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.TradingCenter=function(a){this.goldAmount=a?a*50:100;this.foodResource=new Astriarch.TradingCenter.Resource(Astriarch.TradingCenter.ResourceType.FOOD,320,400,0.1,1.5,40);this.oreResource=new Astriarch.TradingCenter.Resource(Astriarch.TradingCenter.ResourceType.ORE,10,200,0.2,3,20);this.iridiumResource=new Astriarch.TradingCenter.Resource(Astriarch.TradingCenter.ResourceType.IRIDIUM,5,100,0.4,6,10);this.currentTrades=[];this.transactionFeePercentage=0.1};
Astriarch.TradingCenter.prototype.recalculatePrices=function(){this.foodResource.calculateCurrentPrice();this.oreResource.calculateCurrentPrice();this.iridiumResource.calculateCurrentPrice()};Astriarch.TradingCenter.prototype.getResourceByType=function(a){return a==Astriarch.TradingCenter.ResourceType.FOOD?this.foodResource:a==Astriarch.TradingCenter.ResourceType.ORE?this.oreResource:this.iridiumResource};
Astriarch.TradingCenter.prototype.executeTrade=function(a,b,c,d){var e={executed:!1,foodAmount:0,oreAmount:0,iridiumAmount:0,tradeGoldAmount:0},g=this.getResourceByType(d.resourceType),f=0;d.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?(d.amount=Math.min(d.amount,this.foodResource.tradeAmountMax),f=b.TotalFoodAmount(),e.foodAmount=d.amount):d.resourceType==Astriarch.TradingCenter.ResourceType.ORE?(d.amount=Math.min(d.amount,this.oreResource.tradeAmountMax),f=b.TotalOreAmount(),e.oreAmount=
d.amount):(d.amount=Math.min(d.amount,this.iridiumResource.tradeAmountMax),f=b.TotalIridiumAmount(),e.iridiumAmount=d.amount);e.tradeGoldAmount=d.amount*g.currentPrice;if(d.tradeType==Astriarch.TradingCenter.TradeType.SELL){if(e.tradeGoldAmount-=e.tradeGoldAmount*this.transactionFeePercentage,this.goldAmount>=e.tradeGoldAmount&&f>=d.amount)this.goldAmount-=e.tradeGoldAmount,b.Resources.GoldAmount+=e.tradeGoldAmount,g.amount+=d.amount,c.SpendResources(a,0,e.foodAmount,e.oreAmount,e.iridiumAmount,b),
e.executed=!0}else if(e.tradeGoldAmount+=e.tradeGoldAmount*this.transactionFeePercentage,b.Resources.GoldAmount>=e.tradeGoldAmount&&g.amount>=d.amount)this.goldAmount+=e.tradeGoldAmount,b.Resources.GoldAmount-=e.tradeGoldAmount,g.amount-=d.amount,d.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?c.Resources.FoodAmount+=d.amount:d.resourceType==Astriarch.TradingCenter.ResourceType.ORE?c.Resources.OreAmount+=d.amount:c.Resources.IridiumAmount+=d.amount,e.executed=!0;return e};
Astriarch.TradingCenter.ResourceType={FOOD:1,ORE:2,IRIDIUM:3};Astriarch.TradingCenter.Resource=function(a,b,c,d,e,g){this.type=a;this.amount=b;this.desiredAmount=c;this.priceMin=d;this.priceMax=e;this.tradeAmountMax=g||(a==Astriarch.TradingCenter.ResourceType.FOOD?40:a==Astriarch.TradingCenter.ResourceType.ORE?20:10);this.currentPrice=e;this.calculateCurrentPrice()};
Astriarch.TradingCenter.Resource.prototype.calculateCurrentPrice=function(){this.currentPrice=this.amount>=this.desiredAmount?this.priceMin:this.amount<=0?this.priceMax:this.priceMin+(this.priceMax-this.priceMin)/this.desiredAmount*(this.desiredAmount-this.amount)};Astriarch.TradingCenter.TradeType={BUY:1,SELL:2};Astriarch.TradingCenter.OrderType={MARKET:1,LIMIT:2};
Astriarch.TradingCenter.Trade=function(a,b,c,d,e,g,f){this.playerId=a;this.planetId=b;this.tradeType=c;this.resourceType=d;this.amount=e;this.orderType=g;this.limitPrice=f};Astriarch.TradingCenter.TradeToString=function(a){return(a.tradeType==Astriarch.TradingCenter.TradeType.BUY?"Buy":"Sell")+" "+a.amount+" "+(a.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?"Food":a.resourceType==Astriarch.TradingCenter.ResourceType.ORE?"Ore":"Iridium")};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.Research=function(){this.researchProgressByType={};this.researchProgressByType[Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DEFENDER]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DEFENDER,0);this.researchProgressByType[Astriarch.Research.ResearchType.NEW_SHIP_TYPE_SCOUT]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.NEW_SHIP_TYPE_SCOUT,0);this.researchProgressByType[Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DESTROYER]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DESTROYER,
0);this.researchProgressByType[Astriarch.Research.ResearchType.NEW_SHIP_TYPE_CRUISER]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.NEW_SHIP_TYPE_CRUISER,0);this.researchProgressByType[Astriarch.Research.ResearchType.NEW_SHIP_TYPE_BATTLESHIP]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.NEW_SHIP_TYPE_BATTLESHIP,0);this.researchProgressByType[Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_ATTACK]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_ATTACK,
0,{chance:0});this.researchProgressByType[Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_DEFENSE]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_DEFENSE,0,{chance:0});this.researchProgressByType[Astriarch.Research.ResearchType.PROPULSION_IMPROVEMENT]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.PROPULSION_IMPROVEMENT,0,{percent:1});this.researchProgressByType[Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FARMS]=
new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FARMS,0,{percent:1});this.researchProgressByType[Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_MINES]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_MINES,0,{percent:1});this.researchProgressByType[Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_COLONIES]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_COLONIES,
0,{percent:1});this.researchProgressByType[Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FACTORIES]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FACTORIES,0,{percent:1});this.researchProgressByType[Astriarch.Research.ResearchType.SPACE_PLATFORM_IMPROVEMENT]=new Astriarch.Research.ResearchTypeProgress(Astriarch.Research.ResearchType.SPACE_PLATFORM_IMPROVEMENT,0,{max:1});this.researchTypeInQueue=null;this.researchPercent=
0};Astriarch.Research.prototype.getMaxSpacePlatformCount=function(){return this.researchProgressByType[Astriarch.Research.ResearchType.SPACE_PLATFORM_IMPROVEMENT].data.max};Astriarch.Research.prototype.getResearchProgressListSorted=function(){var a=[],b;for(b in this.researchProgressByType)a.push(this.researchProgressByType[b]);a.sort(function(a,b){return a.currentResearchLevel-b.currentResearchLevel});return a};Astriarch.Research.prototype.getResearchData=function(a){return this.researchProgressByType[a].data};
Astriarch.Research.prototype.getResearchDataByStarShipHullType=function(a){var b=null;switch(a){case Astriarch.Fleet.StarShipType.SystemDefense:b=this.getResearchData(Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DEFENDER);break;case Astriarch.Fleet.StarShipType.Scout:b=this.getResearchData(Astriarch.Research.ResearchType.NEW_SHIP_TYPE_SCOUT);break;case Astriarch.Fleet.StarShipType.Destroyer:b=this.getResearchData(Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DESTROYER);break;case Astriarch.Fleet.StarShipType.Cruiser:b=
this.getResearchData(Astriarch.Research.ResearchType.NEW_SHIP_TYPE_CRUISER);break;case Astriarch.Fleet.StarShipType.Battleship:b=this.getResearchData(Astriarch.Research.ResearchType.NEW_SHIP_TYPE_BATTLESHIP)}return b};Astriarch.Research.prototype.setResearchTypeProgressInQueue=function(a,b){this.researchTypeInQueue=a;if(b)this.researchProgressByType[a].data=b};
Astriarch.Research.prototype.estimateTurnsRemainingInQueue=function(a){a=this.getGoldAndResearchAmountEarned(a).researchAmountEarned;return this.researchTypeInQueue?Math.ceil(this.researchProgressByType[this.researchTypeInQueue].GetResearchLevelData().researchCostToNextLevel/a):999};Astriarch.Research.prototype.getGoldAndResearchAmountEarned=function(a){var b={goldAmountEarned:0,researchAmountEarned:a*this.researchPercent};b.goldAmountEarned=a-b.researchAmountEarned;return b};
Astriarch.Research.prototype.nextTurn=function(a){var b=this.getGoldAndResearchAmountEarned(a);b.endOfTurnMessages=[];if(this.researchTypeInQueue){if(b.researchAmountEarned+=Astriarch.NextRandom(0,b.researchAmountEarned*0.1),a=this.researchProgressByType[this.researchTypeInQueue],a.setResearchPointsCompleted(a.researchPointsCompleted+b.researchAmountEarned)&&(b.endOfTurnMessages.push(new Astriarch.TurnEventMessage(Astriarch.TurnEventMessage.TurnEventMessageType.ResearchComplete,null,"Our Scientists and Engineers have finished researching and developing: "+
a.ToString())),!a.canResearch()))this.researchTypeInQueue=null}else b.goldAmountEarned=a,b.researchAmountEarned=0,this.researchPercent&&b.endOfTurnMessages.push(new Astriarch.TurnEventMessage(Astriarch.TurnEventMessage.TurnEventMessageType.ResearchQueueEmpty,null,"Our Scientists and Engineers are idle, R&D points were used for tax collection instead."));return b};
Astriarch.Research.GetTotalResearchLevelCosts=function(a){for(var b=[],a=Astriarch.Research.GetResearchLevelCosts(a),c=0,d=0;d<10;d++)c+=a[d],b.push(c);return b};Astriarch.Research.GetResearchLevelCosts=function(a){for(var a=a||1,b=0,c=[],d=0;d<10;d++){var e=a;a+=b;c.push(a);b=e}return c};
Astriarch.Research.ResearchTypeProgress=function(a,b,c){this.type=a;this.data=c||{};this.currentResearchLevel=-1;this.researchPointsBase=0;this.isCustomShip=!1;this.maxResearchLevel=9;switch(this.type){case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DEFENDER:this.isCustomShip=!0;this.researchPointsBase=10;break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_SCOUT:this.isCustomShip=!0;this.researchPointsBase=20;break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DESTROYER:this.isCustomShip=
!0;this.researchPointsBase=30;break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_CRUISER:this.isCustomShip=!0;this.researchPointsBase=50;break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_BATTLESHIP:this.isCustomShip=!0;this.researchPointsBase=80;break;case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_ATTACK:this.researchPointsBase=4;break;case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_DEFENSE:this.researchPointsBase=3;break;case Astriarch.Research.ResearchType.PROPULSION_IMPROVEMENT:this.researchPointsBase=
8;break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FARMS:this.researchPointsBase=2;break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_MINES:this.researchPointsBase=1;break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_COLONIES:this.researchPointsBase=1;break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FACTORIES:this.researchPointsBase=5;break;case Astriarch.Research.ResearchType.SPACE_PLATFORM_IMPROVEMENT:this.researchPointsBase=
10}if(this.isCustomShip){c=a=this.maxResearchLevel=0;switch(this.data.advantageAgainst){case Astriarch.Fleet.StarShipType.SystemDefense:a=this.researchPointsBase*0.1;break;case Astriarch.Fleet.StarShipType.Scout:a=this.researchPointsBase*0.2;break;case Astriarch.Fleet.StarShipType.Destroyer:a=this.researchPointsBase*0.3;break;case Astriarch.Fleet.StarShipType.Cruiser:a=this.researchPointsBase*0.5;break;case Astriarch.Fleet.StarShipType.Battleship:a=this.researchPointsBase*0.8}switch(this.data.disadvantageAgainst){case Astriarch.Fleet.StarShipType.SystemDefense:c=
this.researchPointsBase*0.8;break;case Astriarch.Fleet.StarShipType.Scout:c=this.researchPointsBase*0.5;break;case Astriarch.Fleet.StarShipType.Destroyer:c=this.researchPointsBase*0.3;break;case Astriarch.Fleet.StarShipType.Cruiser:c=this.researchPointsBase*0.2;break;case Astriarch.Fleet.StarShipType.Battleship:c=this.researchPointsBase*0.1}this.researchPointsBase+=a+c}this.researchLevelCosts=Astriarch.Research.GetTotalResearchLevelCosts(this.researchPointsBase);this.researchPointsCompleted=0;this.setResearchPointsCompleted(b)};
Astriarch.Research.ResearchTypeProgress.prototype.canResearch=function(){return this.currentResearchLevel<this.maxResearchLevel};Astriarch.Research.ResearchTypeProgress.prototype.setResearchPointsCompleted=function(a){var b=this.currentResearchLevel;this.researchPointsCompleted=a;for(a=0;a<this.researchLevelCosts.length;a++)if(this.researchPointsCompleted>=this.researchLevelCosts[a])this.currentResearchLevel=a;else break;this.setDataBasedOnLevel();return this.currentResearchLevel-b};
Astriarch.Research.ResearchTypeProgress.prototype.setDataBasedOnLevel=function(){switch(this.type){case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_ATTACK:case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_DEFENSE:this.data.chance=(this.currentResearchLevel+1)/10;break;case Astriarch.Research.ResearchType.PROPULSION_IMPROVEMENT:this.data.percent=1+(this.currentResearchLevel+1)*0.5;break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FARMS:case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_MINES:case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_COLONIES:case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FACTORIES:this.data.percent=
1+(this.currentResearchLevel+1)/10;break;case Astriarch.Research.ResearchType.SPACE_PLATFORM_IMPROVEMENT:this.data.max=Math.max(Math.floor((this.currentResearchLevel+1)/2),1)}};
Astriarch.Research.ResearchTypeProgress.prototype.GetResearchLevelData=function(){var a={currentResearchLevel:this.currentResearchLevel+1,researchCostToNextLevel:0,percentComplete:0},b=a.currentResearchLevel===0?0:this.researchLevelCosts[a.currentResearchLevel-1],c=this.researchLevelCosts[a.currentResearchLevel];a.researchCostToNextLevel=c-this.researchPointsCompleted;a.percentComplete=(this.researchPointsCompleted-b)/(c-b);return a};
Astriarch.Research.ResearchTypeProgress.prototype.GetCurrentLevelDataString=function(){var a=this.ToString()+", \n";switch(this.type){case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DEFENDER:case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_SCOUT:case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DESTROYER:case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_CRUISER:case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_BATTLESHIP:a+="Advantage over: "+Astriarch.GameTools.StarShipTypeToFriendlyName(this.data.advantageAgainst)+
", Disadvantage over: "+Astriarch.GameTools.StarShipTypeToFriendlyName(this.data.disadvantageAgainst);break;case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_ATTACK:a+=this.data.chance*100+"% Chance to inflict 50% more damage.";break;case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_DEFENSE:a+=this.data.chance*100+"% Chance to decrease damage by 50%.";break;case Astriarch.Research.ResearchType.PROPULSION_IMPROVEMENT:case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FARMS:case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_MINES:case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_COLONIES:case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FACTORIES:a+=
"Operating at "+this.data.percent*100+"% efficiency.";break;case Astriarch.Research.ResearchType.SPACE_PLATFORM_IMPROVEMENT:a+="Maximum "+this.data.max+" per planet."}return a};
Astriarch.Research.ResearchTypeProgress.prototype.GetFriendlyName=function(){var a="Unknown";switch(this.type){case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DEFENDER:a="Custom "+Astriarch.GameTools.StarShipTypeToFriendlyName(Astriarch.Fleet.StarShipType.SystemDefense);break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_SCOUT:a="Custom "+Astriarch.GameTools.StarShipTypeToFriendlyName(Astriarch.Fleet.StarShipType.Scout);break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DESTROYER:a=
"Custom "+Astriarch.GameTools.StarShipTypeToFriendlyName(Astriarch.Fleet.StarShipType.Destroyer);break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_CRUISER:a="Custom "+Astriarch.GameTools.StarShipTypeToFriendlyName(Astriarch.Fleet.StarShipType.Cruiser);break;case Astriarch.Research.ResearchType.NEW_SHIP_TYPE_BATTLESHIP:a="Custom "+Astriarch.GameTools.StarShipTypeToFriendlyName(Astriarch.Fleet.StarShipType.Battleship);break;case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_ATTACK:a="Ship Attack";
break;case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_DEFENSE:a="Ship Defense";break;case Astriarch.Research.ResearchType.PROPULSION_IMPROVEMENT:a="Ship Propulsion";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FARMS:a="Farms";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_MINES:a="Mines";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_COLONIES:a="Colonies";break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FACTORIES:a=
"Factories";break;case Astriarch.Research.ResearchType.SPACE_PLATFORM_IMPROVEMENT:a="Space Platforms"}return a};
Astriarch.Research.ResearchTypeProgress.prototype.ToString=function(a){var a=this.currentResearchLevel+(a?2:1),b=this.GetFriendlyName();switch(this.type){case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_ATTACK:b+=" Level "+a;break;case Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_DEFENSE:b+=" Level "+a;break;case Astriarch.Research.ResearchType.PROPULSION_IMPROVEMENT:b+=" Level "+a;break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FARMS:b="Level "+a+" "+b;break;
case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_MINES:b="Level "+a+" "+b;break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_COLONIES:b="Level "+a+" "+b;break;case Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FACTORIES:b="Level "+a+" "+b;break;case Astriarch.Research.ResearchType.SPACE_PLATFORM_IMPROVEMENT:b="Level "+a+" "+b}return b};
Astriarch.Research.ResearchType={UNKNOWN:0,NEW_SHIP_TYPE_DEFENDER:1,NEW_SHIP_TYPE_SCOUT:2,NEW_SHIP_TYPE_DESTROYER:3,NEW_SHIP_TYPE_CRUISER:4,NEW_SHIP_TYPE_BATTLESHIP:5,COMBAT_IMPROVEMENT_ATTACK:6,COMBAT_IMPROVEMENT_DEFENSE:7,PROPULSION_IMPROVEMENT:8,BUILDING_EFFICIENCY_IMPROVEMENT_FARMS:9,BUILDING_EFFICIENCY_IMPROVEMENT_MINES:10,BUILDING_EFFICIENCY_IMPROVEMENT_COLONIES:11,BUILDING_EFFICIENCY_IMPROVEMENT_FACTORIES:12,SPACE_PLATFORM_IMPROVEMENT:13};Astriarch=Astriarch||require("./astriarch_base");Astriarch.Model=function(a,b,c){this.ShowUnexploredPlanetsAndEnemyPlayerStats=!1;this.GameOptions=new Astriarch.Model.GameOptions(b);this.Turn=new Astriarch.Model.Turn;this.TradingCenter=new Astriarch.TradingCenter(a.length);this.Players=a;this.PlayersDestroyed=[];this.galaxyWidth=621;this.galaxyHeight=480;this.GameGrid=new Astriarch.Grid(this.galaxyWidth,this.galaxyHeight,this.GameOptions);this.Planets=[];c||this.populatePlanets()};
Astriarch.Model.GameOptions=function(a){this.SystemsToGenerate=a.SystemsToGenerate;this.GalaxySize=a.GalaxySize||Astriarch.Model.GalaxySizeOption.LARGE;this.PlanetsPerSystem=a.PlanetsPerSystem;if(this.GalaxySize==Astriarch.Model.GalaxySizeOption.SMALL&&this.PlanetsPerSystem>Astriarch.Model.PlanetsPerSystemOption.SIX)this.PlanetsPerSystem=Astriarch.Model.PlanetsPerSystemOption.SIX;this.DistributePlanetsEvenly=a.DistributePlanetsEvenly;this.QuickStart=a.QuickStart||!1;this.TurnTimeLimitSeconds=a.TurnTimeLimitSeconds||
0};Astriarch.Model.prototype.getPlanetById=function(a){for(var b=0;b<this.Planets.length;b++)if(this.Planets[b].Id==a)return this.Planets[b];return null};Astriarch.Model.prototype.getPlayerById=function(a){var b=null,c;for(c in this.Players){var d=this.Players[c];if(d.Id==a){b=d;break}}if(!b)for(c in this.PlayersDestroyed)if(d=this.PlayersDestroyed[c],d.Id==a){b=d;break}return b};
Astriarch.Model.prototype.populatePlanets=function(){for(var a=0;a<this.GameGrid.Quadrants.length;a++){for(var b=this.GameGrid.Quadrants[a],c=[],d=0;d<b.Children.length;d++){var e=b.Children[d];c[d]=[];for(var g in this.GameGrid.Hexes){var f=this.GameGrid.Hexes[g];e.Contains(f.MidPoint)&&c[d].push(f)}}if(!(this.GameOptions.SystemsToGenerate==2&&(a==1||a==3))){f=[];f.push(Astriarch.Planet.PlanetType.PlanetClass1);f.push(Astriarch.Planet.PlanetType.DeadPlanet);f.push(Astriarch.Planet.PlanetType.AsteroidBelt);
for(d=0;d<b.Children.length;d++){var h=d;if(!this.GameOptions.DistributePlanetsEvenly){do h=Astriarch.NextRandom(0,b.Children.length);while(c[h].length==0)}var e=Astriarch.NextRandom(0,c[h].length),i=c[h][e];c[h].splice(e,1);h=3;e=Astriarch.Planet.PlanetType.PlanetClass2;d>0&&f.length<=3&&(h=Astriarch.NextRandom(0,f.length),e=f[h],f.splice(h,1));var h=null,j=!1,k=0;a==0?e==Astriarch.Planet.PlanetType.PlanetClass2&&(j=!0):this.Players.length==2?a==2&&(k=1,e==Astriarch.Planet.PlanetType.PlanetClass2&&
(j=!0)):a<this.Players.length&&(k=a,e==Astriarch.Planet.PlanetType.PlanetClass2&&(j=!0));j&&(h=this.Players[k],h.SetColor(Astriarch.Model.PlayerColors[k]));e=new Astriarch.Planet(e,i.Id,i,h);if(h)h.HomePlanetId=e.Id,e.Resources.OreAmount=2,e.Resources.IridiumAmount=1;this.GameOptions.QuickStart&&(e.SetPlanetExplored(this,this.Players[k]),h&&(e.Resources.OreAmount*=2,e.Resources.IridiumAmount*=2,e.AddBuiltImprovement(new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Farm)),
e.AddBuiltImprovement(new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Farm)),e.AddBuiltImprovement(new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Farm)),e.AddBuiltImprovement(new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Colony)),e.AddBuiltImprovement(new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Factory)),e.PlanetaryFleet.AddShip(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Scout))));
this.Planets.push(e)}if(this.GameOptions.PlanetsPerSystem!=Astriarch.Model.PlanetsPerSystemOption.FOUR){b=[25,25,25,25];f=40;h=34;k=26;for(j=4;j<this.GameOptions.PlanetsPerSystem;j++)for(var l=!1;!l;){for(d=0;d<b.length;d++)if(c[d].length){var e=b[d],m=b.reduce(function(a,b){return a+b},0);if(Astriarch.NextRandom(0,m)<e){e=Astriarch.NextRandom(0,c[d].length);i=c[d][e];c[d].splice(e,1);b[d]-=6;break}}if(i.PlanetContainedInHex==null)e=Astriarch.Planet.PlanetType.PlanetClass1,m=f+h+k,Astriarch.NextRandom(0,
m)>k?(e=Astriarch.Planet.PlanetType.DeadPlanet,Astriarch.NextRandom(0,m)>h?(e=Astriarch.Planet.PlanetType.AsteroidBelt,f-=15):h-=15):k-=15,e=new Astriarch.Planet(e,i.Id,i,null),this.Planets.push(e),l=!0}}}}};Astriarch.Model.PlayerColors=[new Astriarch.Util.ColorRGBA(0,255,0,255),new Astriarch.Util.ColorRGBA(200,0,200,255),new Astriarch.Util.ColorRGBA(0,128,255,255),new Astriarch.Util.ColorRGBA(255,0,0,255)];Astriarch.Model.Turn=function(){this.Number=1};Astriarch.Model.Turn.prototype.Next=function(){this.Number++};
Astriarch.Model.PlanetsPerSystemOption={FOUR:4,FIVE:5,SIX:6,SEVEN:7,EIGHT:8};Astriarch.Model.GalaxySizeOption={SMALL:1,MEDIUM:2,LARGE:3};Astriarch.Model.GalaxySizeOptionToHexSizeMultiplier=function(a){if(a==Astriarch.Model.GalaxySizeOption.LARGE)return 1;a=a==Astriarch.Model.GalaxySizeOption.MEDIUM?4:3;return 621/(a*Astriarch.Hexagon.Static.WIDTH+a*Astriarch.Hexagon.Static.SIDE+Astriarch.Hexagon.Static.X)};
Astriarch.Model.WorkingPlayerResources=function(a,b){a?(this.GoldAmount=a.Resources.GoldAmount,this.OreAmount=a.TotalOreAmount(),this.IridiumAmount=a.TotalIridiumAmount()):(this.GoldAmount=b.GoldAmount,this.OreAmount=b.OreAmount,this.IridiumAmount=b.IridiumAmount)};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.Player=function(a,b,c){this.Id=a;this.Type=b;this.Name=c;this.Resources=new Astriarch.Player.PlayerResources;this.Research=new Astriarch.Research;this.Color=new Astriarch.Util.ColorRGBA(0,255,0,255);this.LastTurnFoodNeededToBeShipped=0;this.OwnedPlanets={};this.KnownClientPlanets={};this.LastKnownPlanetFleetStrength={};this.PlanetBuildGoals={};this.HomePlanetId=null;this.EarnedPointsByType={};this.Points=0;this.FleetsInTransit=[];this.fleetsArrivingOnUnownedPlanets={};this.Destroyed=this.CurrentTurnEnded=
!1};Astriarch.Player.EarnedPointsType={POPULATION_GROWTH:{key:0,points_per:4,max_points:1E5},PRODUCTION_UNIT_BUILT:{key:1,points_per:0.25,max_points:500},REPAIRED_STARSHIP_STRENGTH:{key:2,points_per:2,max_points:4E3},DAMAGED_STARSHIP_STRENGTH:{key:3,points_per:0.5,max_points:1E3},CITIZEN_ON_CAPTURED_PLANET:{key:4,points_per:10,max_points:1E4}};
Astriarch.Player.prototype.IncreasePoints=function(a,b){a.key in this.EarnedPointsByType||(this.EarnedPointsByType[a.key]=0);this.EarnedPointsByType[a.key]<a.max_points&&(this.EarnedPointsByType[a.key]+=a.points_per*b);this.Points=0;for(var c in this.EarnedPointsByType)this.Points+=this.EarnedPointsByType[c];return this.Points=Math.floor(this.Points)};
Astriarch.Player.prototype.GetTaxRevenueAtMaxPercent=function(){var a=0,b;for(b in this.OwnedPlanets){var c=this.OwnedPlanets[b];a+=c.Id==this.HomePlanetId?c.Population.length*2:c.Population.length}return a/1.75};Astriarch.Player.prototype.SetColor=function(a){Astriarch.Util.GetImageData(a);this.Color=a};
Astriarch.Player.prototype.GetOwnedPlanetsListSorted=function(){var a=[],b;for(b in this.OwnedPlanets)a.push(this.OwnedPlanets[b]);a.sort(Astriarch.Planet.PlanetPopulationImprovementCountComparerSortFunction);return a};Astriarch.Player.prototype.TotalFoodAmount=function(){var a=0,b;for(b in this.OwnedPlanets)a+=this.OwnedPlanets[b].Resources.FoodAmount;return a};Astriarch.Player.prototype.TotalOreAmount=function(){var a=0,b;for(b in this.OwnedPlanets)a+=this.OwnedPlanets[b].Resources.OreAmount;return a};
Astriarch.Player.prototype.TotalIridiumAmount=function(){var a=0,b;for(b in this.OwnedPlanets)a+=this.OwnedPlanets[b].Resources.IridiumAmount;return a};Astriarch.Player.prototype.AddFleetArrivingOnUnownedPlanet=function(a,b){this.fleetsArrivingOnUnownedPlanets[a.Id]?this.fleetsArrivingOnUnownedPlanets[a.Id].MergeFleet(b):this.fleetsArrivingOnUnownedPlanets[a.Id]=b};
Astriarch.Player.prototype.GatherFleetsArrivingOnUnownedPlanets=function(){var a=[],b;for(b in this.fleetsArrivingOnUnownedPlanets)a.push(this.fleetsArrivingOnUnownedPlanets[b]);this.fleetsArrivingOnUnownedPlanets={};return a};Astriarch.Player.prototype.GetPlanetIfOwnedByPlayer=function(a){var b=null;a in this.OwnedPlanets&&(b=this.OwnedPlanets[a]);return b};
Astriarch.Player.prototype.PlanetTypeIfKnownByPlayer=function(a){var b=null;if(a.Id in this.KnownClientPlanets)b=this.KnownClientPlanets[a.Id].Type;return b};Astriarch.Player.prototype.PlanetContainsFriendlyInboundFleet=function(a){for(var b in this.FleetsInTransit)if(this.FleetsInTransit[b].DestinationHex.PlanetContainedInHex.Id==a.Id)return!0;return!1};Astriarch.Player.prototype.GetTotalPopulation=function(){var a=0,b;for(b in this.OwnedPlanets)a+=this.OwnedPlanets[b].Population.length;return a};
Astriarch.Player.prototype.GetTotalResourceProductionPerTurn=function(){var a={gold:0,research:0,foodToShip:0,food:0,ore:0,iridium:0},b=this.Research.getGoldAndResearchAmountEarned(this.GetTaxRevenueAtMaxPercent());a.gold=b.goldAmountEarned;a.research=b.researchAmountEarned;for(var c in this.OwnedPlanets){var b=this.OwnedPlanets[c],d=b.ResourcesPerTurn.GetFoodAmountPerTurn();a.food+=d;a.foodToShip+=Math.max(0,b.Population.length-d);a.ore+=b.ResourcesPerTurn.GetOreAmountPerTurn();a.iridium+=b.ResourcesPerTurn.GetIridiumAmountPerTurn()}return a};
Astriarch.Player.PlayerType={Human:0,Computer_Easy:1,Computer_Normal:2,Computer_Hard:3,Computer_Expert:4};Astriarch.Player.PlayerResources=function(){this.GoldAmount=3};Astriarch.Player.PlayerResources.prototype.SpendGoldAsPossible=function(a){this.GoldAmount>=a?this.GoldAmount-=a:(a-=this.GoldAmount,this.GoldAmount=0);return a};Astriarch.Player.PlayerGameOptions=function(){this.ShowHexGrid=!1;this.ShowPlanetaryConflictPopups=!0};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.Planet=function(a,b,c,d){this.Id=Astriarch.Planet.Static.NEXT_PLANET_ID++;this.Name=b;this.Type=a;this.Population=[];this.RemainderProduction=0;this.BuildQueue=[];this.BuiltImprovements={};this.Resources=this.MaxImprovements=null;this.BoundingHex=c;this.PlanetaryFleet=this.Owner=this.OriginPoint=null;this.OutgoingFleets=[];this.ResourcesPerTurn=null;this.PlanetHappiness=Astriarch.Planet.PlanetHappinessType.Normal;this.SetPlanetOwner(d);if(this.Type==Astriarch.Planet.PlanetType.AsteroidBelt)this.Population=
[];this.recomputeOriginPoint();this.BuildQueue=[];this.BuiltImprovements={};this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Colony]=[];this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory]=[];this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Farm]=[];this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine]=[];this.Resources=new Astriarch.Planet.PlanetResources;this.StarShipTypeLastBuilt=null;this.StarShipCustomShipLastBuilt=!1;this.BuildLastStarShip=
!0;this.WayPointPlanetId=null;if(d!==null)this.Population.push(new Astriarch.Planet.Citizen(this.Type,d.Id)),this.Population.push(new Astriarch.Planet.Citizen(this.Type,d.Id)),this.Resources.FoodAmount=4;this.ResourcesPerTurn=new Astriarch.Planet.PlanetPerTurnResourceGeneration(this,this.Type);this.GenerateResources();switch(this.Type){case Astriarch.Planet.PlanetType.AsteroidBelt:this.MaxImprovements=3;this.PlanetaryFleet=Astriarch.Fleet.StarShipFactoryHelper.GenerateShips(d,Astriarch.Fleet.StarShipType.SystemDefense,
0,this.BoundingHex);break;case Astriarch.Planet.PlanetType.DeadPlanet:this.MaxImprovements=5;this.PlanetaryFleet=Astriarch.Fleet.StarShipFactoryHelper.GenerateShips(d,Astriarch.Fleet.StarShipType.SystemDefense,Astriarch.NextRandom(3,5),this.BoundingHex);break;case Astriarch.Planet.PlanetType.PlanetClass1:this.MaxImprovements=6;this.PlanetaryFleet=Astriarch.Fleet.StarShipFactoryHelper.GenerateShips(d,Astriarch.Fleet.StarShipType.SystemDefense,Astriarch.NextRandom(4,6),this.BoundingHex);break;case Astriarch.Planet.PlanetType.PlanetClass2:this.MaxImprovements=
9;this.PlanetaryFleet=Astriarch.Fleet.StarShipFactoryHelper.GenerateShips(d,Astriarch.Fleet.StarShipType.SystemDefense,Astriarch.NextRandom(10,15),this.BoundingHex);break;default:throw new NotImplementedException("Planet type "+this.Type+"not supported by planet constructor.");}this.maxPopulation=this.MaxImprovements;c.PlanetContainedInHex=this};Astriarch.Planet.Static={NEXT_PLANET_ID:1,PLANET_SIZE:20};
Astriarch.Planet.prototype.GetPopulationByContentment=function(){var a={protesting:[],content:[]},b;for(b in this.Population){var c=this.Population[b];c.ProtestLevel>0?a.protesting.push(c):a.content.push(c)}return a};
Astriarch.Planet.prototype.GetPopulationGrowthRate=function(){var a=this.Population.length,b=0;if(a>0&&this.PlanetHappiness!=Astriarch.Planet.PlanetHappinessType.Riots&&(a<this.MaxPopulation()||this.Population[a-1].PopulationChange<1)){var b=this.MaxPopulation()-a,c=a/8,d=this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Colony].length;this.Owner&&d&&(c*=this.Owner.Research.getResearchData(Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_COLONIES).percent*d);b=c*Math.min(b/
a,2);this.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Unrest&&(b/=2)}return b};Astriarch.Planet.prototype.GetTurnsUntilPopulationGrowth=function(){var a=999;if(this.Population.length>0&&this.Population.length<this.MaxPopulation())a=this.Population[this.Population.length-1].PopulationChange,a=a>=1?1:Math.floor((1-a)/this.GetPopulationGrowthRate())+1;return a};Astriarch.Planet.prototype.MaxPopulation=function(){return this.maxPopulation+this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Colony].length};
Astriarch.Planet.prototype.BuiltImprovementCount=function(){var a=0,b;for(b in this.BuiltImprovements)a+=this.BuiltImprovements[b].length;return a};
Astriarch.Planet.prototype.RemoveBuildQueueItemForRefund=function(a){var b=0;if(this.BuildQueue.length>a){var c=[],d;for(d in this.BuildQueue)c.push(this.BuildQueue[d]);var e=c[a].GetRefundAmount();b+=e.Gold;this.Owner.Resources.GoldAmount+=e.Gold;this.Owner.Resources.OreAmount+=e.Ore;this.Owner.Resources.IridiumAmount+=e.Iridium;c.splice(a,1);this.BuildQueue=[];for(d in c)this.BuildQueue.push(c[d])}return b};
Astriarch.Planet.prototype.GetSpacePlatformCount=function(a){var b=0;if(this.PlanetaryFleet)b=this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform].length;if(a)for(var c in this.BuildQueue)a=this.BuildQueue[c],a instanceof Astriarch.Planet.StarShipInProduction&&a.Type==Astriarch.Fleet.StarShipType.SpacePlatform&&b++;return b};
Astriarch.Planet.prototype.BuiltAndBuildQueueImprovementCount=function(){var a=this.BuiltImprovementCount(),b;for(b in this.BuildQueue)this.BuildQueue[b]instanceof Astriarch.Planet.PlanetImprovement&&a++;return a};Astriarch.Planet.prototype.BuiltAndBuildQueueImprovementTypeCount=function(a){var b=this.BuiltImprovements[a].length,c;for(c in this.BuildQueue){var d=this.BuildQueue[c];d instanceof Astriarch.Planet.PlanetImprovement&&d.Type==a&&b++}return b};
Astriarch.Planet.prototype.BuildQueueContainsMobileStarship=function(a){a.turnsToComplete=99;a.starshipStrength=0;for(var b in this.BuildQueue){var c=this.BuildQueue[b];if(c instanceof Astriarch.Planet.StarShipInProduction&&c.Type!=Astriarch.Fleet.StarShipType.SystemDefense)return a.turnsToComplete=c.TurnsToComplete,a.starshipStrength=(new Astriarch.Fleet.StarShip(c.Type)).Strength(),!0}return!1};
Astriarch.Planet.prototype.BuildQueueContainsImprovement=function(a){for(var b in this.BuildQueue){var c=this.BuildQueue[b];if(c instanceof Astriarch.Planet.PlanetImprovement&&c.Type==a)return!0}return!1};Astriarch.Planet.prototype.EnqueueProductionItemAndSpendResources=function(a,b,c){b&&(this.BuildQueue.push(b),this.SpendResources(a,b.GoldCost,0,b.OreCost,b.IridiumCost,c))};Astriarch.Planet.prototype.GetNextProductionItemFromBuildQueue=function(){return this.BuildQueue[0]};
Astriarch.Planet.prototype.SpendResources=function(a,b,c,d,e,g){g.Resources.GoldAmount-=b;b=c-this.Resources.SpendFoodAsPossible(c);d-=this.Resources.SpendOreAsPossible(d);e-=this.Resources.SpendIridiumAsPossible(e);if(b!=0||d!=0||e!=0){var c=[],f;for(f in g.OwnedPlanets)this.Id!=g.OwnedPlanets[f].Id&&c.push(g.OwnedPlanets[f]);a=new Astriarch.Planet.PlanetDistanceComparer(a,this);c.sort(a.sortFunction);for(f in c)if(b!=0&&(b-=c[f].Resources.SpendFoodAsPossible(d)),d!=0&&(d-=c[f].Resources.SpendOreAsPossible(d)),
e!=0&&(e-=c[f].Resources.SpendIridiumAsPossible(e)),b==0&&d==0&&e==0)break;(b!=0||d!=0||e!=0)&&console.warn("Problem spending food, ore and iridium as necessary! Player:",g.Name,this.Name,b,d,e)}};Astriarch.Planet.prototype.recomputeOriginPoint=function(){this.OriginPoint=new Astriarch.Point(this.BoundingHex.MidPoint.X-Astriarch.Planet.Static.PLANET_SIZE/2,this.BoundingHex.MidPoint.Y-Astriarch.Planet.Static.PLANET_SIZE/2)};
Astriarch.Planet.prototype.GenerateResources=function(){this.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats();if(this.Owner!==null){var a=1;this.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Unrest?a=2:this.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Riots&&(a=4);this.Resources.FoodAmount+=this.ResourcesPerTurn.FoodAmountPerTurn/a;this.Resources.OreAmount+=this.ResourcesPerTurn.OreAmountPerTurn/a;this.Resources.IridiumAmount+=this.ResourcesPerTurn.IridiumAmountPerTurn/
a}};Astriarch.Planet.prototype.AddBuiltImprovement=function(a){a instanceof Astriarch.Planet.PlanetImprovement&&this.BuiltImprovements[a.Type].push(a)};
Astriarch.Planet.prototype.BuildImprovements=function(a,b){b.buildQueueEmpty=!1;var c=[];if(this.BuildQueue.length>0){var d=this.BuildQueue.slice(0,1)[0];this.ResourcesPerTurn.GetProductionDivisor();var e=this.ResourcesPerTurn.GetProductionAmountPerTurn();d.ProductionCostComplete+=e+this.RemainderProduction;this.RemainderProduction=0;if(d.ProductionCostComplete>=d.BaseProductionCost){d=this.BuildQueue.shift();d.TurnsToComplete=0;this.Owner&&this.Owner.IncreasePoints(Astriarch.Player.EarnedPointsType.PRODUCTION_UNIT_BUILT,
d.BaseProductionCost);var g="Nothing";if(this.BuildQueue.length>0){var f=this.BuildQueue.slice(0,1)[0],g=f.ToString();f.EstimateTurnsToComplete(e)}if(d instanceof Astriarch.Planet.PlanetImprovement)this.AddBuiltImprovement(d),c.push(new Astriarch.SerializableTurnEventMessage(Astriarch.TurnEventMessage.TurnEventMessageType.ImprovementBuilt,this,d.ToString()+" built on planet: "+this.Name+", next in queue: "+g));else if(d instanceof Astriarch.Planet.StarShipInProduction){e=new Astriarch.Fleet.StarShip(d.Type,
d.CustomShip,d.AdvantageAgainstType,d.DisadvantageAgainstType);if(e.Type!=Astriarch.Fleet.StarShipType.SpacePlatform)this.StarShipTypeLastBuilt=d.Type,this.StarShipCustomShipLastBuilt=d.CustomShip;if((f=this.WayPointPlanetId?a.getPlanetById(this.WayPointPlanetId):null)&&d.Type!=Astriarch.Fleet.StarShipType.SystemDefense){var h=new Astriarch.Fleet(this.Owner);h.AddShip(e);h.SetDestination(a.GameGrid,this.BoundingHex,f.BoundingHex);this.OutgoingFleets.push(h)}else this.PlanetaryFleet.AddShip(e);c.push(new Astriarch.SerializableTurnEventMessage(Astriarch.TurnEventMessage.TurnEventMessageType.ShipBuilt,
this,d.ToString()+" built on planet: "+this.Name+", next in queue: "+g))}else if(d instanceof Astriarch.Planet.PlanetImprovementToDestroy&&this.BuiltImprovements[d.TypeToDestroy].length>0){this.BuiltImprovements[d.TypeToDestroy].pop();for(c.push(new Astriarch.SerializableTurnEventMessage(Astriarch.TurnEventMessage.TurnEventMessageType.ImprovementDemolished,this,Astriarch.GameTools.PlanetImprovementTypeToFriendlyName(d.TypeToDestroy)+" demolished on planet: "+this.Name+", next in queue: "+g));this.MaxPopulation()<
this.Population.length;)this.Population.pop()}this.RemainderProduction=d.ProductionCostComplete-d.BaseProductionCost;this.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats()}else d.EstimateTurnsToComplete(e)}else b.buildQueueEmpty=!0;return c};Astriarch.Planet.prototype.GetClientPlanet=function(){return new Astriarch.ClientPlanet(this.Id,this.Name,this.OriginPoint,null,this.BoundingHex,this.Type)};
Astriarch.Planet.prototype.SetPlanetOwner=function(a){var b=0,c=null;if(a)c=a.Id;if(this.Owner!==null){this.StarShipTypeLastBuilt=this.WayPointPlanetId=null;for(var d=this.BuildQueue.length-1;d>=0;d--)b+=this.RemoveBuildQueueItemForRefund(d);this.RemainderProduction=0;this.Owner.PlanetBuildGoals[this.Id]&&delete this.Owner.PlanetBuildGoals[this.Id];delete this.Owner.OwnedPlanets[this.Id];for(var d=0,e=null,g=0;g<this.Population.length;g++)e=this.Population[g],e.LoyalToPlayerId&&e.LoyalToPlayerId==
c||Astriarch.NextRandom(0,3)==0?(e.ProtestLevel=0,e.LoyalToPlayerId=c,d++):e.ProtestLevel=Astriarch.NextRandomFloat(e.LoyalToPlayerId?0.5:0,e.LoyalToPlayerId?1:0.5);if(d==0&&this.Population.length>0)e=this.Population[0],e.ProtestLevel=0,e.LoyalToPlayerId=c;this.PlanetHappiness=Astriarch.Planet.PlanetHappinessType.Riots;a&&a.IncreasePoints(Astriarch.Player.EarnedPointsType.CITIZEN_ON_CAPTURED_PLANET,this.Population.length)}if(this.Owner=a)a.KnownClientPlanets[this.Id]=this.GetClientPlanet(),a.OwnedPlanets[this.Id]=
this;this.Population.length==0&&this.Population.push(new Astriarch.Planet.Citizen(this.Type,c));return b};Astriarch.Planet.prototype.SetPlanetExplored=function(a,b){var c=this.GetClientPlanet();c.Type=this.Type;b.KnownClientPlanets[this.Id]=c;this.SetPlayerLastKnownPlanetFleetStrength(a,b)};
Astriarch.Planet.prototype.SetPlayerLastKnownPlanetFleetStrength=function(a,b){var c=Astriarch.Fleet.StarShipFactoryHelper.GenerateFleetWithShipCount(b,this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].length,this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Scout].length,this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length,this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length,this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Battleship].length,
this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform].length,this.BoundingHex),c=new Astriarch.Fleet.LastKnownFleet(c,this.Owner);c.TurnLastExplored=a.Turn.Number;b.LastKnownPlanetFleetStrength[this.Id]=c};
Astriarch.Planet.prototype.CountPopulationWorkerTypes=function(a){workers=miners=farmers=0;var b=this.GetPopulationByContentment(),c;for(c in b.content)switch(b.content[c].WorkerType){case Astriarch.Planet.CitizenWorkerType.Farmer:farmers++;break;case Astriarch.Planet.CitizenWorkerType.Miner:miners++;break;case Astriarch.Planet.CitizenWorkerType.Worker:workers++}a.Farmers=farmers;a.Miners=miners;a.Workers=workers};
Astriarch.Planet.prototype.UpdatePopulationWorkerTypesByDiff=function(a,b,c,d,e,g){for(;d!==0;)if(d>0){if(b>0&&e<0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Miner).WorkerType=Astriarch.Planet.CitizenWorkerType.Farmer,b--,a++,d--,e++;if(d!==0&&c>0&&g<0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Worker).WorkerType=Astriarch.Planet.CitizenWorkerType.Farmer,c--,a++,d--,g++}else{if(e>0&&b<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Farmer).WorkerType=
Astriarch.Planet.CitizenWorkerType.Miner,a--,b++,d++,e--;if(d!==0&&g>0&&c<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Farmer).WorkerType=Astriarch.Planet.CitizenWorkerType.Worker,a--,c++,d++,g--}for(;e!==0;)if(e>0){if(c>0&&g<0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Worker).WorkerType=Astriarch.Planet.CitizenWorkerType.Miner,c--,b++,e--,g++}else if(g>0&&c<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Miner).WorkerType=Astriarch.Planet.CitizenWorkerType.Worker,
b--,c++,e++,g--;(d!==0||e!==0||g!==0)&&console.error("Couldn't move workers in Planet.UpdatePopulationWorkerTypesByDiff!",d,e,g);this.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats()};
Astriarch.Planet.prototype.UpdatePopulationWorkerTypes=function(a,b,c){var d=new Astriarch.Planet.PopulationAssignments;this.CountPopulationWorkerTypes(d);for(var e=d.Farmers,g=d.Miners,d=d.Workers,f=a-e;e!=a;)if(f>0){if(g>0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Miner).WorkerType=Astriarch.Planet.CitizenWorkerType.Farmer,g--,e++,f--;if(f>0&&d>0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Worker).WorkerType=Astriarch.Planet.CitizenWorkerType.Farmer,d--,e++,f--}else{if(g<
b&&g<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Farmer).WorkerType=Astriarch.Planet.CitizenWorkerType.Miner,e--,g++,f++;if(f<0&&d<c&&d<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Farmer).WorkerType=Astriarch.Planet.CitizenWorkerType.Worker,e--,d++,f++}for(f=b-g;g!=b;)if(f>0){if(d>0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Worker).WorkerType=Astriarch.Planet.CitizenWorkerType.Miner,d--,g++,f--}else if(d<c&&d<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Miner).WorkerType=
Astriarch.Planet.CitizenWorkerType.Worker,g--,d++,f++;(e!=a||g!=b||d!=c)&&console.error("Couldn't move workers in Planet.UpdatePopulationWorkerTypes! targets: ",a,b,c,"currents:",e,g,d);this.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats()};
Astriarch.Planet.prototype.getCitizenType=function(a){var b=this.GetPopulationByContentment(),c;for(c in b.content)if(b.content[c].WorkerType==a)return b.content[c];if(b.content.length>0)return console.error("Couldn't find: "+a+" in Planet.getCitizenType!"),b.content[0];else if(b.protesting.length>0){for(var d in b.protesting)if(b.protesting[d].WorkerType==a)return console.error("No content citizens found in Planet.getCitizenType! Returning protesting citizen."),b.protesting[d];console.error("Couldn't find: "+
a+" in Planet.getCitizenType for protesting citizens!");return b.protesting[0]}else return console.error("No citizens found in Planet.getCitizenType!"),null};Astriarch.Planet.PlanetPopulationImprovementCountComparerSortFunction=function(a,b){var c=b.Population.length.compareTo(a.Population.length);c==0&&(c=b.BuiltImprovementCount().compareTo(a.BuiltImprovementCount()));return c};Astriarch.Planet.PlanetFoodProductionPotentialComparerSortFunction=function(a,b){return b.ResourcesPerTurn.GetExactFoodAmountNextWorkerPerTurn().compareTo(a.ResourcesPerTurn.GetExactFoodAmountNextWorkerPerTurn())};
Astriarch.Planet.PlanetMineralProductionPotentialComparer=function(a,b){this.oreNeeded=a;this.iridiumNeeded=b};Astriarch.Planet.PlanetMineralProductionPotentialComparer.prototype.sortFunction=function(a,b){var c=0;return c=this.oreNeeded>=this.iridiumNeeded?b.ResourcesPerTurn.GetExactOreAmountNextWorkerPerTurn().compareTo(a.ResourcesPerTurn.GetExactOreAmountNextWorkerPerTurn()):b.ResourcesPerTurn.GetExactIridiumAmountNextWorkerPerTurn().compareTo(a.ResourcesPerTurn.GetExactIridiumAmountNextWorkerPerTurn())};
Astriarch.Planet.PlanetDistanceComparer=function(a,b){this.gameModel=a;this.source=b;var c=this;this.sortFunction=function(a,b){var g=0,f=0,h=0;a!=c.source&&(f=c.gameModel.GameGrid.GetHexDistance(c.source.BoundingHex,a.BoundingHex),g=1);b!=c.source&&(h=c.gameModel.GameGrid.GetHexDistance(c.source.BoundingHex,b.BoundingHex),g=-1);g!==0&&(g=f==h?0:f<h?1:-1);return g}};
Astriarch.Planet.PlanetValueDistanceStrengthComparer=function(a,b,c){this.gameModel=a;this.source=b;this.lastKnownPlanetFleetStrength=c;var d=this;this.sortFunction=function(a,b){var c=0,h=0,i=0;a!=d.source&&(h=d.gameModel.GameGrid.GetHexDistance(d.source.BoundingHex,a.BoundingHex),c=1);b!=d.source&&(i=d.gameModel.GameGrid.GetHexDistance(d.source.BoundingHex,b.BoundingHex),c=-1);c!==0&&(h=Astriarch.Planet.PlanetValueDistanceStrengthComparer.increaseDistanceBasedOnPlanetValueAndFleetStrength(d.lastKnownPlanetFleetStrength,
h,a),i=Astriarch.Planet.PlanetValueDistanceStrengthComparer.increaseDistanceBasedOnPlanetValueAndFleetStrength(d.lastKnownPlanetFleetStrength,i,b),c=h==i?0:h<i?1:-1);return c}};
Astriarch.Planet.PlanetValueDistanceStrengthComparer.increaseDistanceBasedOnPlanetValueAndFleetStrength=function(a,b,c){switch(c.Type){case Astriarch.Planet.PlanetType.AsteroidBelt:b+=3;break;case Astriarch.Planet.PlanetType.DeadPlanet:b+=2;break;case Astriarch.Planet.PlanetType.PlanetClass1:b+=1}a[c.Id]&&(a=a[c.Id].Fleet.DetermineFleetStrength(),a>=20&&a<40?b+=1:a>=40&&a<80?b+=2:a>=80&&(b+=3));return b};
Astriarch.Planet.PlanetPerTurnResourceGeneration=function(a,b){this.BaseIridiumAmountPerWorkerPerTurn=this.BaseOreAmountPerWorkerPerTurn=this.BaseFoodAmountPerWorkerPerTurn=0;this.BaseProductionPerWorkerPerTurn=2;this.ProductionAmountPerBuilderPerTurn=this.ProductionAmountPerTurn=this.IridiumAmountNextMinerPerTurn=this.IridiumAmountPerMinerPerTurn=this.IridiumAmountPerTurn=this.OreAmountNextMinerPerTurn=this.OreAmountPerMinerPerTurn=this.OreAmountPerTurn=this.FoodAmountNextFarmerPerTurn=this.FoodAmountPerFarmerPerTurn=
this.FoodAmountPerTurn=0;this.Planet=a;switch(b){case Astriarch.Planet.PlanetType.AsteroidBelt:this.BaseFoodAmountPerWorkerPerTurn=0.5;this.BaseOreAmountPerWorkerPerTurn=1.75;this.BaseIridiumAmountPerWorkerPerTurn=1;break;case Astriarch.Planet.PlanetType.DeadPlanet:this.BaseFoodAmountPerWorkerPerTurn=1;this.BaseOreAmountPerWorkerPerTurn=1.5;this.BaseIridiumAmountPerWorkerPerTurn=0.5;break;case Astriarch.Planet.PlanetType.PlanetClass1:this.BaseFoodAmountPerWorkerPerTurn=1.5;this.BaseOreAmountPerWorkerPerTurn=
0.5;this.BaseIridiumAmountPerWorkerPerTurn=0.375;break;case Astriarch.Planet.PlanetType.PlanetClass2:this.BaseFoodAmountPerWorkerPerTurn=2;this.BaseOreAmountPerWorkerPerTurn=0.25;this.BaseIridiumAmountPerWorkerPerTurn=0.125;break;default:throw new NotImplementedException("Planet type "+b+"not supported by PlanetPerTurnResourceGeneration constructor.");}this.UpdateResourcesPerTurnBasedOnPlanetStats()};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetProductionDivisor=function(){var a=1;this.Planet.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Unrest?a=4:this.Planet.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Riots&&(a=8);return a};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetResourceDivisor=function(){var a=1;this.Planet.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Unrest?a=2:this.Planet.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Riots&&(a=4);return a};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetProductionAmountPerTurn=function(){return this.ProductionAmountPerTurn/this.GetProductionDivisor()};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetFoodAmountPerTurn=function(){return this.FoodAmountPerTurn/this.GetResourceDivisor()};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetOreAmountPerTurn=function(){return this.OreAmountPerTurn/this.GetResourceDivisor()};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetIridiumAmountPerTurn=function(){return this.IridiumAmountPerTurn/this.GetResourceDivisor()};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.UpdateResourcesPerTurnBasedOnPlanetStats=function(){var a=new Astriarch.Planet.PopulationAssignments;this.Planet.CountPopulationWorkerTypes(a);this.IridiumAmountNextMinerPerTurn=this.OreAmountNextMinerPerTurn=this.FoodAmountNextFarmerPerTurn=0;if(a.Farmers<this.Planet.Population.length)this.FoodAmountNextFarmerPerTurn=this.BaseFoodAmountPerWorkerPerTurn;if(a.Miners<this.Planet.Population.length)this.OreAmountNextMinerPerTurn=this.BaseOreAmountPerWorkerPerTurn,
this.IridiumAmountNextMinerPerTurn=this.BaseIridiumAmountPerWorkerPerTurn;var b=this.BaseOreAmountPerWorkerPerTurn*a.Miners,c=this.BaseIridiumAmountPerWorkerPerTurn*a.Miners,d=this.BaseProductionPerWorkerPerTurn*a.Workers;this.FoodAmountPerTurn=this.BaseFoodAmountPerWorkerPerTurn*a.Farmers;this.OreAmountPerTurn=b;this.IridiumAmountPerTurn=c;this.ProductionAmountPerTurn=d;if(this.Planet.BuiltImprovementCount()>0){var b=this.Planet.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Farm].length,
c=this.Planet.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length,d=this.Planet.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length,e=null;if(b>0){e=this.Planet.Owner?this.Planet.Owner.Research.getResearchData(Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FARMS).percent:1;if(a.Farmers<b)this.FoodAmountNextFarmerPerTurn=this.BaseFoodAmountPerWorkerPerTurn*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*e;a.Farmers>0&&
(this.FoodAmountPerTurn+=Math.min(b,a.Farmers)*this.BaseFoodAmountPerWorkerPerTurn*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*e)}if(c>0){e=this.Planet.Owner?this.Planet.Owner.Research.getResearchData(Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_MINES).percent:1;if(a.Miners<c)this.OreAmountNextMinerPerTurn=this.BaseOreAmountPerWorkerPerTurn*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*e,this.IridiumAmountNextMinerPerTurn=
this.BaseIridiumAmountPerWorkerPerTurn*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*e;a.Miners>0&&(this.OreAmountPerTurn+=Math.min(c,a.Miners)*this.BaseOreAmountPerWorkerPerTurn*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*e,this.IridiumAmountPerTurn+=Math.min(c,a.Miners)*this.BaseIridiumAmountPerWorkerPerTurn*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*e)}d>0&&a.Workers>0&&(e=this.Planet.Owner?this.Planet.Owner.Research.getResearchData(Astriarch.Research.ResearchType.BUILDING_EFFICIENCY_IMPROVEMENT_FACTORIES).percent:
1,this.ProductionAmountPerTurn+=Math.min(d,a.Workers)*this.BaseProductionPerWorkerPerTurn*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*e)}this.FoodAmountPerFarmerPerTurn=a.Farmers?this.FoodAmountPerTurn/a.Farmers:0;this.OreAmountPerMinerPerTurn=a.Miners?this.OreAmountPerTurn/a.Miners:0;this.IridiumAmountPerMinerPerTurn=a.Miners?this.IridiumAmountPerTurn/a.Miners:0;this.ProductionAmountPerBuilderPerTurn=a.Workers?this.ProductionAmountPerTurn/a.Workers:0};
Astriarch.Planet.PlanetPerTurnResourceGeneration.Static={IMPROVEMENT_RATIO:2};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetExactFoodAmountPerWorkerPerTurn=function(){return this.FoodAmountPerFarmerPerTurn};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetExactFoodAmountNextWorkerPerTurn=function(){return this.FoodAmountNextFarmerPerTurn};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetExactOreAmountPerWorkerPerTurn=function(){return this.OreAmountPerMinerPerTurn};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetExactOreAmountNextWorkerPerTurn=function(){return this.OreAmountNextMinerPerTurn};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetExactIridiumAmountPerWorkerPerTurn=function(){return this.IridiumAmountPerMinerPerTurn};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetExactIridiumAmountNextWorkerPerTurn=function(){return this.IridiumAmountNextMinerPerTurn};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetExactProductionAmountPerWorkerPerTurn=function(){return this.ProductionAmountPerBuilderPerTurn};Astriarch.Planet.PlanetResources=function(){this.IridiumAmount=this.OreAmount=this.FoodAmount=0};Astriarch.Planet.PlanetResources.prototype.SpendFoodAsPossible=function(a){this.FoodAmount>=a?this.FoodAmount-=a:(a=this.FoodAmount,this.FoodAmount=0);return a};
Astriarch.Planet.PlanetResources.prototype.SpendOreAsPossible=function(a){this.OreAmount>=a?this.OreAmount-=a:(a=this.OreAmount,this.OreAmount=0);return a};Astriarch.Planet.PlanetResources.prototype.SpendIridiumAsPossible=function(a){this.IridiumAmount>=a?this.IridiumAmount-=a:(a=this.IridiumAmount,this.IridiumAmount=0);return a};Astriarch.Planet.ProductionResources=function(a,b,c){this.Gold=a;this.Ore=b;this.Iridium=c};
Astriarch.Planet.PopulationAssignments=function(a,b,c){this.Farmers=a;this.Miners=b;this.Workers=c};
Astriarch.Planet.PlanetProductionItem=Class.extend({init:function(){this.TurnsToComplete=99;this.BaseProductionCost=this.ProductionCostComplete=0;this.GoldCost=1;this.IridiumCost=this.OreCost=0},EstimateTurnsToComplete:function(a,b){this.TurnsToComplete=a!==0?Math.ceil((this.BaseProductionCost-this.ProductionCostComplete-(b||0))/a):999;if(this.TurnsToComplete<=0)this.TurnsToComplete=1},GetRefundAmount:function(){var a=1-this.ProductionCostComplete/(this.BaseProductionCost*1);goldRefund=this.GoldCost*
a;oreRefund=this.OreCost*a;iridiumRefund=this.IridiumCost*a;return new Astriarch.Planet.ProductionResources(goldRefund,oreRefund,iridiumRefund)}});Astriarch.Planet.PlanetImprovementToDestroy=Astriarch.Planet.PlanetProductionItem.extend({init:function(a){this._super();this.TypeToDestroy=a;this.GoldCost=0;this.BaseProductionCost=(new Astriarch.Planet.PlanetImprovement(a)).BaseProductionCost/4},ToString:function(){return"Demolish "+Astriarch.GameTools.PlanetImprovementTypeToFriendlyName(this.TypeToDestroy)}});
Astriarch.Planet.PlanetImprovement=Astriarch.Planet.PlanetProductionItem.extend({init:function(a){this._super();this.Type=a;switch(this.Type){case Astriarch.Planet.PlanetImprovementType.Colony:this.BaseProductionCost=16;this.OreCost=2;this.IridiumCost=1;this.GoldCost=3;break;case Astriarch.Planet.PlanetImprovementType.Factory:this.BaseProductionCost=32;this.OreCost=4;this.IridiumCost=2;this.GoldCost=6;break;case Astriarch.Planet.PlanetImprovementType.Farm:this.BaseProductionCost=4;this.GoldCost=1;
break;case Astriarch.Planet.PlanetImprovementType.Mine:this.BaseProductionCost=8,this.OreCost=1,this.GoldCost=2}},ToString:function(){return Astriarch.GameTools.PlanetImprovementTypeToFriendlyName(this.Type)}});
Astriarch.Planet.StarShipInProduction=Astriarch.Planet.PlanetProductionItem.extend({init:function(a,b,c,d){this._super();this.Type=a;a=new Astriarch.Fleet.StarShip(a);this.AdvantageAgainstType=a.AdvantageAgainstType;this.DisadvantageAgainstType=a.DisadvantageAgainstType;a=this.AdvantageAgainstType-(this.DisadvantageAgainstType-1);if(b)this.CustomShip=!0,this.AdvantageAgainstType=c,this.DisadvantageAgainstType=d;switch(this.Type){case Astriarch.Fleet.StarShipType.SpacePlatform:this.BaseProductionCost=
162;this.OreCost=12;this.IridiumCost=6;this.GoldCost=18;break;case Astriarch.Fleet.StarShipType.Battleship:this.BaseProductionCost=104;this.OreCost=16;this.IridiumCost=8;this.GoldCost=24;break;case Astriarch.Fleet.StarShipType.Cruiser:this.BaseProductionCost=41;this.OreCost=8;this.IridiumCost=4;this.GoldCost=12;break;case Astriarch.Fleet.StarShipType.Destroyer:this.BaseProductionCost=16;this.OreCost=4;this.IridiumCost=2;this.GoldCost=6;break;case Astriarch.Fleet.StarShipType.Scout:this.BaseProductionCost=
6;this.OreCost=2;this.IridiumCost=1;this.GoldCost=3;break;case Astriarch.Fleet.StarShipType.SystemDefense:this.BaseProductionCost=2,this.GoldCost=this.OreCost=1}this.CustomShip&&(b=Math.max(1,1+(this.AdvantageAgainstType-(this.DisadvantageAgainstType-1)-a)/10),this.BaseProductionCost*=b,this.OreCost*=b,this.GoldCost*=b)},ToString:function(){return Astriarch.GameTools.StarShipTypeToFriendlyName(this.Type)}});Astriarch.Planet.PlanetImprovementType={Factory:1,Colony:2,Farm:3,Mine:4};
Astriarch.Planet.PlanetType={AsteroidBelt:1,DeadPlanet:2,PlanetClass1:3,PlanetClass2:4};Astriarch.Planet.PlanetHappinessType={Normal:1,Unrest:2,Riots:3};Astriarch.Planet.CitizenWorkerType={Farmer:1,Miner:2,Worker:3};Astriarch.Planet.Citizen=function(a,b){this.PopulationChange=0;this.LoyalToPlayerId=b;this.ProtestLevel=0;this.WorkerType=Astriarch.Planet.CitizenWorkerType.Farmer;if(a==Astriarch.Planet.PlanetType.AsteroidBelt||a==Astriarch.Planet.PlanetType.DeadPlanet)this.WorkerType=Astriarch.Planet.CitizenWorkerType.Miner};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.Fleet=function(a){this.StarShips={};this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]=[];this.StarShips[Astriarch.Fleet.StarShipType.Scout]=[];this.StarShips[Astriarch.Fleet.StarShipType.Destroyer]=[];this.StarShips[Astriarch.Fleet.StarShipType.Cruiser]=[];this.StarShips[Astriarch.Fleet.StarShipType.Battleship]=[];this.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform]=[];this.DestinationHex=this.travelingFromHex=this.LocationHex=null;this.ParsecsToDestination=this.totalTravelDistance=
0;this.DrawnFleet=this.OnFleetMergedOrDestroyed=this.OnFleetMoved=null;this.Owner=a};
Astriarch.Fleet.Static={SPACE_PLATFORM_STRENGTH:64,getStrengthDetailsForShips:function(a){for(var b={strength:0,maxStrength:0,health:0,percentHealth:0,color:null,percentHealthText:"",damageText:""},c=0;c<a.length;c++){var d=a[c];b.strength+=d.Strength();b.maxStrength+=d.MaxStrength();b.health+=d.Health}b.percentHealth=b.maxStrength==0?1:b.health/b.maxStrength;c=b.percentHealth?(b.percentHealth*100).toFixed(1):0;b.percentHealthText=a.length==0?"":c+"%";b.damageText=b.strength+"/"+b.maxStrength;b.color=
b.percentHealth==1?"green":b.percentHealth>0.75?"yellow":b.percentHealth>0.5?"orange":"red";return b}};Astriarch.Fleet.prototype.SetDestination=function(a,b,c,d,e){this.DestinationHex=c;this.travelingFromHex=b;this.totalTravelDistance=e;if(!this.totalTravelDistance)this.totalTravelDistance=a.GetHexDistance(this.travelingFromHex,this.DestinationHex);this.ParsecsToDestination=this.totalTravelDistance;if(d)this.ParsecsToDestination=d};
Astriarch.Fleet.prototype.CreateDrawnFleetAndSetDestination=function(a,b,c,d,e){this.SetDestination(a,b,c,d,e);this.CreateDrawnFleet()};Astriarch.Fleet.prototype.CreateDrawnFleet=function(){this.DrawnFleet=new Astriarch.DrawnFleet(this);Astriarch.View.DrawnFleets.push(this.DrawnFleet);Astriarch.View.CanvasFleetsLayer.addChild(this.DrawnFleet);this.DrawnFleet.updateTravelLine()};
Astriarch.Fleet.prototype.GetSpeed=function(){return this.Owner?this.Owner.Research.getResearchData(Astriarch.Research.ResearchType.PROPULSION_IMPROVEMENT).percent:1};Astriarch.Fleet.prototype.GetTurnsToDestination=function(){return this.ParsecsToDestination/this.GetSpeed()};Astriarch.Fleet.prototype.MoveFleet=function(){this.LocationHex=null;this.ParsecsToDestination-=this.GetSpeed();this.DrawnFleet&&this.DrawnFleet.updateTravelLine();this.OnFleetMoved!=null&&this.OnFleetMoved(this)};
Astriarch.Fleet.prototype.LandFleet=function(a,b){a.travelingFromHex=null;a.DestinationHex=null;a.ParsecsToDestination=0;this.LocationHex=b;this.MergeFleet(a)};
Astriarch.Fleet.prototype.MergeFleet=function(a){this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]=this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].concat(a.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]);this.StarShips[Astriarch.Fleet.StarShipType.Scout]=this.StarShips[Astriarch.Fleet.StarShipType.Scout].concat(a.StarShips[Astriarch.Fleet.StarShipType.Scout]);this.StarShips[Astriarch.Fleet.StarShipType.Destroyer]=this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].concat(a.StarShips[Astriarch.Fleet.StarShipType.Destroyer]);
this.StarShips[Astriarch.Fleet.StarShipType.Cruiser]=this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].concat(a.StarShips[Astriarch.Fleet.StarShipType.Cruiser]);this.StarShips[Astriarch.Fleet.StarShipType.Battleship]=this.StarShips[Astriarch.Fleet.StarShipType.Battleship].concat(a.StarShips[Astriarch.Fleet.StarShipType.Battleship]);this.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform]=this.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform].concat(a.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform]);
a.SendFleetMergedOrDestroyed()};
Astriarch.Fleet.prototype.GetAllStarShips=function(a){var b=[];a||(b=b.concat(this.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform]));b=b.concat(this.StarShips[Astriarch.Fleet.StarShipType.Battleship]);b=b.concat(this.StarShips[Astriarch.Fleet.StarShipType.Cruiser]);b=b.concat(this.StarShips[Astriarch.Fleet.StarShipType.Destroyer]);b=b.concat(this.StarShips[Astriarch.Fleet.StarShipType.Scout]);a||(b=b.concat(this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]));return b};
Astriarch.Fleet.prototype.SendFleetMergedOrDestroyed=function(){this.OnFleetMergedOrDestroyed!=null&&this.OnFleetMergedOrDestroyed(this)};Astriarch.Fleet.prototype.ReduceFleet=function(){for(var a in this.StarShips)for(var b=this.StarShips[a],c=b.length-1;c>=0;c--)b[c].Strength()<=0&&b.splice(c,1)};Astriarch.Fleet.prototype.DetermineFleetStrength=function(a){var b=0,a=this.GetAllStarShips(a),c;for(c in a)b+=a[c].Strength();return b};
Astriarch.Fleet.prototype.SplitFleet=function(a,b,c,d){var e=new Astriarch.Fleet(this.Owner);e.LocationHex=this.LocationHex;if(a>this.StarShips[Astriarch.Fleet.StarShipType.Scout].length||b>this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length||c>this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length||d>this.StarShips[Astriarch.Fleet.StarShipType.Battleship].length)console.error("Cannot send more ships than in the fleet!",a,b,c,d,this.StarShips),a=Math.min(a,this.StarShips[Astriarch.Fleet.StarShipType.Scout].length),
b=Math.min(b,this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length),c=Math.min(c,this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length),d=Math.min(d,this.StarShips[Astriarch.Fleet.StarShipType.Battleship].length);for(var g=0;g<a;g++)e.StarShips[Astriarch.Fleet.StarShipType.Scout].push(this.StarShips[Astriarch.Fleet.StarShipType.Scout][0]),this.StarShips[Astriarch.Fleet.StarShipType.Scout].shift();for(g=0;g<b;g++)e.StarShips[Astriarch.Fleet.StarShipType.Destroyer].push(this.StarShips[Astriarch.Fleet.StarShipType.Destroyer][0]),
this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].shift();for(g=0;g<c;g++)e.StarShips[Astriarch.Fleet.StarShipType.Cruiser].push(this.StarShips[Astriarch.Fleet.StarShipType.Cruiser][0]),this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].shift();for(g=0;g<d;g++)e.StarShips[Astriarch.Fleet.StarShipType.Battleship].push(this.StarShips[Astriarch.Fleet.StarShipType.Battleship][0]),this.StarShips[Astriarch.Fleet.StarShipType.Battleship].shift();return e};
Astriarch.Fleet.prototype.SplitFleetWithShipIds=function(a,b,c,d){var e=new Astriarch.Fleet(this.Owner);e.LocationHex=this.LocationHex;var g=function(a,b,c,d){for(var a=a.StarShips[c],e=0;e<d.length;e++)for(var g=a.length-1;g>=0;g--)if(a[g].id==d[e]){b.StarShips[c].push(a[g]);a.splice(g,1);break}};g(this,e,Astriarch.Fleet.StarShipType.Scout,a);g(this,e,Astriarch.Fleet.StarShipType.Destroyer,b);g(this,e,Astriarch.Fleet.StarShipType.Cruiser,c);g(this,e,Astriarch.Fleet.StarShipType.Battleship,d);return e};
Astriarch.Fleet.prototype.SplitOffSmallestPossibleFleet=function(){var a=null,b=0,c=0,d=0,e=0;this.StarShips[Astriarch.Fleet.StarShipType.Scout].length!=0?b=1:this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length!=0?c=1:this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length!=0?d=1:this.StarShips[Astriarch.Fleet.StarShipType.Battleship].length!=0&&(e=1);if(b!=0||c!=0||d!=0||e!=0)a=this.SplitFleet(b,c,d,e);return a};Astriarch.Fleet.prototype.GetPlanetaryFleetMobileStarshipCount=function(){return this.GetAllStarShips(!0).length};
Astriarch.Fleet.prototype.CloneFleet=function(){var a=new Astriarch.Fleet(this.Owner);a.LocationHex=this.LocationHex;for(var b in this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense])a.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].push(this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense][b].CloneStarShip());for(b in this.StarShips[Astriarch.Fleet.StarShipType.Scout])a.StarShips[Astriarch.Fleet.StarShipType.Scout].push(this.StarShips[Astriarch.Fleet.StarShipType.Scout][b].CloneStarShip());
for(b in this.StarShips[Astriarch.Fleet.StarShipType.Destroyer])a.StarShips[Astriarch.Fleet.StarShipType.Destroyer].push(this.StarShips[Astriarch.Fleet.StarShipType.Destroyer][b].CloneStarShip());for(b in this.StarShips[Astriarch.Fleet.StarShipType.Cruiser])a.StarShips[Astriarch.Fleet.StarShipType.Cruiser].push(this.StarShips[Astriarch.Fleet.StarShipType.Cruiser][b].CloneStarShip());for(b in this.StarShips[Astriarch.Fleet.StarShipType.Battleship])a.StarShips[Astriarch.Fleet.StarShipType.Battleship].push(this.StarShips[Astriarch.Fleet.StarShipType.Battleship][b].CloneStarShip());
for(b in this.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform])a.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform].push(this.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform][b].CloneStarShip());return a};Astriarch.Fleet.prototype.AddShip=function(a){this.StarShips[a.Type].push(a)};
Astriarch.Fleet.prototype.RepairFleet=function(a){var b=0,c=0,d=[];this.LocationHex.PlanetContainedInHex.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length>0&&(d=d.concat(this.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform]),this.LocationHex.PlanetContainedInHex.GetSpacePlatformCount()>0&&(d=d.concat(this.StarShips[Astriarch.Fleet.StarShipType.Battleship]),d=d.concat(this.StarShips[Astriarch.Fleet.StarShipType.Cruiser])),d=d.concat(this.StarShips[Astriarch.Fleet.StarShipType.Destroyer]));
var d=d.concat(this.StarShips[Astriarch.Fleet.StarShipType.Scout]),d=d.concat(this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]),e;for(e in d)if(c=d[e].RepairStarShip(a),b+=c,a-=c,a<=0)break;return b};
Astriarch.Fleet.prototype.CountShipsByType=function(){var a=this,b=function(b){for(var c=null,g={count:a.StarShips[b].length,standard:0,custom:0},c=0;c<g.count;c++)a.StarShips[b][c].CustomShip?g.custom++:g.standard++;return g},c={};c[Astriarch.Fleet.StarShipType.SystemDefense]=b(Astriarch.Fleet.StarShipType.SystemDefense);c[Astriarch.Fleet.StarShipType.Scout]=b(Astriarch.Fleet.StarShipType.Scout);c[Astriarch.Fleet.StarShipType.Destroyer]=b(Astriarch.Fleet.StarShipType.Destroyer);c[Astriarch.Fleet.StarShipType.Cruiser]=
b(Astriarch.Fleet.StarShipType.Cruiser);c[Astriarch.Fleet.StarShipType.Battleship]=b(Astriarch.Fleet.StarShipType.Battleship);c[Astriarch.Fleet.StarShipType.SpacePlatform]=b(Astriarch.Fleet.StarShipType.SpacePlatform);return c};
Astriarch.Fleet.prototype.ToString=function(){var a="",b=this.CountShipsByType(),c=function(c){var e=b[c];e.standard>0&&(a!=""&&(a+=", "),a+=e.standard+" "+Astriarch.GameTools.StarShipTypeToFriendlyName(c)+(e.standard>1?"s":""));e.custom>0&&(a!=""&&(a+=", "),a+=e.custom+" Custom "+Astriarch.GameTools.StarShipTypeToFriendlyName(c)+(e.custom>1?"s":""))};c(Astriarch.Fleet.StarShipType.SystemDefense);c(Astriarch.Fleet.StarShipType.Scout);c(Astriarch.Fleet.StarShipType.Destroyer);c(Astriarch.Fleet.StarShipType.Cruiser);
c(Astriarch.Fleet.StarShipType.Battleship);c(Astriarch.Fleet.StarShipType.SpacePlatform);a==""&&(a="No Ships");return a};Astriarch.Fleet.LastKnownFleet=function(a,b){this.TurnLastExplored=0;this.Fleet=a;this.LastKnownOwner=b};
Astriarch.Fleet.StarShip=function(a,b,c,d){this.id=Astriarch.Fleet.StarShip.Static.NEXT_STARSHIP_ID++;this.Type=a;this.CustomShip=!1;this.DisadvantageAgainstType=this.AdvantageAgainstType=null;this.BaseStarShipStrength=0;switch(this.Type){case Astriarch.Fleet.StarShipType.SystemDefense:this.BaseStarShipStrength=2;this.AdvantageAgainstType=Astriarch.Fleet.StarShipType.Battleship;this.DisadvantageAgainstType=Astriarch.Fleet.StarShipType.Scout;break;case Astriarch.Fleet.StarShipType.Scout:this.BaseStarShipStrength=
4;this.AdvantageAgainstType=Astriarch.Fleet.StarShipType.SystemDefense;this.DisadvantageAgainstType=Astriarch.Fleet.StarShipType.Destroyer;break;case Astriarch.Fleet.StarShipType.Destroyer:this.BaseStarShipStrength=8;this.AdvantageAgainstType=Astriarch.Fleet.StarShipType.Scout;this.DisadvantageAgainstType=Astriarch.Fleet.StarShipType.Cruiser;break;case Astriarch.Fleet.StarShipType.Cruiser:this.BaseStarShipStrength=16;this.AdvantageAgainstType=Astriarch.Fleet.StarShipType.Destroyer;this.DisadvantageAgainstType=
Astriarch.Fleet.StarShipType.Battleship;break;case Astriarch.Fleet.StarShipType.Battleship:this.BaseStarShipStrength=32;this.AdvantageAgainstType=Astriarch.Fleet.StarShipType.Cruiser;this.DisadvantageAgainstType=Astriarch.Fleet.StarShipType.SystemDefense;break;case Astriarch.Fleet.StarShipType.SpacePlatform:this.BaseStarShipStrength=64}this.Health=this.BaseStarShipStrength;this.ExperienceAmount=0;if(b)this.CustomShip=!0,this.AdvantageAgainstType=c,this.DisadvantageAgainstType=d};
Astriarch.Fleet.StarShip.Static={NEXT_STARSHIP_ID:1};Astriarch.Fleet.StarShip.prototype.Strength=function(){return this.Health};Astriarch.Fleet.StarShip.prototype.MaxStrength=function(){return this.BaseStarShipStrength+this.StrengthBoostFromLevel()};Astriarch.Fleet.StarShip.prototype.StrengthBoostFromLevel=function(){var a=this.Level().level;if(a<=2)return a*(this.BaseStarShipStrength/4);return Math.round(Math.log(a)/Math.log(Math.pow(9,1/(this.BaseStarShipStrength*2))))};
Astriarch.Fleet.StarShip.prototype.Level=function(){for(var a=-1,b=this.BaseStarShipStrength/2,c=!1;!c;)this.ExperienceAmount<b&&(c=!0),b+=b+Math.round(b/2),a++;return{level:a,nextLevelExpRequirement:b}};Astriarch.Fleet.StarShip.prototype.CloneStarShip=function(){var a=new Astriarch.Fleet.StarShip(this.Type,this.CustomShip,this.AdvantageAgainstType,this.DisadvantageAgainstType);a.Health=this.Health;a.ExperienceAmount=this.ExperienceAmount;return a};
Astriarch.Fleet.StarShip.prototype.RepairStarShip=function(a){var b=this.MaxStrength()-this.Health,a=Math.min(a,b);this.Health+=a;return a};Astriarch.Fleet.StarShipAdvantageStrengthComparer=function(a,b){this.ship=a;this.fleetDamagePending=b;var c=this;this.sortFunction=function(a,b){var g=0,g=c.getStarShipAdvantageDisadvantageAdjustedStrength(a),f=c.getStarShipAdvantageDisadvantageAdjustedStrength(b);return g==f?0:g<f?-1:1}};
Astriarch.Fleet.StarShipAdvantageStrengthComparer.prototype.getStarShipAdvantageDisadvantageAdjustedStrength=function(a){var b=a.Strength();this.fleetDamagePending[a]&&(b-=this.fleetDamagePending[a]);b*=Astriarch.BattleSimulator.StarshipHasAdvantage(this.ship,a)?1:Astriarch.BattleSimulator.StarshipHasDisadvantage(this.ship,a)?1E4:100;return b};
Astriarch.Fleet.StarShipFactoryHelper={GenerateShips:function(a,b,c,d){a=new Astriarch.Fleet(a);a.LocationHex=d;for(d=0;d<c;d++)a.StarShips[b].push(new Astriarch.Fleet.StarShip(b));return a},GenerateFleetWithShipCount:function(a,b,c,d,e,g,f,h){a=new Astriarch.Fleet(a);a.LocationHex=h;for(h=0;h<b;h++)a.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].push(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.SystemDefense));for(h=0;h<c;h++)a.StarShips[Astriarch.Fleet.StarShipType.Scout].push(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Scout));
for(h=0;h<d;h++)a.StarShips[Astriarch.Fleet.StarShipType.Destroyer].push(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Destroyer));for(h=0;h<e;h++)a.StarShips[Astriarch.Fleet.StarShipType.Cruiser].push(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Cruiser));for(h=0;h<g;h++)a.StarShips[Astriarch.Fleet.StarShipType.Battleship].push(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Battleship));for(h=0;h<f;h++)a.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform].push(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.SpacePlatform));
return a}};Astriarch.Fleet.StarShipType={SystemDefense:1,Scout:2,Destroyer:3,Cruiser:4,Battleship:5,SpacePlatform:6};Astriarch=Astriarch||require("./astriarch_base");Astriarch.TurnEventMessage=function(a,b,c){this.Type=a;this.Planet=b;this.Message=c;this.Data=null};Astriarch.TurnEventMessage.TurnEventMessageComparerSortFunction=function(a,b){if(a.Type>b.Type)return-1;else if(a.Type<b.Type)return 1;return 0};
Astriarch.TurnEventMessage.TurnEventMessageType={ResourcesAutoSpent:0,PopulationGrowth:1,TradesExecuted:2,TradesNotExecuted:3,ImprovementBuilt:4,ShipBuilt:5,ImprovementDemolished:6,BuildQueueEmpty:7,ResearchComplete:8,ResearchQueueEmpty:9,ResearchStolen:10,CitizensProtesting:11,InsufficientFood:12,DefendedAgainstAttackingFleet:13,AttackingFleetLost:14,PlanetCaptured:15,PopulationStarvation:16,FoodShortageRiots:17,PlanetLostDueToStarvation:18,PlanetLost:19};
Astriarch.TurnEventMessage.PlanetaryConflictData=function(a,b,c,d){this.DefendingPlayer=a;this.DefendingFleet=b.CloneFleet();this.AttackingPlayer=c;this.AttackingFleet=d.CloneFleet();this.WinningFleet=null;this.ResearchAmountLooted=this.FoodAmountLooted=this.IridiumAmountLooted=this.OreAmountLooted=this.GoldAmountLooted=this.AttackingFleetChances=0};
Astriarch.SerializableTurnEventMessage=function(a,b,c){this.Type=a;this.SerializableClientPlanet=null;if(b)this.SerializableClientPlanet=new Astriarch.SerializableClientPlanet(b.Id,b.Name,b.OriginPoint);this.Message=c;this.Data=null};
Astriarch.TurnEventMessage.SerializablePlanetaryConflictData=function(a){this.DefendingSerializableClientPlayer=null;if(a.DefendingPlayer)this.DefendingSerializableClientPlayer=new Astriarch.SerializableClientPlayer(a.DefendingPlayer.Id,a.DefendingPlayer.Type,a.DefendingPlayer.Name,a.DefendingPlayer.Color,a.DefendingPlayer.Points,a.DefendingPlayer.CurrentTurnEnded,a.DefendingPlayer.Destroyed,a.DefendingPlayer.Research);this.DefendingSerializableFleet=new Astriarch.SerializableFleet(a.DefendingFleet,
!1);this.AttackingSerializableClientPlayer=new Astriarch.SerializableClientPlayer(a.AttackingPlayer.Id,a.AttackingPlayer.Type,a.AttackingPlayer.Name,a.AttackingPlayer.Color,a.AttackingPlayer.Points,a.AttackingPlayer.CurrentTurnEnded,a.AttackingPlayer.Destroyed,a.AttackingPlayer.Research);this.AttackingSerializableFleet=new Astriarch.SerializableFleet(a.AttackingFleet,!1);this.WinningSerializableFleet=null;if(a.WinningFleet)this.WinningSerializableFleet=new Astriarch.SerializableFleet(a.WinningFleet,
!1);this.AttackingFleetResearchBoostAttack=a.AttackingFleetResearchBoostAttack;this.AttackingFleetResearchBoostDefense=a.AttackingFleetResearchBoostDefense;this.DefendingFleetResearchBoostAttack=a.DefendingFleetResearchBoostAttack;this.DefendingFleetResearchBoostDefense=a.DefendingFleetResearchBoostDefense;this.AttackingFleetChances=a.AttackingFleetChances;this.GoldAmountLooted=a.GoldAmountLooted;this.OreAmountLooted=a.OreAmountLooted;this.IridiumAmountLooted=a.IridiumAmountLooted;this.FoodAmountLooted=
a.FoodAmountLooted;this.ResearchAmountLooted=a.ResearchAmountLooted};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.BattleSimulator={STARSHIP_WEAPON_POWER:2,STARSHIP_WEAPON_POWER_HALF:1,SimulateFleetBattle:function(a,b){var c=null,d={attack:0,defense:0},e={attack:0,defense:0},g={},f={},h={};if(a.Owner)d.attack=a.Owner.Research.getResearchData(Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_ATTACK).chance,d.defense=a.Owner.Research.getResearchData(Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_DEFENSE).chance;if(b.Owner)e.attack=b.Owner.Research.getResearchData(Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_ATTACK).chance,e.defense=
b.Owner.Research.getResearchData(Astriarch.Research.ResearchType.COMBAT_IMPROVEMENT_DEFENSE).chance;for(;a.DetermineFleetStrength()>0&&b.DetermineFleetStrength()>0;){var i=a.GetAllStarShips(),j=b.GetAllStarShips(),k;for(k in i){var l=i[k];h[l.id]||(h[l.id]=0);h[l.id]+=Astriarch.BattleSimulator.StarshipFireWeapons(d.attack,e.defense,l,j,f)}for(k in j)l=j[k],h[l.id]||(h[l.id]=0),h[l.id]+=Astriarch.BattleSimulator.StarshipFireWeapons(e.attack,d.defense,l,i,g);for(k in g)i=g[k],i.Starship.Health-=i.Damage,
b.Owner&&b.Owner.IncreasePoints(Astriarch.Player.EarnedPointsType.DAMAGED_STARSHIP_STRENGTH,i.Damage);g={};for(k in f)i=f[k],i.Starship.Health-=i.Damage,a.Owner&&a.Owner.IncreasePoints(Astriarch.Player.EarnedPointsType.DAMAGED_STARSHIP_STRENGTH,i.Damage);f={};a.ReduceFleet();b.ReduceFleet()}a.DetermineFleetStrength()>0?(c=!0,a.GetAllStarShips().forEach(function(a){h[a.id]&&(a.ExperienceAmount+=h[a.id])})):b.DetermineFleetStrength()>0&&(c=!1,b.GetAllStarShips().forEach(function(a){h[a.id]&&(a.ExperienceAmount+=
h[a.id])}));return c},StarshipFireWeapons:function(a,b,c,d,e){var g=0,f=0,f=0,h=[],h=h.concat(d),d=new Astriarch.Fleet.StarShipAdvantageStrengthComparer(c,e);h.sort(d.sortFunction);for(d=0;d<c.Strength();d+=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER){for(f=h.length-1;f>=0;f--){var i=h[f],j={Starship:i,Damage:0};e[i.id]&&(j=e[i.id]);h[f].Strength()-j.Damage<=0&&h.splice(f,1)}f=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER;a&&Math.random()<a&&(f+=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER_HALF);
b&&Math.random()<b&&(f-=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER_HALF);h.length>0&&(i=h[0],Astriarch.BattleSimulator.StarshipHasAdvantage(c,i)?f+=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER_HALF:Astriarch.BattleSimulator.StarshipHasDisadvantage(c,i)&&(f-=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER_HALF),f=Astriarch.NextRandom(0,f+1),g+=f,f!=0&&(e[i.id]||(e[i.id]={Starship:i,Damage:0}),e[i.id].Damage+=f))}return g},StarshipHasAdvantage:function(a,b){if(a.Type==Astriarch.Fleet.StarShipType.SpacePlatform)return!0;
else if(b.Type!=Astriarch.Fleet.StarShipType.SpacePlatform&&a.AdvantageAgainstType==b.Type)return!0;return!1},StarshipHasDisadvantage:function(a,b){if(a.Type!=Astriarch.Fleet.StarShipType.SpacePlatform)if(b.Type==Astriarch.Fleet.StarShipType.SpacePlatform)return!0;else if(a.DisadvantageAgainstType==b.Type)return!0;return!1}};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.AI={OnComputerSentFleet:function(a){console.debug("Computer Sent Fleet:",a.ToString(),"From:",a.travelingFromHex.PlanetContainedInHex.Name,"To:",a.DestinationHex.PlanetContainedInHex.Name)},ComputerTakeTurn:function(a,b){var c=b.GetOwnedPlanetsListSorted();Astriarch.AI.computerSetPlanetBuildGoals(a,b,c);Astriarch.AI.computerSubmitTrades(a,b,c);Astriarch.AI.computerBuildImprovementsAndShips(a,b,c);Astriarch.AI.computerAdjustPopulationAssignments(b);Astriarch.AI.computerSendShips(a,b,c)},
computerAdjustPopulationAssignments:function(a){var b={},c={},d={},e=[],g;for(g in a.OwnedPlanets){var f=a.OwnedPlanets[g],h=new Astriarch.Planet.PopulationAssignments;f.CountPopulationWorkerTypes(h);b[f.Id]=h.Farmers;c[f.Id]=h.Miners;d[f.Id]=h.Workers;e.push(f);console.debug(a.Name,"Population Assignment for planet:",f.Name,h);f.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats()}var i=a.GetTotalPopulation(),j=0,k=0,h=0;for(g in a.OwnedPlanets)f=a.OwnedPlanets[g],k+=f.Resources.FoodAmount,
j+=f.ResourcesPerTurn.GetFoodAmountPerTurn(),f.Population.length<f.MaxPopulation()&&h++;k-=i;k-=h;h=f=0;switch(a.Type){case Astriarch.Player.PlayerType.Computer_Easy:f-=i*3;h=Math.floor(i*1.5);break;case Astriarch.Player.PlayerType.Computer_Normal:f-=Math.floor(i*1.5);h=i;break;case Astriarch.Player.PlayerType.Computer_Hard:f-=i/2,h=0}f=Astriarch.NextRandom(f,h+1);k+=f;var l=h=0;for(g in a.OwnedPlanets)f=a.OwnedPlanets[g],f.Id in a.PlanetBuildGoals&&(f=a.PlanetBuildGoals[f.Id],h+=f.OreCost,l+=f.IridiumCost);
f=1;switch(a.Type){case Astriarch.Player.PlayerType.Computer_Easy:f=Astriarch.NextRandom(20,41)/10;break;case Astriarch.Player.PlayerType.Computer_Normal:f=Astriarch.NextRandom(10,21)/10}var h=Math.round(h*f)-a.TotalOreAmount(),l=Math.round(l*f)-a.TotalIridiumAmount(),m=0;console.debug(a.Name,"Mineral Needs:",h,l);if(i>j+k){m=i-(j+k);console.debug(a.Name,"potential food shortage:",m);e.sort(Astriarch.Planet.PlanetFoodProductionPotentialComparerSortFunction);a=m;i=[];if(a>0)for(g in e)if(f=e[g],a>
0&&f.ResourcesPerTurn.GetExactFoodAmountNextWorkerPerTurn()>0&&(c[f.Id]>0||d[f.Id]>0))if(i.push(f),a-=f.ResourcesPerTurn.GetExactFoodAmountNextWorkerPerTurn(),a<=0)break;for(;m>0;){a=!1;for(g in i)if(f=i[g],j=d[f.Id],f.Type==Astriarch.Planet.PlanetType.PlanetClass2&&(j=f.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length==0?0:1),c[f.Id]>=j&&c[f.Id]>0?(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],1,-1,0),b[f.Id]++,c[f.Id]--,m-=f.ResourcesPerTurn.GetExactFoodAmountNextWorkerPerTurn(),
a=!0):d[f.Id]>0&&(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],1,0,-1),b[f.Id]++,d[f.Id]--,m-=f.ResourcesPerTurn.GetExactFoodAmountNextWorkerPerTurn(),a=!0),m<=0)break;if(!a)break}}else{m=j+k-i;console.debug(a.Name,"potential food surplus:",m);e.sort(Astriarch.Planet.PlanetFoodProductionPotentialComparerSortFunction);e.reverse();a=m;i=[];if(a>0)for(g in e)if(f=e[g],a>0&&a>f.ResourcesPerTurn.GetExactFoodAmountPerWorkerPerTurn()&&b[f.Id]>0&&(i.push(f),a-=f.ResourcesPerTurn.GetExactFoodAmountPerWorkerPerTurn(),
a<=0))break;for(;m>0;){a=!1;for(g in i)if(f=i[g],!(m<f.ResourcesPerTurn.GetExactFoodAmountPerWorkerPerTurn())&&((f.Type!=Astriarch.Planet.PlanetType.PlanetClass2||f.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length>0)&&(h>0||l>0)&&b[f.Id]>0?(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],-1,1,0),b[f.Id]--,c[f.Id]++,h-=f.ResourcesPerTurn.GetExactOreAmountNextWorkerPerTurn(),l-=f.ResourcesPerTurn.GetExactIridiumAmountNextWorkerPerTurn(),m-=f.ResourcesPerTurn.GetExactFoodAmountPerWorkerPerTurn(),
a=!0):b[f.Id]>0&&(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],-1,0,1),b[f.Id]--,d[f.Id]++,m-=f.ResourcesPerTurn.GetExactFoodAmountPerWorkerPerTurn(),a=!0),m<=0))break;if(!a)break}}a=h*1;i=l*1;if(h>0||l>0){j=[];f=new Astriarch.Planet.PlanetMineralProductionPotentialComparer(h,l);e.sort(f.sortFunction);for(g in e){if(a<0&&i<0)break;f=e[g];k=0;m=-1;f.Type==Astriarch.Planet.PlanetType.PlanetClass2&&(k=f.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length==0?2:1,m=0);
d[f.Id]>k&&b[f.Id]>m&&(j.push(f),a-=f.ResourcesPerTurn.GetExactOreAmountNextWorkerPerTurn(),i-=f.ResourcesPerTurn.GetExactIridiumAmountNextWorkerPerTurn())}for(;h>0||l>0;){a=!1;for(g in j)if(f=j[g],k=1,f.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length==0&&(k=2),d[f.Id]>k&&(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],0,1,-1),c[f.Id]++,d[f.Id]--,h-=f.ResourcesPerTurn.GetExactOreAmountNextWorkerPerTurn(),l-=f.ResourcesPerTurn.GetExactIridiumAmountNextWorkerPerTurn(),
a=!0),h<=0&&l<=0)break;if(!a)break}}else{j=[];f=new Astriarch.Planet.PlanetMineralProductionPotentialComparer(h,l);e.sort(f.sortFunction);e.reverse();for(g in e){if(a>0||i>0)break;f=e[g];c[f.Id]>0&&(j.push(f),a+=f.ResourcesPerTurn.GetExactOreAmountPerWorkerPerTurn(),i+=f.ResourcesPerTurn.GetExactIridiumAmountPerWorkerPerTurn())}for(;h<0&&l<0;){a=!1;for(g in j)if(f=j[g],c[f.Id]>0&&h+f.ResourcesPerTurn.GetExactOreAmountPerWorkerPerTurn()<0&&l+f.ResourcesPerTurn.GetExactIridiumAmountPerWorkerPerTurn()<
0&&(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],0,-1,1),c[f.Id]--,d[f.Id]++,h+=f.ResourcesPerTurn.GetExactOreAmountPerWorkerPerTurn(),l+=f.ResourcesPerTurn.GetExactIridiumAmountPerWorkerPerTurn(),a=!0),h>0||l>0)break;if(!a)break}}},computerSetPlanetBuildGoals:function(a,b,c){var d=[],e=[],g=[],f=Astriarch.AI.countPlanetsNeedingExploration(a,b),h;for(h in c){var i=c[h];b.PlanetBuildGoals[i.Id]||(i.BuildQueue.length&&console.debug(b.Name,"build queue on:",i.Name,i.BuildQueue[0]),i.BuildQueue.length<=
1&&(d.push(i),c.length>1?i.GetSpacePlatformCount()<b.Research.getMaxSpacePlatformCount()&&i.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length>0?e.push(i):g.push(i):f!=0?g.push(i):i.GetSpacePlatformCount()<b.Research.getMaxSpacePlatformCount()&&i.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length>0?e.push(i):g.push(i)))}for(h in e)i=e[h],i.GetSpacePlatformCount(!0)<=b.Research.getMaxSpacePlatformCount()&&(b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.SpacePlatform));
for(h in d){var i=d[h],j=e=0,k=1,l=i.BuiltAndBuildQueueImprovementTypeCount(Astriarch.Planet.PlanetImprovementType.Farm),m=i.BuiltAndBuildQueueImprovementTypeCount(Astriarch.Planet.PlanetImprovementType.Mine),o=i.BuiltAndBuildQueueImprovementTypeCount(Astriarch.Planet.PlanetImprovementType.Factory),n=i.BuiltAndBuildQueueImprovementTypeCount(Astriarch.Planet.PlanetImprovementType.Colony),p=2;i.Type==Astriarch.Planet.PlanetType.PlanetClass2?c.length==1?(e=3,j=p):(e=4,j=0):i.Type==Astriarch.Planet.PlanetType.PlanetClass1?
e=2:i.Type==Astriarch.Planet.PlanetType.DeadPlanet?j=1:i.Type==Astriarch.Planet.PlanetType.AsteroidBelt&&(j=2);k=i.MaxImprovements-j-e-1;l<e?b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Farm):m<j?b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Mine):o==0&&k>0?b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Factory):n<1?b.PlanetBuildGoals[i.Id]=
new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Colony):o<k?b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Factory):l>e?b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.PlanetImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Farm):m>j?b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.PlanetImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Mine):o>k?b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.PlanetImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Factory):
n>1&&(b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.PlanetImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Colony));b.PlanetBuildGoals[i.Id]&&console.debug(b.Name,"Planet:",i.Name,"Improvement Build Goal:",b.PlanetBuildGoals[i.Id],Astriarch.GameTools.PlanetImprovementTypeToFriendlyName(b.PlanetBuildGoals[i.Id].Type))}for(h in g)if(i=g[h],!b.PlanetBuildGoals[i.Id]||!((c.length>3||c.length==1)&&m!=p))e=d=!1,b.Type==Astriarch.Player.PlayerType.Computer_Easy?(d=Astriarch.NextRandom(0,4)<=1,
e=!d&&Astriarch.NextRandom(0,4)<=1):b.Type==Astriarch.Player.PlayerType.Computer_Normal&&(d=Astriarch.NextRandom(0,4)==0,e=!d&&Astriarch.NextRandom(0,4)==0),i.GetSpacePlatformCount()>0&&!d?(d=Astriarch.NextRandom(4),b.PlanetBuildGoals[i.Id]=d<2?d%2==0?new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Battleship):new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Destroyer):d%2==1?new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Cruiser):
new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Destroyer)):f!=0?(console.debug(b.Name,f,"Planets needing exploration, building scouts"),b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Scout)):i.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length>0&&e?b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Destroyer):a.Turn.Number%4==0&&d&&(b.PlanetBuildGoals[i.Id]=new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.SystemDefense)),
b.PlanetBuildGoals[i.Id]&&console.debug(b.Name,"Planet:",i.Name,"StarShip Build Goal:",Astriarch.GameTools.StarShipTypeToFriendlyName(b.PlanetBuildGoals[i.Id].Type))},computerSubmitTrades:function(a,b,c){var d=b.GetTotalPopulation(),e=b.Resources.GoldAmount,g=b.TotalFoodAmount(),f=b.TotalOreAmount(),h=b.TotalIridiumAmount(),i=0,j=0,k=0,l;for(l in b.PlanetBuildGoals){var m=b.PlanetBuildGoals[l];i+=m.GoldCost;j+=m.OreCost;k+=m.IridiumCost}m=[];l=b.HomePlanetId?b.HomePlanetId:c[0].Id;var c=0,o=Astriarch.TradingCenter.OrderType.MARKET,
n=Astriarch.TradingCenter.TradeType.SELL;if(e<i)g>=d*4&&(c=Math.floor(g*0.25),m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.FOOD,c,o,null))),f>=j*2&&(c=Math.floor(f*0.25),m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.ORE,c,o,null))),h>=k*2&&(c=Math.floor(h*0.25),m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.IRIDIUM,c,o,null)));else if(e>i*1.2)n=Astriarch.TradingCenter.TradeType.BUY,
g<=d*1.2&&(c=Math.floor(d*0.25),m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.FOOD,c,o,null))),f<=j*1.2&&(c=Math.floor(j*0.25),m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.ORE,c,o,null))),h<=k*1.2&&(c=Math.floor(k*0.25),m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.IRIDIUM,c,o,null)));for(var p in m)d=m[p],d.amount>0?(console.debug(b.Name,"Submitted a Trade: ",d),a.TradingCenter.currentTrades.push(d)):
console.debug(b.Name,"Trade found with zero amount.",d)},computerBuildImprovementsAndShips:function(a,b,c){var d=b.LastTurnFoodNeededToBeShipped;switch(b.Type){case Astriarch.Player.PlayerType.Computer_Easy:d=Astriarch.NextRandom(0,(d+1)/4);break;case Astriarch.Player.PlayerType.Computer_Normal:d=Astriarch.NextRandom(0,(d+1)/2);break;case Astriarch.Player.PlayerType.Computer_Hard:d+=Astriarch.CountObjectKeys(b.OwnedPlanets)-0.5;break;case Astriarch.Player.PlayerType.Computer_Expert:d+=Astriarch.CountObjectKeys(b.OwnedPlanets)-
0.25}for(var e in c){var g=c[e];if(g.BuildQueue.length==0&&g.Id in b.PlanetBuildGoals){var f=b.PlanetBuildGoals[g.Id];b.Resources.GoldAmount-f.GoldCost>d&&b.TotalOreAmount()-f.OreCost>=0&&b.TotalIridiumAmount()-f.IridiumCost>=0&&(g.EnqueueProductionItemAndSpendResources(a,f,b),delete b.PlanetBuildGoals[g.Id])}}},computerSendShips:function(a,b,c){var d=[],e;for(e in c){var g=c[e];if(g.PlanetaryFleet.GetPlanetaryFleetMobileStarshipCount()>0)if(b.Type==Astriarch.Player.PlayerType.Computer_Easy)d.push(g);
else{var f=0;Astriarch.AI.countPlanetsNeedingExploration(a,b)!=0?f=0:g.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length>0&&(f=Math.floor(Math.pow(g.Type,2)*4));if(b.Type==Astriarch.Player.PlayerType.Computer_Hard||b.Type==Astriarch.Player.PlayerType.Computer_Expert){var h={minDistance:0},i=Astriarch.AI.getClosestUnownedPlanet(a,b,g,h);i!=null&&(b.LastKnownPlanetFleetStrength[i.Id]?f+=b.LastKnownPlanetFleetStrength[i.Id].Fleet.DetermineFleetStrength(!0):b.KnownClientPlanets[i.Id]&&
(f+=Math.floor(Math.pow(i.Type,2)*4)));i={turnsToComplete:99,starshipStrength:0};g.BuildQueueContainsMobileStarship(i)&&i.turnsToComplete<=h.minDistance+1&&(f-=i.starshipStrength)}g.PlanetaryFleet.DetermineFleetStrength()>f&&d.push(g)}}var j=[],c=[];if(d.length>0)for(e in a.Planets)g=a.Planets[e],g.Owner!=b&&!b.PlanetContainsFriendlyInboundFleet(g)&&(Astriarch.AI.planetNeedsExploration(g,a,b)?j.push(g):b.GetPlanetIfOwnedByPlayer(g.Id)||c.push(g));b.HomePlanetId!=null&&(f=a.getPlanetById(b.HomePlanetId),
h=b.Type==Astriarch.Player.PlayerType.Computer_Easy||b.Type==Astriarch.Player.PlayerType.Computer_Normal?new Astriarch.Planet.PlanetDistanceComparer(a,f):new Astriarch.Planet.PlanetValueDistanceStrengthComparer(a,f,b.LastKnownPlanetFleetStrength),c.sort(h.sortFunction),j.sort(h.sortFunction));f=[];if(b.Type==Astriarch.Player.PlayerType.Computer_Expert)for(e in b.OwnedPlanets)g=b.OwnedPlanets[e],g.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length>0&&f.push(g);console.debug(b.Name,
"planetCandidatesForSendingShips:",d.length,"planetCandidatesForInboundScouts:",j.length,"planetCandidatesForInboundAttackingFleets:",c.length,"planetCandidatesForInboundReinforcements:",f.length);if(d.length>0)for(e=j.length-1;e>=0;e--){g=j[e];b.Type==Astriarch.Player.PlayerType.Computer_Easy||b.Type==Astriarch.Player.PlayerType.Computer_Normal?(h=new Astriarch.Planet.PlanetDistanceComparer(a,g),d.sort(h.sortFunction)):(h=new Astriarch.Planet.PlanetValueDistanceStrengthComparer(a,g,b.LastKnownPlanetFleetStrength),
d.sort(h.sortFunction),d.reverse());for(i=d.length-1;i>=0;){var h=d[i],g=j[e],k=h.PlanetaryFleet.SplitOffSmallestPossibleFleet();k.SetDestination(a.GameGrid,h.BoundingHex,g.BoundingHex);h.OutgoingFleets.push(k);Astriarch.AI.OnComputerSentFleet!=null&&Astriarch.AI.OnComputerSentFleet(k);h=h.PlanetaryFleet.GetPlanetaryFleetMobileStarshipCount();h==0&&d.splice(i,1);break}if(d.length==0)break}for(e=c.length-1;e>=0;e--){g=c[e];b.Type==Astriarch.Player.PlayerType.Computer_Easy||b.Type==Astriarch.Player.PlayerType.Computer_Normal?
(h=new Astriarch.Planet.PlanetDistanceComparer(a,g),d.sort(h.sortFunction)):(h=new Astriarch.Planet.PlanetValueDistanceStrengthComparer(a,g,b.LastKnownPlanetFleetStrength),d.sort(h.sortFunction),d.reverse());h=0.5;i=1;switch(b.Type){case Astriarch.Player.PlayerType.Computer_Easy:h=3;i=6;break;case Astriarch.Player.PlayerType.Computer_Normal:h=2;i=4;break;case Astriarch.Player.PlayerType.Computer_Hard:h=1,i=2}for(var l=Astriarch.NextRandom(Math.floor(h*10),Math.floor(i*10)+1)/10,m=!1,i=d.length-1;i>=
0;i--){var h=d[i],o=Math.floor(Math.pow(g.Type+1,2)*4);(k=b.LastKnownPlanetFleetStrength[g.Id])&&(o=k.Fleet.DetermineFleetStrength());var j=h.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Scout].length,n=h.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length,p=h.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length,q=h.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Battleship].length,k=Astriarch.Fleet.StarShipFactoryHelper.GenerateFleetWithShipCount(b,
0,j,n,p,q,0,h.BoundingHex);if(k.DetermineFleetStrength()>o*l){k=h.PlanetaryFleet.SplitFleet(j,n,p,q);k.SetDestination(a.GameGrid,h.BoundingHex,g.BoundingHex);h.OutgoingFleets.push(k);Astriarch.AI.OnComputerSentFleet!=null&&Astriarch.AI.OnComputerSentFleet(k);h=h.PlanetaryFleet.GetPlanetaryFleetMobileStarshipCount();h==0&&d.splice(i,1);m=!0;break}}if(!m&&f.length>0){h=new Astriarch.Planet.PlanetDistanceComparer(a,g);f.sort(h.sortFunction);l=f[f.length-1];k=a.GameGrid.GetHexDistance(g.BoundingHex,l.BoundingHex);
for(i=d.length-1;i>=0;){h=d[i];if(h.Id==l.Id)break;if(a.GameGrid.GetHexDistance(g.BoundingHex,h.BoundingHex)<k)break;j=h.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Scout].length;n=h.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length;p=h.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length;q=h.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Battleship].length;k=h.PlanetaryFleet.SplitFleet(j,n,p,q);k.SetDestination(a.GameGrid,h.BoundingHex,l.BoundingHex);
h.OutgoingFleets.push(k);Astriarch.AI.OnComputerSentFleet!=null&&Astriarch.AI.OnComputerSentFleet(k);h=h.PlanetaryFleet.GetPlanetaryFleetMobileStarshipCount();h==0&&d.splice(i,1);break}}if(d.length==0)break}},getClosestUnownedPlanet:function(a,b,c,d){d.minDistance=999;var e=null,g;for(g in a.Planets){var f=a.Planets[g];if(f.Id!=c.Id&&f.Owner!=b){var h=a.GameGrid.GetHexDistance(c.BoundingHex,f.BoundingHex);if(h<d.minDistance)d.minDistance=h,e=f}}return e},countPlanetsNeedingExploration:function(a,
b){var c=0,d;for(d in a.Planets){var e=a.Planets[d];e.Owner!=b&&!b.PlanetContainsFriendlyInboundFleet(e)&&Astriarch.AI.planetNeedsExploration(e,a,b)&&c++}return c},planetNeedsExploration:function(a,b,c){if(a.Id in c.KnownClientPlanets){if(c.Type===Astriarch.Player.PlayerType.Computer_Easy)return!1}else return!0;var d=a.Id in c.LastKnownPlanetFleetStrength?b.Turn.Number-c.LastKnownPlanetFleetStrength[a.Id].TurnLastExplored:0,e=b.Planets.length/2*b.GameOptions.GalaxySize;if(d>e)return!0;else{e/=2;var g=
Astriarch.CountObjectKeys(c.OwnedPlanets)||1,f;for(f in c.OwnedPlanets)g+=b.GameGrid.GetHexDistance(a.BoundingHex,c.OwnedPlanets[f].BoundingHex);g/=Astriarch.CountObjectKeys(c.OwnedPlanets)||1;if(g<=e&&d>g)return!0}return!1}};Astriarch.DrawnPlanet=jCanvas.DrawnObject.extend({init:function(a){this.ClientPlanet=a;this.planetImageBackgroundPosition=this.knownPlanetType=null;this.textBlockStrengthForeground=this.textBlockForeground="yellow";this.textBlockStrengthText="";this.fleetRectangle=new Astriarch.Rectangle(this.ClientPlanet.BoundingHex.MidPoint.X+Astriarch.Planet.Static.PLANET_SIZE/2-2,this.ClientPlanet.BoundingHex.MidPoint.Y+Astriarch.Planet.Static.PLANET_SIZE/2-2,11,11);this.drawFleetRectangle=!1;this.fleetRectangleImageData=
Astriarch.Util.starshipImageData;this.spacePlatformRectangle=new Astriarch.Rectangle(this.ClientPlanet.BoundingHex.MidPoint.X-Astriarch.Planet.Static.PLANET_SIZE/2-8,this.ClientPlanet.BoundingHex.MidPoint.Y+Astriarch.Planet.Static.PLANET_SIZE/2-2,11,11);this.drawSpacePlatformRectangle=!1;this.spacePlatformRectangleImageData=Astriarch.Util.spaceplatformImageData;this.wayPointLine=this.productionItemStatusColor=null},draw:function(a){var b=Astriarch.Planet.Static.PLANET_SIZE,c=Astriarch.Planet.Static.PLANET_SIZE,
d=this.ClientPlanet.OriginPoint.X+b/2,e=this.ClientPlanet.OriginPoint.Y+c/2;if(this.planetImageBackgroundPosition===null)b*=1.33,a.beginPath(),a.moveTo(d,e-c/2),a.bezierCurveTo(d-b/2,e-c/2,d-b/2,e+c/2,d,e+c/2),a.bezierCurveTo(d+b/2,e+c/2,d+b/2,e-c/2,d,e-c/2),a.lineWidth=2,a.strokeStyle="white",a.fillStyle="black",a.stroke(),a.fill(),a.closePath(),this.drawText(a,d,e);else{var g=new Image,f=this.ClientPlanet.OriginPoint.X-6,h=this.ClientPlanet.OriginPoint.Y-7;this.knownPlanetType==Astriarch.Planet.PlanetType.AsteroidBelt&&
(f+=1);var i=this;g.onload=function(){a.drawImage(g,0,i.planetImageBackgroundPosition,32,32,f,h,32,32);i.drawText(a,d,e)};g.src=Astriarch.View.SpriteSheetInfo.filename;if(this.drawFleetRectangle){var c=a.createImageData(this.fleetRectangle.Width,this.fleetRectangle.Height),j;for(j in this.fleetRectangleImageData)c.data[j]=this.fleetRectangleImageData[j];a.putImageData(c,this.fleetRectangle.X,this.fleetRectangle.Y)}if(this.drawSpacePlatformRectangle){c=a.createImageData(this.spacePlatformRectangle.Width,
this.spacePlatformRectangle.Height);for(j in this.spacePlatformRectangleImageData)c.data[j]=this.spacePlatformRectangleImageData[j];a.putImageData(c,this.spacePlatformRectangle.X,this.spacePlatformRectangle.Y)}if(this.productionItemStatusColor)b=d-b/2-4,a.beginPath(),a.moveTo(b,e-2),a.bezierCurveTo(b-2,e-2,b-2,e+2,b,e+2),a.bezierCurveTo(b+2,e+2,b+2,e-2,b,e-2),a.lineWidth=2,a.strokeStyle=this.productionItemStatusColor,a.fillStyle=this.productionItemStatusColor,a.stroke(),a.fill(),a.closePath();if(this.wayPointLine)a.strokeStyle=
this.textBlockForeground,a.lineWidth=1,a.setLineDash([8,15]),a.beginPath(),a.moveTo(this.wayPointLine.X1,this.wayPointLine.Y1),a.lineTo(this.wayPointLine.X2,this.wayPointLine.Y2),a.closePath(),a.stroke(),a.setLineDash([])}},drawText:function(a,b,c){a.fillStyle=this.textBlockForeground;a.font="bolder 8pt Trebuchet MS,Tahoma,Verdana,Arial,sans-serif";a.textAlign="center";a.textBaseline="middle";a.fillText(this.ClientPlanet.BoundingHex.Id,b,c);a.fillStyle=this.textBlockStrengthForeground;a.font="bold 7pt Trebuchet MS,Tahoma,Verdana,Arial,sans-serif";
a.fillText(this.textBlockStrengthText,b,c-14)},isInBounds:function(){return!1},UpdatePlanetDrawingForPlayer:function(a){var b=a.MainPlayer;this.planetImageBackgroundPosition=null;if(this.knownPlanetType=b.PlanetTypeIfKnownByPlayer(this.ClientPlanet))switch(this.knownPlanetType){case Astriarch.Planet.PlanetType.PlanetClass2:this.planetImageBackgroundPosition=Astriarch.View.SpriteSheetInfo.planetClass2Y;break;case Astriarch.Planet.PlanetType.PlanetClass1:this.planetImageBackgroundPosition=Astriarch.View.SpriteSheetInfo.planetClass1Y;
break;case Astriarch.Planet.PlanetType.DeadPlanet:this.planetImageBackgroundPosition=Astriarch.View.SpriteSheetInfo.planetDeadY;break;case Astriarch.Planet.PlanetType.AsteroidBelt:this.planetImageBackgroundPosition=Astriarch.View.SpriteSheetInfo.planetAsteroidY}this.drawSpacePlatformRectangle=this.drawFleetRectangle=!1;var c=this.wayPointLine=this.productionItemStatusColor=null,d=null;if(this.ClientPlanet.Id in b.LastKnownPlanetFleetStrength)c=b.LastKnownPlanetFleetStrength[this.ClientPlanet.Id],
d=c.LastKnownOwner;var e=b.GetPlanetIfOwnedByPlayer(this.ClientPlanet.Id);if(e){this.textBlockForeground=b.Color.toString();this.textBlockStrengthForeground=b.Color.toString();if(e.PlanetaryFleet.GetPlanetaryFleetMobileStarshipCount()>0)this.drawFleetRectangle=!0,this.fleetRectangleImageData=Astriarch.Util.GetImageData(b.Color).starshipImageData;if(e.GetSpacePlatformCount()>0)this.drawSpacePlatformRectangle=!0,this.spacePlatformRectangleImageData=Astriarch.Util.GetImageData(b.Color).spaceplatformImageData;
this.textBlockStrengthText=e.PlanetaryFleet.DetermineFleetStrength()+"";if(b=e.GetNextProductionItemFromBuildQueue())if(b instanceof Astriarch.Planet.PlanetImprovement)this.productionItemStatusColor="#00FF00";else if(b instanceof Astriarch.Planet.StarShipInProduction)this.productionItemStatusColor="#336699";else{if(b instanceof Astriarch.Planet.PlanetImprovementToDestroy)this.productionItemStatusColor="#FF0000"}else this.productionItemStatusColor="#CCCCCC";if(e.WayPointPlanetId&&(a=a.getClientPlanetById(e.WayPointPlanetId)))this.wayPointLine=
new Astriarch.Line(this.ClientPlanet.BoundingHex.MidPoint.X,this.ClientPlanet.BoundingHex.MidPoint.Y,a.BoundingHex.MidPoint.X,a.BoundingHex.MidPoint.Y)}else if(this.knownPlanetType&&c&&d){this.textBlockForeground=d.Color.toString();this.textBlockStrengthForeground=d.Color.toString();if(c.Fleet.GetPlanetaryFleetMobileStarshipCount()>0)this.drawFleetRectangle=!0,this.fleetRectangleImageData=Astriarch.Util.GetImageData(d.Color).starshipImageData;if(c.Fleet.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform].length>
0)this.drawSpacePlatformRectangle=!0,this.spacePlatformRectangleImageData=Astriarch.Util.GetImageData(d.Color).spaceplatformImageData;this.textBlockStrengthText=c.Fleet.DetermineFleetStrength()+""}else this.textBlockForeground=this.knownPlanetType==Astriarch.Planet.PlanetType.DeadPlanet?"black":"yellow",this.textBlockStrengthForeground="yellow",this.textBlockStrengthText=this.knownPlanetType&&c?c.Fleet.DetermineFleetStrength()+"":""}});Astriarch.DrawnFleet=jCanvas.DrawnObject.extend({init:function(a){this.Fleet=a;this.Fleet.DrawnFleet=this;this.TravelETATextBlockRect=new Astriarch.Rectangle;this.TravelETATextBlockText="ETA";this.travelDistancePoint=new Astriarch.Point;this.TravelFleetRect=new Astriarch.Rectangle;this.TravelFleetRect.Height=11;this.TravelFleetRect.Width=11;this.TravelLine=new Astriarch.Line},draw:function(a){if(this.Fleet.totalTravelDistance>0){var b="green",c=Astriarch.Util.starshipImageData;if(this.Fleet.Owner)b=
this.Fleet.Owner.Color.toString(),c=Astriarch.Util.GetImageData(this.Fleet.Owner.Color).starshipImageData;a.strokeStyle=b;a.lineWidth=1.5;a.beginPath();a.moveTo(this.TravelLine.X1,this.TravelLine.Y1);a.lineTo(this.TravelLine.X2,this.TravelLine.Y2);a.closePath();a.stroke();var d=a.createImageData(this.TravelFleetRect.Width,this.TravelFleetRect.Height),e;for(e in c)d.data[e]=c[e];a.putImageData(d,this.TravelFleetRect.X,this.TravelFleetRect.Y);a.fillStyle=b;a.font="bold 8px sans-serif";a.textAlign="left";
a.textBaseline="alphabetic";a.fillText(this.TravelETATextBlockText,this.TravelETATextBlockRect.X,this.TravelETATextBlockRect.Y)}},isInBounds:function(){return!1},updateTravelLine:function(){if(this.Fleet.ParsecsToDestination>=0){this.TravelLine.X2=this.Fleet.DestinationHex.MidPoint.X;this.TravelLine.Y2=this.Fleet.DestinationHex.MidPoint.Y;var a=(this.Fleet.totalTravelDistance-this.Fleet.ParsecsToDestination)*1/(this.Fleet.totalTravelDistance*1);this.travelDistancePoint.X=this.Fleet.travelingFromHex.MidPoint.X-
(this.Fleet.travelingFromHex.MidPoint.X-this.TravelLine.X2)*a;this.travelDistancePoint.Y=this.Fleet.travelingFromHex.MidPoint.Y-(this.Fleet.travelingFromHex.MidPoint.Y-this.TravelLine.Y2)*a;this.TravelLine.X1=this.travelDistancePoint.X;this.TravelLine.Y1=this.travelDistancePoint.Y;a=Math.ceil(this.Fleet.GetTurnsToDestination());this.TravelETATextBlockText=a+(a>1?" Turns":" Turn");var b=8;this.TravelLine.X2>this.Fleet.travelingFromHex.MidPoint.X&&(b=a>9?-40:a==1?-30:-35);this.TravelETATextBlockRect.X=
this.travelDistancePoint.X+b;this.TravelETATextBlockRect.Y=this.travelDistancePoint.Y+4;this.TravelFleetRect.X=this.travelDistancePoint.X-5;this.TravelFleetRect.Y=this.travelDistancePoint.Y-5}else this.Fleet.totalTravelDistance=0;if(this.layer)this.layer.needsDisplay=!0}});Astriarch.Dialog=function(a,b,c,d,e,g){this.contentSelector=a;this.DialogResult=!1;this.okCallback=e;this.cancelCallback=g;e=[];typeof this.okCallback=="function"&&e.push({text:"Ok",click:function(){f.okClose()}});typeof this.cancelCallback=="function"&&e.push({text:"Cancel",click:function(){f.cancelClose()}});var f=this;this.dlg=$(a).dialog({autoOpen:!1,resizable:!1,title:b,width:c,height:d,modal:!0,buttons:e,open:function(){$(this).siblings(".ui-dialog-buttonpane").find("button[autofocus]").focus()},
close:function(){Astriarch.View.BindHotkeys()}})};Astriarch.Dialog.prototype.open=function(){Astriarch.View.BindHotkeys(this.contentSelector);this.dlg.dialog("open")};Astriarch.Dialog.prototype.close=function(){this.dlg.dialog("close")};Astriarch.Dialog.prototype.okClose=function(){this.DialogResult=!0;typeof this.okCallback=="function"&&this.okCallback();this.close()};
Astriarch.Dialog.prototype.cancelClose=function(){this.DialogResult=!1;typeof this.cancelCallback=="function"&&this.cancelCallback();this.close()};Astriarch.Dialog.prototype.setTitle=function(a){this.dlg.dialog("option","title",a)};Astriarch.GameController={planetaryConflictMessages:[],turnTimerTimeoutId:null,gameOver:!1};
Astriarch.GameController.ResetView=function(a){$("#TurnDisplay,#OverallPlayerStatusGrid,#SelectedItemStatus,#SelectedItemPopulationPanel,#SelectedItemImprovementSlotsPanel,#SelectedItemPopulationAssignmentsPanel,#SelectedItemBuiltImprovementsGrid,#SelectedItemPlanetaryFleetGrid,#SelectedItemStatusDetails,#BottomStatusGrid,#TurnSummaryItemsListBox,#ButtonPanel").show();$("#PlanetViewButton,#SendShipsButton,#NextTurnButton,#ButtonOpenTradingCenter,#ButtonOpenResearch").show();$("#NextTurnButton").button("enable");
var b=new Astriarch.Grid(621,480,a.Options);Astriarch.ClientGameModel=Astriarch.ClientModelInterface.GetClientModelFromSerializableClientModel(a,b);Astriarch.GameController.RefreshTurnDisplay();Astriarch.GameController.SetupViewFromGameModel();Astriarch.CommControl.refreshPlayerList()};
Astriarch.GameController.SetupViewFromGameModel=function(){Astriarch.View.ClearPlanetsAndFleets();Astriarch.View.audioInterface.BeginGame();Astriarch.View.TurnSummaryItemsListBox.clear();for(var a in Astriarch.ClientGameModel.GameGrid.Hexes)Astriarch.View.CanvasPlayfieldLayer.addChild(Astriarch.ClientGameModel.GameGrid.Hexes[a]);for(var b in Astriarch.ClientGameModel.GameGrid.Quadrants)Astriarch.View.CanvasPlayfieldLayer.addChild(new Astriarch.Grid.DrawnRect(Astriarch.ClientGameModel.GameGrid.Quadrants[b]));
for(var c in Astriarch.ClientGameModel.ClientPlanets)a=Astriarch.ClientGameModel.ClientPlanets[c],b=new Astriarch.DrawnPlanet(a),Astriarch.View.DrawnPlanets[a.Id]=b,Astriarch.View.CanvasPlayfieldLayer.addChild(b);Astriarch.View.updateCanvasForPlayer();Astriarch.View.selectPlanet(Astriarch.ClientGameModel.getClientPlanetById(Astriarch.ClientGameModel.MainPlayer.HomePlanetId));Astriarch.View.updatePlayerStatusPanel()};
Astriarch.GameController.NextTurn=function(){Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.END_TURN,payload:{}})};Astriarch.GameController.HideControlsForTurnStart=function(){Astriarch.PlanetView.Close();Astriarch.SendShipsControl.Close();Astriarch.TradingControl.Close();Astriarch.PlanetaryConflictControl.Close();Astriarch.ResearchControl.Close()};
Astriarch.GameController.OnEndTurnMessageResponse=function(a){if(a.payload.allPlayersFinished)$("#NextTurnButton").button("enable"),Astriarch.GameController.HideControlsForTurnStart(),Astriarch.View.audioInterface.StartTurn(),Astriarch.GameController.OnStartTurn(a);else if(a.payload.clientPlayers)Astriarch.View.audioInterface.EndTurn(),Astriarch.ClientGameModel.ClientPlayers=a.payload.clientPlayers.map(function(a){return Astriarch.ClientModelInterface.GetClientPlayerFromSerializableClientPlayer(a)}),
Astriarch.CommControl.refreshPlayerList(),Astriarch.ClientGameModel.ClientPlayers.forEach(function(a){a.Id==Astriarch.ClientGameModel.MainPlayer.Id&&!a.CurrentTurnEnded&&$("#NextTurnButton").button("enable")})};Astriarch.GameController.OnPlayerDestroyed=function(a){new Astriarch.Alert(a.Name+" Destroyed",'Player: <span style="color:'+a.Color.toString()+'">'+a.Name+"</span> destroyed.")};
Astriarch.GameController.OnGameOverMessageResponse=function(a){Astriarch.GameController.gameOver=!0;Astriarch.View.audioInterface.EndGame();Astriarch.GameController.HideControlsForTurnStart();Astriarch.GameController.UpdateUIForEndTurnMessage(a);$("#PlanetViewButton,#SendShipsButton,#NextTurnButton,#ButtonOpenTradingCenter,#ButtonOpenResearch").hide();Astriarch.GameOverControl.show(a.payload.winningSerializablePlayer,a.payload.playerWon,a.payload.score)};
Astriarch.GameController.OnExitResignMessageResponse=function(){Astriarch.View.NextTurn()};
Astriarch.GameController.RefreshTurnDisplay=function(){var a=Astriarch.ClientGameModel.Turn.Number+3E3;$("#TurnDisplay").text("Turn "+Astriarch.ClientGameModel.Turn.Number+", Year "+a);var b=$("#TurnTimer");Astriarch.ClientGameModel.GameOptions.TurnTimeLimitSeconds&&!Astriarch.GameController.gameOver?(b.show(),b.stop(!0).animate({width:"100%"},500,"linear",function(){b.animate({width:"0px"},Astriarch.ClientGameModel.GameOptions.TurnTimeLimitSeconds*1E3,"linear");Astriarch.GameController.ClearTurnTimer();
Astriarch.GameController.turnTimerTimeoutId=setTimeout(function(){Astriarch.View.NextTurn()},Astriarch.ClientGameModel.GameOptions.TurnTimeLimitSeconds*1E3)})):b.hide()};Astriarch.GameController.ClearTurnTimer=function(){Astriarch.GameController.turnTimerTimeoutId&&clearTimeout(Astriarch.GameController.turnTimerTimeoutId)};
Astriarch.GameController.OnStartTurn=function(a){if(a.payload.destroyedClientPlayers)for(var b in a.payload.destroyedClientPlayers)Astriarch.GameController.OnPlayerDestroyed(a.payload.destroyedClientPlayers[b]);Astriarch.GameController.UpdateUIForEndTurnMessage(a);Astriarch.GameController.processNextEndOfTurnPlanetaryConflictMessage()};
Astriarch.GameController.UpdateUIForEndTurnMessage=function(a){Astriarch.ClientGameModel=Astriarch.ClientModelInterface.GetClientModelFromSerializableClientModel(a.payload.gameData,Astriarch.ClientGameModel.GameGrid);Astriarch.GameController.RefreshTurnDisplay();Astriarch.CommControl.refreshPlayerList();var b=a.payload.endOfTurnMessages,a=[],c;for(c in b)a.push(Astriarch.ClientModelInterface.GetTurnEventMessageFromSerializableTurnEventMessage(b[c],Astriarch.ClientGameModel.GameGrid));Astriarch.GameController.planetaryConflictMessages=
[];if(Astriarch.PlayerGameOptions.ShowPlanetaryConflictPopups)for(var d in a)b=a[d],(b.Type==Astriarch.TurnEventMessage.TurnEventMessageType.AttackingFleetLost||b.Type==Astriarch.TurnEventMessage.TurnEventMessageType.DefendedAgainstAttackingFleet||b.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetCaptured||b.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetLost)&&b.Data!=null&&Astriarch.GameController.planetaryConflictMessages.push(b);Astriarch.View.updatePlayerStatusPanel();
Astriarch.View.updateSelectedItemPanelForPlanet();Astriarch.View.updateCanvasForPlayer();Astriarch.View.TurnSummaryItemsListBox.clear();if(a.length>0){c=[];for(d in a){b=a[d];b=new Astriarch.GameController.TurnSummaryMessageListBoxItem(b);switch(b.EventMessage.Type){case Astriarch.TurnEventMessage.TurnEventMessageType.ResourcesAutoSpent:case Astriarch.TurnEventMessage.TurnEventMessageType.PopulationGrowth:b.Foreground="blue";break;case Astriarch.TurnEventMessage.TurnEventMessageType.DefendedAgainstAttackingFleet:b.Foreground=
"purple";break;case Astriarch.TurnEventMessage.TurnEventMessageType.BuildQueueEmpty:b.Foreground="grey";break;case Astriarch.TurnEventMessage.TurnEventMessageType.CitizensProtesting:case Astriarch.TurnEventMessage.TurnEventMessageType.InsufficientFood:b.Foreground="yellow";break;case Astriarch.TurnEventMessage.TurnEventMessageType.PlanetCaptured:case Astriarch.TurnEventMessage.TurnEventMessageType.AttackingFleetLost:b.Foreground="orange";break;case Astriarch.TurnEventMessage.TurnEventMessageType.PlanetLost:case Astriarch.TurnEventMessage.TurnEventMessageType.PopulationStarvation:case Astriarch.TurnEventMessage.TurnEventMessageType.PlanetLostDueToStarvation:case Astriarch.TurnEventMessage.TurnEventMessageType.FoodShortageRiots:b.Foreground=
"red";break;default:b.Foreground="green"}c.push(b)}Astriarch.View.TurnSummaryItemsListBox.addItems(c)}if((d=Astriarch.ClientGameModel.MainPlayer.GetPlanetIfOwnedByPlayer(Astriarch.ClientGameModel.MainPlayer.HomePlanetId))&&window.tour.enabled)a=d.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length,c=d.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Colony].length,b=d.GetSpacePlatformCount(),(a==1&&window.tour.step==48||a==2&&window.tour.step==49||a==3&&window.tour.step==
50||c==1&&window.tour.step==51||b==1&&window.tour.step==68)&&window.tour.jqElm.joyride("resume"),d.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Scout].length>0&&window.tour.step==54&&window.tour.jqElm.joyride("resume"),Astriarch.CountObjectKeys(Astriarch.ClientGameModel.MainPlayer.KnownClientPlanets)>=4&&window.tour.step==63&&window.tour.jqElm.joyride("resume"),Astriarch.CountObjectKeys(Astriarch.ClientGameModel.MainPlayer.OwnedPlanets)>=4&&window.tour.step==66&&window.tour.jqElm.joyride("resume")};
Astriarch.GameController.processNextEndOfTurnPlanetaryConflictMessage=function(){var a=Astriarch.GameController.planetaryConflictMessages.length-1;if(a>=0){var b=Astriarch.GameController.planetaryConflictMessages[a];Astriarch.GameController.planetaryConflictMessages.splice(a,1);Astriarch.PlayerGameOptions.ShowPlanetaryConflictPopups&&Astriarch.GameController.popupPlanetaryConflictControl(b)}};Astriarch.GameController.popupPlanetaryConflictControl=function(a){Astriarch.PlanetaryConflictControl.show(a)};
Astriarch.GameController.GameOverControlClosed=function(){Astriarch.View.updateCanvasForPlayer();Astriarch.View.updateSelectedItemPanelForPlanet();$("#MainMenuButtonGameOver").show()};
Astriarch.GameController.TurnSummaryMessageListBoxItem=JSListBox.Item.extend({init:function(a){this.value=a.Message;this.Foreground=null;this.EventMessage=a},render:function(){return'<a href="#" style="color:'+this.Foreground+'">'+this.value+"</a>"},onClick:function(){this.EventMessage!=null&&this.EventMessage.Planet!=null&&Astriarch.View.selectPlanet(this.EventMessage.Planet)},onDblClick:function(){this.EventMessage&&(this.EventMessage.Type==Astriarch.TurnEventMessage.TurnEventMessageType.AttackingFleetLost||
this.EventMessage.Type==Astriarch.TurnEventMessage.TurnEventMessageType.DefendedAgainstAttackingFleet||this.EventMessage.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetCaptured||this.EventMessage.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetLost)&&Astriarch.GameController.popupPlanetaryConflictControl(this.EventMessage)}});Astriarch.PlanetView={dialog:null,planetMain:null,population:0,farmers:0,miners:0,workers:0,farmCount:0,mineCount:0,factoryCount:0,colonyCount:0,workingBuildQueue:[],workingResources:null,workingProductionRemainderOriginal:0,lastClicked:null,lastChanged:null,updatingGUI:!1,ItemsAvailableCardList:null,BuildQueueListBox:null,lbiFarm:null,lbiMine:null,lbiColony:null,lbiFactory:null,lbiSpacePlatform:null,lbiDefender:null,lbiScout:null,lbiDestroyer:null,lbiCruiser:null,lbiBattleship:null,itemsAvailable:[],
init:function(){$("#ButtonDemolishFarm, #ButtonDemolishMine, #ButtonDemolishFactory, #ButtonDemolishColony").button({icons:{primary:"icon-16x16-demolish"},text:!1});$("#SliderFarmers").slider({value:0,step:1,min:0,max:10,slide:Astriarch.PlanetView.SliderFarmersValueChanged});$("#SliderMiners").slider({value:0,step:1,min:0,max:10,slide:Astriarch.PlanetView.SliderMinersValueChanged});$("#SliderWorkers").slider({value:0,step:1,min:0,max:10,slide:Astriarch.PlanetView.SliderWorkersValueChanged});$("#BuildLastShipCheckBox").change(Astriarch.PlanetView.BuildLastShipCheckBoxValueChanged);
$("#ButtonBuildQueueRemoveSelectedItem").button({icons:{primary:"icon-16x16-build-queue-remove"},text:!1});$("#ButtonBuildQueueMoveSelectedItemDown").button({icons:{primary:"icon-16x16-build-queue-down"},text:!1});$("#ButtonBuildQueueMoveSelectedItemUp").button({icons:{primary:"icon-16x16-build-queue-up"},text:!1});$("#ButtonBuildQueueRemoveSelectedItem").click(function(){Astriarch.PlanetView.removeSelectedItemFromQueue()});$("#ButtonBuildQueueMoveSelectedItemDown").click(function(){Astriarch.PlanetView.moveSelectedItemInQueue(!1)});
$("#ButtonBuildQueueMoveSelectedItemUp").click(function(){Astriarch.PlanetView.moveSelectedItemInQueue(!0)});$("#ButtonDemolishFarm").click(function(){Astriarch.PlanetView.addImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Farm)});$("#ButtonDemolishMine").click(function(){Astriarch.PlanetView.addImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Mine)});$("#ButtonDemolishFactory").click(function(){Astriarch.PlanetView.addImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Factory)});
$("#ButtonDemolishColony").click(function(){Astriarch.PlanetView.addImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Colony)});$("#PlanetViewButtonFarmers, #PlanetViewButtonMiners, #PlanetViewButtonWorkers").button();$("#PlanetViewButtonFarmers").click(function(){var a=$("#SliderFarmers"),b=a.slider("value")+1;Astriarch.PlanetView.updateSliderValues(Astriarch.PlanetView.SliderValueClicked.Farmers,b);a.slider("value",b)});$("#PlanetViewButtonMiners").click(function(){var a=$("#SliderMiners"),
b=a.slider("value")+1;Astriarch.PlanetView.updateSliderValues(Astriarch.PlanetView.SliderValueClicked.Miners,b);a.slider("value",b)});$("#PlanetViewButtonWorkers").click(function(){var a=$("#SliderWorkers"),b=a.slider("value")+1;Astriarch.PlanetView.updateSliderValues(Astriarch.PlanetView.SliderValueClicked.Workers,b);a.slider("value",b)});$("#ButtonClearWaypoint").button();$("#ButtonClearWaypoint").click(function(){$("#ButtonClearWaypoint").button("disable");Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CLEAR_WAYPOINT,
payload:{planetIdSource:Astriarch.PlanetView.planetMain.Id}});Astriarch.PlanetView.planetMain.WayPointPlanetId=null});$("#BuildLastShipCheckBoxLabel").attr("title","If this option is checked and the build queue is empty at the end of the turn,\r\nthe ship last built on this planet will be added to the queue.\r\nIn order to build the ship, sufficient resources must exist\r\nas well as a surplus of gold to cover the amount of food shipped last turn.");$("#BuildLastShipCheckBox").prop("checked",!0);
Astriarch.PlanetView.ItemsAvailableCardList=new JSCardList({containerSelector:"ItemsAvailableCardList",multiselect:!1});Astriarch.PlanetView.BuildQueueListBox=new JSListBox({containerSelector:"BuildQueueListBox"});Astriarch.PlanetView.lbiFarm=new Astriarch.PlanetView.AvailableImprovementCardListItem(Astriarch.Planet.PlanetImprovementType.Farm,"r");Astriarch.PlanetView.lbiMine=new Astriarch.PlanetView.AvailableImprovementCardListItem(Astriarch.Planet.PlanetImprovementType.Mine,"i");Astriarch.PlanetView.lbiColony=
new Astriarch.PlanetView.AvailableImprovementCardListItem(Astriarch.Planet.PlanetImprovementType.Colony,"l");Astriarch.PlanetView.lbiFactory=new Astriarch.PlanetView.AvailableImprovementCardListItem(Astriarch.Planet.PlanetImprovementType.Factory,"t");Astriarch.PlanetView.lbiSpacePlatform=new Astriarch.PlanetView.AvailableStarShipCardListItem(Astriarch.Fleet.StarShipType.SpacePlatform,!1,"P");Astriarch.PlanetView.lbiDefender=new Astriarch.PlanetView.AvailableStarShipCardListItem(Astriarch.Fleet.StarShipType.SystemDefense,
!1,"e");Astriarch.PlanetView.lbiScout=new Astriarch.PlanetView.AvailableStarShipCardListItem(Astriarch.Fleet.StarShipType.Scout,!1,"S");Astriarch.PlanetView.lbiDestroyer=new Astriarch.PlanetView.AvailableStarShipCardListItem(Astriarch.Fleet.StarShipType.Destroyer,!1,"D");Astriarch.PlanetView.lbiCruiser=new Astriarch.PlanetView.AvailableStarShipCardListItem(Astriarch.Fleet.StarShipType.Cruiser,!1,"C");Astriarch.PlanetView.lbiBattleship=new Astriarch.PlanetView.AvailableStarShipCardListItem(Astriarch.Fleet.StarShipType.Battleship,
!1,"a");Astriarch.PlanetView.dialog=new Astriarch.Dialog("#planetViewDialog","Planet View",568,485,Astriarch.PlanetView.OKClose);Astriarch.PlanetView.lastClicked=Astriarch.PlanetView.SliderValueClicked.None;Astriarch.PlanetView.lastChanged=Astriarch.PlanetView.SliderValueClicked.None},show:function(a){Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_START,payload:{planetId:a.Id}});Astriarch.PlanetView.planetMain=a;var b=Astriarch.GameTools.PlanetTypeToClassName(a.Type);
$("#PlanetImage").attr("class",b);$("#TextBlockPlanetType").text(Astriarch.GameTools.PlanetTypeToFriendlyName(a.Type));Astriarch.PlanetView.farmCount=a.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Farm].length;Astriarch.PlanetView.mineCount=a.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length;Astriarch.PlanetView.factoryCount=a.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length;Astriarch.PlanetView.colonyCount=a.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Colony].length;
$("#PlanetViewFarmCount").text(Astriarch.PlanetView.farmCount);$("#PlanetViewMineCount").text(Astriarch.PlanetView.mineCount);$("#PlanetViewFactoryCount").text(Astriarch.PlanetView.factoryCount);$("#PlanetViewColonyCount").text(Astriarch.PlanetView.colonyCount);$("#PlanetViewSpacePlatformCount").text(a.GetSpacePlatformCount());Astriarch.PlanetView.refreshResourcesPerTurnTextBoxes();Astriarch.PlanetView.updatePlanetStatsToolTip();b=a.GetPopulationByContentment();Astriarch.PlanetView.population=b.content.length;
$("#SliderFarmers").slider("option","max",Astriarch.PlanetView.population);$("#SliderMiners").slider("option","max",Astriarch.PlanetView.population);$("#SliderWorkers").slider("option","max",Astriarch.PlanetView.population);b=new Astriarch.Planet.PopulationAssignments;a.CountPopulationWorkerTypes(b);Astriarch.PlanetView.farmers=b.Farmers;Astriarch.PlanetView.miners=b.Miners;Astriarch.PlanetView.workers=b.Workers;$("#SliderFarmers").slider("value",Astriarch.PlanetView.farmers);$("#TextBoxFarmers").text(Astriarch.PlanetView.farmers+
"");$("#SliderMiners").slider("value",Astriarch.PlanetView.miners);$("#TextBoxMiners").text(Astriarch.PlanetView.miners+"");$("#SliderWorkers").slider("value",Astriarch.PlanetView.workers);$("#TextBoxWorkers").text(Astriarch.PlanetView.workers+"");Astriarch.PlanetView.workingBuildQueue=[];for(var c in a.BuildQueue)Astriarch.PlanetView.workingBuildQueue.push(a.BuildQueue[c]);Astriarch.PlanetView.workingResources=new Astriarch.Model.WorkingPlayerResources(a.Owner);Astriarch.PlanetView.workingProductionRemainderOriginal=
a.RemainderProduction;Astriarch.PlanetView.refreshBuildQueueListBox();Astriarch.PlanetView.showOrHideDemolishImprovementButtons();$("#ButtonBuildQueueRemoveSelectedItem").button("disable");$("#ButtonBuildQueueMoveSelectedItemDown").button("disable");$("#ButtonBuildQueueMoveSelectedItemUp").button("disable");Astriarch.PlanetView.planetMain.WayPointPlanetId?$("#ButtonClearWaypoint").button("enable"):$("#ButtonClearWaypoint").button("disable");Astriarch.PlanetView.refreshCurrentWorkingResourcesTextBoxes();
Astriarch.PlanetView.planetMain.BuildLastStarShip?$("#BuildLastShipCheckBox").prop("checked",!0):$("#BuildLastShipCheckBox").prop("checked",!1);$("#LastShipBuiltTextBlock").text("");Astriarch.PlanetView.planetMain.StarShipTypeLastBuilt!=null&&$("#LastShipBuiltTextBlock").text("Last Built: "+Astriarch.GameTools.StarShipTypeToFriendlyName(Astriarch.PlanetView.planetMain.StarShipTypeLastBuilt));Astriarch.PlanetView.dialog.setTitle("Planet "+a.Name+" View");Astriarch.PlanetView.dialog.open();Astriarch.PlanetView.refreshItemsAvailableCardList();
window.tour.enabled&&(window.tour.step==27||window.tour.step==32||window.tour.step==43)&&window.tour.jqElm.joyride("resume")},BuildQueueSelectionChanged:function(){$("#ButtonBuildQueueRemoveSelectedItem").button("disable");$("#ButtonBuildQueueMoveSelectedItemDown").button("disable");$("#ButtonBuildQueueMoveSelectedItemUp").button("disable");Astriarch.PlanetView.BuildQueueListBox.SelectedItem!=null&&($("#ButtonBuildQueueRemoveSelectedItem").button("enable"),Astriarch.PlanetView.BuildQueueListBox.SelectedIndex!=
Astriarch.PlanetView.BuildQueueListBox.items.length-1&&$("#ButtonBuildQueueMoveSelectedItemDown").button("enable"),Astriarch.PlanetView.BuildQueueListBox.SelectedIndex!=0&&$("#ButtonBuildQueueMoveSelectedItemUp").button("enable"))},ItemsAvailableClicked:function(){Astriarch.PlanetView.addSelectedItemToQueue()},recalculateBuildQueueListItemsTurnsToCompleteEstimates:function(){var a=Astriarch.PlanetView;a.planetMain.UpdatePopulationWorkerTypes(a.farmers,a.miners,a.workers);a.planetMain.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats();
var b=a.workingProductionRemainderOriginal,c;for(c in a.BuildQueueListBox.items)a.BuildQueueListBox.items[c].ProductionItem.EstimateTurnsToComplete(a.planetMain.ResourcesPerTurn.GetProductionAmountPerTurn(),b),b=0;a.BuildQueueListBox.refresh()},refreshResourcesPerTurnTextBoxes:function(){$("#TextBlockFoodPerTurn").text(Astriarch.DecimalToFixed(Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetFoodAmountPerTurn(),3));$("#TextBlockOrePerTurn").text(Astriarch.DecimalToFixed(Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetOreAmountPerTurn(),
3));$("#TextBlockIridiumPerTurn").text(Astriarch.DecimalToFixed(Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetIridiumAmountPerTurn(),3));$("#TextBlockProductionPerTurn").text(Astriarch.DecimalToFixed(Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetProductionAmountPerTurn(),3))},updatePlanetStatsToolTip:function(){var a="";a+="Base Worker Resource Generation Per Turn:\r\n";a+="Food: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.BaseFoodAmountPerWorkerPerTurn+"\r\n";a+="Ore: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.BaseOreAmountPerWorkerPerTurn+
"\r\n";a+="Iridium: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.BaseIridiumAmountPerWorkerPerTurn+"\r\n";a+="Production: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.BaseProductionPerWorkerPerTurn+"\r\n\r\n";a+="Worker Resource Generation with Improvements:\r\n";a+="Food: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetExactFoodAmountPerWorkerPerTurn()+"\r\n";a+="Ore: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetExactOreAmountPerWorkerPerTurn()+"\r\n";a+="Iridium: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetExactIridiumAmountPerWorkerPerTurn()+
"\r\n";a+="Production: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetExactProductionAmountPerWorkerPerTurn()+"\r\n\r\n";a+="Food amount on planet: "+Astriarch.PlanetView.planetMain.Resources.FoodAmount+"\r\n";$("#PlanetImage").attr("title","Planet Stats:\r\n"+a)},workingQueueSpacePlatformCount:function(){var a=0,b;for(b in Astriarch.PlanetView.workingBuildQueue){var c=Astriarch.PlanetView.workingBuildQueue[b];c instanceof Astriarch.Planet.StarShipInProduction&&c.Type==Astriarch.Fleet.StarShipType.SpacePlatform&&
a++}return a},disableOrEnableImprovementsBasedOnSlotsAvailable:function(){var a=Astriarch.PlanetView.planetMain.BuiltImprovementCount(),b;for(b in Astriarch.PlanetView.workingBuildQueue)Astriarch.PlanetView.workingBuildQueue[b]instanceof Astriarch.Planet.PlanetImprovement&&a++;Astriarch.PlanetView.planetMain.MaxImprovements-a<=0?(Astriarch.PlanetView.lbiFarm.CanBuild=!1,Astriarch.PlanetView.lbiMine.CanBuild=!1,Astriarch.PlanetView.lbiColony.CanBuild=!1,Astriarch.PlanetView.lbiFactory.CanBuild=!1):
(Astriarch.PlanetView.lbiFarm.CanBuild=!0,Astriarch.PlanetView.lbiMine.CanBuild=!0,Astriarch.PlanetView.lbiColony.CanBuild=!0,Astriarch.PlanetView.lbiFactory.CanBuild=!0);Astriarch.PlanetView.lbiSpacePlatform.CanBuild=Astriarch.PlanetView.planetMain.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length==0?!1:!0;if(Astriarch.PlanetView.planetMain.GetSpacePlatformCount()+Astriarch.PlanetView.workingQueueSpacePlatformCount()>=Astriarch.ClientGameModel.MainPlayer.Research.getMaxSpacePlatformCount())Astriarch.PlanetView.lbiSpacePlatform.CanBuild=
!1},disableImprovementsBasedOnResourcesAvailable:function(){for(var a in Astriarch.PlanetView.itemsAvailable){var b=Astriarch.PlanetView.itemsAvailable[a];if(b instanceof Astriarch.PlanetView.AvailableImprovementCardListItem){if(b.CanBuild)b.CanBuildBasedOnResources=Astriarch.PlanetView.workingResources.GoldAmount<b.AvailablePlanetImprovement.GoldCost||Astriarch.PlanetView.workingResources.IridiumAmount<b.AvailablePlanetImprovement.IridiumCost||Astriarch.PlanetView.workingResources.OreAmount<b.AvailablePlanetImprovement.OreCost?
!1:!0}else if(b instanceof Astriarch.PlanetView.AvailableStarShipCardListItem&&b.CanBuild)b.CanBuildBasedOnResources=Astriarch.PlanetView.workingResources.GoldAmount<b.AvailableStarShip.GoldCost||Astriarch.PlanetView.workingResources.IridiumAmount<b.AvailableStarShip.IridiumCost||Astriarch.PlanetView.workingResources.OreAmount<b.AvailableStarShip.OreCost?!1:!0}},refreshItemsAvailableCardList:function(){Astriarch.PlanetView.itemsAvailable=[];Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiFarm);
Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiMine);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiColony);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiFactory);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiSpacePlatform);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiDefender);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiScout);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiDestroyer);
Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiCruiser);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiBattleship);var a=new Astriarch.PlanetView.AvailableStarShipCardListItem(Astriarch.Fleet.StarShipType.SystemDefense,!0),b=new Astriarch.PlanetView.AvailableStarShipCardListItem(Astriarch.Fleet.StarShipType.Scout,!0),c=new Astriarch.PlanetView.AvailableStarShipCardListItem(Astriarch.Fleet.StarShipType.Destroyer,!0),d=new Astriarch.PlanetView.AvailableStarShipCardListItem(Astriarch.Fleet.StarShipType.Cruiser,
!0),e=new Astriarch.PlanetView.AvailableStarShipCardListItem(Astriarch.Fleet.StarShipType.Battleship,!0);Astriarch.ClientGameModel.MainPlayer.Research.researchProgressByType[Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DEFENDER].currentResearchLevel>=0&&Astriarch.PlanetView.itemsAvailable.push(a);Astriarch.ClientGameModel.MainPlayer.Research.researchProgressByType[Astriarch.Research.ResearchType.NEW_SHIP_TYPE_SCOUT].currentResearchLevel>=0&&Astriarch.PlanetView.itemsAvailable.push(b);Astriarch.ClientGameModel.MainPlayer.Research.researchProgressByType[Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DESTROYER].currentResearchLevel>=
0&&Astriarch.PlanetView.itemsAvailable.push(c);Astriarch.ClientGameModel.MainPlayer.Research.researchProgressByType[Astriarch.Research.ResearchType.NEW_SHIP_TYPE_CRUISER].currentResearchLevel>=0&&Astriarch.PlanetView.itemsAvailable.push(d);Astriarch.ClientGameModel.MainPlayer.Research.researchProgressByType[Astriarch.Research.ResearchType.NEW_SHIP_TYPE_BATTLESHIP].currentResearchLevel>=0&&Astriarch.PlanetView.itemsAvailable.push(e);if(Astriarch.PlanetView.planetMain)Astriarch.PlanetView.disableOrEnableImprovementsBasedOnSlotsAvailable(),
Astriarch.PlanetView.planetMain.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length==0?(Astriarch.PlanetView.lbiDestroyer.CanBuild=!1,c.CanBuild=!1):(Astriarch.PlanetView.lbiDestroyer.CanBuild=!0,c.CanBuild=!0),Astriarch.PlanetView.planetMain.GetSpacePlatformCount()==0?(Astriarch.PlanetView.lbiCruiser.CanBuild=!1,d.CanBuild=!1,Astriarch.PlanetView.lbiBattleship.CanBuild=!1,e.CanBuild=!1):(Astriarch.PlanetView.lbiCruiser.CanBuild=!0,d.CanBuild=!0,Astriarch.PlanetView.lbiBattleship.CanBuild=
!0,e.CanBuild=!0),Astriarch.PlanetView.disableImprovementsBasedOnResourcesAvailable();Astriarch.PlanetView.itemsAvailable.forEach(function(a){a.selected=!1});Astriarch.PlanetView.ItemsAvailableCardList.setItems(Astriarch.PlanetView.itemsAvailable);var g=function(a){if(a=a.data("jscardlist.item"))a.selected=!0,a.onClick()};$(".pvcItemAnchor[data-hotkey]").each(function(){var a=$(this),b=a.attr("data-hotkey"),a=a.parent();a.attr("enabled")=="true"&&Astriarch.View.RegisterClickTargetToHotkey(a,b,"planetViewDialog",
g)});Astriarch.View.BindHotkeys("#planetViewDialog")},refreshBuildQueueListBox:function(){Astriarch.PlanetView.BuildQueueListBox.clear();var a=Astriarch.PlanetView.workingProductionRemainderOriginal,b;for(b in Astriarch.PlanetView.workingBuildQueue){var c=Astriarch.PlanetView.workingBuildQueue[b];c.EstimateTurnsToComplete(Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetProductionAmountPerTurn(),a);a=0;c=new Astriarch.PlanetView.BuildQueueListBoxItem(c);Astriarch.PlanetView.BuildQueueListBox.addItem(c)}},
showOrHideDemolishImprovementButtons:function(){Astriarch.PlanetView.farmCount-Astriarch.PlanetView.countDemolishImprovementsInQueueByType(Astriarch.Planet.PlanetImprovementType.Farm)>0?$("#ButtonDemolishFarm").css({visibility:"visible"}):$("#ButtonDemolishFarm").css({visibility:"hidden"});Astriarch.PlanetView.mineCount-Astriarch.PlanetView.countDemolishImprovementsInQueueByType(Astriarch.Planet.PlanetImprovementType.Mine)>0?$("#ButtonDemolishMine").css({visibility:"visible"}):$("#ButtonDemolishMine").css({visibility:"hidden"});
Astriarch.PlanetView.factoryCount-Astriarch.PlanetView.countDemolishImprovementsInQueueByType(Astriarch.Planet.PlanetImprovementType.Factory)>0?$("#ButtonDemolishFactory").css({visibility:"visible"}):$("#ButtonDemolishFactory").css({visibility:"hidden"});Astriarch.PlanetView.colonyCount-Astriarch.PlanetView.countDemolishImprovementsInQueueByType(Astriarch.Planet.PlanetImprovementType.Colony)>0?$("#ButtonDemolishColony").css({visibility:"visible"}):$("#ButtonDemolishColony").css({visibility:"hidden"})},
refreshCurrentWorkingResourcesTextBoxes:function(){$("#TextBlockCurrentGoldAmount").text(Math.floor(Astriarch.PlanetView.workingResources.GoldAmount));$("#TextBlockCurrentOreAmount").text(Math.floor(Astriarch.PlanetView.workingResources.OreAmount));$("#TextBlockCurrentIridiumAmount").text(Math.floor(Astriarch.PlanetView.workingResources.IridiumAmount))},countDemolishImprovementsInQueueByType:function(a){var b=0,c;for(c in Astriarch.PlanetView.workingBuildQueue){var d=Astriarch.PlanetView.workingBuildQueue[c];
d instanceof Astriarch.Planet.PlanetImprovementToDestroy&&d.TypeToDestroy==a&&b++}return b},addImprovementToDestroy:function(a){var b=new Astriarch.Planet.PlanetImprovementToDestroy(a);Astriarch.PlanetView.workingBuildQueue.push(b);Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.DEMOLISH_IMPROVEMENT,planetId:Astriarch.PlanetView.planetMain.Id,data:a}});Astriarch.PlanetView.showOrHideDemolishImprovementButtons();
Astriarch.PlanetView.refreshBuildQueueListBox()},updateSliderValues:function(a,b){var c=Astriarch.PlanetView;if(!(b<0||b>c.population)){var d=0;c.updatingGUI=!0;if(c.lastClicked!=a)c.lastChanged=Astriarch.PlanetView.SliderValueClicked.None;var e=$("#SliderFarmers").slider("value"),g=$("#SliderMiners").slider("value"),f=$("#SliderWorkers").slider("value");switch(a){case Astriarch.PlanetView.SliderValueClicked.Farmers:e=b;d=e-c.farmers;break;case Astriarch.PlanetView.SliderValueClicked.Miners:g=b;d=
g-c.miners;break;case Astriarch.PlanetView.SliderValueClicked.Workers:f=b,d=f-c.workers}var h=!1,i=!1,j=!1;if(d>0)h=c.farmers!=0,i=c.miners!=0,j=c.workers!=0;else if(d<0)h=c.farmers!=c.population,i=c.miners!=c.population,j=c.workers!=c.population;else{c.updatingGUI=!1;return}for(;d!=0;){var k=1;d<0&&(k=-1);var l=Astriarch.PlanetView.SliderValueClicked.None;switch(a){case Astriarch.PlanetView.SliderValueClicked.Farmers:l=i&&!j?Astriarch.PlanetView.SliderValueClicked.Miners:!i&&j?Astriarch.PlanetView.SliderValueClicked.Workers:
g==f?c.lastChanged!=Astriarch.PlanetView.SliderValueClicked.Miners?Astriarch.PlanetView.SliderValueClicked.Miners:Astriarch.PlanetView.SliderValueClicked.Workers:d>0?g>f?Astriarch.PlanetView.SliderValueClicked.Miners:Astriarch.PlanetView.SliderValueClicked.Workers:g<f?Astriarch.PlanetView.SliderValueClicked.Miners:Astriarch.PlanetView.SliderValueClicked.Workers;break;case Astriarch.PlanetView.SliderValueClicked.Miners:l=h&&!j?Astriarch.PlanetView.SliderValueClicked.Farmers:!h&&j?Astriarch.PlanetView.SliderValueClicked.Workers:
e==f?c.lastChanged!=Astriarch.PlanetView.SliderValueClicked.Farmers?Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Workers:d>0?e>f?Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Workers:e<f?Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Workers;break;case Astriarch.PlanetView.SliderValueClicked.Workers:l=h&&!i?Astriarch.PlanetView.SliderValueClicked.Farmers:!h&&i?Astriarch.PlanetView.SliderValueClicked.Miners:
e==g?c.lastChanged!=Astriarch.PlanetView.SliderValueClicked.Farmers?Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Miners:d>0?e>g?Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Miners:e<g?Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Miners}switch(l){case Astriarch.PlanetView.SliderValueClicked.Farmers:e-=k;$("#SliderFarmers").slider("value",e);c.lastChanged=Astriarch.PlanetView.SliderValueClicked.Farmers;
break;case Astriarch.PlanetView.SliderValueClicked.Miners:g-=k;$("#SliderMiners").slider("value",g);c.lastChanged=Astriarch.PlanetView.SliderValueClicked.Miners;break;case Astriarch.PlanetView.SliderValueClicked.Workers:f-=k;$("#SliderWorkers").slider("value",f);c.lastChanged=Astriarch.PlanetView.SliderValueClicked.Workers;break;default:console.error("Unable to determine slider to change in PlanetViewControl!")}c.farmers=e;c.miners=g;c.workers=f;d>0?d--:d<0&&d++}c.updatingGUI=!1;c.lastClicked=a;$("#TextBoxFarmers").text(c.farmers);
$("#TextBoxMiners").text(c.miners);$("#TextBoxWorkers").text(c.workers);window.tour.enabled&&window.tour.step==20&&c.workers==3?window.tour.jqElm.joyride("nextTip"):window.tour.enabled&&window.tour.step==29&&c.miners==2?window.tour.jqElm.joyride("nextTip"):window.tour.enabled&&window.tour.step==33&&c.miners==3?window.tour.jqElm.joyride("nextTip"):window.tour.enabled&&window.tour.step==45&&c.workers==3&&window.tour.jqElm.joyride("nextTip");c.SendUpdatePlanetOptionsMessage();c.recalculateBuildQueueListItemsTurnsToCompleteEstimates();
c.refreshResourcesPerTurnTextBoxes()}},SendUpdatePlanetOptionsMessage:function(){Astriarch.PlanetView.planetMain.BuildLastStarShip=!0;if(!$("#BuildLastShipCheckBox").prop("checked"))Astriarch.PlanetView.planetMain.BuildLastStarShip=!1;Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_OPTIONS,payload:{planetId:Astriarch.PlanetView.planetMain.Id,farmers:Astriarch.PlanetView.farmers,miners:Astriarch.PlanetView.miners,workers:Astriarch.PlanetView.workers,BuildLastStarShip:Astriarch.PlanetView.planetMain.BuildLastStarShip}})},
SliderFarmersValueChanged:function(a,b){Astriarch.PlanetView.updatingGUI||Astriarch.PlanetView.updateSliderValues(Astriarch.PlanetView.SliderValueClicked.Farmers,b.value)},SliderMinersValueChanged:function(a,b){Astriarch.PlanetView.updatingGUI||Astriarch.PlanetView.updateSliderValues(Astriarch.PlanetView.SliderValueClicked.Miners,b.value)},SliderWorkersValueChanged:function(a,b){Astriarch.PlanetView.updatingGUI||Astriarch.PlanetView.updateSliderValues(Astriarch.PlanetView.SliderValueClicked.Workers,
b.value)},BuildLastShipCheckBoxValueChanged:function(){Astriarch.PlanetView.updatingGUI||Astriarch.PlanetView.SendUpdatePlanetOptionsMessage()},moveSelectedItemInQueue:function(a){var b=Astriarch.PlanetView.BuildQueueListBox.SelectedIndex;if(!(b==0&&a)&&(b!=Astriarch.PlanetView.BuildQueueListBox.items.length-1||a)){var c=Astriarch.PlanetView.BuildQueueListBox.items[b];Astriarch.PlanetView.BuildQueueListBox.items.splice(b,1);Astriarch.PlanetView.workingBuildQueue.splice(b,1);a?(Astriarch.PlanetView.BuildQueueListBox.items.splice(b-
1,0,c),Astriarch.PlanetView.workingBuildQueue.splice(b-1,0,c.ProductionItem),Astriarch.PlanetView.BuildQueueListBox.setSelectedIndex(b-1),Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.MOVEUP,planetId:Astriarch.PlanetView.planetMain.Id,data:b}})):(Astriarch.PlanetView.BuildQueueListBox.items.splice(b+1,0,c),Astriarch.PlanetView.workingBuildQueue.splice(b+1,0,c.ProductionItem),Astriarch.PlanetView.BuildQueueListBox.setSelectedIndex(b+
1),Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.MOVEDOWN,planetId:Astriarch.PlanetView.planetMain.Id,data:b}}));Astriarch.PlanetView.BuildQueueSelectionChanged();Astriarch.PlanetView.BuildQueueListBox.refresh()}},removeSelectedItemFromQueue:function(){var a=Astriarch.PlanetView.BuildQueueListBox.SelectedItem,b=Astriarch.PlanetView.BuildQueueListBox.SelectedIndex;a!=null&&b!=null&&
(a=a.ProductionItem.GetRefundAmount(),Astriarch.PlanetView.workingResources.GoldAmount+=a.Gold,Astriarch.PlanetView.workingResources.OreAmount+=a.Ore,Astriarch.PlanetView.workingResources.IridiumAmount+=a.Iridium,Astriarch.PlanetView.workingBuildQueue.splice(b,1),Astriarch.PlanetView.BuildQueueListBox.removeAt(b),Astriarch.PlanetView.refreshItemsAvailableCardList(),Astriarch.PlanetView.refreshCurrentWorkingResourcesTextBoxes(),Astriarch.PlanetView.showOrHideDemolishImprovementButtons(),Astriarch.PlanetView.BuildQueueSelectionChanged(),
Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.REMOVE,planetId:Astriarch.PlanetView.planetMain.Id,data:b}}))},addSelectedItemToQueue:function(){var a=Astriarch.PlanetView.ItemsAvailableCardList.getSelectedItems();if(a&&a.length){a=a[0];if(a instanceof Astriarch.PlanetView.AvailableImprovementCardListItem){if(a.CanBuild)if(Astriarch.PlanetView.workingResources.GoldAmount>=a.AvailablePlanetImprovement.GoldCost&&
Astriarch.PlanetView.workingResources.IridiumAmount>=a.AvailablePlanetImprovement.IridiumCost&&Astriarch.PlanetView.workingResources.OreAmount>=a.AvailablePlanetImprovement.OreCost){Astriarch.PlanetView.workingResources.GoldAmount-=a.AvailablePlanetImprovement.GoldCost;Astriarch.PlanetView.workingResources.IridiumAmount-=a.AvailablePlanetImprovement.IridiumCost;Astriarch.PlanetView.workingResources.OreAmount-=a.AvailablePlanetImprovement.OreCost;var b=new Astriarch.Planet.PlanetImprovement(a.AvailablePlanetImprovement.Type);
Astriarch.PlanetView.workingBuildQueue.push(b);window.tour.enabled&&(window.tour.step==19&&Astriarch.PlanetView.workingBuildQueue.length==3&&Astriarch.PlanetView.workingBuildQueue[0].Type==Astriarch.Planet.PlanetImprovementType.Farm&&Astriarch.PlanetView.workingBuildQueue[1].Type==Astriarch.Planet.PlanetImprovementType.Farm&&Astriarch.PlanetView.workingBuildQueue[2].Type==Astriarch.Planet.PlanetImprovementType.Farm?window.tour.jqElm.joyride("nextTip"):window.tour.step==28&&Astriarch.PlanetView.workingBuildQueue.length==
2&&Astriarch.PlanetView.workingBuildQueue[0].Type==Astriarch.Planet.PlanetImprovementType.Mine&&Astriarch.PlanetView.workingBuildQueue[1].Type==Astriarch.Planet.PlanetImprovementType.Mine?window.tour.jqElm.joyride("nextTip"):(window.tour.step==44&&Astriarch.PlanetView.workingBuildQueue.length==2&&Astriarch.PlanetView.workingBuildQueue[1].Type==Astriarch.Planet.PlanetImprovementType.Factory||Astriarch.PlanetView.workingBuildQueue.length==1&&Astriarch.PlanetView.workingBuildQueue[0].Type==Astriarch.Planet.PlanetImprovementType.Factory)&&
window.tour.jqElm.joyride("nextTip"));Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.ADD_IMPROVEMENT,planetId:Astriarch.PlanetView.planetMain.Id,data:a.AvailablePlanetImprovement.Type}})}else new Astriarch.Alert("Insufficient resources","Insufficient resources: (Gold/Ore/Iridium)\r\nRequires  ("+a.AvailablePlanetImprovement.GoldCost+" / "+a.AvailablePlanetImprovement.OreCost+" / "+
a.AvailablePlanetImprovement.IridiumCost+")\r\nYou have ("+Astriarch.PlanetView.workingResources.GoldAmount+" / "+Astriarch.PlanetView.workingResources.OreAmount+" / "+Astriarch.PlanetView.workingResources.IridiumAmount+")","Insufficient resources")}else a instanceof Astriarch.PlanetView.AvailableStarShipCardListItem&&a.CanBuild&&(Astriarch.PlanetView.workingResources.GoldAmount>=a.AvailableStarShip.GoldCost&&Astriarch.PlanetView.workingResources.IridiumAmount>=a.AvailableStarShip.IridiumCost&&Astriarch.PlanetView.workingResources.OreAmount>=
a.AvailableStarShip.OreCost?(Astriarch.PlanetView.workingResources.GoldAmount-=a.AvailableStarShip.GoldCost,Astriarch.PlanetView.workingResources.IridiumAmount-=a.AvailableStarShip.IridiumCost,Astriarch.PlanetView.workingResources.OreAmount-=a.AvailableStarShip.OreCost,b=new Astriarch.Planet.StarShipInProduction(a.AvailableStarShip.Type,a.AvailableStarShip.CustomShip,a.AvailableStarShip.AdvantageAgainstType,a.AvailableStarShip.DisadvantageAgainstType),Astriarch.PlanetView.workingBuildQueue.push(b),
window.tour.enabled&&Astriarch.PlanetView.workingBuildQueue.length==1&&Astriarch.PlanetView.workingBuildQueue[0].Type==Astriarch.Fleet.StarShipType.Scout&&window.tour.jqElm.joyride("resume"),Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.ADD_STARSHIP,planetId:Astriarch.PlanetView.planetMain.Id,data:{hullType:a.AvailableStarShip.Type,customShip:a.AvailableStarShip.CustomShip}}})):new Astriarch.Alert("Insufficient resources",
"Insufficient resources: (Gold/Ore/Iridium)\r\nRequires  ("+a.AvailableStarShip.GoldCost+" / "+a.AvailableStarShip.OreCost+" / "+a.AvailableStarShip.IridiumCost+")\r\nYou have ("+Astriarch.PlanetView.workingResources.GoldAmount+" / "+Astriarch.PlanetView.workingResources.OreAmount+" / "+Astriarch.PlanetView.workingResources.IridiumAmount+")","Insufficient resources"));Astriarch.PlanetView.refreshItemsAvailableCardList();Astriarch.PlanetView.refreshBuildQueueListBox();Astriarch.PlanetView.refreshCurrentWorkingResourcesTextBoxes()}},
OKClose:function(){window.tour.enabled&&(window.tour.step==21||window.tour.step==30||window.tour.step==34||window.tour.step==46)&&window.tour.jqElm.joyride("nextTip");var a=Astriarch.PlanetView;a.planetMain.UpdatePopulationWorkerTypes(a.farmers,a.miners,a.workers);a.planetMain.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats();a.planetMain.BuildQueue=[];for(var b in a.workingBuildQueue)a.planetMain.BuildQueue.push(a.workingBuildQueue[b]);b=new Astriarch.Model.WorkingPlayerResources(a.planetMain.Owner);
a.planetMain.SpendResources(Astriarch.ClientGameModel,b.GoldAmount-a.workingResources.GoldAmount,0,b.OreAmount-a.workingResources.OreAmount,b.IridiumAmount-a.workingResources.IridiumAmount,a.planetMain.Owner);a.planetMain.Owner.Resources.GoldAmount=a.workingResources.GoldAmount;a.planetMain.Owner.Resources.OreAmount=a.workingResources.OreAmount;a.planetMain.Owner.Resources.IridiumAmount=a.workingResources.IridiumAmount;Astriarch.View.PlanetViewDialogWindowClosed()},Close:function(){Astriarch.PlanetView.dialog.dlg.dialog("close")}};
Astriarch.PlanetView.BuildQueueListBoxItem=JSListBox.Item.extend({ProductionItem:null,init:function(a){this.ProductionItem=a},render:function(){var a=this.ProductionItem.ToString(),b="",b=" ("+this.ProductionItem.TurnsToComplete+")";a+=" "+Math.round(this.ProductionItem.ProductionCostComplete)+"/"+this.ProductionItem.BaseProductionCost+b;return'<a href="#">'+a+"</a>"},onClick:function(){Astriarch.PlanetView.BuildQueueSelectionChanged()}});
Astriarch.PlanetView.AvailableImprovementCardListItem=JSCardList.Item.extend({Tooltip:"",AvailablePlanetImprovement:null,CanBuild:!0,CanBuildBasedOnResources:!0,Foreground:"white",Hotkey:null,init:function(a,b){this.Tooltip=Astriarch.GameTools.PlanetImprovementTypeToHelpText(a);this.AvailablePlanetImprovement=new Astriarch.Planet.PlanetImprovement(a);this.Hotkey=b},render:function(){this.enabled=!1;if(this.CanBuild)if(this.CanBuildBasedOnResources){if(this.CanBuild)this.Foreground="white",this.enabled=
!0}else this.Foreground="yellow";else this.Foreground="darkgray";var a=Astriarch.GameTools.PlanetImprovementTypeToClassName(this.AvailablePlanetImprovement.Type);return'<a class="pvcItemAnchor" '+(this.enabled?'href="#" ':"")+'title="'+this.Tooltip+'" style="color:'+this.Foreground+'"'+(this.Hotkey?' data-hotkey="'+this.Hotkey+'"':"")+">"+('<span class="pvcItem"><span class="pvcItemName">'+Astriarch.View.GetUnderlinedHtmlForHotkey(Astriarch.GameTools.PlanetImprovementTypeToFriendlyName(this.AvailablePlanetImprovement.Type),
this.Hotkey)+'</span><div class="pvcItemImg '+a+'" /><span class="pvcItemGoldCost colorGold">'+this.AvailablePlanetImprovement.GoldCost+'</span><span class="pvcItemOreCost colorOre">'+this.AvailablePlanetImprovement.OreCost+'</span><span class="pvcItemIridiumCost colorIridium">'+this.AvailablePlanetImprovement.IridiumCost+"</span></span>")+"</a>"},onClick:function(){Astriarch.PlanetView.ItemsAvailableClicked()},onDblClick:function(){}});
Astriarch.PlanetView.AvailableStarShipCardListItem=JSCardList.Item.extend({Tooltip:"",AvailableStarShip:null,CanBuild:!0,CanBuildBasedOnResources:!0,Foreground:"white",Hotkey:null,init:function(a,b,c){var d={};b&&(d=Astriarch.ClientGameModel.MainPlayer.Research.getResearchData(a));this.AvailableStarShip=new Astriarch.Planet.StarShipInProduction(a,b,d.advantageAgainst,d.disadvantageAgainst);this.Tooltip=Astriarch.GameTools.StarShipTypeToHelpText(this.AvailableStarShip);this.Hotkey=c},render:function(){this.enabled=
!1;if(this.CanBuild)if(this.CanBuildBasedOnResources){if(this.CanBuild)this.Foreground="white",this.enabled=!0}else this.Foreground="yellow";else this.Foreground="darkgray";var a=Astriarch.GameTools.StarShipTypeToClassName(this.AvailableStarShip.Type,this.AvailableStarShip.CustomShip);return'<a class="pvcItemAnchor" '+(this.enabled?'href="#" ':"")+'title="'+this.Tooltip+'" style="color:'+this.Foreground+'"'+(this.Hotkey?' data-hotkey="'+this.Hotkey+'"':"")+">"+('<span class="pvcItem"><span class="pvcItemName">'+
Astriarch.View.GetUnderlinedHtmlForHotkey(Astriarch.GameTools.StarShipTypeToFriendlyName(this.AvailableStarShip.Type),this.Hotkey)+'</span><div class="pvcItemImg '+a+'" /><span class="pvcItemGoldCost colorGold">'+Math.floor(this.AvailableStarShip.GoldCost)+'</span><span class="pvcItemOreCost colorOre">'+Math.floor(this.AvailableStarShip.OreCost)+'</span><span class="pvcItemIridiumCost colorIridium">'+Math.floor(this.AvailableStarShip.IridiumCost)+"</span></span>")+"</a>"},onClick:function(){Astriarch.PlanetView.ItemsAvailableClicked()},
onDblClick:function(){}});Astriarch.PlanetView.SliderValueClicked={None:0,Farmers:1,Miners:2,Workers:3};Astriarch.SendShipsControl={dialog:null,pSource:null,pDest:null,distance:null,CreatedFleet:null,StarShipsAvailableCardList:null,init:function(){Astriarch.SendShipsControl.StarShipsAvailableCardList=new JSCardList({containerSelector:"StarShipsAvailableCardList",multiselect:!0});$("#ButtonSendNoShips, #ButtonSendAllShips").button();$("#ButtonSendNoShips").click(function(){Astriarch.SendShipsControl.ButtonSendNoShipsClick()});$("#ButtonSendAllShips").click(function(){Astriarch.SendShipsControl.ButtonSendAllShipsClick()});
$("#SetWaypointCheckBoxLabel").attr("title","When a waypoint is set on a planet, newly built ships will automatically be sent to the destination planet.");$("#SetWaypointCheckBox").prop("checked",!1);Astriarch.SendShipsControl.dialog=new Astriarch.Dialog("#sendShipsDialog","Send Ships",380,330,Astriarch.SendShipsControl.OKClose,Astriarch.SendShipsControl.CancelClose)},show:function(a,b,c){window.tour.enabled&&window.tour.step==56&&window.tour.jqElm.joyride("resume");Astriarch.SendShipsControl.CreatedFleet=
null;Astriarch.SendShipsControl.pSource=a;Astriarch.SendShipsControl.pDest=b;Astriarch.SendShipsControl.distance=c;$("#SendShipsDialogStatus").text(c+" parsecs from "+a.Name+" to "+b.Name);c=a.PlanetaryFleet;Astriarch.SendShipsControl.StarShipsAvailableCardList.clear();Astriarch.SendShipsControl.addAvailableStarShipCardListItems(c.StarShips[Astriarch.Fleet.StarShipType.Battleship]);Astriarch.SendShipsControl.addAvailableStarShipCardListItems(c.StarShips[Astriarch.Fleet.StarShipType.Cruiser]);Astriarch.SendShipsControl.addAvailableStarShipCardListItems(c.StarShips[Astriarch.Fleet.StarShipType.Destroyer]);
Astriarch.SendShipsControl.addAvailableStarShipCardListItems(c.StarShips[Astriarch.Fleet.StarShipType.Scout]);Astriarch.SendShipsControl.StarShipsAvailableCardList.setSelectedIndex(0);c="Waypoint not set";if(a.WayPointPlanetId){var d=Astriarch.ClientGameModel.getClientPlanetById(a.WayPointPlanetId);d&&(c="Waypoint set to planet "+d.Name)}$("#CurrentWaypointStatus").text(c);a.WayPointPlanetId==b.Id?$("#SetWaypointCheckBox").prop("checked",!0):$("#SetWaypointCheckBox").prop("checked",!1);Astriarch.SendShipsControl.dialog.setTitle("Sending Ships from "+
a.Name+" to "+b.Name);Astriarch.SendShipsControl.dialog.open()},addAvailableStarShipCardListItems:function(a){for(var b=[],c=0;c<a.length;c++)b.push(new Astriarch.SendShipsControl.AvailableStarShipCardListItem(a[c]));Astriarch.SendShipsControl.StarShipsAvailableCardList.addItems(b)},ButtonSendAllShipsClick:function(){window.tour.enabled&&window.tour.step==58&&window.tour.jqElm.joyride("nextTip");Astriarch.SendShipsControl.StarShipsAvailableCardList.selectAll()},ButtonSendNoShipsClick:function(){Astriarch.SendShipsControl.StarShipsAvailableCardList.selectNone()},
OKClose:function(){var a=Astriarch.SendShipsControl,b=a.pSource.PlanetaryFleet,c=Astriarch.SendShipsControl.StarShipsAvailableCardList.getSelectedItems();if(c.length>0){for(var d=[],e=[],g=[],f=[],h=0;h<c.length;h++){var i=c[h].StarShip;switch(i.Type){case Astriarch.Fleet.StarShipType.Scout:d.push(i.id);break;case Astriarch.Fleet.StarShipType.Destroyer:e.push(i.id);break;case Astriarch.Fleet.StarShipType.Cruiser:g.push(i.id);break;case Astriarch.Fleet.StarShipType.Battleship:f.push(i.id)}}a.CreatedFleet=
b.SplitFleetWithShipIds(d,e,g,f);a.CreatedFleet.CreateDrawnFleetAndSetDestination(Astriarch.ClientGameModel.GameGrid,a.pSource.BoundingHex,a.pDest.BoundingHex);a.pSource.OutgoingFleets.push(a.CreatedFleet);a={planetIdSource:a.pSource.Id,planetIdDest:a.pDest.Id,data:{scouts:d,destroyers:e,cruisers:g,battleships:f}};if($("#SetWaypointCheckBox").attr("checked"))Astriarch.SendShipsControl.pSource.WayPointPlanetId=Astriarch.SendShipsControl.pDest.Id,a.data.WayPointPlanetId=Astriarch.SendShipsControl.pDest.Id;
else if(Astriarch.SendShipsControl.pSource.WayPointPlanetId==Astriarch.SendShipsControl.pDest.Id)Astriarch.SendShipsControl.pSource.WayPointPlanetId=null,a.data.WayPointPlanetId=null;Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.SEND_SHIPS,payload:a})}else a.CreatedFleet=null;Astriarch.View.SendShipsDialogWindowClosed(!0);window.tour.enabled&&window.tour.step==59&&window.tour.jqElm.joyride("nextTip")},CancelClose:function(){Astriarch.View.SendShipsDialogWindowClosed(!1)},Close:function(){Astriarch.SendShipsControl.dialog.dlg.dialog("close")}};
Astriarch.SendShipsControl.AvailableStarShipCardListItem=JSCardList.Item.extend({Tooltip:"",StarShip:null,Foreground:"white",init:function(a){this.Tooltip=Astriarch.GameTools.StarShipTypeToFriendlyName(a.Type);this.StarShip=a},render:function(){var a=Astriarch.Fleet.Static.getStrengthDetailsForShips([this.StarShip]);this.Foreground=a.color;var b=this.StarShip.Level(),c=this.StarShip.ExperienceAmount/b.nextLevelExpRequirement,d=Astriarch.GameTools.StarShipTypeToClassName(this.StarShip.Type,this.StarShip.CustomShip);
return'<a class="sscItemAnchor" href="#" title="'+this.Tooltip+'" style="color:'+this.Foreground+'">'+('<span class="sscItem"><span class="sscItemHealth">'+a.damageText+'</span><div class="sscItemImg '+d+'" /><div class="sscHealthBarContainer"><div class="sscHealthBar" style="background:'+this.Foreground+";height:"+a.percentHealthText+'" /></div><div class="sscExpBarContainer"><div class="sscExpBar" style="background:#369;height:'+c*100+'%" /></div><span class="sscItemLevel">'+(b.level+1)+"</span></span>")+
"</a>"},onClick:function(){window.tour.enabled&&window.tour.step==58&&window.tour.jqElm.joyride("nextTip")},onDblClick:function(){}});Astriarch.PlanetaryConflictControl={dialog:null,planetaryConflictMessage:null,init:function(){Astriarch.PlanetaryConflictControl.dialog=new Astriarch.Dialog("#planetaryConflictDialog","Planetary Conflict",424,323,Astriarch.PlanetaryConflictControl.OKClose);$("#NeverShowPlanetaryConflictPopupsCheckbox").change(function(){window.tour.enabled&&window.tour.step==61&&this.checked&&window.tour.jqElm.joyride("nextTip")})},show:function(a){window.tour.enabled&&window.tour.step==59&&window.tour.jqElm.joyride("resume");
Astriarch.PlanetaryConflictControl.planetaryConflictMessage=a;var b="";b+=a.Message+"<br />";var c="";if(a.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetCaptured||a.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetLost)if(c="No Resources Looted.",a.Data.FoodAmountLooted!=0||a.Data.GoldAmountLooted!=0||a.Data.OreAmountLooted!=0||a.Data.IridiumAmountLooted!=0||a.Data.ResearchAmountLooted!=0)c="",c+=a.Data.FoodAmountLooted!=0?Astriarch.DecimalToFixed(a.Data.FoodAmountLooted,
2)+" Food":"",c+=a.Data.GoldAmountLooted!=0?(c?", ":"")+Astriarch.DecimalToFixed(a.Data.GoldAmountLooted,2)+" Gold":"",c+=a.Data.OreAmountLooted!=0?(c?", ":"")+Astriarch.DecimalToFixed(a.Data.OreAmountLooted,2)+" Ore":"",c+=a.Data.IridiumAmountLooted!=0?(c?", ":"")+Astriarch.DecimalToFixed(a.Data.IridiumAmountLooted,2)+" Iridium":"",c+=a.Data.ResearchAmountLooted!=0?(c?", ":"")+Astriarch.DecimalToFixed(a.Data.ResearchAmountLooted,2)+" Research":"",c="Resources looted: "+c;b+=c+"<br />";var c=a.Data.AttackingFleet.DetermineFleetStrength(),
d=a.Data.AttackingFleetResearchBoostAttack?", +"+a.Data.AttackingFleetResearchBoostAttack/2*100+"% Attack":"";d+=a.Data.AttackingFleetResearchBoostDefense?", +"+a.Data.AttackingFleetResearchBoostDefense/2*100+"% Defense":"";b+="Attacking Fleet (strength "+c+", Chance to Win: "+a.Data.AttackingFleetChances+"%"+d+"): <br />";b+=a.Data.AttackingFleet.ToString()+"<br /><br />";c=a.Data.DefendingFleet.DetermineFleetStrength();d=a.Data.DefendingFleetResearchBoostAttack?", +"+a.Data.DefendingFleetResearchBoostAttack/
2*100+"% Attack":"";d+=a.Data.DefendingFleetResearchBoostDefense?", +"+a.Data.DefendingFleetResearchBoostDefense/2*100+"% Defense":"";b+="Defending Fleet (strength "+c+d+"): <br />";b+=a.Data.DefendingFleet.ToString()+"<br /><br />";b+="Ships Remaining: <br />";b+=a.Data.WinningFleet.ToString()+"<br />";Astriarch.PlayerGameOptions.ShowPlanetaryConflictPopups?$("#NeverShowPlanetaryConflictPopupsCheckbox").prop("checked",!1):$("#NeverShowPlanetaryConflictPopupsCheckbox").prop("checked",!0);$("#PlanetaryConflictSummary").html(b);
b=a.Data.AttackingPlayer.Name;c=Astriarch.GameTools.PlanetOwnerToFriendlyName(a.Planet.Type,a.Data.DefendingPlayer);Astriarch.PlanetaryConflictControl.dialog.setTitle(b+" Attacked "+c+" at Planet: "+a.Planet.Name);Astriarch.PlanetaryConflictControl.dialog.open()},OKClose:function(){Astriarch.PlayerGameOptions.ShowPlanetaryConflictPopups=!0;if($("#NeverShowPlanetaryConflictPopupsCheckbox").attr("checked"))Astriarch.PlayerGameOptions.ShowPlanetaryConflictPopups=!1;setTimeout(function(){Astriarch.GameController.processNextEndOfTurnPlanetaryConflictMessage()},
100);window.tour.enabled&&window.tour.step==62&&window.tour.jqElm.joyride("nextTip")},Close:function(){Astriarch.PlanetaryConflictControl.dialog.dlg.dialog("close")}};Astriarch.GameOverControl={dialog:null,winningSerializablePlayer:null,init:function(){Astriarch.GameOverControl.dialog=new Astriarch.Dialog("#gameOverDialog","Game Over",424,313,Astriarch.GameOverControl.OKClose)},show:function(a,b,c){Astriarch.GameOverControl.winningSerializablePlayer=a;var d="";d+=b?"You conquered all of your enemies and reign supreme over the known universe!<br />You will be known as the first Astriarch - Ruler of the Stars.<br />":"You lost control over all your fleets and planets and have been crushed by the power of your enemies!<br />";
d+="In "+Astriarch.ClientGameModel.Turn.Number+" turns.<br />";a?(d+=a.Name+" won the game with "+a.OwnedPlanetIds.length+" planets.<br />",Astriarch.GameOverControl.dialog.setTitle("Game Over, Player: "+a.Name+" Wins!")):(d+="Other Players are still battling it out to earn the title of Astriarch.<br />",Astriarch.GameOverControl.dialog.setTitle("Game Over, Other Players Still Fighting!"));d+="<br />Your points: "+c;AstriarchExtern.OnGameOver({PlayerWon:b,Turns:Astriarch.ClientGameModel.Turn.Number,
Score:c});$("#GameOverSummary").html(d);Astriarch.GameOverControl.dialog.open()},OKClose:function(){Astriarch.GameController.GameOverControlClosed()}};Astriarch.Alert=function(a,b){$("#AstriarchAlertBox").html(b);this.dlg=$("#AstriarchAlertBox").dialog({autoOpen:!0,title:a,width:200,height:120,modal:!0})};Astriarch.TradingControl={dialog:null,planet:null,tradesSubmittedListBox:null,playerResourceAmountsAfterTrades:{food:0,ore:0,iridium:0},jqElm:{tradeResourceAmount:null,tradeResourceEstimatedPrice:null},init:function(){Astriarch.TradingControl.jqElm.tradeResourceAmount=$("#TradeResourceAmount");Astriarch.TradingControl.jqElm.tradeResourceEstimatedPrice=$("#TradeResourceEstimatedPrice");Astriarch.TradingControl.jqElm.buttonSubmitTrade=$("#ButtonSubmitTrade");$("#SliderTradeResourceAmount").slider({value:0,
step:1,min:0,max:10,slide:Astriarch.TradingControl.SliderTradeResourceAmountValueChanged});$("#ButtonTradesSubmittedRetractSelectedTrade").button({icons:{primary:"icon-16x16-build-queue-remove"},text:!1});$("#ButtonTradesSubmittedRetractSelectedTrade").button("disable");$("#ButtonTradesSubmittedRetractSelectedTrade").click(function(){Astriarch.TradingControl.ButtonRetractSelectedTradeClick()});$("#TradeTypeRadio").buttonset();$("#TradeResourceRadioFood").button({icons:{primary:"icon-16x16-food"}});
$("#TradeResourceRadioOre").button({icons:{primary:"icon-16x16-ore"}});$("#TradeResourceRadioIridium").button({icons:{primary:"icon-16x16-iridium"}});$("#TradeResourceRadio").buttonset();Astriarch.TradingControl.jqElm.buttonSubmitTrade.button();Astriarch.TradingControl.jqElm.buttonSubmitTrade.button("disable");Astriarch.TradingControl.jqElm.buttonSubmitTrade.click(function(){window.tour.enabled&&window.tour.step==38&&window.tour.jqElm.joyride("nextTip");Astriarch.TradingControl.ButtonSubmitTradeClick()});
$("input[name=TradeTypeRadioGroup]:radio").change(function(){Astriarch.TradingControl.setSliderPropertiesBasedOnNewTradeOptions()});$("input[name=TradeResourceRadioGroup]:radio").change(function(){Astriarch.TradingControl.setSliderPropertiesBasedOnNewTradeOptions()});Astriarch.TradingControl.tradesSubmittedListBox=new JSListBox({containerSelector:"TradesSubmittedListBox"});Astriarch.TradingControl.dialog=new Astriarch.Dialog("#tradingControlDialog","Galactic Trading Center",470,425,Astriarch.TradingControl.OKClose)},
show:function(a){Astriarch.TradingControl.planet=a;Astriarch.TradingControl.dialog.setTitle("Galactic Trading Center, Trading from: "+a.Name);Astriarch.TradingControl.dialog.open();this.refreshTradesSubmittedListBox();this.setSliderPropertiesBasedOnNewTradeOptions()},refreshStatsFromClientTradingCenter:function(){var a=Astriarch.ClientGameModel.ClientTradingCenter;$("#tcdStockpilePriceFood").text(Astriarch.DecimalToFixed(a.foodResource.currentPrice,2));$("#tcdTradingCenterAmtFood").text(a.foodResource.amount);
$("#tcdStockpileAmtFood").text(Math.floor(this.playerResourceAmountsAfterTrades.food));$("#tcdStockpilePriceOre").text(Astriarch.DecimalToFixed(a.oreResource.currentPrice,2));$("#tcdTradingCenterAmtOre").text(a.oreResource.amount);$("#tcdStockpileAmtOre").text(Math.floor(this.playerResourceAmountsAfterTrades.ore));$("#tcdStockpilePriceIridium").text(Astriarch.DecimalToFixed(a.iridiumResource.currentPrice,2));$("#tcdTradingCenterAmtIridium").text(a.iridiumResource.amount);$("#tcdStockpileAmtIridium").text(Math.floor(this.playerResourceAmountsAfterTrades.iridium));
$("#tcdTradingCenterAmtGold").text(Astriarch.DecimalToFixed(a.goldAmount,2))},refreshTradesSubmittedListBox:function(){Astriarch.TradingControl.setPlayerResourceAmountAfterCurrentTrades();Astriarch.TradingControl.tradesSubmittedListBox.clear();for(var a in Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades){var b=new Astriarch.TradingControl.TradeListBoxItem(Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades[a]);Astriarch.TradingControl.tradesSubmittedListBox.addItem(b)}},
setSliderPropertiesBasedOnNewTradeOptions:function(){var a=this.getSubmitTradeRadioButtonOptions(),b=0,b=Astriarch.ClientGameModel.ClientTradingCenter,b=a.tradeType==Astriarch.TradingCenter.TradeType.BUY?a.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?Math.min(b.foodResource.amount,b.foodResource.tradeAmountMax):a.resourceType==Astriarch.TradingCenter.ResourceType.ORE?Math.min(b.oreResource.amount,b.oreResource.tradeAmountMax):Math.min(b.iridiumResource.amount,b.iridiumResource.tradeAmountMax):
a.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?Math.min(this.playerResourceAmountsAfterTrades.food,b.foodResource.tradeAmountMax):a.resourceType==Astriarch.TradingCenter.ResourceType.ORE?Math.min(this.playerResourceAmountsAfterTrades.ore,b.oreResource.tradeAmountMax):Math.min(this.playerResourceAmountsAfterTrades.iridium,b.iridiumResource.tradeAmountMax);this.jqElm.tradeResourceAmount.text(0);this.jqElm.tradeResourceEstimatedPrice.text(0);Astriarch.TradingControl.jqElm.buttonSubmitTrade.button("disable");
$("#SliderTradeResourceAmount").slider("value",0);$("#SliderTradeResourceAmount").slider("option","max",b)},setPlayerResourceAmountAfterCurrentTrades:function(){var a=Astriarch.ClientGameModel.MainPlayer;this.playerResourceAmountsAfterTrades={food:a.TotalFoodAmount(),ore:a.TotalOreAmount(),iridium:a.TotalIridiumAmount()};for(var b in Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades){var a=Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades[b],c=a.tradeType==Astriarch.TradingCenter.TradeType.BUY?
a.amount:-1*a.amount;a.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?this.playerResourceAmountsAfterTrades.food+=c:a.resourceType==Astriarch.TradingCenter.ResourceType.ORE?this.playerResourceAmountsAfterTrades.ore+=c:this.playerResourceAmountsAfterTrades.iridium+=c}this.refreshStatsFromClientTradingCenter()},SliderTradeResourceAmountValueChanged:function(a,b){var c=b.value;Astriarch.TradingControl.jqElm.tradeResourceAmount.text(c);c==0?Astriarch.TradingControl.jqElm.buttonSubmitTrade.button("disable"):
Astriarch.TradingControl.jqElm.buttonSubmitTrade.button("enable");var d=0,d=Astriarch.TradingControl.getSubmitTradeRadioButtonOptions(),e=Astriarch.ClientGameModel.ClientTradingCenter,d=d.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?e.foodResource.currentPrice*c:d.resourceType==Astriarch.TradingCenter.ResourceType.ORE?e.oreResource.currentPrice*c:e.iridiumResource.currentPrice*c;Astriarch.TradingControl.jqElm.tradeResourceEstimatedPrice.text(Astriarch.DecimalToFixed(d,2))},ButtonSubmitTradeClick:function(){var a=
this.getSubmitTradeRadioButtonOptions(),b=parseInt(this.jqElm.tradeResourceAmount.text()),a=new Astriarch.TradingCenter.Trade(-1,this.planet.Id,a.tradeType,a.resourceType,b,Astriarch.TradingCenter.OrderType.MARKET,null);Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.SUBMIT_TRADE,payload:{trade:a}});Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades.push(a);this.refreshTradesSubmittedListBox()},ButtonRetractSelectedTradeClick:function(){var a=Astriarch.TradingControl.tradesSubmittedListBox.SelectedIndex;
Astriarch.TradingControl.tradesSubmittedListBox.SelectedItem!=null&&a!=null&&(Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CANCEL_TRADE,payload:{tradeIndex:a,planetId:this.planet.Id}}),Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades.splice(a,1),this.refreshTradesSubmittedListBox())},getSubmitTradeRadioButtonOptions:function(){var a={tradeType:null,resourceType:null};a.tradeType=$("input:radio[name=TradeTypeRadioGroup]:checked").val();a.tradeType=a.tradeType==
"buy"?Astriarch.TradingCenter.TradeType.BUY:Astriarch.TradingCenter.TradeType.SELL;a.resourceType=$("input:radio[name=TradeResourceRadioGroup]:checked").val();a.resourceType=a.resourceType=="food"?Astriarch.TradingCenter.ResourceType.FOOD:a.resourceType=="ore"?Astriarch.TradingCenter.ResourceType.ORE:Astriarch.TradingCenter.ResourceType.IRIDIUM;return a},TradesSubmittedSelectionChanged:function(){$("#ButtonTradesSubmittedRetractSelectedTrade").button("disable");Astriarch.TradingControl.tradesSubmittedListBox.SelectedItem!=
null&&$("#ButtonTradesSubmittedRetractSelectedTrade").button("enable")},OKClose:function(){window.tour.enabled&&window.tour.step==39&&window.tour.jqElm.joyride("nextTip")},Close:function(){Astriarch.TradingControl.dialog.dlg.dialog("close")}};Astriarch.TradingControl.TradeListBoxItem=JSListBox.Item.extend({Trade:null,init:function(a){this.Trade=a},render:function(){return'<a href="#">'+Astriarch.TradingCenter.TradeToString(this.Trade)+"</a>"},onClick:function(){Astriarch.TradingControl.TradesSubmittedSelectionChanged()}});Astriarch.ResearchControl={dialog:null,researchItemsCompleteListBox:null,jqElm:{},init:function(){Astriarch.ResearchControl.jqElm.buttonSubmitCustomShip=$("#ButtonSubmitCustomShip");Astriarch.ResearchControl.jqElm.sliderResearchPercent=$("#SliderResearchPercent");Astriarch.ResearchControl.jqElm.buttonIncreaseResearch=$("#ButtonIncreaseResearch");Astriarch.ResearchControl.jqElm.researchPercentDescription=$("#ResearchPercentDescription");Astriarch.ResearchControl.jqElm.taxPercentDescription=$("#TaxPercentDescription");
Astriarch.ResearchControl.jqElm.buttonIncreaseTaxes=$("#ButtonIncreaseTaxes");Astriarch.ResearchControl.jqElm.researchNewShipTypeHullType=$("#ResearchNewShipTypeHullType");Astriarch.ResearchControl.jqElm.researchNewShipTypeAdvantageBox=$("#ResearchNewShipTypeAdvantageBox");Astriarch.ResearchControl.jqElm.researchNewShipTypeDisadvantageBox=$("#ResearchNewShipTypeDisadvantageBox");Astriarch.ResearchControl.jqElm.sliderResearchPercent.slider({value:0,step:10,min:0,max:100,slide:function(a,b){Astriarch.ResearchControl.SliderResearchPercentValueChanged(b.value)}});
Astriarch.ResearchControl.jqElm.buttonSubmitCustomShip.button();Astriarch.ResearchControl.jqElm.buttonSubmitCustomShip.click(function(){Astriarch.ResearchControl.ButtonSubmitCustomShipClick()});Astriarch.ResearchControl.jqElm.buttonIncreaseResearch.button({icons:{primary:"icon-16x16-research"},text:!1});Astriarch.ResearchControl.jqElm.buttonIncreaseResearch.click(function(){var a=Astriarch.ResearchControl.jqElm.sliderResearchPercent.slider("value")+10;Astriarch.ResearchControl.SliderResearchPercentValueChanged(a)});
Astriarch.ResearchControl.jqElm.buttonIncreaseTaxes.button({icons:{primary:"icon-16x16-credits"},text:!1});Astriarch.ResearchControl.jqElm.buttonIncreaseTaxes.click(function(){var a=Astriarch.ResearchControl.jqElm.sliderResearchPercent.slider("value")-10;Astriarch.ResearchControl.SliderResearchPercentValueChanged(a)});Astriarch.ResearchControl.researchTypeProgressCardList=new JSCardList({containerSelector:"ResearchTypeProgressCardList",multiselect:!1});Astriarch.ResearchControl.dialog=new Astriarch.Dialog("#researchControlDialog",
"Research and Development",470,425,Astriarch.ResearchControl.OKClose)},show:function(){Astriarch.ResearchControl.dialog.open();this.refreshUIFromState()},refreshUIFromState:function(){this.refreshResearchPercentSliderArea();this.refreshResearchTypeProgressCardList();this.refreshInDesignResearchArea()},refreshResearchPercentSliderArea:function(){var a=Astriarch.ClientGameModel.MainPlayer.Research.researchPercent*100;Astriarch.ResearchControl.jqElm.researchPercentDescription.text(a);Astriarch.ResearchControl.jqElm.taxPercentDescription.text(100-
a);Astriarch.ResearchControl.jqElm.sliderResearchPercent.slider("value",a)},refreshInDesignResearchArea:function(){var a="No active research project. Click on a research area below to have your scientists and engineers start researching in that area.";Astriarch.ClientGameModel.MainPlayer.Research.researchTypeInQueue&&(a="Currently Researching: "+Astriarch.ClientGameModel.MainPlayer.Research.researchProgressByType[Astriarch.ClientGameModel.MainPlayer.Research.researchTypeInQueue].ToString(!0)+", Estimated Turns Remaining: "+
Astriarch.ClientGameModel.MainPlayer.Research.estimateTurnsRemainingInQueue(Astriarch.ClientGameModel.MainPlayer.GetTaxRevenueAtMaxPercent()));$("#CurrentResearchProjectStatusArea").html(a);$("#CurrentResearchAreaCustomShipDetails").hide();$("#CurrentResearchProjectStatusArea").show()},SliderResearchPercentValueChanged:function(a){if(!(a<0||a>100))a/=100,Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.ADJUST_RESEARCH_PERCENT,payload:{researchPercent:a}}),Astriarch.ClientGameModel.MainPlayer.Research.researchPercent=
a,this.refreshResearchPercentSliderArea(),this.refreshInDesignResearchArea()},buildCustomShipComboBoxes:function(a){a=a.ResearchTypeProgress.type==Astriarch.Research.ResearchType.NEW_SHIP_TYPE_DEFENDER?"":'<option value="1">Defenders</option>';Astriarch.ResearchControl.jqElm.researchNewShipTypeAdvantageBox.html('<select id="ResearchNewShipTypeAdvantageComboBox">'+a+'<option value="2" selected="">Scouts</option><option value="3">Destroyers</option><option value="4">Cruisers</option><option value="5"">Battleships</option></select>');
Astriarch.ResearchControl.jqElm.researchNewShipTypeDisadvantageBox.html('<select id="ResearchNewShipTypeDisadvantageComboBox">'+a+'<option value="2" selected="">Scouts</option><option value="3">Destroyers</option><option value="4">Cruisers</option><option value="5"">Battleships</option></select>');$("select#ResearchNewShipTypeAdvantageComboBox").selectmenu({width:110});$("select#ResearchNewShipTypeDisadvantageComboBox").selectmenu({width:110})},ButtonSubmitCustomShipClick:function(){var a=Astriarch.ResearchControl.researchTypeProgressCardList.getSelectedItems();
if(a&&a.length){var a=a[0],b={};b.advantageAgainst=Number($("select#ResearchNewShipTypeAdvantageComboBox").val());b.disadvantageAgainst=Number($("select#ResearchNewShipTypeDisadvantageComboBox").val());this.SubmitResearchTypeProgress(a.ResearchTypeProgress.type,b)}},SubmitResearchTypeProgress:function(a,b){Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.SUBMIT_RESEARCH_ITEM,payload:{researchItem:{type:a,data:b}}});Astriarch.ClientGameModel.MainPlayer.Research.setResearchTypeProgressInQueue(a,
b);this.refreshInDesignResearchArea()},refreshResearchTypeProgressCardList:function(){var a=[],b=null,c;for(c in Astriarch.ClientGameModel.MainPlayer.Research.researchProgressByType){var d=new Astriarch.ResearchControl.ResearchTypeProgressCardListItem(Astriarch.ClientGameModel.MainPlayer.Research.researchProgressByType[c]);a.push(d);Astriarch.ClientGameModel.MainPlayer.Research.researchTypeInQueue==c&&(b=d)}Astriarch.ResearchControl.researchTypeProgressCardList.setItems(a);b&&Astriarch.ResearchControl.researchTypeProgressCardList.setSelectedItem(b)},
ResearchTypeProgressCardListItemClicked:function(){var a=Astriarch.ResearchControl.researchTypeProgressCardList.getSelectedItems();a&&a.length&&(a=a[0],a.ResearchTypeProgress.isCustomShip&&!a.ResearchTypeProgress.researchPointsCompleted?($("#CurrentResearchProjectStatusArea").hide(),$("#CurrentResearchAreaCustomShipDetails").show(),Astriarch.ResearchControl.jqElm.researchNewShipTypeHullType.text(a.ResearchTypeProgress.GetFriendlyName()),Astriarch.ResearchControl.buildCustomShipComboBoxes(a)):(this.SubmitResearchTypeProgress(a.ResearchTypeProgress.type,
a.ResearchTypeProgress.data),this.refreshInDesignResearchArea()))},OKClose:function(){window.tour.enabled&&window.tour.step==39&&window.tour.jqElm.joyride("nextTip");Astriarch.View.updatePlayerStatusPanel()},Close:function(){Astriarch.ResearchControl.dialog.dlg.dialog("close")}};
Astriarch.ResearchControl.ResearchTypeProgressCardListItem=JSCardList.Item.extend({Tooltip:"",ResearchTypeProgress:null,CanResearch:!0,Foreground:"white",Hotkey:null,init:function(a,b){this.Tooltip=a.researchPointsCompleted?a.GetCurrentLevelDataString():Astriarch.GameTools.ResearchTypeToHelpText(a.type);this.ResearchTypeProgress=a;this.CanResearch=this.ResearchTypeProgress.canResearch();this.Hotkey=b},render:function(){this.enabled=!1;this.CanResearch?(this.Foreground="white",this.enabled=!0):this.Foreground=
"darkgray";var a=Astriarch.GameTools.ResearchTypeToClassName(this.ResearchTypeProgress.type),b=this.ResearchTypeProgress.GetResearchLevelData();return'<a class="rtpItemAnchor" '+(this.enabled?'href="#" ':"")+'title="'+this.Tooltip+'" style="color:'+this.Foreground+'"'+(this.Hotkey?' data-hotkey="'+this.Hotkey+'"':"")+">"+('<span class="rtpItem"><span class="rtpItemName"></span><div class="rtpItemImg '+a+'" /><div class="rtpPercentCompleteContainer"><div class="rtpHealthBar" style="background:#369;height:'+
(this.CanResearch?b.percentComplete*100:0)+'%" /></div><span class="rtpItemLevel">'+(b.currentResearchLevel||"")+"</span></span>")+"</a>"},onClick:function(){Astriarch.ResearchControl.ResearchTypeProgressCardListItemClicked()},onDblClick:function(){}});Astriarch=Astriarch||require("./astriarch_base");Astriarch.LocalStorageInterface={Prefs:{gameName:"New Game",playerName:"Player"},Key:"astriarch_prefs"};Astriarch.LocalStorageInterface.savePrefs=function(){if(localStorage){var a=JSON.stringify(Astriarch.LocalStorageInterface.Prefs);a!=null&&localStorage.setItem(Astriarch.LocalStorageInterface.Key,a)}};
Astriarch.LocalStorageInterface.loadPrefs=function(){var a=Astriarch.LocalStorageInterface.Prefs;if(localStorage){var b=localStorage.getItem(Astriarch.LocalStorageInterface.Key);if(b!=null)try{var c=JSON.parse(b);if(c)Astriarch.LocalStorageInterface.Prefs=c}catch(d){}}return a};Astriarch.LocalStorageInterface.loadPrefs();var Astriarch=Astriarch||require("./astriarch_base"),require=require||function(){},extend=typeof jQuery!="undefined"?jQuery.extend:require("extend");Astriarch.SavedGameInterface={};Astriarch.SavedGameInterface.findCircularReferences=function(a,b,c,d){d||(d=[]);if(!(a==null||typeof a!="object"))for(var e in d.indexOf(a)==-1?d.push(a):alert("found circular reference: "+c+"."+b),a)Astriarch.SavedGameInterface.findCircularReferences(a[e],e,b,d)};
Astriarch.SavedGameInterface.getModelFromSerializableModel=function(a){var b=[],c=new Astriarch.Model(b,a.GameOptions,!0);c.ShowUnexploredPlanetsAndEnemyPlayerStats=a.ShowUnexploredPlanetsAndEnemyPlayerStats;c.Turn=extend(!0,c.Turn,a.Turn);c.TradingCenter=new Astriarch.TradingCenter(a.SerializablePlayers.length);c.TradingCenter.goldAmount=a.TradingCenter.goldAmount;c.TradingCenter.currentTrades=a.TradingCenter.currentTrades;c.TradingCenter.foodResource=Astriarch.SavedGameInterface.getTradingCenterResourceFromSerializableTradingCenterResource(a.TradingCenter.foodResource);
c.TradingCenter.oreResource=Astriarch.SavedGameInterface.getTradingCenterResourceFromSerializableTradingCenterResource(a.TradingCenter.oreResource);c.TradingCenter.iridiumResource=Astriarch.SavedGameInterface.getTradingCenterResourceFromSerializableTradingCenterResource(a.TradingCenter.iridiumResource);var d=[],e={},g;for(g in a.SerializablePlanets){var f=a.SerializablePlanets[g],h=Astriarch.SavedGameInterface.getPlanetFromSerializedPlanet(f,c.GameGrid);d.push(h);e[h.Id]=h}for(g in a.SerializablePlayers)b.push(Astriarch.SavedGameInterface.getPlayerFromSerializedPlayer(c.GameGrid,
a.SerializablePlayers[g],e));var i={},j={};for(g in b)f=b[g],i[f.Id]=f,j[f.Id]=new Astriarch.ClientPlayer(f.Id,f.Type,f.Name,f.Color,f.Points,f.CurrentTurnEnded,f.Destroyed,f.Research);for(g in a.SerializablePlayersDestroyed)f=a.SerializablePlayersDestroyed[g],f=Astriarch.SavedGameInterface.getPlayerFromSerializedPlayer(c.GameGrid,f,e),c.PlayersDestroyed.push(f),i[f.Id]=f,j[f.Id]=new Astriarch.ClientPlayer(f.Id,f.Type,f.Name,f.Color,f.Points,f.CurrentTurnEnded,f.Destroyed,f.Research);for(g in a.SerializablePlayers)f=
a.SerializablePlayers[g],h=i[f.Id],Astriarch.SavedGameInterface.setPlayerLastKnownPlanetFleetStrength(h,f,c.GameGrid,j);c.Planets=d;return c};Astriarch.SavedGameInterface.getTradingCenterResourceFromSerializableTradingCenterResource=function(a){return new Astriarch.TradingCenter.Resource(a.type,a.amount,a.desiredAmount,a.priceMin,a.priceMax,a.tradeAmountMax)};
Astriarch.SavedGameInterface.setPlayerLastKnownPlanetFleetStrength=function(a,b,c,d){for(var e in b.LastKnownPlanetSerializableFleetStrength){var g=b.LastKnownPlanetSerializableFleetStrength[e],f=null;g.LastKnownOwnerId&&(f=d[g.LastKnownOwnerId]);var h=Astriarch.SavedGameInterface.getFleetFromSerializableFleet(f,g.SerializableFleet,c),f=new Astriarch.Fleet.LastKnownFleet(h,f);f.TurnLastExplored=g.TurnLastExplored;a.LastKnownPlanetFleetStrength[e]=f}};
Astriarch.SavedGameInterface.getPlanetFromSerializedPlanet=function(a,b){var c=b.GetHexAt(a.OriginPoint),c=new Astriarch.Planet(a.Type,a.Name,c,null);c.Id=a.Id;c.Population=a.Population;c.RemainderProduction=a.RemainderProduction;for(var d in a.BuildQueue){var e=a.BuildQueue[d];e&&(e=Astriarch.SavedGameInterface.getPlanetProductionItemFromSerializedPlanetProductionItem(e),c.BuildQueue.push(e))}c.BuiltImprovements=a.BuiltImprovements;c.MaxImprovements=a.MaxImprovements;c.Resources=extend(!0,c.Resources,
a.Resources);c.OriginPoint=a.OriginPoint;c.PlanetaryFleet=Astriarch.SavedGameInterface.getFleetFromSerializableFleet(null,a.PlanetarySerializableFleet,b);for(d in a.OutgoingSerializableFleets)c.OutgoingFleets.push(Astriarch.SavedGameInterface.getFleetFromSerializableFleet(null,a.OutgoingSerializableFleets[d],b));c.PlanetHappiness=a.PlanetHappiness;c.StarShipTypeLastBuilt=a.StarShipTypeLastBuilt;c.StarShipCustomShipLastBuilt=a.StarShipCustomShipLastBuilt;c.BuildLastStarShip=a.BuildLastStarShip;c.WayPointPlanetId=
a.WayPointPlanetId;c.ResourcesPerTurn=new Astriarch.Planet.PlanetPerTurnResourceGeneration(c,c.Type);c.maxPopulation=c.MaxImprovements;return c};
Astriarch.SavedGameInterface.getPlayerFromSerializedPlayer=function(a,b,c,d){var e=new Astriarch.Player(b.Id,b.Type,b.Name);e.Resources=extend(!0,e.Resources,b.Resources);e.Research=extend(!0,e.Research,b.Research);for(var g in e.Research.researchProgressByType){var f=e.Research.researchProgressByType[g];e.Research.researchProgressByType[g]=new Astriarch.Research.ResearchTypeProgress(f.type,f.researchPointsCompleted,f.data)}b.Color=extend(!0,new Astriarch.Util.ColorRGBA(0,0,0,0),b.Color);e.Type==
Astriarch.Player.PlayerType.Human?e.Color=b.Color:e.SetColor(b.Color);e.LastTurnFoodNeededToBeShipped=b.LastTurnFoodNeededToBeShipped;e.Options=b.Options;for(var h in b.OwnedPlanetIds){g=c[b.OwnedPlanetIds[h]];g.SetPlanetOwner(e);g.PlanetaryFleet.Owner=e;for(var i in g.OutgoingFleets)g.OutgoingFleets[i].Owner=e;g.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats()}for(h in b.KnownPlanetIds)i=b.KnownPlanetIds[h],e.KnownClientPlanets[i]=i in c?c[i].GetClientPlanet():d[i];for(h in b.PlanetBuildGoals)if(c=
b.PlanetBuildGoals[h])c=Astriarch.SavedGameInterface.getPlanetProductionItemFromSerializedPlanetProductionItem(c),e.PlanetBuildGoals[h]=c;e.HomePlanetId=b.HomePlanetId;e.EarnedPointsByType=b.EarnedPointsByType;e.Points=b.Points;for(h in b.SerializableFleetsInTransit)e.FleetsInTransit.push(Astriarch.SavedGameInterface.getFleetFromSerializableFleet(e,b.SerializableFleetsInTransit[h],a));e.CurrentTurnEnded=b.CurrentTurnEnded;e.Destroyed=b.Destroyed;return e};
Astriarch.SavedGameInterface.getPlanetProductionItemFromSerializedPlanetProductionItem=function(a){var b=null;a.PlanetProductionItemType==Astriarch.Planet.PlanetProductionItemType.PlanetImprovement?b=new Astriarch.Planet.PlanetImprovement(a.Type):a.PlanetProductionItemType==Astriarch.Planet.PlanetProductionItemType.StarShipInProduction?b=new Astriarch.Planet.StarShipInProduction(a.Type,a.CustomShip,a.AdvantageAgainstType,a.DisadvantageAgainstType):a.PlanetProductionItemType==Astriarch.Planet.PlanetProductionItemType.PlanetImprovementToDestroy&&
(b=new Astriarch.Planet.PlanetImprovementToDestroy(a.Type));return extend(!0,b,a)};
Astriarch.SavedGameInterface.getFleetFromSerializableFleet=function(a,b,c){var a=new Astriarch.Fleet(a),d;for(d in b.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]){var e=extend(!0,new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.SystemDefense),b.StarShips[Astriarch.Fleet.StarShipType.SystemDefense][d]);a.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].push(e)}for(d in b.StarShips[Astriarch.Fleet.StarShipType.Scout])e=extend(!0,new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Scout),
b.StarShips[Astriarch.Fleet.StarShipType.Scout][d]),a.StarShips[Astriarch.Fleet.StarShipType.Scout].push(e);for(d in b.StarShips[Astriarch.Fleet.StarShipType.Destroyer])e=extend(!0,new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Destroyer),b.StarShips[Astriarch.Fleet.StarShipType.Destroyer][d]),a.StarShips[Astriarch.Fleet.StarShipType.Destroyer].push(e);for(d in b.StarShips[Astriarch.Fleet.StarShipType.Cruiser])e=extend(!0,new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Cruiser),
b.StarShips[Astriarch.Fleet.StarShipType.Cruiser][d]),a.StarShips[Astriarch.Fleet.StarShipType.Cruiser].push(e);for(d in b.StarShips[Astriarch.Fleet.StarShipType.Battleship])e=extend(!0,new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Battleship),b.StarShips[Astriarch.Fleet.StarShipType.Battleship][d]),a.StarShips[Astriarch.Fleet.StarShipType.Battleship].push(e);for(d in b.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform])e=extend(!0,new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.SpacePlatform),
b.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform][d]),a.StarShips[Astriarch.Fleet.StarShipType.SpacePlatform].push(e);a.LocationHex=null;if(b.LocationHexMidPoint)a.LocationHex=c.GetHexAt(b.LocationHexMidPoint);if(b.travelingFromHexMidPoint){d=c.GetHexAt(b.travelingFromHexMidPoint);var e=c.GetHexAt(b.DestinationHexMidPoint),g=c.GetHexDistance(d,e);a.SetDestination(c,d,e,b.ParsecsToDestination,g)}return a};
Astriarch.SerializableModel=function(a){this.GameOptions=a.GameOptions;this.Turn=a.Turn;this.TradingCenter=a.TradingCenter;this.SerializablePlayers=[];for(var b in a.Players)this.SerializablePlayers.push(new Astriarch.SerializablePlayer(a.Players[b]));this.SerializablePlayersDestroyed=[];for(b in a.PlayersDestroyed)this.SerializablePlayersDestroyed.push(new Astriarch.SerializablePlayer(a.PlayersDestroyed[b]));this.SerializablePlanets=[];for(b in a.Planets)this.SerializablePlanets.push(new Astriarch.SerializablePlanet(a.Planets[b]));
this.Version=Astriarch.Version};
Astriarch.SerializablePlayer=function(a){this.Id=a.Id;this.Type=a.Type;this.Name=a.Name;this.Resources=a.Resources;this.Research=a.Research;this.Color=a.Color;this.LastTurnFoodNeededToBeShipped=a.LastTurnFoodNeededToBeShipped;this.Options=a.Options;this.OwnedPlanetIds=[];for(var b in a.OwnedPlanets)this.OwnedPlanetIds.push(a.OwnedPlanets[b].Id);this.KnownPlanetIds=[];for(b in a.KnownClientPlanets)this.KnownPlanetIds.push(a.KnownClientPlanets[b].Id);this.LastKnownPlanetSerializableFleetStrength={};
for(b in a.LastKnownPlanetFleetStrength)this.LastKnownPlanetSerializableFleetStrength[b]=new Astriarch.Fleet.SerializableLastKnownFleet(a.LastKnownPlanetFleetStrength[b]);this.PlanetBuildGoals=a.PlanetBuildGoals;for(b in this.PlanetBuildGoals)Astriarch.SavedGameInterface.makePlanetProductionItemSerializable(this.PlanetBuildGoals[b]);this.HomePlanetId=a.HomePlanetId;this.EarnedPointsByType=a.EarnedPointsByType;this.Points=a.Points;this.SerializableFleetsInTransit=[];for(b in a.FleetsInTransit)this.SerializableFleetsInTransit.push(new Astriarch.SerializableFleet(a.FleetsInTransit[b],
this.Type==Astriarch.Player.PlayerType.Human));this.CurrentTurnEnded=a.CurrentTurnEnded;this.Destroyed=a.Destroyed};Astriarch.SerializableFleet=function(a){this.StarShips=a.StarShips;this.LocationHexMidPoint=null;if(a.LocationHex)this.LocationHexMidPoint=a.LocationHex.MidPoint;if(a.travelingFromHex&&a.DestinationHex)this.travelingFromHexMidPoint=a.travelingFromHex.MidPoint,this.DestinationHexMidPoint=a.DestinationHex.MidPoint,this.ParsecsToDestination=a.ParsecsToDestination};
Astriarch.Fleet.SerializableLastKnownFleet=function(a){this.TurnLastExplored=a.TurnLastExplored;this.SerializableFleet=new Astriarch.SerializableFleet(a.Fleet,!1);if(a.LastKnownOwner)this.LastKnownOwnerId=a.LastKnownOwner.Id};
Astriarch.SerializablePlanet=function(a){this.Id=a.Id;this.Name=a.Name;this.Type=a.Type;this.Population=a.Population;this.RemainderProduction=a.RemainderProduction;this.BuildQueue=a.BuildQueue;for(var b in this.BuildQueue)Astriarch.SavedGameInterface.makePlanetProductionItemSerializable(this.BuildQueue[b]);this.BuiltImprovements=a.BuiltImprovements;this.MaxImprovements=a.MaxImprovements;this.Resources=a.Resources;this.OriginPoint=a.OriginPoint;this.PlanetarySerializableFleet=new Astriarch.SerializableFleet(a.PlanetaryFleet,
!1);this.OutgoingSerializableFleets=[];for(b in a.OutgoingFleets)a.Owner&&this.OutgoingSerializableFleets.push(new Astriarch.SerializableFleet(a.OutgoingFleets[b],a.Owner.Type==Astriarch.Player.PlayerType.Human));this.PlanetHappiness=a.PlanetHappiness;this.BuiltImprovements=a.BuiltImprovements;this.StarShipTypeLastBuilt=a.StarShipTypeLastBuilt;this.StarShipCustomShipLastBuilt=a.StarShipCustomShipLastBuilt;this.BuildLastStarShip=a.BuildLastStarShip;this.WayPointPlanetId=a.WayPointPlanetId};
Astriarch.Planet.PlanetProductionItemType={Unknown:0,PlanetImprovement:1,StarShipInProduction:2,PlanetImprovementToDestroy:3};
Astriarch.SavedGameInterface.makePlanetProductionItemSerializable=function(a){a.PlanetProductionItemType=Astriarch.Planet.PlanetProductionItemType.Unknown;if(a instanceof Astriarch.Planet.PlanetImprovement)a.PlanetProductionItemType=Astriarch.Planet.PlanetProductionItemType.PlanetImprovement;else if(a instanceof Astriarch.Planet.StarShipInProduction)a.PlanetProductionItemType=Astriarch.Planet.PlanetProductionItemType.StarShipInProduction;else if(a instanceof Astriarch.Planet.PlanetImprovementToDestroy)a.PlanetProductionItemType=
Astriarch.Planet.PlanetProductionItemType.PlanetImprovementToDestroy;return a};Astriarch.CommControl={chatLog:null,chatRoomInfo:null,inputTextBox:null,playerNameTextBox:null,chatLogPlayerNameDiv:null,playerName:null,playerNumber:null,playerSessions:null,init:function(){this.chatLog=$("#chatLog");this.chatRoomInfo=$("#chatRoomInfo");this.inputTextBox=$("#chatInputTextBox");this.inputTextBox.keyup(function(a){a.keyCode==13&&Astriarch.CommControl.sendTextMessage()});this.playerNameTextBox=$("#chatPlayerNameTextBox");this.playerNameTextBox.keyup(function(a){a.keyCode==13&&Astriarch.CommControl.submitPlayerNameChange()});
this.playerNameTextBox.change(function(){Astriarch.CommControl.submitPlayerNameChange()});this.chatLogPlayerNameDiv=$("#chatLogPlayerName");this.chatLogPlayerNameDiv.text(Astriarch.LocalStorageInterface.Prefs.playerName);this.chatLogPlayerNameDiv.click(function(){Astriarch.CommControl.playerNumber||(Astriarch.CommControl.playerNameTextBox.val(Astriarch.LocalStorageInterface.Prefs.playerName),Astriarch.CommControl.chatLogPlayerNameDiv.hide(),Astriarch.CommControl.playerNameTextBox.show(),Astriarch.CommControl.playerNameTextBox.select())});
Astriarch.CommControl.joinChatRoom(Astriarch.LocalStorageInterface.Prefs.playerName,null);$("#chatArea").show()},submitPlayerNameChange:function(){Astriarch.CommControl.setPlayerNameDivAndLocalStorageToNewName(Astriarch.CommControl.playerNameTextBox.val());Astriarch.CommControl.joinChatRoom(Astriarch.CommControl.playerName,Astriarch.CommControl.playerNumber);Astriarch.CommControl.playerNameTextBox.hide();Astriarch.CommControl.chatLogPlayerNameDiv.show()},setPlayerNameDivAndLocalStorageToNewName:function(a){Astriarch.CommControl.playerName=
a;Astriarch.LocalStorageInterface.Prefs.playerName=Astriarch.CommControl.playerName;Astriarch.LocalStorageInterface.savePrefs();Astriarch.CommControl.chatLogPlayerNameDiv.text(Astriarch.CommControl.playerName)},sendTextMessage:function(){var a=this.inputTextBox.val();a&&a.trim()&&(this.inputTextBox.val(""),a={messageType:Astriarch.Shared.CHAT_MESSAGE_TYPE.TEXT_MESSAGE,text:a,sentByPlayerName:this.playerName,sentByPlayerNumber:this.playerNumber,dateSent:(new Date).getTime()},Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CHAT_MESSAGE,
payload:a}),this.appendMessages([a]))},joinChatRoom:function(a,b){this.playerName=a;this.playerNumber=b;Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CHAT_MESSAGE,payload:{messageType:Astriarch.Shared.CHAT_MESSAGE_TYPE.PLAYER_ENTER,sentByPlayerName:a,sentByPlayerNumber:b}});this.chatLog.html("")},setPlayerSessions:function(a){Astriarch.CommControl.playerSessions=a;Astriarch.CommControl.refreshPlayerList()},refreshPlayerList:function(){var a="";if(Astriarch.GameId&&Astriarch.ClientGameModel&&
Astriarch.ClientGameModel.ClientPlayers)for(var b=0;b<Astriarch.ClientGameModel.ClientPlayers.length;b++){var c=Astriarch.ClientGameModel.ClientPlayers[b],d="messagePlayer"+c.Id;d+=c.Type!=Astriarch.Player.PlayerType.Human||c.CurrentTurnEnded?" sessionTurnEnded":c.Destroyed?" sessionDestroyed":" sessionNormal";a+='<div class="'+d+'">'+c.Name+(c.Points!=null?" ("+Math.floor(c.Points)+")":"")+"</div>"}else for(b=0;b<Astriarch.CommControl.playerSessions.length;b++)c=Astriarch.CommControl.playerSessions[b],
d=c.playerNumber?"messagePlayer"+c.playerNumber:"messagePlayerLobby",a+='<div class="'+d+'">'+c.playerName+"</div>";this.chatRoomInfo.html(a)},appendMessages:function(a){for(var b="",c=0;c<a.length;c++){var d=a[c],e=(new Date(d.dateSent)).toLocaleTimeString("en-US",{hour12:!1})+" ",g=d.sentByPlayerNumber?"messagePlayer"+d.sentByPlayerNumber:"messagePlayerLobby";b+=d.messageType==Astriarch.Shared.CHAT_MESSAGE_TYPE.TEXT_MESSAGE?'<div class="chatLogMessage"><span class="messageTime">'+e+'</span><span class="'+
g+'">'+d.sentByPlayerName+": </span>"+d.text+"</div>":'<div class="chatLogMessage"><span class="messageTime">'+e+'</span><span class="messageSystem">'+d.sentByPlayerName+(d.messageType==Astriarch.Shared.CHAT_MESSAGE_TYPE.PLAYER_ENTER?" Arrived":d.messageType==Astriarch.Shared.CHAT_MESSAGE_TYPE.PLAYER_DISCONNECT?" Disconnected":" Left")+"</span></div>"}this.chatLog.append(b);this.chatLog.animate({scrollTop:this.chatLog[0].scrollHeight},1E3)}};Astriarch.LobbyControl={GamesAvailableListBox:null,init:function(){$("#NewSkirmishGameButton").button();$("#NewSkirmishGameButton").click(function(){window.tour.enabled&&window.tour.jqElm.joyride("nextTip");Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CREATE_GAME,payload:{name:Astriarch.LocalStorageInterface.Prefs.gameName,playerName:Astriarch.LocalStorageInterface.Prefs.playerName}})});this.GamesAvailableListBox=new JSListBox({containerSelector:"GamesAvailableListBox",stylemap:{border:"none",
background:"none"}});$("#GameSelectedPanel").hide();$("#JoinGameButton").button();$("#JoinGameButton").button("disable");$("#JoinGameButton").click(function(){var a=Astriarch.LobbyControl.GamesAvailableListBox.SelectedItem;if(a)Astriarch.GameId=a.GameInfo._id,a.GameInfo.started?Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.RESUME_GAME}):Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.JOIN_GAME,payload:{playerName:Astriarch.LocalStorageInterface.Prefs.playerName}})})},
OnGameResumeMessageResponse:function(a){Astriarch.CommControl.joinChatRoom(Astriarch.LocalStorageInterface.Prefs.playerName,a.payload.playerPosition+1);$("#mainMenu").hide();Astriarch.GameController.ResetView(a.payload.gameData)},OnGameJoinMessageResponse:function(a){Astriarch.GameId=a.payload._id;a.payload.playerPosition?Astriarch.NewGameControl.joinGame(a):Astriarch.NewGameControl.newGame(a);$("#mainMenu").hide();Astriarch.View.ShowNewGameOptions()},OnGameCreateMessageResponse:function(a){Astriarch.GameId=
a.payload;Astriarch.NewGameControl.newGame();$("#mainMenu").hide();Astriarch.View.ShowNewGameOptions()},refreshGameList:function(a){Astriarch.LobbyControl.GamesAvailableListBox.clear();var b=[];if(a.payload&&a.payload.length)for(var c in a.payload){var d=new Astriarch.LobbyControl.GamesAvailableListBoxItem(a.payload[c]);b.push(d)}Astriarch.LobbyControl.GamesAvailableListBox.addItems(b)},updateGameList:function(a){for(var b=!1,c=0;c<Astriarch.LobbyControl.GamesAvailableListBox.items.length;c++){var d=
Astriarch.LobbyControl.GamesAvailableListBox.items[c];if(d.GameInfo._id==a.payload._id){d.GameInfo=a.payload;d.value=a.payload.name;Astriarch.LobbyControl.GamesAvailableListBox.refresh();b=!0;break}}b||Astriarch.LobbyControl.GamesAvailableListBox.addItem(new Astriarch.LobbyControl.GamesAvailableListBoxItem(a.payload))},GamesAvailableSelectionChanged:function(){if(Astriarch.LobbyControl.GamesAvailableListBox.SelectedItem){$("#JoinGameButton").button("enable");$("#GameSelectedPanel").show();var a=Astriarch.LobbyControl.GamesAvailableListBox.SelectedItem.GameInfo,
b=a.gameOptions;$("#GameSelectedName").text(a.name);$("#GameSelectedHostName").text("Host: "+b.mainPlayerName);$("#GameSelectedPlayerSummary").text(a.players.length+"/"+b.systemsToGenerate+" Players");$("#GameSelectedPlayer2Details").text(Astriarch.LobbyControl.GetOpponentSummaryText(b.opponentOptions[0]));$("#GameSelectedPlayer3Details").text(Astriarch.LobbyControl.GetOpponentSummaryText(b.opponentOptions[1]));$("#GameSelectedPlayer4Details").text(Astriarch.LobbyControl.GetOpponentSummaryText(b.opponentOptions[2]));
$("#GameSelectedNumberOfSystems").text(b.systemsToGenerate+" Systems");$("#GameSelectedPlanetsPerSystem").text(b.planetsPerSystem+" Planets per System");$("#GameSelectedDateCreated").text("Created At: "+(new Date(a.dateCreated)).toLocaleString());$("#GameSelectedDateLastPlayed").text("Last Played: "+(new Date(a.dateLastPlayed)).toLocaleString());a.started?$("#JoinGameButton").button("option","label","Resume Game"):$("#JoinGameButton").button("option","label","Join Game")}else $("#GameSelectedPanel").hide(),
$("#JoinGameButton").button("disable")},GetOpponentSummaryText:function(a){return Astriarch.GameTools.OpponentOptionToFriendlyString(a)}};Astriarch.LobbyControl.GamesAvailableListBoxItem=JSListBox.Item.extend({init:function(a){this.value=a.name;this.Foreground=null;this.GameInfo=a},render:function(){return'<a href="#" style="color:'+this.Foreground+'">'+this.value+"</a>"},onClick:function(){Astriarch.LobbyControl.GamesAvailableSelectionChanged()},onDblClick:function(){}});Astriarch.NewGameControl={GameCreator:!0,StarfieldCanvas:null,StarfieldCanvasContext:null,StarfieldCanvasSize:{w:200,h:170},init:function(){this.StarfieldCanvas=document.getElementById("newGameControlStarfieldCanvas");this.StarfieldCanvasContext=this.StarfieldCanvas.getContext("2d");$("#GameNameTextBox").val(Astriarch.LocalStorageInterface.Prefs.gameName);$("#GameNameTextBox").change(function(){var a=$("#GameNameTextBox").val();Astriarch.LocalStorageInterface.Prefs.gameName=a;Astriarch.LocalStorageInterface.savePrefs();
Astriarch.NewGameControl.changedGameOptions()});$("#PlayerNameTextBox").change(function(){var a=$(this).val();Astriarch.CommControl.setPlayerNameDivAndLocalStorageToNewName(a);Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CHANGE_PLAYER_NAME,payload:{playerName:a}})});$("select#NumberOfSystemsComboBox").selectmenu({width:55,change:function(){Astriarch.NewGameControl.UpdateStartupOptionsBasedOnOpponentCount();Astriarch.NewGameControl.changedGameOptions()}});Astriarch.NewGameControl.buildPlanetsPerSystemComboBox(Astriarch.Model.PlanetsPerSystemOption.FOUR,
Astriarch.Model.GalaxySizeOption.LARGE);$("select#GalaxySizeComboBox").selectmenu({width:120,change:function(){Astriarch.NewGameControl.changedGalaxySize()}});$("input#DistributePlanetsEvenlyCheckBox").change(function(){Astriarch.NewGameControl.changedGameOptions()});$("input#QuickStartCheckBox").change(function(){Astriarch.NewGameControl.changedGameOptions()});$("select#TurnTimeLimitComboBox").selectmenu({width:120,change:function(){Astriarch.NewGameControl.changedGameOptions()}});this.buildPlayerComboBoxes();
$("#StartGameOptionsOkButton").button();$("#StartGameOptionsOkButton").click(function(){window.tour.enabled&&window.tour.jqElm.joyride("nextTip");Astriarch.NewGameControl.SetupNewGame()});this.drawGameOptionsRepresentationOnCanvas(this.getSelectedGameOptions())},show:function(){$("#PlayerNameTextBox").val(Astriarch.LocalStorageInterface.Prefs.playerName);$("#startGameOptionsContainer").show()},buildPlayerComboBoxes:function(a){$("#Player2OptionsBox").html('<select id="Player2ComboBox"><option value="-1" selected="">Open</option>'+
(a&&a.opponentOptions[0].type==0?'<option value="0" disabled="disabled">Human</option>':"")+'<option value="1">Easy Computer</option><option value="2">Normal Computer</option><option value="3">Hard Computer</option><option value="4">Expert Computer</option></select>');$("#Player3OptionsBox").html('<select id="Player3ComboBox"><option value="-2">Closed</option><option value="-1" selected="">Open</option>'+(a&&a.opponentOptions[1].type==0?'<option value="0" disabled="disabled">Human</option>':"")+'<option value="1">Easy Computer</option><option value="2">Normal Computer</option><option value="3">Hard Computer</option><option value="4">Expert Computer</option></select>');
$("#Player4OptionsBox").html('<select id="Player4ComboBox"><option value="-2">Closed</option><option value="-1" selected="">Open</option>'+(a&&a.opponentOptions[2].type==0?'<option value="0" disabled="disabled">Human</option>':"")+'<option value="1">Easy Computer</option><option value="2">Normal Computer</option><option value="3">Hard Computer</option><option value="4">Expert Computer</option></select>');$("select#Player2ComboBox").selectmenu({width:150,change:function(){Astriarch.NewGameControl.changedGameOptions()}});
$("select#Player3ComboBox").selectmenu({width:150,change:function(){Astriarch.NewGameControl.changedGameOptions()}});$("select#Player4ComboBox").selectmenu({width:150,change:function(){Astriarch.NewGameControl.changedGameOptions()}})},buildPlanetsPerSystemComboBox:function(a,b){for(var a=a||Number($("select#PlanetsPerSystemComboBox").val()),b=b||Number($("select#GalaxySizeComboBox").val()),c="",d=4;d<=Astriarch.Model.PlanetsPerSystemOption.EIGHT;d++){if(b==Astriarch.Model.GalaxySizeOption.SMALL&&
d>Astriarch.Model.PlanetsPerSystemOption.SIX)break;c+='<option value="'+d+'"'+(a==d?' selected="true"':"")+">"+d+"</option>"}$("#PlanetsPerSystemOptionsBox").html('<select id="PlanetsPerSystemComboBox">'+c+"</select>");$("select#PlanetsPerSystemComboBox").selectmenu({width:55,change:function(){Astriarch.NewGameControl.changedGameOptions()}})},UpdateStartupOptionsBasedOnOpponentCount:function(){var a=Number($("select#NumberOfSystemsComboBox").val());$(".Player3Panel").hide();$(".Player4Panel").hide();
a>=3?$(".Player3Panel").show():$("select#Player3ComboBox").val("-2").selectmenu("refresh");a>=4?$(".Player4Panel").show():$("select#Player4ComboBox").val("-2").selectmenu("refresh")},newGame:function(a){Astriarch.CommControl.joinChatRoom(Astriarch.LocalStorageInterface.Prefs.playerName,1);a&&Astriarch.NewGameControl.OnGameOptionsChanged(a)},joinGame:function(a){Astriarch.NewGameControl.GameCreator=!1;$("#GameNameTextBox").parent().html('<span id="GameNameValue"></span>');$("select#NumberOfSystemsComboBox").parent().html('<span id="NumberOfSystemsValue"></span>');
$("select#PlanetsPerSystemComboBox").parent().html('<span id="PlanetsPerSystemValue"></span>');$("select#GalaxySizeComboBox").parent().html('<span id="GalaxySizeValue"></span>');$("input#DistributePlanetsEvenlyCheckBox").parent().html('<span id="DistributePlanetsEvenlyValue"></span>');$("input#QuickStartCheckBox").parent().html('<span id="QuickStartValue"></span>');$("select#TurnTimeLimitComboBox").parent().html('<span id="TurnTimeLimitValue"></span>');$("select#Player2ComboBox").parent().html('<span id="Player2NamePanel"></span>');
$("select#Player3ComboBox").parent().html('<span id="Player3NamePanel"></span>');$("select#Player4ComboBox").parent().html('<span id="Player4NamePanel"></span>');$("#StartGameOptionsOkButton").remove();Astriarch.NewGameControl.OnGameOptionsChanged(a);Astriarch.CommControl.joinChatRoom(Astriarch.LocalStorageInterface.Prefs.playerName,a.payload.playerPosition+1)},changedGalaxySize:function(){Astriarch.NewGameControl.buildPlanetsPerSystemComboBox();Astriarch.NewGameControl.changedGameOptions()},changedGameOptions:function(){var a=
this.getSelectedGameOptions(),b=$("#GameNameTextBox").val();this.drawGameOptionsRepresentationOnCanvas(a);Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CHANGE_GAME_OPTIONS,payload:{gameOptions:a,name:b}});window.tour.enabled&&(a.systemsToGenerate==2&&window.tour.step==3||a.opponentOptions[0].type==1&&window.tour.step==4)&&window.tour.jqElm.joyride("nextTip")},OnGameOptionsChanged:function(a){var b=a.payload.gameOptions;this.drawGameOptionsRepresentationOnCanvas(b);if(Astriarch.NewGameControl.GameCreator){$("#GameNameTextBox").val(a.payload.name);
$("select#NumberOfSystemsComboBox").val(b.systemsToGenerate).selectmenu("refresh");Astriarch.NewGameControl.buildPlanetsPerSystemComboBox(b.planetsPerSystem,b.systemsToGenerate);$("select#GalaxySizeComboBox").val(b.galaxySize).selectmenu("refresh");$("input#DistributePlanetsEvenlyCheckBox").prop("checked",b.distributePlanetsEvenly);$("input#QuickStartCheckBox").prop("checked",b.distributePlanetsEvenly);$("select#TurnTimeLimitComboBox").val(b.turnTimeLimitSeconds).selectmenu("refresh");Astriarch.NewGameControl.UpdateStartupOptionsBasedOnOpponentCount();
Astriarch.NewGameControl.buildPlayerComboBoxes(b);for(a=0;a<b.opponentOptions.length;a++){var c=b.opponentOptions[a];$("select#Player"+(a+2)+"ComboBox").val(c.type).selectmenu("refresh");c.type==0&&($("#Player"+(a+2)+"OptionsBox").hide(),$("#Player"+(a+2)+"NamePanel").text(c.name))}}else $("#GameNameValue").text(a.payload.name),$("#NumberOfSystemsValue").text(b.systemsToGenerate),$("#PlanetsPerSystemValue").text(b.planetsPerSystem),$("#GalaxySizeValue").text(b.galaxySize==Astriarch.Model.GalaxySizeOption.LARGE?
"Large":b.galaxySize==Astriarch.Model.GalaxySizeOption.MEDIUM?"Medium":"Small"),$("#DistributePlanetsEvenlyValue").text("Distribute Planets Evenly: "+b.distributePlanetsEvenly),$("#QuickStartValue").text("Quick Start: "+b.quickStart),a=b.turnTimeLimitSeconds/60,$("#TurnTimeLimitValue").text("Turn Time Limit: "+(a==0?"None":a<1?b.turnTimeLimitSeconds+" Seconds":a==1?"1 Minute":a+" Minutes")),$("#Player1NamePanel").text(b.mainPlayerName),$("#Player2NamePanel").text(Astriarch.GameTools.OpponentOptionToFriendlyString(b.opponentOptions[0])),
$("#Player3NamePanel").text(Astriarch.GameTools.OpponentOptionToFriendlyString(b.opponentOptions[1])),$("#Player4NamePanel").text(Astriarch.GameTools.OpponentOptionToFriendlyString(b.opponentOptions[2]));c=[{playerName:b.mainPlayerName,playerNumber:1,dateJoined:new Date}];for(a=0;a<b.opponentOptions.length;a++)b.opponentOptions[a].type>=0&&c.push({playerName:b.opponentOptions[a].name,playerNumber:a+2,dateJoined:new Date});Astriarch.CommControl.setPlayerSessions(c)},getSelectedGameOptions:function(){var a=
[],b=$("#PlayerNameTextBox").val();if(b==null||$.trim(b)=="")b="Player";a.push({name:$("#Player2NamePanel").text(),type:Number($("select#Player2ComboBox").val())});a.push({name:$("#Player3NamePanel").text(),type:Number($("select#Player3ComboBox").val())});a.push({name:$("#Player4NamePanel").text(),type:Number($("select#Player4ComboBox").val())});var c=Number($("select#NumberOfSystemsComboBox").val()),d=Number($("select#PlanetsPerSystemComboBox").val()),e=Number($("select#GalaxySizeComboBox").val()),
g=!0;$("#DistributePlanetsEvenlyCheckBox").attr("checked")||(g=!1);var f=!1;$("#QuickStartCheckBox").attr("checked")&&(f=!0);var h=Number($("select#TurnTimeLimitComboBox").val());return{mainPlayerName:b,opponentOptions:a,systemsToGenerate:c,planetsPerSystem:d,galaxySize:e,distributePlanetsEvenly:g,quickStart:f,turnTimeLimitSeconds:h}},SetupNewGame:function(){var a=this.getSelectedGameOptions(),b=1,c;for(c in a.opponentOptions)a.opponentOptions[c].type>=0&&b++;AstriarchExtern.OnGameStart({Players:b,
PlanetsPerSystem:a.planetsPerSystem,Systems:a.systemsToGenerate});Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.START_GAME,payload:a})},OnGameStartMessageResponse:function(a){Astriarch.GameController.gameOver=!1;$("#startGameOptionsContainer").hide();Astriarch.GameController.ResetView(a.payload)},drawGameOptionsRepresentationOnCanvas:function(a){var b=this.StarfieldCanvasSize.w,c=b/2,d=this.StarfieldCanvasSize.h,e=d/2;this.StarfieldCanvasContext.clearRect(0,0,b,d);for(d=0;d<
a.systemsToGenerate;d++){var g=0,f=0;a.systemsToGenerate==2&&d==1||a.systemsToGenerate==4&&d==2?(g=c,f=e):(a.systemsToGenerate==3||a.systemsToGenerate==4)&&d==1?g=c:a.systemsToGenerate==3&&d==2?(g=b/4,f=e):a.systemsToGenerate==4&&d==3&&(f=e);var h=this.StarfieldCanvasContext.createRadialGradient(g+c/2,f+e/2,0,g+c/2,f+e/2,this.StarfieldCanvasSize.h/4),i=Astriarch.View.Colors[0];if(d==0||a.opponentOptions[d-1].type>=0)i=Astriarch.Model.PlayerColors[d];h.addColorStop(0,"rgba(0, 0, 0, 0)");h.addColorStop(0.9,
i);h.addColorStop(1,"rgba(0, 0, 0, 0)");this.StarfieldCanvasContext.fillStyle=h;this.StarfieldCanvasContext.fillRect(g,f,c,e)}}};Astriarch.ExitConfirmControl={dialog:null,init:function(){$("#ButtonExitMainMenu").button().click(function(){Astriarch.View.ShowMainMenu();Astriarch.ExitConfirmControl.CancelClose()});$("#ButtonExitResign").button().click(function(){Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.EXIT_RESIGN,payload:{}});Astriarch.ExitConfirmControl.CancelClose()});Astriarch.ExitConfirmControl.dialog=new Astriarch.Dialog("#exitConfirmDialog","Exit or Resign?",200,165,null,Astriarch.ExitConfirmControl.CancelClose)},
show:function(){Astriarch.ExitConfirmControl.dialog.open()},CancelClose:function(){Astriarch.ExitConfirmControl.dialog.dlg.dialog("close")}};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.ClientModelInterface={GetClientModelFromSerializableClientModel:function(a,b){var c={},d;for(d in a.MainPlayerOwnedSerializablePlanets){var e=Astriarch.SavedGameInterface.getPlanetFromSerializedPlanet(a.MainPlayerOwnedSerializablePlanets[d],b);c[e.Id]=e}d={};var e=[],g;for(g in a.SerializableClientPlayers){var f=this.GetClientPlayerFromSerializableClientPlayer(a.SerializableClientPlayers[g]);e.push(f);d[f.Id]=f}f={};g=[];for(var h in a.SerializableClientPlanets){var i=this.GetClientPlanetFromSerializableClientPlanet(a.SerializableClientPlanets[h],
b);g.push(i);f[i.Id]=i}c=Astriarch.SavedGameInterface.getPlayerFromSerializedPlayer(b,a.SerializableMainPlayer,c,f);Astriarch.SavedGameInterface.setPlayerLastKnownPlanetFleetStrength(c,a.SerializableMainPlayer,b,d);return new Astriarch.ClientModel(a.TurnNumber,c,e,g,a.ClientTradingCenter,b,a.Options)},GetClientPlayerFromSerializableClientPlayer:function(a){var b=new Astriarch.Util.ColorRGBA(a.Color.r,a.Color.g,a.Color.b,a.Color.a);return new Astriarch.ClientPlayer(a.Id,a.Type,a.Name,b,a.Points,a.CurrentTurnEnded,
a.Destroyed,a.Research)},GetClientPlanetFromSerializableClientPlanet:function(a,b){return new Astriarch.ClientPlanet(a.Id,a.Name,a.OriginPoint,b,null,a.Type)},GetTurnEventMessageFromSerializableTurnEventMessage:function(a,b){var c=null;a.SerializableClientPlanet&&(c=Astriarch.ClientModelInterface.GetClientPlanetFromSerializableClientPlanet(a.SerializableClientPlanet,b));c=new Astriarch.TurnEventMessage(a.Type,c,a.Message);if(a.Data){var d=null;a.Data.DefendingSerializableClientPlayer&&(d=Astriarch.ClientModelInterface.GetClientPlayerFromSerializableClientPlayer(a.Data.DefendingSerializableClientPlayer));
var e=Astriarch.SavedGameInterface.getFleetFromSerializableFleet(d,a.Data.DefendingSerializableFleet,b),g=Astriarch.ClientModelInterface.GetClientPlayerFromSerializableClientPlayer(a.Data.AttackingSerializableClientPlayer),f=Astriarch.SavedGameInterface.getFleetFromSerializableFleet(g,a.Data.AttackingSerializableFleet,b);c.Data=new Astriarch.TurnEventMessage.PlanetaryConflictData(d,e,g,f);c.Data.WinningFleet=Astriarch.SavedGameInterface.getFleetFromSerializableFleet(null,a.Data.WinningSerializableFleet,
b);c.Data.AttackingFleetResearchBoostAttack=a.Data.AttackingFleetResearchBoostAttack;c.Data.AttackingFleetResearchBoostDefense=a.Data.AttackingFleetResearchBoostDefense;c.Data.DefendingFleetResearchBoostAttack=a.Data.DefendingFleetResearchBoostAttack;c.Data.DefendingFleetResearchBoostDefense=a.Data.DefendingFleetResearchBoostDefense;c.Data.AttackingFleetChances=a.Data.AttackingFleetChances;c.Data.GoldAmountLooted=a.Data.GoldAmountLooted;c.Data.OreAmountLooted=a.Data.OreAmountLooted;c.Data.IridiumAmountLooted=
a.Data.IridiumAmountLooted;c.Data.FoodAmountLooted=a.Data.FoodAmountLooted;c.Data.ResearchAmountLooted=a.Data.ResearchAmountLooted}return c}};Astriarch.ClientModel=function(a,b,c,d,e,g,f){this.Turn=new Astriarch.Model.Turn;this.Turn.Number=a;this.MainPlayer=b;this.ClientPlayers=c;this.ClientPlanets=d;this.ClientTradingCenter=e;this.GameGrid=g;this.GameOptions=f||{TurnTimeLimitSeconds:0}};
Astriarch.ClientModel.prototype.getClientPlanetById=function(a){for(var b=0;b<this.ClientPlanets.length;b++)if(this.ClientPlanets[b].Id==a)return this.ClientPlanets[b];return null};Astriarch.ClientPlayer=function(a,b,c,d,e,g,f,h){this.Id=a;this.Type=b;this.Name=c;this.Color=d;this.Points=e;this.CurrentTurnEnded=g;this.Destroyed=f;this.Research=h};
Astriarch.ClientPlanet=function(a,b,c,d,e,g){this.Id=a;this.Name=b;this.OriginPoint=c;this.BoundingHex=d?d.GetHexAt(c):e;this.BoundingHex.ClientPlanetContainedInHex=this;this.Type=g};Astriarch.ClientTradingCenter=function(a,b,c,d,e){this.goldAmount=a;this.foodResource=b;this.oreResource=c;this.iridiumResource=d;this.clientPlayerTrades=e};
Astriarch.SerializableClientModel=function(a,b,c,d,e,g,f){this.TurnNumber=a;this.SerializableMainPlayer=b;this.SerializableClientPlayers=c;this.SerializableClientPlanets=d;this.MainPlayerOwnedSerializablePlanets=e;this.ClientTradingCenter=g;this.Options=f||{TurnTimeLimitSeconds:0}};Astriarch.SerializableClientPlayer=function(a,b,c,d,e,g,f,h){this.Id=a;this.Type=b;this.Name=c;this.Color=d;this.Points=e;this.CurrentTurnEnded=g;this.Destroyed=f;this.Research=h};
Astriarch.SerializableClientPlanet=function(a,b,c,d){this.Id=a;this.Name=b;this.OriginPoint=c;this.Type=d};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.Shared={MESSAGE_TYPE:{ERROR:-1,NOOP:0,PING:1,CHAT_ROOM_SESSIONS_UPDATED:2,LOGOUT:3,LIST_GAMES:4,GAME_LIST_UPDATED:5,CHANGE_GAME_OPTIONS:6,CHANGE_PLAYER_NAME:7,CREATE_GAME:8,JOIN_GAME:9,RESUME_GAME:10,START_GAME:11,END_TURN:12,UPDATE_PLANET_START:13,UPDATE_PLANET_OPTIONS:14,UPDATE_PLANET_BUILD_QUEUE:15,SEND_SHIPS:16,CLEAR_WAYPOINT:17,GAME_OVER:18,SUBMIT_TRADE:19,CANCEL_TRADE:20,ADJUST_RESEARCH_PERCENT:21,SUBMIT_RESEARCH_ITEM:22,CANCEL_RESEARCH_ITEM:23,CHAT_MESSAGE:24,EXIT_RESIGN:25},ERROR_TYPE:{UNKNOWN:0,
INVALID_GAME_OPTIONS:1},PLANET_BUILD_QUEUE_ACTION_TYPE:{ADD_IMPROVEMENT:1,ADD_STARSHIP:2,REMOVE:3,MOVEUP:4,MOVEDOWN:5,DEMOLISH_IMPROVEMENT:6},CHAT_MESSAGE_TYPE:{TEXT_MESSAGE:1,PLAYER_ENTER:2,PLAYER_EXIT:3,PLAYER_DISCONNECT:4},Message:function(a,b){this.type=a||0;this.payload=b||{}},messageIdToTypeName:null,GetMessageType:function(a){if(!Astriarch.Shared.messageIdToTypeName)for(var b in Astriarch.Shared.messageIdToTypeName={},Astriarch.Shared.MESSAGE_TYPE)Astriarch.Shared.messageIdToTypeName[Astriarch.Shared.MESSAGE_TYPE[b]]=
b;return Astriarch.Shared.messageIdToTypeName[a]}};
