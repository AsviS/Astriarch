var Astriarch=Astriarch||{Version:"1.5.2",ClientGameModel:null,PlayerGameOptions:null,GameId:null},module=module||{};module.exports=Astriarch;Astriarch=Astriarch||require("./astriarch_base");Astriarch.NextRandom=function(a,b){if(b===null||typeof b=="undefined")b=a,a=0;a<0?b+=Math.abs(a):b-=a;return Math.floor(Math.random()*b)+a};Astriarch.NextRandomFloat=function(a,b){return Math.random()*(b-a)+a};Astriarch.CountObjectKeys=function(a){var b=0,c;for(c in a)b++;return b};Number.prototype.compareTo=function(a){if(typeof a!="number")return!1;return a<this?1:a>this?-1:0};
Astriarch.GameTools={OpponentOptionToFriendlyString:function(a){var b="";switch(a.type){case -2:b="Closed";break;case -1:b="Open";break;case Astriarch.Player.PlayerType.Human:b="Human Player: "+a.name;break;case Astriarch.Player.PlayerType.Computer_Easy:b="Easy Computer";break;case Astriarch.Player.PlayerType.Computer_Normal:b="Normal Computer";break;case Astriarch.Player.PlayerType.Computer_Hard:b="Hard Computer";break;case Astriarch.Player.PlayerType.Computer_Expert:b="Expert Computer"}return b},
PlanetOwnerToFriendlyName:function(a,b){var c=a==Astriarch.Planet.PlanetType.AsteroidBelt?"None":"Natives";if(b!=null)c=b.Name;return c},PlanetTypeToFriendlyName:function(a){var b="Asteroid Belt";a==Astriarch.Planet.PlanetType.DeadPlanet?b="Dead":a==Astriarch.Planet.PlanetType.PlanetClass1?b="Arid":a==Astriarch.Planet.PlanetType.PlanetClass2&&(b="Terrestrial");return b},PlanetImprovementTypeToFriendlyName:function(a){var b="";switch(a){case Astriarch.Planet.PlanetImprovementType.Factory:b="Factory";
break;case Astriarch.Planet.PlanetImprovementType.Colony:b="Colony";break;case Astriarch.Planet.PlanetImprovementType.Farm:b="Farm";break;case Astriarch.Planet.PlanetImprovementType.Mine:b="Mine";break;case Astriarch.Planet.PlanetImprovementType.SpacePlatform:b="Space Platform"}return b},PlanetImprovementTypeToHelpText:function(a){var b="";switch(a){case Astriarch.Planet.PlanetImprovementType.Farm:b="Farms increase amount of Food produced by each farmer.";break;case Astriarch.Planet.PlanetImprovementType.Mine:b=
"Mines increase the amount of Ore and Iridium produced by each miner.";break;case Astriarch.Planet.PlanetImprovementType.Factory:b="Factories increase the production generated by each worker.\r\nAllows construction of Space Platforms and Destroyers.";break;case Astriarch.Planet.PlanetImprovementType.Colony:b="Colonies increase the planet's maximum population by one.";break;case Astriarch.Planet.PlanetImprovementType.SpacePlatform:b="Space Platforms provide planetary defense.\r\nAllows construction of Cruisers and Battleships.\r\nAdvantage against: Destroyers, Disadvantage Against: Cruisers"}return b},
StarShipTypeToFriendlyName:function(a){var b="";switch(a){case Astriarch.Fleet.StarShipType.SystemDefense:b="Defender";break;case Astriarch.Fleet.StarShipType.Scout:b="Scout";break;case Astriarch.Fleet.StarShipType.Destroyer:b="Destroyer";break;case Astriarch.Fleet.StarShipType.Cruiser:b="Cruiser";break;case Astriarch.Fleet.StarShipType.Battleship:b="Battleship"}return b},StarShipTypeToHelpText:function(a){var b="";switch(a){case Astriarch.Fleet.StarShipType.SystemDefense:b="Defenders protect a planet from attacking fleets but cannot move between planets.\r\nAdvantage against: None, Disadvantage Against: None";
break;case Astriarch.Fleet.StarShipType.Scout:b="Scouts are the weakest ship equipped with warp drive.\r\nAdvantage against: Battleships, Disadvantage Against: Destroyers";break;case Astriarch.Fleet.StarShipType.Destroyer:b="Destroyers require a Factory in order to build and are twice the strength of a Scout.\r\nAdvantage against: Scouts, Disadvantage Against: Cruisers";break;case Astriarch.Fleet.StarShipType.Cruiser:b="Cruisers require a Space Platform in order to build and are twice the strength of a Destroyer.\r\nAdvantage against: Destroyers, Disadvantage Against: Battleships";
break;case Astriarch.Fleet.StarShipType.Battleship:b="Battleships require a Space Platform in order to build and are twice the strength of a Cruiser.\r\nAdvantage against: Cruisers, Disadvantage Against: Scouts"}return b},PlanetTypeToClassName:function(a){var b=null;switch(a){case Astriarch.Planet.PlanetType.PlanetClass2:b="icon-32x32-PlanetClass2";break;case Astriarch.Planet.PlanetType.PlanetClass1:b="icon-32x32-PlanetClass1";break;case Astriarch.Planet.PlanetType.DeadPlanet:b="icon-32x32-PlanetDead";
break;case Astriarch.Planet.PlanetType.AsteroidBelt:b="icon-32x32-PlanetAsteroid"}return b}};
Astriarch.Util={starshipImageData:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,128,0,255,0,128,
0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,
0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,0,0,0,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0],spaceplatformImageData:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,
0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,128,0,255,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],imageDataByColorRGBA:{},
GetImageData:function(a){var b=a.toString();b in Astriarch.Util.imageDataByColorRGBA||(Astriarch.Util.imageDataByColorRGBA[b]={starshipImageData:Astriarch.Util.ChangeImageColor(Astriarch.Util.starshipImageData,a),spaceplatformImageData:Astriarch.Util.ChangeImageColor(Astriarch.Util.spaceplatformImageData,a)});return Astriarch.Util.imageDataByColorRGBA[b]},ChangeImageColor:function(a,b){for(var c=Array(a.length),d=0;d<a.length;d+=4)a[d+3]!=0?(c[d+0]=b.r,c[d+1]=b.g,c[d+2]=b.b):(c[d+0]=a[d+0],c[d+1]=
a[d+1],c[d+2]=a[d+2]),c[d+3]=a[d+3];return c}};Astriarch.Util.ColorRGBA=function(a,b,c,d){this.r=a;this.g=b;this.b=c;this.a=d};Astriarch.Util.ColorRGBA.prototype.toString=function(){return"rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")"};Astriarch.View={jCanvasDraw:null,audioInterface:null,audioMouseInTimer:null,audioMouseOutTimer:null,CanvasBackground:null,ContextBackground:null,CanvasPlayfieldLayer:null,CanvasFleetsLayer:null,BackgroundSpriteSheetImage:null,BACKGROUND_COUNT:7,BACKGROUND_DARKNESS:30,DrawnPlanets:{},DrawnFleets:[],Colors:["white","yellow","orange","blue","green","red","purple"],ColorsRGBA:{white:null,yellow:null,orange:null,blue:null,green:null,red:null,purple:null},sendingShipsTo:!1,sendShipsFromHex:null,TurnSummaryItemsListBox:null,
SpriteSheetInfo:{filename:null,planetAsteroidY:null,planetDeadY:null,planetClass1Y:null,planetClass2Y:null}};
Astriarch.View.PageLoadInit=function(a){Astriarch.View.SetupGraphicalDOMElements();Astriarch.View.jCanvasDraw=new jCanvas({containerSelector:"#canvasContainer",canvasNotSupportedCallback:Astriarch.View.CanvasNotSupported,layers:[{name:"canvasAstriarchBackground",x:0,y:0,width:800,height:600,zIndex:1,backgroundColor:"black"},{name:"canvasAstriarchPlayfield",x:177,y:21,width:615,height:480,zIndex:2,clickCallback:Astriarch.View.PlayfieldClicked,dblclickCallback:Astriarch.View.PlayfieldDoubleClicked,
mouseHitSelector:"#canvasMouseHitDetector"},{name:"canvasAstriarchFleets",x:177,y:21,width:615,height:480,zIndex:3,clickCallback:Astriarch.View.FleetsClicked,mouseHitSelector:"#canvasMouseHitDetector"}]});if(Astriarch.View.jCanvasDraw.canvasSupported){var b=Astriarch.View.jCanvasDraw.getLayer("canvasAstriarchBackground");Astriarch.View.CanvasBackground=b.canvas;Astriarch.View.ContextBackground=b.ctx;Astriarch.View.CanvasPlayfieldLayer=Astriarch.View.jCanvasDraw.getLayer("canvasAstriarchPlayfield");
Astriarch.View.CanvasFleetsLayer=Astriarch.View.jCanvasDraw.getLayer("canvasAstriarchFleets");Astriarch.View.CanvasPlayfieldLayer.canvas.dblclick(function(){});setTimeout(function(){Astriarch.View.loadBackgroundSpriteSheetImage()},10);Astriarch.View.ContextBackground.globalAlpha=1;setInterval(function(){Astriarch.View.jCanvasDraw.draw()},50);Astriarch.View.ColorsRGBA.white=new Astriarch.Util.ColorRGBA(255,255,255,255);Astriarch.View.ColorsRGBA.yellow=new Astriarch.Util.ColorRGBA(255,255,0,255);Astriarch.View.ColorsRGBA.orange=
new Astriarch.Util.ColorRGBA(255,165,0,255);Astriarch.View.ColorsRGBA.blue=new Astriarch.Util.ColorRGBA(0,0,255,255);Astriarch.View.ColorsRGBA.green=new Astriarch.Util.ColorRGBA(0,128,0,255);Astriarch.View.ColorsRGBA.red=new Astriarch.Util.ColorRGBA(255,0,0,255);Astriarch.View.ColorsRGBA.purple=new Astriarch.Util.ColorRGBA(128,0,128,255);Astriarch.View.audioInterface=new AudioInterface(!0);Astriarch.PlayerGameOptions=new Astriarch.Player.PlayerGameOptions;Astriarch.server_comm.init(a);Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.ERROR,
function(a){var b=a.payload;typeof a.payload!="string"&&(b=JSON.stringify(a.payload));new Astriarch.Alert("Error",'<span style="color:red">'+b+"</span>")});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.NOOP,function(a){console.log("NOOP: ",a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.CHAT_ROOM_SESSIONS_UPDATED,function(a){Astriarch.CommControl.setPlayerSessions(a.payload.sessions)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.LIST_GAMES,Astriarch.LobbyControl.refreshGameList);
Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.GAME_LIST_UPDATED,Astriarch.LobbyControl.updateGameList);Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.CHANGE_GAME_OPTIONS,function(a){Astriarch.NewGameControl.OnGameOptionsChanged(a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.JOIN_GAME,function(a){Astriarch.LobbyControl.OnGameJoinMessageResponse(a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.CREATE_GAME,function(a){Astriarch.LobbyControl.OnGameCreateMessageResponse(a)});
Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.RESUME_GAME,function(a){Astriarch.LobbyControl.OnGameResumeMessageResponse(a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.START_GAME,function(a){Astriarch.NewGameControl.OnGameStartMessageResponse(a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.END_TURN,function(a){Astriarch.GameController.OnEndTurnMessageResponse(a)});Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.GAME_OVER,function(a){Astriarch.GameController.OnGameOverMessageResponse(a)});
Astriarch.server_comm.register(Astriarch.Shared.MESSAGE_TYPE.CHAT_MESSAGE,function(a){Astriarch.CommControl.appendMessages([a.payload])});Astriarch.CommControl.init();Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.LIST_GAMES,payload:{}})}};
Astriarch.View.CanvasNotSupported=function(){$("#startGameOptionsContainer").hide();$("#canvasContainer").html('<p style="color:white">Astriarch HTML 5 version not supported by your browser.  You can play with the silverlight plugin by clicking <a href="silverlight.html">here</a>. In 5 seconds you will be taken to the silverlight version automatically.</p>');setTimeout(function(){window.location="silverlight.html"},5E3)};
Astriarch.View.ClearPlanetsAndFleets=function(){Astriarch.View.DrawnPlanets={};Astriarch.View.DrawnFleets=[];Astriarch.View.CanvasPlayfieldLayer.children=[];Astriarch.View.CanvasFleetsLayer.children=[];Astriarch.View.CanvasPlayfieldLayer.needsDisplay=!0;Astriarch.View.CanvasFleetsLayer.needsDisplay=!0};Astriarch.View.ShowNewGameOptions=function(){$("#startGameOptionsContainer").show();Astriarch.View.ClearGameBackgroundControls()};
Astriarch.View.ClearGameBackgroundControls=function(){Astriarch.View.ClearPlanetsAndFleets();$("#TurnDisplay,#OverallPlayerStatusGrid,#SelectedItemStatus,#SelectedItemPopulationPanel,#SelectedItemImprovementSlotsPanel,#SelectedItemPopulationAssignmentsPanel,#SelectedItemBuiltImprovementsGrid,#SelectedItemPlanetaryFleetGrid,#SelectedItemStatusDetails,#BottomStatusGrid,#TurnSummaryItemsListBox,#ButtonPanel").hide();$("#PlanetViewButton,#SendShipsButton,#NextTurnButton,#ButtonOpenTradingCenter").hide()};
Astriarch.View.SetupGraphicalDOMElements=function(){Astriarch.LobbyControl.init();Astriarch.NewGameControl.init();Astriarch.View.TurnSummaryItemsListBox=new JSListBox({containerSelector:"TurnSummaryItemsListBox",stylemap:{border:"none",background:"none"}});$("#PlanetViewButton, #SendShipsButton, #NextTurnButton, #CancelSendButton, #MainMenuButtonGameOver").button();$("#CancelSendButton").hide();$("#MainMenuButtonGameOver").hide();$("#SystemMasterVersion").text("v"+Astriarch.Version);$("#SystemMasterVersion").attr("Title",
"Astriarch - Ruler of the Stars, Version: "+Astriarch.Version+"\r\nCopyright 2010 Mastered Software\r\nMusic by Resonant");Astriarch.PlanetView.init();Astriarch.SendShipsControl.init();Astriarch.PlanetaryConflictControl.init();Astriarch.GameOverControl.init();Astriarch.TradingControl.init();$("#PlanetViewButton").click(function(){window.tour.enabled&&(window.tour.step==15||window.tour.step==27||window.tour.step==32||window.tour.step==43||window.tour.step==53)&&window.tour.jqElm.joyride("nextTip");
Astriarch.View.ShowPlanetView()});$("#SendShipsButton").click(function(){window.tour.enabled&&window.tour.step==55&&window.tour.jqElm.joyride("nextTip");Astriarch.View.StartSendShips()});$("#NextTurnButton").click(function(){window.tour.enabled&&(window.tour.step==22||window.tour.step==24||window.tour.step==26||window.tour.step==28||window.tour.step==31||window.tour.step==35||window.tour.step==40||window.tour.step==42||window.tour.step==47)&&window.tour.jqElm.joyride("nextTip");Astriarch.View.NextTurn()});
$("#CancelSendButton").click(function(){Astriarch.View.CancelSendShips()});$("#MainMenuButtonGameOver").click(function(){Astriarch.View.ShowMainMenu()});$("#MainMenuButton").button({icons:{primary:"icon-16x16-main-menu"},text:!1});$("#MainMenuButton").click(function(){Astriarch.View.ShowMainMenu()});$("#MainMenuIcon").mouseenter(function(){Astriarch.View.mainMenuIconMouseEnter()});$("#MainMenuButton").mouseleave(function(){Astriarch.View.mainMenuButtonMouseLeave()});$("#SpeakerIcon").mouseenter(function(){Astriarch.View.speakerIconMouseEnter()});
$("#ButtonSpeakerToggleMute").mouseleave(function(){Astriarch.View.muteButtonMouseLeave()});$("#SliderVolume").mouseenter(function(){Astriarch.View.volumeSliderMouseEnter()});$("#SliderVolume").mouseleave(function(){Astriarch.View.volumeSliderMouseLeave()});$("#ButtonSpeakerToggleMute").button({icons:{primary:"icon-16x16-speaker-on"},text:!1});$("#ButtonSpeakerToggleMute").click(function(){Astriarch.View.toggleAudioMute()});$("#ButtonOpenTradingCenter").button({icons:{primary:"icon-16x16-trading"},
text:!1});$("#ButtonOpenTradingCenter").click(function(){window.tour.enabled&&window.tour.step==36&&window.tour.jqElm.joyride("nextTip");Astriarch.View.openTradingCenter()});$("#SliderVolume").slider({value:1,step:0.1,min:0,max:1,orientation:"vertical",slide:Astriarch.View.volumeSliderValueChanged});var a=function(a,c){var d=$('<div class="'+a+'"></div>').hide().appendTo("body"),e=d.css(c);c=="background-image"?e=e.replace(/"/g,"").replace(/url\(|\)$/ig,""):c=="background-position"&&(e=parseFloat(e.split(" ")[1].replace(/[^0-9-]/g,
"")));d.remove();return e};Astriarch.View.SpriteSheetInfo.filename=a("icon-32x32-sprite","background-image");Astriarch.View.SpriteSheetInfo.planetAsteroidY=-1*a("icon-32x32-PlanetAsteroid","background-position");Astriarch.View.SpriteSheetInfo.planetDeadY=-1*a("icon-32x32-PlanetDead","background-position");Astriarch.View.SpriteSheetInfo.planetClass1Y=-1*a("icon-32x32-PlanetClass1","background-position");Astriarch.View.SpriteSheetInfo.planetClass2Y=-1*a("icon-32x32-PlanetClass2","background-position")};
Astriarch.View.NextTurn=function(){Astriarch.GameController.turnTimerTimeoutId&&clearTimeout(Astriarch.GameController.turnTimerTimeoutId);$("#NextTurnButton").button("disable");Astriarch.GameController.NextTurn()};
Astriarch.View.ShowMainMenu=function(){Astriarch.GameId=null;Astriarch.View.audioInterface.StartMenu();Astriarch.LobbyControl.refreshGameList({});$("#MainMenuButtonGameOver").hide();$("#MainMenuButton").hide();$("#mainMenu").show();Astriarch.View.ClearGameBackgroundControls();Astriarch.CommControl.joinChatRoom(Astriarch.LocalStorageInterface.Prefs.playerName,null);Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.LIST_GAMES,payload:{}})};
Astriarch.View.ShowPlanetView=function(){var a=Astriarch.ClientGameModel.MainPlayer.GetPlanetIfOwnedByPlayer(Astriarch.ClientGameModel.GameGrid.SelectedHex.ClientPlanetContainedInHex);Astriarch.PlanetView.show(a)};Astriarch.View.StartSendShips=function(){Astriarch.View.sendingShipsTo=!0;$("#SendShipsStatus").text(" Select Planet to Send Ships to. ");$("#CancelSendButton").show();Astriarch.View.sendShipsFromHex=Astriarch.ClientGameModel.GameGrid.SelectedHex};
Astriarch.View.CancelSendShips=function(){$("#SendShipsStatus").text("");$("#CancelSendButton").hide();Astriarch.View.sendingShipsTo=!1};Astriarch.View.SendShipsDialogWindowClosed=function(a){a==!0&&Astriarch.SendShipsControl.CreatedFleet!=null&&Astriarch.SendShipsControl.pSource.PlanetaryFleet.GetPlanetaryFleetMobileStarshipCount()==0&&Astriarch.View.DrawnPlanets[Astriarch.SendShipsControl.pSource.Id].UpdatePlanetDrawingForPlayer(Astriarch.ClientGameModel.MainPlayer);Astriarch.View.selectPlanet(Astriarch.SendShipsControl.pSource)};
Astriarch.View.PlayfieldClicked=function(a){a=new Astriarch.Point(a.x,a.y);a=Astriarch.ClientGameModel.GameGrid.GetHexAt(a);if(a!=null&&a.ClientPlanetContainedInHex!=null&&(Astriarch.ClientGameModel.GameGrid.SelectHex(a),Astriarch.View.updateSelectedItemPanelForPlanet(),Astriarch.View.sendingShipsTo)){if(Astriarch.View.sendShipsFromHex!=Astriarch.ClientGameModel.GameGrid.SelectedHex){var a=Astriarch.ClientGameModel.GameGrid.GetHexDistance(Astriarch.View.sendShipsFromHex,Astriarch.ClientGameModel.GameGrid.SelectedHex),
b=Astriarch.ClientGameModel.MainPlayer.GetPlanetIfOwnedByPlayer(Astriarch.View.sendShipsFromHex.ClientPlanetContainedInHex);Astriarch.SendShipsControl.show(b,Astriarch.ClientGameModel.GameGrid.SelectedHex.ClientPlanetContainedInHex,a)}Astriarch.View.CancelSendShips()}return!0};
Astriarch.View.PlayfieldDoubleClicked=function(a){a=new Astriarch.Point(a.x,a.y);a=Astriarch.ClientGameModel.GameGrid.GetHexAt(a);a!=null&&a.ClientPlanetContainedInHex!=null&&Astriarch.ClientGameModel.MainPlayer.GetPlanetIfOwnedByPlayer(a.ClientPlanetContainedInHex)&&Astriarch.View.ShowPlanetView();return!0};Astriarch.View.FleetsClicked=function(){return!0};Astriarch.View.selectPlanet=function(a){Astriarch.ClientGameModel.GameGrid.SelectHex(a.BoundingHex);Astriarch.View.updateSelectedItemPanelForPlanet()};
Astriarch.View.updatePlayerStatusPanel=function(){var a=Astriarch.ClientGameModel.MainPlayer;if(a!==null){$("#OverallPlayerStatusGrid").css({visibility:"visible"});var b=a.GetTotalPopulation();$("#TextBlockPopulationAmount").text(b);$("#TextBlockPopulationAmount").prop("title","Total Population: "+b);var c=a.GetTotalResourceProductionPerTurn(),d=a.TotalFoodAmount()+c.food,e=c.food-b,g="";e>=0&&(g="+");var f="green";if(e<0)f=e+d<b?"red":"yellow";else if(d<b||e+d<b)f="orange";$("#TextBlockFoodAmount").css("color",
f);$("#TextBlockFoodAmount").text(d+" "+g+e);$("#TextBlockFoodAmount").prop("title","Food Amount: "+a.ExactTotalFoodAmount()+" +"+c.food_exact+" -"+b);$("#TextBlockGoldAmount").text(a.Resources.GoldAmount);$("#TextBlockGoldAmount").prop("title","Gold Amount: "+(a.Resources.GoldAmount+a.Resources.GoldRemainder));$("#TextBlockOreAmount").text(a.TotalOreAmount()+" +"+c.ore);$("#TextBlockOreAmount").prop("title","Ore Amount: "+a.ExactTotalOreAmount()+" +"+c.ore_exact);$("#TextBlockIridiumAmount").text(a.TotalIridiumAmount()+
" +"+c.iridium);$("#TextBlockIridiumAmount").prop("title","Iridium Amount: "+a.ExactTotalIridiumAmount()+" +"+c.iridium_exact)}};
Astriarch.View.updateSelectedItemPanelForPlanet=function(){$("#PlanetViewButton").button("disable");$("#SendShipsButton").button("disable");$("#ButtonOpenTradingCenter").button("disable");var a="";if(Astriarch.ClientGameModel.GameGrid.SelectedHex!=null){var b=Astriarch.ClientGameModel.GameGrid.SelectedHex.ClientPlanetContainedInHex,c=Astriarch.ClientGameModel.MainPlayer;a+="--- Planet "+b.Name+" ---<br />";$("#SelectedItemBuiltImprovementsGrid").css({visibility:"hidden"});$("#SelectedItemPlanetaryFleetGrid").css({visibility:"hidden"});
$("#SelectedItemPopulationPanel").css({visibility:"hidden"});$("#SelectedItemPopulationAssignmentsPanel").css({visibility:"hidden"});$("#SelectedItemImprovementSlotsPanel").css({visibility:"hidden"});$("#SelectedItemStatusDetails").css({visibility:"hidden"});var d=c.PlanetTypeIfKnownByPlayer(b);if(d){var e=null,g=null;if(c.LastKnownPlanetFleetStrength[b.Id])e=c.LastKnownPlanetFleetStrength[b.Id],g=e.LastKnownOwner;a+=Astriarch.GameTools.PlanetTypeToFriendlyName(d)+"<br />";if(b=c.GetPlanetIfOwnedByPlayer(b)){e=
b.Type==Astriarch.Planet.PlanetType.AsteroidBelt?"None":"Natives";if(b.Owner!=null)e=b.Owner.Name;a+=e+"<br />";$("#SelectedItemBuiltImprovementsGrid").css({visibility:"visible"});$("#SelectedItemPlanetaryFleetGrid").css({visibility:"visible"});$("#SelectedItemPopulationPanel").css({visibility:"visible"});$("#SelectedItemPopulationAssignmentsPanel").css({visibility:"visible"});$("#SelectedItemImprovementSlotsPanel").css({visibility:"visible"});$("#SelectedItemStatusDetails").css({visibility:"visible"});
Astriarch.View.updateSelectedItemPopulationPanel(b.Population,b.MaxPopulation());var e=b.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Farm].length,d=b.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length,g=b.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Colony].length,f=b.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length,h=b.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform].length;Astriarch.View.updateSelectedItemImprovementSlotsPanel(e+
d+f+g,b.MaxImprovements);var i=new Astriarch.Planet.PopulationAssignments;b.CountPopulationWorkerTypes(i);Astriarch.View.updateSelectedItemPopulationAssignmentsPanel(i.Farmers,i.Miners,i.Workers);$("#TextBlockFarmCount").text(e);$("#TextBlockMineCount").text(d);$("#TextBlockFactoryCount").text(f);$("#TextBlockColonyCount").text(g);$("#TextBlockSpacePlatformCount").text(h);e=b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Scout].length;d=b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length;
g=b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length;f=b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Battleship].length;$("#TextBlockDefenderCount").text(b.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].length);$("#TextBlockScoutCount").text(e);$("#TextBlockDestroyerCount").text(d);$("#TextBlockCruiserCount").text(g);$("#TextBlockBattleshipCount").text(f);b.Owner==c&&($("#PlanetViewButton").button("enable"),(e!=0||d!=0||g!=0||f!=0)&&$("#SendShipsButton").button("enable"),
$("#ButtonOpenTradingCenter").button("enable"));c="";c+="<br />--- Stockpile ---<br />";c+="Production: "+(b.RemainderProduction+b.RemainderProductionFraction)+"<br />";c+="Food: "+(b.Resources.FoodAmount+b.Resources.FoodRemainder)+"<br />";c+="Ore: "+(b.Resources.OreAmount+b.Resources.OreRemainder)+"<br />";c+="Iridium: "+(b.Resources.IridiumAmount+b.Resources.IridiumRemainder)+"<br />";c+="<br />--- Per Turn ---<br />";c+="Production: "+(b.ResourcesPerTurn.ProductionAmountPerTurn+b.ResourcesPerTurn.RemainderProductionPerTurn)+
"<br />";c+="Food: "+(b.ResourcesPerTurn.FoodAmountPerTurn+b.ResourcesPerTurn.RemainderFoodPerTurn)+"<br />";c+="Ore: "+(b.ResourcesPerTurn.OreAmountPerTurn+b.ResourcesPerTurn.RemainderOrePerTurn)+"<br />";c+="Iridium: "+(b.ResourcesPerTurn.IridiumAmountPerTurn+b.ResourcesPerTurn.RemainderIridiumPerTurn)+"<br />";c+="<br />--- Per Worker ---<br />";c+="Production: "+b.ResourcesPerTurn.GetExactProductionAmountPerWorkerPerTurn()+"<br />";c+="Food: "+b.ResourcesPerTurn.GetExactFoodAmountPerWorkerPerTurn()+
"<br />";c+="Ore: "+b.ResourcesPerTurn.GetExactOreAmountPerWorkerPerTurn()+"<br />";c+="Iridium: "+b.ResourcesPerTurn.GetExactIridiumAmountPerWorkerPerTurn()+"<br />";$("#SelectedItemStatusDetails").html(c)}else if(e!=null)a+=Astriarch.GameTools.PlanetOwnerToFriendlyName(d,g)+"<br />",c=e.Fleet,b=Astriarch.ClientGameModel.Turn.Number-e.TurnLastExplored,a+="--- Known Fleet ---<br />",a+=(b==0?"Explored this turn.":b==1?"Explored last turn.":"As of "+b+" turns ago.")+"<br />",a+=c.HasSpacePlatform?
"1 Space Platform<br />":"No Space Platform<br />",$("#TextBlockDefenderCount").text(c.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].length),$("#TextBlockScoutCount").text(c.StarShips[Astriarch.Fleet.StarShipType.Scout].length),$("#TextBlockDestroyerCount").text(c.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length),$("#TextBlockCruiserCount").text(c.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length),$("#TextBlockBattleshipCount").text(c.StarShips[Astriarch.Fleet.StarShipType.Battleship].length),
$("#SelectedItemPlanetaryFleetGrid").css({visibility:"visible"})}else a+="Unexplored"}$("#SelectedItemStatus").html(a)};
Astriarch.View.updateSelectedItemPopulationPanel=function(a,b){for(var c=null,d=b+1;d<=16;d++)c=$("#PopulationImage"+d),c.attr("class","popImg"),c.prop("title","Planet Population: "+a.length+" / "+b);for(d=1;d<=b;d++)if(c=$("#PopulationImage"+d),d<=a.length){var e=a[d-1];e.ProtestLevel==0?(c.attr("class","icon-10x16-PopulationSmallFilled"),c.prop("title","Planet Population: "+a.length+" / "+b)):(e.ProtestLevel>0.5?c.attr("class","icon-10x16-PopulationSmallFilled_red"):c.attr("class","icon-10x16-PopulationSmallFilled_orange"),
c.prop("title","Citizens Protesting at "+Math.round(100*e.ProtestLevel)+"%"))}else c.attr("class","icon-10x16-PopulationSmallEmpty"),c.prop("title","Planet Population: "+a.length+" / "+b)};
Astriarch.View.updateSelectedItemImprovementSlotsPanel=function(a,b){$("#SelectedItemImprovementSlotsPanel").attr("Title","Planetary Improvements: "+a+" / "+b);for(var c=1;c<=9;c++)$("#PlanetaryImprovementSlotsImage"+c).attr("class","impImg");for(c=1;c<=b;c++)c<=a?$("#PlanetaryImprovementSlotsImage"+c).addClass("icon-16x16-PlanetaryImprovementSlotFilled"):$("#PlanetaryImprovementSlotsImage"+c).addClass("icon-16x16-PlanetaryImprovementSlotEmpty")};
Astriarch.View.updateSelectedItemPopulationAssignmentsPanel=function(){var a;$("#SelectedItemPopulationAssignmentsPanel").attr("Title",farmers+(farmers==1?" Farmer, ":" Farmers, ")+miners+(miners==1?" Miner, ":" Miners, ")+workers+(workers==1?" Builder":" Builders"));for(a=1;a<=16;a++)$("#PopulationAssignmentImage"+a).attr("class","asnImg");for(a=1;a<=farmers;a++)$("#PopulationAssignmentImage"+a).addClass("icon-10x16-Farmer");for(a=farmers+1;a<=farmers+miners;a++)$("#PopulationAssignmentImage"+a).addClass("icon-10x16-Miner");
for(a=farmers+miners+1;a<=farmers+miners+workers;a++)$("#PopulationAssignmentImage"+a).addClass("icon-10x16-Builder")};
Astriarch.View.updateCanvasForPlayer=function(){var a=Astriarch.ClientGameModel.MainPlayer,b;for(b in Astriarch.View.DrawnPlanets)Astriarch.View.DrawnPlanets[b].UpdatePlanetDrawingForPlayer(a);Astriarch.View.CanvasPlayfieldLayer.needsDisplay=!0;Astriarch.View.DrawnFleets=[];Astriarch.View.CanvasFleetsLayer.children=[];for(b in a.FleetsInTransit)a.FleetsInTransit[b].CreateDrawnFleet();for(var c in a.OwnedPlanets){var d=a.OwnedPlanets[c];for(b in d.OutgoingFleets)d.OutgoingFleets[b].CreateDrawnFleet()}Astriarch.View.CanvasFleetsLayer.needsDisplay=
!0};Astriarch.View.loadBackgroundSpriteSheetImage=function(){var a=new Image;a.onload=function(){Astriarch.View.backgroundSpriteSheetImageLoaded()};a.src="img/background-sprites.jpg";Astriarch.View.BackgroundSpriteSheetImage=a};Astriarch.View.backgroundSpriteSheetImageLoaded=function(){var a=Astriarch.View.populateStars();Astriarch.View.populateBackgroundImages();Astriarch.View.paintLargeStars(a);Astriarch.View.drawBorder();$("#loadingSpinner").hide();$("#mainMenu").show()};
Astriarch.View.populateBackgroundImages=function(){for(var a={},b=0;b<Astriarch.View.BACKGROUND_COUNT;b++)a[b]=100;for(var b=Math.floor(Astriarch.View.CanvasBackground[0].height/60),c=Math.floor(Astriarch.View.CanvasBackground[0].width/80),d=0;d<b;d+=2)for(var e=0;e<c;e+=2)if(Astriarch.NextRandom(0,2)==0){var g=Astriarch.NextRandom(0,Math.floor(60)),f=Astriarch.NextRandom(0,Math.floor(80)),h=Astriarch.View.pickRandomTile(a);Astriarch.View.ContextBackground.globalAlpha=Astriarch.NextRandom(70-Astriarch.View.BACKGROUND_DARKNESS,
101-Astriarch.View.BACKGROUND_DARKNESS)/100;Astriarch.View.ContextBackground.drawImage(Astriarch.View.BackgroundSpriteSheetImage,0,h*60,80,60,e*80+f,d*60+g,80,60)}};Astriarch.View.pickRandomTile=function(a){var b=1,c;for(c in a)b+=a[c];var b=Astriarch.NextRandom(0,b),d=c=0,e;for(e in a){var g=a[e];if(b<g+c){d=e;a[e]=Math.floor(g/2);break}c+=g}return d};Astriarch.View.Star=function(a,b,c){this.X=a;this.Y=b;this.Opacity=c};
Astriarch.View.populateStars=function(){for(var a=Math.floor(Astriarch.View.CanvasBackground[0].height/40),b=Math.floor(Astriarch.View.CanvasBackground[0].width/40),c=[],d=[],e=0;e<a;e++)for(var g=0;g<b;g++)for(var f=Astriarch.NextRandom(0,20),h=0;h<f;h++){var i=Astriarch.NextRandom(0,40),j=Astriarch.NextRandom(0,40);if(h>=6||h%2==0){var k=Astriarch.NextRandom(40-Astriarch.View.BACKGROUND_DARKNESS,101-Astriarch.View.BACKGROUND_DARKNESS)/140,k=Math.floor(k*255);c.push(new Astriarch.View.Star(g*40+
j,e*40+i,k))}else d.push(new Astriarch.View.Star(g*40+j,e*40+i,null))}a=Astriarch.View.ContextBackground.createImageData(Astriarch.View.CanvasBackground[0].width,Astriarch.View.CanvasBackground[0].height);for(b=0;b<c.length;b++)e=c[b],g=(e.X+e.Y*Astriarch.View.CanvasBackground[0].width)*4,a.data[g]=255,a.data[g+1]=255,a.data[g+2]=255,a.data[g+3]=e.Opacity;Astriarch.View.ContextBackground.putImageData(a,0,0);return d};
Astriarch.View.paintLargeStars=function(a){for(var b=0;b<a.length;b++){var c=a[b],d=Astriarch.NextRandom(1,6),e=d/2,g=Astriarch.View.ContextBackground.createRadialGradient(c.X,c.Y,0,c.X,c.Y,e),f=Astriarch.NextRandom(0,Astriarch.View.Colors.length);g.addColorStop(0,"white");g.addColorStop(0.5,Astriarch.View.Colors[f]);g.addColorStop(1,"rgba(0, 0, 0, 0)");Astriarch.View.ContextBackground.globalAlpha=Astriarch.NextRandom(50-Astriarch.View.BACKGROUND_DARKNESS,101-Astriarch.View.BACKGROUND_DARKNESS)/100;
Astriarch.View.ContextBackground.fillStyle=g;Astriarch.View.ContextBackground.fillRect(c.X-e,c.Y-e,d,d)}};Astriarch.View.drawBorder=function(){Astriarch.View.ContextBackground.globalAlpha=1;Astriarch.View.ContextBackground.lineWidth=2;Astriarch.View.ContextBackground.strokeStyle="rgba(0, 128, 0, 255)";Astriarch.View.ContextBackground.strokeRect(0,0,800,600)};Astriarch.View.mainMenuIconMouseEnter=function(){$("#MainMenuIcon").hide();$("#MainMenuButton").show()};
Astriarch.View.mainMenuButtonMouseLeave=function(){$("#MainMenuButton").hide();$("#MainMenuIcon").show()};Astriarch.View.speakerIconMouseEnter=function(){$("#SpeakerIcon").hide();$("#ButtonSpeakerToggleMute").show();clearTimeout(Astriarch.View.audioMouseOutTimer);Astriarch.View.audioMouseInTimer=setTimeout(Astriarch.View.audioMouseInTimerTick,200)};
Astriarch.View.muteButtonMouseLeave=function(){$("#ButtonSpeakerToggleMute").hide();$("#SpeakerIcon").show();Astriarch.View.audioMouseOutTimer=setTimeout(Astriarch.View.audioMouseOutTimerTick,200)};Astriarch.View.volumeSliderMouseEnter=function(){clearTimeout(Astriarch.View.audioMouseOutTimer)};Astriarch.View.volumeSliderMouseLeave=function(){Astriarch.View.audioMouseOutTimer=setTimeout(Astriarch.View.audioMouseOutTimerTick,200)};Astriarch.View.audioMouseInTimerTick=function(){$("#SliderVolume").show()};
Astriarch.View.audioMouseOutTimerTick=function(){$("#SliderVolume").hide();clearTimeout(Astriarch.View.audioMouseInTimer)};
Astriarch.View.toggleAudioMute=function(){Astriarch.View.audioInterface.toggleMute();Astriarch.View.audioInterface.muted?($("#SpeakerIcon").removeClass("icon-16x16-speaker-on").addClass("icon-16x16-speaker-off"),$("#ButtonSpeakerToggleMute > .ui-icon").removeClass("icon-16x16-speaker-on").addClass("icon-16x16-speaker-off")):($("#SpeakerIcon").removeClass("icon-16x16-speaker-off").addClass("icon-16x16-speaker-on"),$("#ButtonSpeakerToggleMute > .ui-icon").removeClass("icon-16x16-speaker-off").addClass("icon-16x16-speaker-on"))};
Astriarch.View.volumeSliderValueChanged=function(a,b){Astriarch.View.audioInterface.setVolume(b.value)};Astriarch.View.openTradingCenter=function(){var a=Astriarch.ClientGameModel.MainPlayer.GetPlanetIfOwnedByPlayer(Astriarch.ClientGameModel.GameGrid.SelectedHex.ClientPlanetContainedInHex);a&&Astriarch.TradingControl.show(a)};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.Grid=function(a,b){this.Hexes=[];this.SelectedHex=null;for(var c={},d=0,e=0;e+Astriarch.Hexagon.Static.HEIGHT<=b;e+=Astriarch.Hexagon.Static.HEIGHT/2){var g=0,f=0,h=0;d%2==1&&(h=(Astriarch.Hexagon.Static.WIDTH-Astriarch.Hexagon.Static.SIDE)/2+Astriarch.Hexagon.Static.SIDE,f=1);for(;h+Astriarch.Hexagon.Static.WIDTH<=a;h+=Astriarch.Hexagon.Static.WIDTH+Astriarch.Hexagon.Static.SIDE){var i=new Astriarch.Hexagon(Astriarch.Grid.Static.Letters[d]+(f+1),h,e);i.PathCoOrdX=f;this.Hexes.push(i);c[f]||
(c[f]=[]);c[f].push(i);g++;f+=2}d++}for(h in c)for(e in d=c[h],g=Math.floor(h/2)+h%2,d)i=d[e],i.PathCoOrdY=g++};Astriarch.Grid.Static={Letters:"ABCDEFGHIJKLMNOPQRSTUVWXYZ"};Astriarch.Grid.prototype.SelectHex=function(a){if(this.SelectedHex!=null)this.SelectedHex.Deselect(),this.SelectedHex=null;a.Select();this.SelectedHex=a};Astriarch.Grid.prototype.GetHexAt=function(a){for(var b in this.Hexes)if(this.Hexes[b].Contains(a))return this.Hexes[b];return null};Astriarch.Grid.prototype.ShowHexGrid=function(){for(var a in this.Hexes)this.Hexes[a].Select()};
Astriarch.Grid.prototype.HideHexGrid=function(){};Astriarch.Grid.prototype.GetHexDistance=function(a,b){var c=a.PathCoOrdX-b.PathCoOrdX,d=a.PathCoOrdY-b.PathCoOrdY;return(Math.abs(c)+Math.abs(d)+Math.abs(c-d))/2};var Astriarch=Astriarch||require("./astriarch_base"),jCanvas=jCanvas||require("./../jCanvas");Astriarch.Point=function(a,b){this.X=a;this.Y=b};Astriarch.Rectangle=function(a,b,c,d){this.X=a;this.Y=b;this.Width=c;this.Height=d};Astriarch.Line=function(a,b,c,d){this.X1=a;this.Y1=b;this.X2=c;this.Y2=d};
Astriarch.Hexagon=jCanvas.DrawnObject.extend({init:function(a,b,c){this.Points=[];var d=(Astriarch.Hexagon.Static.WIDTH-Astriarch.Hexagon.Static.SIDE)/2,e=Astriarch.Hexagon.Static.HEIGHT/2;this.Points.push(new Astriarch.Point(d+b,c));this.Points.push(new Astriarch.Point(d+Astriarch.Hexagon.Static.SIDE+b,c));this.Points.push(new Astriarch.Point(Astriarch.Hexagon.Static.WIDTH+b,e+c));this.Points.push(new Astriarch.Point(d+Astriarch.Hexagon.Static.SIDE+b,Astriarch.Hexagon.Static.HEIGHT+c));this.Points.push(new Astriarch.Point(d+
b,Astriarch.Hexagon.Static.HEIGHT+c));this.Points.push(new Astriarch.Point(b,e+c));this.Id=a;this.x=b;this.y=c;this.TopLeftPoint=new Astriarch.Point(this.x,this.y);this.BottomRightPoint=new Astriarch.Point(this.x+Astriarch.Hexagon.Static.WIDTH,this.y+Astriarch.Hexagon.Static.HEIGHT);this.MidPoint=new Astriarch.Point(this.x+Astriarch.Hexagon.Static.WIDTH/2,this.y+Astriarch.Hexagon.Static.HEIGHT/2);this.ClientPlanetContainedInHex=this.PlanetContainedInHex=this.zIndex=this.PathCoOrdY=this.PathCoOrdX=
null;this.selected=!1},draw:function(a){if(this.selected){a.strokeStyle="green";a.lineWidth=2;a.beginPath();a.moveTo(this.Points[0].X,this.Points[0].Y);for(var b=1;b<this.Points.length;b++){var c=this.Points[b];a.lineTo(c.X,c.Y)}a.closePath();a.stroke()}},isInBounds:function(a,b){return this.Contains(new Astriarch.Point(a,b))},Select:function(){this.selected=!0;this.layer.needsDisplay=!0},Deselect:function(){this.selected=!1;this.layer.needsDisplay=!0},isInHexBounds:function(a){if(this.TopLeftPoint.X<
a.X&&this.TopLeftPoint.Y<a.Y&&a.X<this.BottomRightPoint.X&&a.Y<this.BottomRightPoint.Y)return!0;return!1},Contains:function(a){var b=!1;if(this.isInHexBounds(a)){var c,d=0;c=0;for(d=this.Points.length-1;c<this.Points.length;d=c++){var e=this.Points[c],d=this.Points[d];if((e.Y<=a.Y&&a.Y<d.Y||d.Y<=a.Y&&a.Y<e.Y)&&a.X<(d.X-e.X)*(a.Y-e.Y)/(d.Y-e.Y)+e.X)b=!b}}return b}});Astriarch.Hexagon.Static={HEIGHT:40,WIDTH:55,SIDE:25};Astriarch=Astriarch||require("./astriarch_base");Astriarch.TradingCenter=function(){this.goldAmount=1E3;this.foodResource=new Astriarch.TradingCenter.Resource(Astriarch.TradingCenter.ResourceType.FOOD,320,400,0.1,1.5);this.oreResource=new Astriarch.TradingCenter.Resource(Astriarch.TradingCenter.ResourceType.ORE,10,200,0.2,3);this.iridiumResource=new Astriarch.TradingCenter.Resource(Astriarch.TradingCenter.ResourceType.IRIDIUM,5,100,0.4,6);this.currentTrades=[]};
Astriarch.TradingCenter.prototype.recalculatePrices=function(){this.foodResource.calculateCurrentPrice();this.oreResource.calculateCurrentPrice();this.iridiumResource.calculateCurrentPrice()};Astriarch.TradingCenter.prototype.getResourceByType=function(a){return a==Astriarch.TradingCenter.ResourceType.FOOD?this.foodResource:a==Astriarch.TradingCenter.ResourceType.ORE?this.oreResource:this.iridiumResource};
Astriarch.TradingCenter.prototype.executeTrade=function(a,b,c,d){var e={executed:!1,foodAmount:0,oreAmount:0,iridiumAmount:0,tradeGoldAmount:0},g=this.getResourceByType(d.resourceType),f=0;d.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?(f=b.TotalFoodAmount(),e.foodAmount=d.amount):d.resourceType==Astriarch.TradingCenter.ResourceType.ORE?(f=b.TotalOreAmount(),e.oreAmount=d.amount):(f=b.TotalIridiumAmount(),e.iridiumAmount=d.amount);e.tradeGoldAmount=d.amount*g.currentPrice;if(d.tradeType==
Astriarch.TradingCenter.TradeType.SELL){if(e.tradeGoldAmount-=e.tradeGoldAmount*0.1,this.goldAmount>=e.tradeGoldAmount&&f>=d.amount)this.goldAmount-=e.tradeGoldAmount,b.Resources.GoldRemainder+=e.tradeGoldAmount,g.amount+=d.amount,c.SpendResources(a,0,e.foodAmount,e.oreAmount,e.iridiumAmount,b),e.executed=!0}else if(e.tradeGoldAmount+=e.tradeGoldAmount*0.1,b.Resources.GoldAmount>=e.tradeGoldAmount&&g.amount>=d.amount)this.goldAmount+=e.tradeGoldAmount,b.Resources.GoldRemainder-=e.tradeGoldAmount,
g.amount-=d.amount,d.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?c.Resources.FoodAmount+=d.amount:d.resourceType==Astriarch.TradingCenter.ResourceType.ORE?c.Resources.OreAmount+=d.amount:c.Resources.IridiumAmount+=d.amount,e.executed=!0;return e};Astriarch.TradingCenter.ResourceType={FOOD:1,ORE:2,IRIDIUM:3};Astriarch.TradingCenter.Resource=function(a,b,c,d,e){this.type=a;this.amount=b;this.desiredAmount=c;this.priceMin=d;this.currentPrice=this.priceMax=e;this.calculateCurrentPrice()};
Astriarch.TradingCenter.Resource.prototype.calculateCurrentPrice=function(){this.currentPrice=this.amount>=this.desiredAmount?this.priceMin:this.amount<=0?this.priceMax:this.priceMin+(this.priceMax-this.priceMin)/this.desiredAmount*(this.desiredAmount-this.amount)};Astriarch.TradingCenter.TradeType={BUY:1,SELL:2};Astriarch.TradingCenter.OrderType={MARKET:1,LIMIT:2};
Astriarch.TradingCenter.Trade=function(a,b,c,d,e,g,f){this.playerId=a;this.planetId=b;this.tradeType=c;this.resourceType=d;this.amount=e;this.orderType=g;this.limitPrice=f};Astriarch.TradingCenter.TradeToString=function(a){return(a.tradeType==Astriarch.TradingCenter.TradeType.BUY?"Buy":"Sell")+" "+a.amount+" "+(a.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?"Food":a.resourceType==Astriarch.TradingCenter.ResourceType.ORE?"Ore":"Iridium")};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.Model=function(a,b,c){this.ShowUnexploredPlanetsAndEnemyPlayerStats=!1;this.SystemsToGenerate=b.systemsToGenerate;this.PlanetsPerSystem=b.planetsPerSystem;this.DistributePlanetsEvenly=b.distributePlanetsEvenly;this.TurnTimeLimitSeconds=b.turnTimeLimitSeconds;this.Turn=new Astriarch.Model.Turn;this.TradingCenter=new Astriarch.TradingCenter;this.Players=a;this.PlayersDestroyed=[];this.GameGrid=new Astriarch.Grid(615,480);this.Planets=[];this.galaxyWidth=615;this.galaxyHeight=480;this.Quadrants=
[];this.SubQuadrants=[];var d,e,b=a=0;d=this.galaxyWidth/2;e=this.galaxyHeight/2;this.SystemsToGenerate==2||this.SystemsToGenerate==4?(this.Quadrants.push(new Astriarch.Model.Rect(a,b,d,e)),a=d,this.Quadrants.push(new Astriarch.Model.Rect(a,b,d,e)),b=e,this.Quadrants.push(new Astriarch.Model.Rect(a,b,d,e)),a=0):(this.Quadrants.push(new Astriarch.Model.Rect(a,b,d,e)),this.Quadrants.push(new Astriarch.Model.Rect(d,b,d,e)),a=d/2,b=e);this.Quadrants.push(new Astriarch.Model.Rect(a,b,d,e));c||this.populatePlanets()};
Astriarch.Model.prototype.populatePlanets=function(){for(var a=0;a<this.Quadrants.length;a++){var b=this.Quadrants[a],c=[],d=b.Width/2,e=b.Height/2,g=new Astriarch.Model.Rect(b.X,b.Y,d,e);c.push(g);g=new Astriarch.Model.Rect(b.X+d,b.Y,d,e);a==1?c.splice(0,0,g):c.push(g);g=new Astriarch.Model.Rect(b.X+d,b.Y+e,d,e);a==2?c.splice(0,0,g):c.push(g);b=new Astriarch.Model.Rect(b.X,b.Y+e,d,e);a==3?c.splice(0,0,b):c.push(b);this.SubQuadrants.push(c);b=[];d=[];for(e=0;e<c.length;e++)for(var f in g=c[e],b[e]=
[],d[e]=[],this.GameGrid.Hexes){var h=this.GameGrid.Hexes[f];g.Left!==h.TopLeftPoint.X&&g.Top!==h.TopLeftPoint.Y&&g.Right!==h.BottomRightPoint.X&&g.Bottom!==h.BottomRightPoint.Y&&g.Contains(h.TopLeftPoint)&&g.Contains(h.BottomRightPoint)?(b[e].push(h),d[e].push(h)):g.Contains(h.TopLeftPoint)&&g.Contains(h.BottomRightPoint)&&d[e].push(h)}if(!(this.SystemsToGenerate==2&&(a==1||a==3))){var i=[];i.push(Astriarch.Planet.PlanetType.PlanetClass1);i.push(Astriarch.Planet.PlanetType.DeadPlanet);i.push(Astriarch.Planet.PlanetType.AsteroidBelt);
for(e=0;e<c.length;e++){var j=e;if(!this.DistributePlanetsEvenly){do j=Astriarch.NextRandom(0,c.length);while(b[j].length==0)}h=Astriarch.NextRandom(0,b[j].length);g=b[j][h];b[j].splice(h,1);j=3;h=Astriarch.Planet.PlanetType.PlanetClass2;e>0&&i.length<=3&&(j=Astriarch.NextRandom(0,i.length),h=i[j],i.splice(j,1));var j=null,k=!1,l=0;h==Astriarch.Planet.PlanetType.PlanetClass2&&(a==0?k=!0:this.Players.length==2?a==2&&(k=!0,l=1):a<this.Players.length&&(k=!0,l=a));k&&(j=this.Players[l],j.SetColor(Astriarch.Model.PlayerColors[l]));
g=new Astriarch.Planet(h,g.Id,g,j);if(j)g.Resources.OreAmount=2,g.Resources.IridiumAmount=1;this.Planets.push(g)}if(this.PlanetsPerSystem!=Astriarch.Model.PlanetsPerSystemOption.FOUR)for(var k=j=i=c=25,l=50,m=34,o=16,n=4;n<this.PlanetsPerSystem;n++)for(var q=!1;!q;){var e=0,p=c+i+j+k;Astriarch.NextRandom(0,p)>c&&(e=1,Astriarch.NextRandom(0,p)>i&&(e=2,Astriarch.NextRandom(0,p)>j&&(e=3)));h=Astriarch.NextRandom(0,d[e].length);g=d[e][h];b[e].splice(h,1);if(g.PlanetContainedInHex==null){switch(e){case 0:c-=
6;break;case 1:i-=6;break;case 2:j-=6;break;case 3:k-=6}h=Astriarch.Planet.PlanetType.PlanetClass1;p=l+m+o;Astriarch.NextRandom(0,p)>o?(h=Astriarch.Planet.PlanetType.DeadPlanet,Astriarch.NextRandom(0,p)>m?(h=Astriarch.Planet.PlanetType.AsteroidBelt,l-=15):m-=15):o-=15;g=new Astriarch.Planet(h,g.Id,g,null);this.Planets.push(g);q=!0}}}}};
Astriarch.Model.PlayerColors=[new Astriarch.Util.ColorRGBA(0,255,0,255),new Astriarch.Util.ColorRGBA(200,0,200,255),new Astriarch.Util.ColorRGBA(0,128,255,255),new Astriarch.Util.ColorRGBA(255,0,0,255)];Astriarch.Model.Rect=function(a,b,c,d){this.X=a;this.Y=b;this.Width=c;this.Height=d;this.Left=a;this.Right=a+c;this.Top=b;this.Bottom=b+d};Astriarch.Model.Rect.prototype.Contains=function(a){return this.Left<=a.X&&this.Right>=a.X&&this.Bottom>=a.Y&&this.Top<=a.Y?!0:!1};
Astriarch.Model.Turn=function(){this.Number=1};Astriarch.Model.Turn.prototype.Next=function(){this.Number++};Astriarch.Model.PlanetsPerSystemOption={FOUR:4,FIVE:5,SIX:6,SEVEN:7,EIGHT:8};
Astriarch.Model.WorkingPlayerResources=function(a,b){a?(this.GoldAmount=a.Resources.GoldAmount,this.GoldRemainder=0,this.OreAmount=a.TotalOreAmount(),this.OreRemainder=0,this.IridiumAmount=a.TotalIridiumAmount(),this.IridiumRemainder=0):(this.GoldAmount=b.GoldAmount,this.GoldRemainder=b.GoldRemainder,this.OreAmount=b.OreAmount,this.OreRemainder=b.OreRemainder,this.IridiumAmount=b.IridiumAmount,this.IridiumRemainder=b.IridiumRemainder)};
Astriarch.Model.WorkingPlayerResources.prototype.AccumulateResourceRemainders=function(){this.GoldRemainder>=1&&(this.GoldAmount+=Math.floor(this.GoldRemainder/1),this.GoldRemainder%=1);this.OreRemainder>=1&&(this.OreAmount+=Math.floor(this.OreRemainder/1),this.OreRemainder%=1);this.IridiumRemainder>=1&&(this.IridiumAmount+=Math.floor(this.IridiumRemainder/1),this.IridiumRemainder%=1)};Astriarch=Astriarch||require("./astriarch_base");Astriarch.Player=function(a,b){this.Id=Astriarch.Player.Static.NEXT_PLAYER_ID++;this.Type=a;this.Name=b;this.Resources=new Astriarch.Player.PlayerResources;this.Color=new Astriarch.Util.ColorRGBA(0,255,0,255);this.LastTurnFoodNeededToBeShipped=0;this.OwnedPlanets={};this.KnownClientPlanets={};this.LastKnownPlanetFleetStrength={};this.PlanetBuildGoals={};this.HomePlanet=null;this.Points=0;this.FleetsInTransit=[];this.fleetsArrivingOnUnownedPlanets={}};
Astriarch.Player.Static={NEXT_PLAYER_ID:1};Astriarch.Player.prototype.SetColor=function(a){Astriarch.Util.GetImageData(a);this.Color=a};Astriarch.Player.prototype.GetOwnedPlanetsListSorted=function(){var a=[],b;for(b in this.OwnedPlanets)a.push(this.OwnedPlanets[b]);a.sort(Astriarch.Planet.PlanetPopulationImprovementCountComparerSortFunction);return a};Astriarch.Player.prototype.TotalFoodAmount=function(){var a=0,b;for(b in this.OwnedPlanets)a+=this.OwnedPlanets[b].Resources.FoodAmount;return a};
Astriarch.Player.prototype.ExactTotalFoodAmount=function(){var a=0,b;for(b in this.OwnedPlanets)a+=this.OwnedPlanets[b].Resources.FoodRemainder,a+=this.OwnedPlanets[b].Resources.FoodAmount;return a};Astriarch.Player.prototype.TotalOreAmount=function(){var a=0,b;for(b in this.OwnedPlanets)a+=this.OwnedPlanets[b].Resources.OreAmount;return a};
Astriarch.Player.prototype.ExactTotalOreAmount=function(){var a=0,b;for(b in this.OwnedPlanets)a+=this.OwnedPlanets[b].Resources.OreRemainder,a+=this.OwnedPlanets[b].Resources.OreAmount;return a};Astriarch.Player.prototype.TotalIridiumAmount=function(){var a=0,b;for(b in this.OwnedPlanets)a+=this.OwnedPlanets[b].Resources.IridiumAmount;return a};
Astriarch.Player.prototype.ExactTotalIridiumAmount=function(){var a=0,b;for(b in this.OwnedPlanets)a+=this.OwnedPlanets[b].Resources.IridiumRemainder,a+=this.OwnedPlanets[b].Resources.IridiumAmount;return a};Astriarch.Player.prototype.AddFleetArrivingOnUnownedPlanet=function(a,b){this.fleetsArrivingOnUnownedPlanets[a.Id]?this.fleetsArrivingOnUnownedPlanets[a.Id].MergeFleet(b):this.fleetsArrivingOnUnownedPlanets[a.Id]=b};
Astriarch.Player.prototype.GatherFleetsArrivingOnUnownedPlanets=function(){var a=[],b;for(b in this.fleetsArrivingOnUnownedPlanets)a.push(this.fleetsArrivingOnUnownedPlanets[b]);this.fleetsArrivingOnUnownedPlanets={};return a};Astriarch.Player.prototype.GetPlanetIfOwnedByPlayer=function(a){var b=null;a.Id in this.OwnedPlanets&&(b=this.OwnedPlanets[a.Id]);return b};
Astriarch.Player.prototype.PlanetTypeIfKnownByPlayer=function(a){var b=null;if(a.Id in this.KnownClientPlanets)b=this.KnownClientPlanets[a.Id].Type;return b};Astriarch.Player.prototype.PlanetContainsFriendlyInboundFleet=function(a){for(var b in this.FleetsInTransit)if(this.FleetsInTransit[b].DestinationHex.PlanetContainedInHex.Id==a.Id)return!0;return!1};Astriarch.Player.prototype.GetTotalPopulation=function(){var a=0,b;for(b in this.OwnedPlanets)a+=this.OwnedPlanets[b].Population.length;return a};
Astriarch.Player.prototype.GetTotalResourceProductionPerTurn=function(){var a={food:0,food_exact:0,ore:0,ore_exact:0,iridium:0,iridium_exact:0},b;for(b in this.OwnedPlanets){var c=this.OwnedPlanets[b];a.food+=c.ResourcesPerTurn.FoodAmountPerTurn;a.food_exact+=c.ResourcesPerTurn.FoodAmountPerTurn+c.ResourcesPerTurn.RemainderFoodPerTurn;a.ore+=c.ResourcesPerTurn.OreAmountPerTurn;a.ore_exact+=c.ResourcesPerTurn.OreAmountPerTurn+c.ResourcesPerTurn.RemainderOrePerTurn;a.iridium+=c.ResourcesPerTurn.IridiumAmountPerTurn;
a.iridium_exact+=c.ResourcesPerTurn.IridiumAmountPerTurn+c.ResourcesPerTurn.RemainderIridiumPerTurn}return a};Astriarch.Player.PlayerType={Human:0,Computer_Easy:1,Computer_Normal:2,Computer_Hard:3,Computer_Expert:4};Astriarch.Player.PlayerResources=function(){this.GoldAmount=3;this.GoldRemainder=0};
Astriarch.Player.PlayerResources.prototype.AccumulateResourceRemainders=function(){if(this.GoldRemainder>=1||this.GoldRemainder<=-1)this.GoldAmount+=this.GoldRemainder>=1?Math.floor(this.GoldRemainder/1):Math.ceil(this.GoldRemainder/1),this.GoldRemainder%=1};Astriarch.Player.PlayerResources.prototype.SpendGoldAsPossible=function(a){this.GoldAmount>=a?this.GoldAmount-=a:(a-=this.GoldAmount,this.GoldAmount=0);return a};
Astriarch.Player.PlayerGameOptions=function(){this.ShowHexGrid=!1;this.ShowPlanetaryConflictPopups=!0};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.Planet=function(a,b,c,d){this.Id=Astriarch.Planet.Static.NEXT_PLANET_ID++;this.Name=b;this.Type=a;this.Population=[];this.RemainderProductionFraction=this.RemainderProduction=0;this.BuildQueue=[];this.BuiltImprovements={};this.Resources=this.MaxImprovements=null;this.BoundingHex=c;this.PlanetaryFleet=this.Owner=this.OriginPoint=null;this.OutgoingFleets=[];this.ResourcesPerTurn=null;this.PlanetHappiness=Astriarch.Planet.PlanetHappinessType.Normal;this.SetPlanetOwner(d);if(this.Type==Astriarch.Planet.PlanetType.AsteroidBelt)this.Population=
[];this.recomputeOriginPoint();this.BuildQueue=[];this.BuiltImprovements={};this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Colony]=[];this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory]=[];this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Farm]=[];this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine]=[];this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform]=[];this.Resources=new Astriarch.Planet.PlanetResources;this.StarShipTypeLastBuilt=
null;this.BuildLastStarShip=!0;if(d!==null)this.Population.push(new Astriarch.Planet.Citizen(this.Type,d.Id)),this.Population.push(new Astriarch.Planet.Citizen(this.Type,d.Id)),this.Resources.FoodAmount=4;this.ResourcesPerTurn=new Astriarch.Planet.PlanetPerTurnResourceGeneration(this,this.Type);this.GenerateResources();switch(this.Type){case Astriarch.Planet.PlanetType.AsteroidBelt:this.MaxImprovements=3;this.PlanetaryFleet=Astriarch.Fleet.StarShipFactoryHelper.GenerateShips(d,Astriarch.Fleet.StarShipType.SystemDefense,
0,this.BoundingHex);break;case Astriarch.Planet.PlanetType.DeadPlanet:this.MaxImprovements=5;this.PlanetaryFleet=Astriarch.Fleet.StarShipFactoryHelper.GenerateShips(d,Astriarch.Fleet.StarShipType.SystemDefense,Astriarch.NextRandom(2,5),this.BoundingHex);break;case Astriarch.Planet.PlanetType.PlanetClass1:this.MaxImprovements=6;this.PlanetaryFleet=Astriarch.Fleet.StarShipFactoryHelper.GenerateShips(d,Astriarch.Fleet.StarShipType.SystemDefense,Astriarch.NextRandom(5,10),this.BoundingHex);break;case Astriarch.Planet.PlanetType.PlanetClass2:this.MaxImprovements=
9;this.PlanetaryFleet=Astriarch.Fleet.StarShipFactoryHelper.GenerateShips(d,Astriarch.Fleet.StarShipType.SystemDefense,Astriarch.NextRandom(10,15),this.BoundingHex);break;default:throw new NotImplementedException("Planet type "+this.Type+"not supported by planet constructor.");}this.maxPopulation=this.MaxImprovements;c.PlanetContainedInHex=this};Astriarch.Planet.Static={NEXT_PLANET_ID:1,PLANET_SIZE:20};
Astriarch.Planet.prototype.GetPopulationByContentment=function(){var a={protesting:[],content:[]},b;for(b in this.Population){var c=this.Population[b];c.ProtestLevel>0?a.protesting.push(c):a.content.push(c)}return a};Astriarch.Planet.prototype.MaxPopulation=function(){return this.maxPopulation+this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Colony].length};
Astriarch.Planet.prototype.BuiltImprovementCount=function(){var a=0,b;for(b in this.BuiltImprovements)b!=Astriarch.Planet.PlanetImprovementType.SpacePlatform&&(a+=this.BuiltImprovements[b].length);return a};
Astriarch.Planet.prototype.RemoveBuildQueueItemForRefund=function(a){var b=0;if(this.BuildQueue.length>a){var c=[],d;for(d in this.BuildQueue)c.push(this.BuildQueue[d]);var e=c[a].GetRefundAmount();b+=e.Gold;this.Owner.Resources.GoldRemainder+=e.Gold;this.Owner.Resources.OreRemainder+=e.Ore;this.Owner.Resources.IridiumRemainder+=e.Iridium;this.Owner.Resources.AccumulateResourceRemainders();c.splice(a,1);this.BuildQueue=[];for(d in c)this.BuildQueue.push(c[d])}return b};
Astriarch.Planet.prototype.BuiltAndBuildQueueImprovementCount=function(){var a=this.BuiltImprovementCount(),b;for(b in this.BuildQueue){var c=this.BuildQueue[b];c instanceof Astriarch.Planet.PlanetImprovement&&c.Type!=Astriarch.Planet.PlanetImprovementType.SpacePlatform&&a++}return a};
Astriarch.Planet.prototype.BuiltAndBuildQueueImprovementTypeCount=function(a){var b=this.BuiltImprovements[a].length,c;for(c in this.BuildQueue){var d=this.BuildQueue[c];d instanceof Astriarch.Planet.PlanetImprovement&&d.Type==a&&b++}return b};
Astriarch.Planet.prototype.BuildQueueContainsMobileStarship=function(a){a.turnsToComplete=99;a.starshipStrength=0;for(var b in this.BuildQueue){var c=this.BuildQueue[b];if(c instanceof Astriarch.Planet.StarShipInProduction&&c.Type!=Astriarch.Fleet.StarShipType.SystemDefense)return a.turnsToComplete=c.TurnsToComplete,a.starshipStrength=(new Astriarch.Fleet.StarShip(c.Type)).BaseStarShipStrength,!0}return!1};
Astriarch.Planet.prototype.BuildQueueContainsImprovement=function(a){for(var b in this.BuildQueue){var c=this.BuildQueue[b];if(c instanceof Astriarch.Planet.PlanetImprovement&&c.Type==a)return!0}return!1};Astriarch.Planet.prototype.EnqueueProductionItemAndSpendResources=function(a,b,c){b&&(this.BuildQueue.push(b),this.SpendResources(a,b.GoldCost,0,b.OreCost,b.IridiumCost,c))};
Astriarch.Planet.prototype.SpendResources=function(a,b,c,d,e,g){g.Resources.GoldAmount-=b;b=c-this.Resources.SpendFoodAsPossible(c);d-=this.Resources.SpendOreAsPossible(d);e-=this.Resources.SpendIridiumAsPossible(e);if(b!=0||d!=0||e!=0){var c=[],f;for(f in g.OwnedPlanets)this.Id!=g.OwnedPlanets[f].Id&&c.push(g.OwnedPlanets[f]);a=new Astriarch.Planet.PlanetDistanceComparer(a,this);c.sort(a.sortFunction);for(f in c)if(b!=0&&(b-=c[f].Resources.SpendFoodAsPossible(d)),d!=0&&(d-=c[f].Resources.SpendOreAsPossible(d)),
e!=0&&(e-=c[f].Resources.SpendIridiumAsPossible(e)),b==0&&d==0&&e==0)break;(b!=0||d!=0||e!=0)&&console.warn("Problem spending food, ore and iridium as necessary! Player:",g.Name,this.Name,b,d,e)}};Astriarch.Planet.prototype.recomputeOriginPoint=function(){this.OriginPoint=new Astriarch.Point(this.BoundingHex.MidPoint.X-Astriarch.Planet.Static.PLANET_SIZE/2,this.BoundingHex.MidPoint.Y-Astriarch.Planet.Static.PLANET_SIZE/2)};
Astriarch.Planet.prototype.GenerateResources=function(){this.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats();if(this.Owner!==null){var a=1;this.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Unrest?a=2:this.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Riots&&(a=4);this.Resources.FoodAmount+=Math.round(this.ResourcesPerTurn.FoodAmountPerTurn/a);this.Resources.FoodRemainder+=this.ResourcesPerTurn.RemainderFoodPerTurn/a;this.Resources.OreAmount+=Math.round(this.ResourcesPerTurn.OreAmountPerTurn/
a);this.Resources.OreRemainder+=this.ResourcesPerTurn.RemainderOrePerTurn/a;this.Resources.IridiumAmount+=Math.round(this.ResourcesPerTurn.IridiumAmountPerTurn/a);this.Resources.IridiumRemainder+=this.ResourcesPerTurn.RemainderIridiumPerTurn/a;this.Resources.AccumulateResourceRemainders()}};
Astriarch.Planet.prototype.BuildImprovements=function(a){a.buildQueueEmpty=!1;var b=[];if(this.BuildQueue.length>0){var a=this.BuildQueue.slice(0,1)[0],c=this.ResourcesPerTurn.GetProductionDivisor(),d=this.ResourcesPerTurn.GetProductionAmountPerTurn();this.RemainderProductionFraction+=this.ResourcesPerTurn.RemainderProductionPerTurn/c;this.RemainderProductionFraction>=1&&(this.RemainderProduction+=Math.floor(this.RemainderProductionFraction/1),this.RemainderProductionFraction%=1);a.ProductionCostComplete+=
d+this.RemainderProduction;this.RemainderProduction=0;if(a.ProductionCostComplete>=a.BaseProductionCost){a=this.BuildQueue.shift();a.TurnsToComplete=0;this.Owner&&(this.Owner.Points+=Astriarch.ServerController.POINTS_PER_PRODUCTION_UNIT_BUILT*a.BaseProductionCost);c="Nothing";this.BuildQueue.length>0&&(c=this.BuildQueue.slice(0,1)[0].ToString());if(a instanceof Astriarch.Planet.PlanetImprovement){this.BuiltImprovements[a.Type].push(a);if(a.Type==Astriarch.Planet.PlanetImprovementType.SpacePlatform)this.PlanetaryFleet.HasSpacePlatform=
!0;b.push(new Astriarch.SerializableTurnEventMessage(Astriarch.TurnEventMessage.TurnEventMessageType.ImprovementBuilt,this,a.ToString()+" built on planet: "+this.Name+", next in queue: "+c))}else if(a instanceof Astriarch.Planet.StarShipInProduction)d=new Astriarch.Fleet.StarShip(a.Type),this.PlanetaryFleet.StarShips[a.Type].push(d),this.StarShipTypeLastBuilt=a.Type,b.push(new Astriarch.SerializableTurnEventMessage(Astriarch.TurnEventMessage.TurnEventMessageType.ShipBuilt,this,a.ToString()+" built on planet: "+
this.Name+", next in queue: "+c));else if(a instanceof Astriarch.Planet.PlanetImprovementToDestroy&&this.BuiltImprovements[a.TypeToDestroy].length>0){this.BuiltImprovements[a.TypeToDestroy].pop();for(b.push(new Astriarch.SerializableTurnEventMessage(Astriarch.TurnEventMessage.TurnEventMessageType.ImprovementDemolished,this,Astriarch.GameTools.PlanetImprovementTypeToFriendlyName(a.TypeToDestroy)+" demolished on planet: "+this.Name+", next in queue: "+c));this.MaxPopulation()<this.Population.length;)this.Population.pop()}this.RemainderProduction=
a.ProductionCostComplete-a.BaseProductionCost;this.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats()}else a.EstimateTurnsToComplete(d)}else a.buildQueueEmpty=!0;return b};Astriarch.Planet.prototype.GetClientPlanet=function(){return new Astriarch.ClientPlanet(this.Id,this.Name,this.OriginPoint,null,this.BoundingHex,this.Type)};
Astriarch.Planet.prototype.SetPlanetOwner=function(a){var b=0,c=null;if(a)c=a.Id;if(this.Owner!==null){for(var d=this.BuildQueue.length-1;d>=0;d--)b+=this.RemoveBuildQueueItemForRefund(d);this.RemainderProductionFraction=this.RemainderProduction=0;this.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform]=[];this.Owner.PlanetBuildGoals[this.Id]&&delete this.Owner.PlanetBuildGoals[this.Id];delete this.Owner.OwnedPlanets[this.Id];for(var d=0,e=null,g=0;g<this.Population.length;g++)e=
this.Population[g],e.LoyalToPlayerId&&e.LoyalToPlayerId==c||Astriarch.NextRandom(0,3)==0?(e.ProtestLevel=0,e.LoyalToPlayerId=c,d++):e.ProtestLevel=Astriarch.NextRandomFloat(e.LoyalToPlayerId?0.5:0,e.LoyalToPlayerId?1:0.5);if(d==0&&this.Population.length>0)e=this.Population[0],e.ProtestLevel=0,e.LoyalToPlayerId=c;this.PlanetHappiness=Astriarch.Planet.PlanetHappinessType.Riots;a&&(a.Points+=Astriarch.ServerController.POINTS_PER_CITIZEN_ON_CAPTURED_PLANET*this.Population.length)}if(this.Owner=a){a.KnownClientPlanets[this.Id]=
this.GetClientPlanet();if(Astriarch.CountObjectKeys(a.OwnedPlanets)==0)a.HomePlanet=this;a.OwnedPlanets[this.Id]=this}this.Population.length==0&&this.Population.push(new Astriarch.Planet.Citizen(this.Type,c));return b};Astriarch.Planet.prototype.SetPlanetExplored=function(a,b){var c=this.GetClientPlanet();c.Type=this.Type;b.KnownClientPlanets[this.Id]=c;this.SetPlayerLastKnownPlanetFleetStrength(a,b)};
Astriarch.Planet.prototype.SetPlayerLastKnownPlanetFleetStrength=function(a,b){var c=Astriarch.Fleet.StarShipFactoryHelper.GenerateFleetWithShipCount(b,this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].length,this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Scout].length,this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length,this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length,this.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Battleship].length,
this.BoundingHex);c.SetFleetHasSpacePlatform();c=new Astriarch.Fleet.LastKnownFleet(c,this.Owner);c.TurnLastExplored=a.Turn.Number;b.LastKnownPlanetFleetStrength[this.Id]=c};
Astriarch.Planet.prototype.CountPopulationWorkerTypes=function(a){workers=miners=farmers=0;var b=this.GetPopulationByContentment(),c;for(c in b.content)switch(b.content[c].WorkerType){case Astriarch.Planet.CitizenWorkerType.Farmer:farmers++;break;case Astriarch.Planet.CitizenWorkerType.Miner:miners++;break;case Astriarch.Planet.CitizenWorkerType.Worker:workers++}a.Farmers=farmers;a.Miners=miners;a.Workers=workers};
Astriarch.Planet.prototype.UpdatePopulationWorkerTypesByDiff=function(a,b,c,d,e,g){for(;d!==0;)if(d>0){if(b>0&&e<0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Miner).WorkerType=Astriarch.Planet.CitizenWorkerType.Farmer,b--,a++,d--,e++;if(d!==0&&c>0&&g<0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Worker).WorkerType=Astriarch.Planet.CitizenWorkerType.Farmer,c--,a++,d--,g++}else{if(e>0&&b<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Farmer).WorkerType=
Astriarch.Planet.CitizenWorkerType.Miner,a--,b++,d++,e--;if(d!==0&&g>0&&c<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Farmer).WorkerType=Astriarch.Planet.CitizenWorkerType.Worker,a--,c++,d++,g--}for(;e!==0;)if(e>0){if(c>0&&g<0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Worker).WorkerType=Astriarch.Planet.CitizenWorkerType.Miner,c--,b++,e--,g++}else if(g>0&&c<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Miner).WorkerType=Astriarch.Planet.CitizenWorkerType.Worker,
b--,c++,e++,g--;(d!==0||e!==0||g!==0)&&console.error("Couldn't move workers in Planet.UpdatePopulationWorkerTypesByDiff!",d,e,g)};
Astriarch.Planet.prototype.UpdatePopulationWorkerTypes=function(a,b,c){var d=new Astriarch.Planet.PopulationAssignments;this.CountPopulationWorkerTypes(d);for(var e=d.Farmers,g=d.Miners,d=d.Workers,f=a-e;e!=a;)if(f>0){if(g>0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Miner).WorkerType=Astriarch.Planet.CitizenWorkerType.Farmer,g--,e++,f--;if(f>0&&d>0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Worker).WorkerType=Astriarch.Planet.CitizenWorkerType.Farmer,d--,e++,f--}else{if(g<
b&&g<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Farmer).WorkerType=Astriarch.Planet.CitizenWorkerType.Miner,e--,g++,f++;if(f<0&&d<c&&d<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Farmer).WorkerType=Astriarch.Planet.CitizenWorkerType.Worker,e--,d++,f++}for(f=b-g;g!=b;)if(f>0){if(d>0)this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Worker).WorkerType=Astriarch.Planet.CitizenWorkerType.Miner,d--,g++,f--}else if(d<c&&d<this.MaxPopulation())this.getCitizenType(Astriarch.Planet.CitizenWorkerType.Miner).WorkerType=
Astriarch.Planet.CitizenWorkerType.Worker,g--,d++,f++;(e!=a||g!=b||d!=c)&&console.error("Couldn't move workers in Planet.UpdatePopulationWorkerTypes! targets: ",a,b,c,"currents:",e,g,d)};
Astriarch.Planet.prototype.getCitizenType=function(a){var b=this.GetPopulationByContentment(),c;for(c in b.content)if(b.content[c].WorkerType==a)return b.content[c];if(b.content.length>0)return console.error("Couldn't find: "+a+" in Planet.getCitizenType!"),b.content[0];else if(b.protesting.length>0){for(var d in b.protesting)if(b.protesting[d].WorkerType==a)return console.error("No content citizens found in Planet.getCitizenType! Returning protesting citizen."),b.protesting[d];console.error("Couldn't find: "+
a+" in Planet.getCitizenType for protesting citizens!");return b.protesting[0]}else return console.error("No citizens found in Planet.getCitizenType!"),null};Astriarch.Planet.PlanetPopulationImprovementCountComparerSortFunction=function(a,b){var c=b.Population.length.compareTo(a.Population.length);c==0&&(c=b.BuiltImprovementCount().compareTo(a.BuiltImprovementCount()));return c};Astriarch.Planet.PlanetFoodProductionComparerSortFunction=function(a,b){return b.ResourcesPerTurn.FoodAmountPerWorkerPerTurn().compareTo(a.ResourcesPerTurn.FoodAmountPerWorkerPerTurn())};
Astriarch.Planet.PlanetMineralProductionComparer=function(a,b){this.oreNeeded=a;this.iridiumNeeded=b};Astriarch.Planet.PlanetMineralProductionComparer.prototype.sortFunction=function(a,b){var c=0;return c=this.oreNeeded>=this.iridiumNeeded?b.ResourcesPerTurn.OreAmountPerWorkerPerTurn().compareTo(a.ResourcesPerTurn.OreAmountPerWorkerPerTurn()):b.ResourcesPerTurn.IridiumAmountPerWorkerPerTurn().compareTo(a.ResourcesPerTurn.IridiumAmountPerWorkerPerTurn())};
Astriarch.Planet.PlanetDistanceComparer=function(a,b){this.gameModel=a;this.source=b;var c=this;this.sortFunction=function(a,b){var g=0,f=0,h=0;a!=c.source&&(f=c.gameModel.GameGrid.GetHexDistance(c.source.BoundingHex,a.BoundingHex),g=1);b!=c.source&&(h=c.gameModel.GameGrid.GetHexDistance(c.source.BoundingHex,b.BoundingHex),g=-1);g!==0&&(g=f==h?0:f<h?1:-1);return g}};
Astriarch.Planet.PlanetValueDistanceStrengthComparer=function(a,b,c){this.gameModel=a;this.source=b;this.lastKnownPlanetFleetStrength=c;var d=this;this.sortFunction=function(a,b){var c=0,h=0,i=0;a!=d.source&&(h=d.gameModel.GameGrid.GetHexDistance(d.source.BoundingHex,a.BoundingHex),c=1);b!=d.source&&(i=d.gameModel.GameGrid.GetHexDistance(d.source.BoundingHex,b.BoundingHex),c=-1);c!==0&&(h=Astriarch.Planet.PlanetValueDistanceStrengthComparer.increaseDistanceBasedOnPlanetValueAndFleetStrength(d.lastKnownPlanetFleetStrength,
h,a),i=Astriarch.Planet.PlanetValueDistanceStrengthComparer.increaseDistanceBasedOnPlanetValueAndFleetStrength(d.lastKnownPlanetFleetStrength,i,b),c=h==i?0:h<i?1:-1);return c}};
Astriarch.Planet.PlanetValueDistanceStrengthComparer.increaseDistanceBasedOnPlanetValueAndFleetStrength=function(a,b,c){switch(c.Type){case Astriarch.Planet.PlanetType.AsteroidBelt:b+=3;break;case Astriarch.Planet.PlanetType.DeadPlanet:b+=2;break;case Astriarch.Planet.PlanetType.PlanetClass1:b+=1}a[c.Id]&&(a=a[c.Id].Fleet.DetermineFleetStrength(),a>=20&&a<40?b+=1:a>=40&&a<80?b+=2:a>=80&&(b+=3));return b};
Astriarch.Planet.PlanetPerTurnResourceGeneration=function(a,b){this.BaseIridiumAmountPerWorkerPerTurn=this.BaseOreAmountPerWorkerPerTurn=this.BaseFoodAmountPerWorkerPerTurn=0;this.BaseProductionPerWorkerPerTurn=2;this.RemainderProductionPerTurn=this.ProductionAmountPerTurn=this.RemainderIridiumPerTurn=this.IridiumAmountPerTurn=this.RemainderOrePerTurn=this.OreAmountPerTurn=this.RemainderFoodPerTurn=this.FoodAmountPerTurn=0;this.Planet=a;switch(b){case Astriarch.Planet.PlanetType.AsteroidBelt:this.BaseFoodAmountPerWorkerPerTurn=
0.5;this.BaseOreAmountPerWorkerPerTurn=1.75;this.BaseIridiumAmountPerWorkerPerTurn=1;break;case Astriarch.Planet.PlanetType.DeadPlanet:this.BaseFoodAmountPerWorkerPerTurn=1;this.BaseOreAmountPerWorkerPerTurn=1.5;this.BaseIridiumAmountPerWorkerPerTurn=0.5;break;case Astriarch.Planet.PlanetType.PlanetClass1:this.BaseFoodAmountPerWorkerPerTurn=1.5;this.BaseOreAmountPerWorkerPerTurn=0.5;this.BaseIridiumAmountPerWorkerPerTurn=0.375;break;case Astriarch.Planet.PlanetType.PlanetClass2:this.BaseFoodAmountPerWorkerPerTurn=
2;this.BaseOreAmountPerWorkerPerTurn=0.25;this.BaseIridiumAmountPerWorkerPerTurn=0.125;break;default:throw new NotImplementedException("Planet type "+b+"not supported by PlanetPerTurnResourceGeneration constructor.");}this.UpdateResourcesPerTurnBasedOnPlanetStats()};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetProductionDivisor=function(){var a=1;this.Planet.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Unrest?a=4:this.Planet.PlanetHappiness==Astriarch.Planet.PlanetHappinessType.Riots&&(a=8);return a};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetProductionAmountPerTurn=function(){return Math.round(this.Planet.ResourcesPerTurn.ProductionAmountPerTurn/this.GetProductionDivisor())};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.UpdateResourcesPerTurnBasedOnPlanetStats=function(){var a=new Astriarch.Planet.PopulationAssignments;this.Planet.CountPopulationWorkerTypes(a);var b=this.BaseFoodAmountPerWorkerPerTurn*a.Farmers,c=this.BaseOreAmountPerWorkerPerTurn*a.Miners,d=this.BaseIridiumAmountPerWorkerPerTurn*a.Miners,a=this.BaseProductionPerWorkerPerTurn*a.Workers;this.FoodAmountPerTurn=Math.floor(b);this.OreAmountPerTurn=Math.floor(c);this.IridiumAmountPerTurn=Math.floor(d);
this.ProductionAmountPerTurn=Math.floor(a);if(this.Planet.BuiltImprovementCount()>0){var e=this.Planet.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Farm].length,g=this.Planet.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length,f=this.Planet.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length;if(e>0)e*=b*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO,this.FoodAmountPerTurn=Math.floor(b+e),this.RemainderFoodPerTurn=(b+e)%
1;if(g>0)b=c*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*g,this.OreAmountPerTurn=Math.floor(c+b),this.RemainderOrePerTurn=(c+b)%1,c=d*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*g,this.IridiumAmountPerTurn=Math.floor(d+c),this.RemainderIridiumPerTurn=(d+c)%1;if(f>0)d=a*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*f,this.ProductionAmountPerTurn=Math.floor(a+d),this.RemainderProductionPerTurn=(a+d)%1}};
Astriarch.Planet.PlanetPerTurnResourceGeneration.Static={IMPROVEMENT_RATIO:0.5};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.FoodAmountPerWorkerPerTurn=function(){return Math.round(this.GetExactFoodAmountPerWorkerPerTurn())};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.OreAmountPerWorkerPerTurn=function(){return Math.round(this.GetExactOreAmountPerWorkerPerTurn())};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.IridiumAmountPerWorkerPerTurn=function(){return Math.round(this.GetExactIridiumAmountPerWorkerPerTurn())};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.ProductionAmountPerWorkerPerTurn=function(){return Math.round(this.GetExactProductionAmountPerWorkerPerTurn())};Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetExactFoodAmountPerWorkerPerTurn=function(){return this.BaseFoodAmountPerWorkerPerTurn+this.BaseFoodAmountPerWorkerPerTurn*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*this.Planet.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Farm].length};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetExactOreAmountPerWorkerPerTurn=function(){return this.BaseOreAmountPerWorkerPerTurn+this.BaseOreAmountPerWorkerPerTurn*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*this.Planet.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetExactIridiumAmountPerWorkerPerTurn=function(){return this.BaseIridiumAmountPerWorkerPerTurn+this.BaseIridiumAmountPerWorkerPerTurn*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*this.Planet.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length};
Astriarch.Planet.PlanetPerTurnResourceGeneration.prototype.GetExactProductionAmountPerWorkerPerTurn=function(){return this.BaseProductionPerWorkerPerTurn+this.BaseProductionPerWorkerPerTurn*Astriarch.Planet.PlanetPerTurnResourceGeneration.Static.IMPROVEMENT_RATIO*this.Planet.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length};
Astriarch.Planet.PlanetResources=function(){this.IridiumRemainder=this.IridiumAmount=this.OreRemainder=this.OreAmount=this.FoodRemainder=this.FoodAmount=0};
Astriarch.Planet.PlanetResources.prototype.AccumulateResourceRemainders=function(){this.FoodRemainder>=1&&(this.FoodAmount+=Math.floor(this.FoodRemainder/1),this.FoodRemainder%=1);this.OreRemainder>=1&&(this.OreAmount+=Math.floor(this.OreRemainder/1),this.OreRemainder%=1);this.IridiumRemainder>=1&&(this.IridiumAmount+=Math.floor(this.IridiumRemainder/1),this.IridiumRemainder%=1)};
Astriarch.Planet.PlanetResources.prototype.SpendFoodAsPossible=function(a){this.FoodAmount>=a?this.FoodAmount-=a:(a=this.FoodAmount,this.FoodAmount=0);return a};Astriarch.Planet.PlanetResources.prototype.SpendOreAsPossible=function(a){this.OreAmount>=a?this.OreAmount-=a:(a=this.OreAmount,this.OreAmount=0);return a};Astriarch.Planet.PlanetResources.prototype.SpendIridiumAsPossible=function(a){this.IridiumAmount>=a?this.IridiumAmount-=a:(a=this.IridiumAmount,this.IridiumAmount=0);return a};
Astriarch.Planet.ProductionResources=function(a,b,c){this.Gold=a;this.Ore=b;this.Iridium=c};Astriarch.Planet.PopulationAssignments=function(a,b,c){this.Farmers=a;this.Miners=b;this.Workers=c};
Astriarch.Planet.PlanetProductionItem=Class.extend({init:function(){this.TurnsToComplete=99;this.BaseProductionCost=this.ProductionCostComplete=0;this.GoldCost=1;this.IridiumCost=this.OreCost=0},EstimateTurnsToComplete:function(a){this.TurnsToComplete=a!==0?Math.ceil((this.BaseProductionCost-this.ProductionCostComplete)/a):999},GetRefundAmount:function(){var a=1-this.ProductionCostComplete/(this.BaseProductionCost*1);goldRefund=this.GoldCost*a;oreRefund=this.OreCost*a;iridiumRefund=this.IridiumCost*
a;return new Astriarch.Planet.ProductionResources(goldRefund,oreRefund,iridiumRefund)}});Astriarch.Planet.PlanetImprovementToDestroy=Astriarch.Planet.PlanetProductionItem.extend({init:function(a){this._super();this.TypeToDestroy=a;this.GoldCost=0;this.BaseProductionCost=(new Astriarch.Planet.PlanetImprovement(a)).BaseProductionCost/4},ToString:function(){return"Demolish "+Astriarch.GameTools.PlanetImprovementTypeToFriendlyName(this.TypeToDestroy)}});
Astriarch.Planet.PlanetImprovement=Astriarch.Planet.PlanetProductionItem.extend({init:function(a){this._super();this.Type=a;switch(this.Type){case Astriarch.Planet.PlanetImprovementType.Colony:this.BaseProductionCost=16;this.OreCost=2;this.IridiumCost=1;this.GoldCost=3;break;case Astriarch.Planet.PlanetImprovementType.Factory:this.BaseProductionCost=32;this.OreCost=4;this.IridiumCost=2;this.GoldCost=6;break;case Astriarch.Planet.PlanetImprovementType.Farm:this.BaseProductionCost=4;this.GoldCost=1;
break;case Astriarch.Planet.PlanetImprovementType.Mine:this.BaseProductionCost=8;this.OreCost=1;this.GoldCost=2;break;case Astriarch.Planet.PlanetImprovementType.SpacePlatform:this.BaseProductionCost=162,this.OreCost=30,this.IridiumCost=12,this.GoldCost=50}},ToString:function(){return Astriarch.GameTools.PlanetImprovementTypeToFriendlyName(this.Type)}});
Astriarch.Planet.StarShipInProduction=Astriarch.Planet.PlanetProductionItem.extend({init:function(a){this._super();this.Type=a;switch(this.Type){case Astriarch.Fleet.StarShipType.Battleship:this.BaseProductionCost=162;this.OreCost=30;this.IridiumCost=12;this.GoldCost=50;break;case Astriarch.Fleet.StarShipType.Cruiser:this.BaseProductionCost=54;this.OreCost=12;this.IridiumCost=5;this.GoldCost=20;break;case Astriarch.Fleet.StarShipType.Destroyer:this.BaseProductionCost=18;this.OreCost=5;this.IridiumCost=
2;this.GoldCost=8;break;case Astriarch.Fleet.StarShipType.Scout:this.BaseProductionCost=6;this.OreCost=2;this.IridiumCost=1;this.GoldCost=3;break;case Astriarch.Fleet.StarShipType.SystemDefense:this.BaseProductionCost=2,this.GoldCost=this.OreCost=1}},ToString:function(){return Astriarch.GameTools.StarShipTypeToFriendlyName(this.Type)}});Astriarch.Planet.PlanetImprovementType={Factory:1,Colony:2,Farm:3,Mine:4,SpacePlatform:5};
Astriarch.Planet.PlanetType={AsteroidBelt:1,DeadPlanet:2,PlanetClass1:3,PlanetClass2:4};Astriarch.Planet.PlanetHappinessType={Normal:1,Unrest:2,Riots:3};Astriarch.Planet.CitizenWorkerType={Farmer:1,Miner:2,Worker:3};Astriarch.Planet.Citizen=function(a,b){this.PopulationChange=0;this.LoyalToPlayerId=b;this.ProtestLevel=0;this.WorkerType=Astriarch.Planet.CitizenWorkerType.Farmer;if(a==Astriarch.Planet.PlanetType.AsteroidBelt)this.WorkerType=Astriarch.Planet.CitizenWorkerType.Miner};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.Fleet=function(a){this.StarShips={};this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]=[];this.StarShips[Astriarch.Fleet.StarShipType.Scout]=[];this.StarShips[Astriarch.Fleet.StarShipType.Destroyer]=[];this.StarShips[Astriarch.Fleet.StarShipType.Cruiser]=[];this.StarShips[Astriarch.Fleet.StarShipType.Battleship]=[];this.HasSpacePlatform=!1;this.SpacePlatformDamage=0;this.DestinationHex=this.travelingFromHex=this.LocationHex=null;this.TurnsToDestination=this.totalTravelDistance=0;
this.OnFleetMergedOrDestroyed=this.OnFleetMoved=null;this.SetFleetHasSpacePlatform();this.DrawnFleet=null;this.Owner=a};Astriarch.Fleet.Static={SPACE_PLATFORM_STRENGTH:64};Astriarch.Fleet.prototype.SetFleetHasSpacePlatform=function(){this.HasSpacePlatform=!1;if(this.LocationHex!=null&&this.LocationHex.PlanetContainedInHex!=null&&this.LocationHex.PlanetContainedInHex.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform].length>0)this.HasSpacePlatform=!0};
Astriarch.Fleet.prototype.SetDestination=function(a,b,c,d,e){this.HasSpacePlatform=!1;this.DestinationHex=c;this.travelingFromHex=b;this.totalTravelDistance=e;if(!this.totalTravelDistance)this.totalTravelDistance=a.GetHexDistance(this.travelingFromHex,this.DestinationHex);this.TurnsToDestination=this.totalTravelDistance;if(d)this.TurnsToDestination=d};Astriarch.Fleet.prototype.CreateDrawnFleetAndSetDestination=function(a,b,c,d,e){this.SetDestination(a,b,c,d,e);this.CreateDrawnFleet()};
Astriarch.Fleet.prototype.CreateDrawnFleet=function(){this.DrawnFleet=new Astriarch.DrawnFleet(this);Astriarch.View.DrawnFleets.push(this.DrawnFleet);Astriarch.View.CanvasFleetsLayer.addChild(this.DrawnFleet);this.DrawnFleet.updateTravelLine()};Astriarch.Fleet.prototype.MoveFleet=function(){this.LocationHex=null;this.TurnsToDestination-=1;this.DrawnFleet&&this.DrawnFleet.updateTravelLine();this.OnFleetMoved!=null&&this.OnFleetMoved(this)};
Astriarch.Fleet.prototype.LandFleet=function(a,b){a.travelingFromHex=null;a.DestinationHex=null;a.TurnsToDestination=0;this.LocationHex=b;this.MergeFleet(a);this.SetFleetHasSpacePlatform()};
Astriarch.Fleet.prototype.MergeFleet=function(a){this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]=this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].concat(a.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]);this.StarShips[Astriarch.Fleet.StarShipType.Scout]=this.StarShips[Astriarch.Fleet.StarShipType.Scout].concat(a.StarShips[Astriarch.Fleet.StarShipType.Scout]);this.StarShips[Astriarch.Fleet.StarShipType.Destroyer]=this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].concat(a.StarShips[Astriarch.Fleet.StarShipType.Destroyer]);
this.StarShips[Astriarch.Fleet.StarShipType.Cruiser]=this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].concat(a.StarShips[Astriarch.Fleet.StarShipType.Cruiser]);this.StarShips[Astriarch.Fleet.StarShipType.Battleship]=this.StarShips[Astriarch.Fleet.StarShipType.Battleship].concat(a.StarShips[Astriarch.Fleet.StarShipType.Battleship]);a.SendFleetMergedOrDestroyed()};
Astriarch.Fleet.prototype.GetAllStarShips=function(){var a=[],a=a.concat(this.StarShips[Astriarch.Fleet.StarShipType.Battleship]),a=a.concat(this.StarShips[Astriarch.Fleet.StarShipType.Cruiser]),a=a.concat(this.StarShips[Astriarch.Fleet.StarShipType.Destroyer]),a=a.concat(this.StarShips[Astriarch.Fleet.StarShipType.Scout]);return a=a.concat(this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense])};
Astriarch.Fleet.prototype.SendFleetMergedOrDestroyed=function(){this.OnFleetMergedOrDestroyed!=null&&this.OnFleetMergedOrDestroyed(this)};
Astriarch.Fleet.prototype.ReduceFleet=function(a){for(var b in this.StarShips)for(var c=this.StarShips[b],d=c.length-1;d>=0;d--)c[d].Strength()<=0&&c.splice(d,1);this.SpacePlatformDamage+=a;if(this.SpacePlatformDamage!=0&&this.HasSpacePlatform&&this.SpacePlatformDamage>=Astriarch.Fleet.Static.SPACE_PLATFORM_STRENGTH&&this.LocationHex!=null&&this.LocationHex.PlanetContainedInHex!=null)this.LocationHex.PlanetContainedInHex.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform]=[],this.HasSpacePlatform=
!1};
Astriarch.Fleet.prototype.DetermineFleetStrength=function(a){if(a===null||typeof a=="undefined")a=!0;var b=0,c;for(c in this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense])b+=this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense][c].Strength();for(c in this.StarShips[Astriarch.Fleet.StarShipType.Scout])b+=this.StarShips[Astriarch.Fleet.StarShipType.Scout][c].Strength();for(c in this.StarShips[Astriarch.Fleet.StarShipType.Destroyer])b+=this.StarShips[Astriarch.Fleet.StarShipType.Destroyer][c].Strength();for(c in this.StarShips[Astriarch.Fleet.StarShipType.Cruiser])b+=
this.StarShips[Astriarch.Fleet.StarShipType.Cruiser][c].Strength();for(c in this.StarShips[Astriarch.Fleet.StarShipType.Battleship])b+=this.StarShips[Astriarch.Fleet.StarShipType.Battleship][c].Strength();a&&this.HasSpacePlatform&&(b+=Astriarch.Fleet.Static.SPACE_PLATFORM_STRENGTH-this.SpacePlatformDamage);return b};
Astriarch.Fleet.prototype.SplitFleet=function(a,b,c,d){var e=new Astriarch.Fleet(this.Owner);e.LocationHex=this.LocationHex;if(a>this.StarShips[Astriarch.Fleet.StarShipType.Scout].length||b>this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length||c>this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length||d>this.StarShips[Astriarch.Fleet.StarShipType.Battleship].length)console.error("Cannot send more ships than in the fleet!",a,b,c,d,this.StarShips),a=Math.min(a,this.StarShips[Astriarch.Fleet.StarShipType.Scout].length),
b=Math.min(b,this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length),c=Math.min(c,this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length),d=Math.min(d,this.StarShips[Astriarch.Fleet.StarShipType.Battleship].length);for(var g=0;g<a;g++)e.StarShips[Astriarch.Fleet.StarShipType.Scout].push(this.StarShips[Astriarch.Fleet.StarShipType.Scout][0]),this.StarShips[Astriarch.Fleet.StarShipType.Scout].shift();for(g=0;g<b;g++)e.StarShips[Astriarch.Fleet.StarShipType.Destroyer].push(this.StarShips[Astriarch.Fleet.StarShipType.Destroyer][0]),
this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].shift();for(g=0;g<c;g++)e.StarShips[Astriarch.Fleet.StarShipType.Cruiser].push(this.StarShips[Astriarch.Fleet.StarShipType.Cruiser][0]),this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].shift();for(g=0;g<d;g++)e.StarShips[Astriarch.Fleet.StarShipType.Battleship].push(this.StarShips[Astriarch.Fleet.StarShipType.Battleship][0]),this.StarShips[Astriarch.Fleet.StarShipType.Battleship].shift();return e};
Astriarch.Fleet.prototype.SplitOffSmallestPossibleFleet=function(){var a=null,b=0,c=0,d=0,e=0;this.StarShips[Astriarch.Fleet.StarShipType.Scout].length!=0?b=1:this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length!=0?c=1:this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length!=0?d=1:this.StarShips[Astriarch.Fleet.StarShipType.Battleship].length!=0&&(e=1);if(b!=0||c!=0||d!=0||e!=0)a=this.SplitFleet(b,c,d,e);return a};
Astriarch.Fleet.prototype.GetPlanetaryFleetMobileStarshipCount=function(){var a=0;a+=this.StarShips[Astriarch.Fleet.StarShipType.Scout].length;a+=this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length;a+=this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length;a+=this.StarShips[Astriarch.Fleet.StarShipType.Battleship].length;return a};
Astriarch.Fleet.prototype.CloneFleet=function(){var a=new Astriarch.Fleet(this.Owner);a.LocationHex=this.LocationHex;a.HasSpacePlatform=this.HasSpacePlatform;for(var b in this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense])a.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].push(this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense][b].CloneStarShip());for(b in this.StarShips[Astriarch.Fleet.StarShipType.Scout])a.StarShips[Astriarch.Fleet.StarShipType.Scout].push(this.StarShips[Astriarch.Fleet.StarShipType.Scout][b].CloneStarShip());
for(b in this.StarShips[Astriarch.Fleet.StarShipType.Destroyer])a.StarShips[Astriarch.Fleet.StarShipType.Destroyer].push(this.StarShips[Astriarch.Fleet.StarShipType.Destroyer][b].CloneStarShip());for(b in this.StarShips[Astriarch.Fleet.StarShipType.Cruiser])a.StarShips[Astriarch.Fleet.StarShipType.Cruiser].push(this.StarShips[Astriarch.Fleet.StarShipType.Cruiser][b].CloneStarShip());for(b in this.StarShips[Astriarch.Fleet.StarShipType.Battleship])a.StarShips[Astriarch.Fleet.StarShipType.Battleship].push(this.StarShips[Astriarch.Fleet.StarShipType.Battleship][b].CloneStarShip());
return a};
Astriarch.Fleet.prototype.RepairFleet=function(a){var b=0,c=0,d=[];this.LocationHex.PlanetContainedInHex.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length>0&&(this.LocationHex.PlanetContainedInHex.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform].length>0&&(c=Math.min(a,this.SpacePlatformDamage),this.SpacePlatformDamage-=c,a-=c,b+=c,d=d.concat(this.StarShips[Astriarch.Fleet.StarShipType.Battleship]),d=d.concat(this.StarShips[Astriarch.Fleet.StarShipType.Cruiser])),d=
d.concat(this.StarShips[Astriarch.Fleet.StarShipType.Destroyer]));var d=d.concat(this.StarShips[Astriarch.Fleet.StarShipType.Scout]),d=d.concat(this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]),e;for(e in d)if(c=d[e].RepairStarShip(a),b+=c,a-=c,a<=0)break;return b};
Astriarch.Fleet.prototype.ToString=function(){var a="",b=-1,b=this.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].length;b>0&&(a=b+" Defender"+(b>1?"s":""));b=this.StarShips[Astriarch.Fleet.StarShipType.Scout].length;b>0&&(a!=""&&(a+=", "),a+=b+" Scout"+(b>1?"s":""));b=this.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length;b>0&&(a!=""&&(a+=", "),a+=b+" Destroyer"+(b>1?"s":""));b=this.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length;b>0&&(a!=""&&(a+=", "),a+=b+" Cruiser"+(b>1?"s":
""));b=this.StarShips[Astriarch.Fleet.StarShipType.Battleship].length;b>0&&(a!=""&&(a+=", "),a+=b+" Battleship"+(b>1?"s":""));this.HasSpacePlatform&&(a!=""&&(a+=", "),a+="1 Space Platform");a==""&&(a="No Ships");return a};Astriarch.Fleet.LastKnownFleet=function(a,b){this.TurnLastExplored=0;this.Fleet=a;this.LastKnownOwner=b};
Astriarch.Fleet.StarShip=function(a){this.id=Astriarch.Fleet.StarShip.Static.NEXT_STARSHIP_ID++;this.Type=a;this.DamageAmount=this.BaseStarShipStrength=0;switch(this.Type){case Astriarch.Fleet.StarShipType.SystemDefense:this.BaseStarShipStrength=2;break;case Astriarch.Fleet.StarShipType.Scout:this.BaseStarShipStrength=4;break;case Astriarch.Fleet.StarShipType.Destroyer:this.BaseStarShipStrength=8;break;case Astriarch.Fleet.StarShipType.Cruiser:this.BaseStarShipStrength=16;break;case Astriarch.Fleet.StarShipType.Battleship:this.BaseStarShipStrength=
32}};Astriarch.Fleet.StarShip.Static={NEXT_STARSHIP_ID:1};Astriarch.Fleet.StarShip.prototype.Strength=function(){return this.BaseStarShipStrength-this.DamageAmount};Astriarch.Fleet.StarShip.prototype.CloneStarShip=function(){var a=new Astriarch.Fleet.StarShip(this.Type);a.DamageAmount=this.DamageAmount;return a};Astriarch.Fleet.StarShip.prototype.RepairStarShip=function(a){a=Math.min(a,this.DamageAmount);this.DamageAmount-=a;return a};
Astriarch.Fleet.StarShipAdvantageStrengthComparer=function(a,b,c){this.type=a;this.isSpacePlatform=b;this.fleetDamagePending=c;var d=this;this.sortFunction=function(a,b){var c=0,c=d.getStarShipAdvantageDisadvantageAdjustedStrength(a),h=d.getStarShipAdvantageDisadvantageAdjustedStrength(b);return c==h?0:c<h?-1:1}};
Astriarch.Fleet.StarShipAdvantageStrengthComparer.prototype.getStarShipAdvantageDisadvantageAdjustedStrength=function(a){var b=a.Strength();this.fleetDamagePending[a]&&(b-=this.fleetDamagePending[a]);b*=Astriarch.BattleSimulator.StarshipHasAdvantageBasedOnType(this.isSpacePlatform,this.type,!1,a.Type)?1:Astriarch.BattleSimulator.StarshipHasDisadvantageBasedOnType(this.isSpacePlatform,this.type,!1,a.Type)?1E4:100;return b};
Astriarch.Fleet.StarShipFactoryHelper={GenerateShips:function(a,b,c,d){a=new Astriarch.Fleet(a);a.LocationHex=d;for(d=0;d<c;d++)a.StarShips[b].push(new Astriarch.Fleet.StarShip(b));return a},GenerateFleetWithShipCount:function(a,b,c,d,e,g,f){a=new Astriarch.Fleet(a);a.LocationHex=f;for(f=0;f<b;f++)a.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].push(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.SystemDefense));for(f=0;f<c;f++)a.StarShips[Astriarch.Fleet.StarShipType.Scout].push(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Scout));
for(f=0;f<d;f++)a.StarShips[Astriarch.Fleet.StarShipType.Destroyer].push(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Destroyer));for(f=0;f<e;f++)a.StarShips[Astriarch.Fleet.StarShipType.Cruiser].push(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Cruiser));for(f=0;f<g;f++)a.StarShips[Astriarch.Fleet.StarShipType.Battleship].push(new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Battleship));return a}};
Astriarch.Fleet.StarShipType={SystemDefense:1,Scout:2,Destroyer:3,Cruiser:4,Battleship:5};Astriarch=Astriarch||require("./astriarch_base");Astriarch.TurnEventMessage=function(a,b,c){this.Type=a;this.Planet=b;this.Message=c;this.Data=null};Astriarch.TurnEventMessage.TurnEventMessageComparerSortFunction=function(a,b){if(a.Type>b.Type)return-1;else if(a.Type<b.Type)return 1;return 0};
Astriarch.TurnEventMessage.TurnEventMessageType={ResourcesAutoSpent:0,PopulationGrowth:1,TradesExecuted:2,TradesNotExecuted:3,ImprovementBuilt:4,ShipBuilt:5,ImprovementDemolished:6,BuildQueueEmpty:7,CitizensProtesting:8,InsufficientFood:9,DefendedAgainstAttackingFleet:10,AttackingFleetLost:11,PlanetCaptured:12,PopulationStarvation:13,FoodShortageRiots:14,PlanetLostDueToStarvation:15,PlanetLost:16};
Astriarch.TurnEventMessage.PlanetaryConflictData=function(a,b,c,d){this.DefendingPlayer=a;this.DefendingFleet=b.CloneFleet();this.AttackingPlayer=c;this.AttackingFleet=d.CloneFleet();this.WinningFleet=null;this.FoodAmountLooted=this.IridiumAmountLooted=this.OreAmountLooted=this.GoldAmountLooted=this.AttackingFleetChances=0};
Astriarch.SerializableTurnEventMessage=function(a,b,c){this.Type=a;this.SerializableClientPlanet=null;if(b)this.SerializableClientPlanet=new Astriarch.SerializableClientPlanet(b.Id,b.Name,b.OriginPoint);this.Message=c;this.Data=null};
Astriarch.TurnEventMessage.SerializablePlanetaryConflictData=function(a){this.DefendingSerializableClientPlayer=null;if(a.DefendingPlayer)this.DefendingSerializableClientPlayer=new Astriarch.SerializableClientPlayer(a.DefendingPlayer.Id,a.DefendingPlayer.Type,a.DefendingPlayer.Name,a.DefendingPlayer.Color,a.DefendingPlayer.Points);this.DefendingSerializableFleet=new Astriarch.SerializableFleet(a.DefendingFleet,!1);this.AttackingSerializableClientPlayer=new Astriarch.SerializableClientPlayer(a.AttackingPlayer.Id,
a.AttackingPlayer.Type,a.AttackingPlayer.Name,a.AttackingPlayer.Color,a.AttackingPlayer.Points);this.AttackingSerializableFleet=new Astriarch.SerializableFleet(a.AttackingFleet,!1);this.WinningSerializableFleet=null;if(a.WinningFleet)this.WinningSerializableFleet=new Astriarch.SerializableFleet(a.WinningFleet,!1);this.AttackingFleetChances=a.AttackingFleetChances;this.GoldAmountLooted=a.GoldAmountLooted;this.OreAmountLooted=a.OreAmountLooted;this.IridiumAmountLooted=a.IridiumAmountLooted;this.FoodAmountLooted=
a.FoodAmountLooted};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.BattleSimulator={STARSHIP_WEAPON_POWER:2,STARSHIP_WEAPON_POWER_HALF:1,SimulateFleetBattle:function(a,b){for(var c=null,d={},e={enemyFleetSpacePlatformDamagePending:0},g={},f={enemyFleetSpacePlatformDamagePending:0};a.DetermineFleetStrength(!0)>0&&b.DetermineFleetStrength(!0)>0;){var h=a.GetAllStarShips(),i=b.GetAllStarShips(),j;for(j in h){var k=h[j];Astriarch.BattleSimulator.StarshipFireWeapons(k.Strength(),k.Type,!1,i,b.HasSpacePlatform,g,f)}a.HasSpacePlatform&&Astriarch.BattleSimulator.StarshipFireWeapons(Astriarch.Fleet.Static.SPACE_PLATFORM_STRENGTH-
a.SpacePlatformDamage,Astriarch.Fleet.StarShipType.SystemDefense,!0,i,b.HasSpacePlatform,d,f);for(j in i)k=i[j],Astriarch.BattleSimulator.StarshipFireWeapons(k.Strength(),k.Type,!1,h,a.HasSpacePlatform,d,e);b.HasSpacePlatform&&Astriarch.BattleSimulator.StarshipFireWeapons(Astriarch.Fleet.Static.SPACE_PLATFORM_STRENGTH-b.SpacePlatformDamage,Astriarch.Fleet.StarShipType.SystemDefense,!0,h,a.HasSpacePlatform,d,e);for(j in d)h=d[j],h.Starship.DamageAmount+=h.Damage,b.Owner&&(b.Owner.Points+=Astriarch.ServerController.POINTS_PER_DAMAGED_STARSHIP_STRENGTH*
h.Damage);d={};for(j in g)h=g[j],h.Starship.DamageAmount+=h.Damage,a.Owner&&(a.Owner.Points+=Astriarch.ServerController.POINTS_PER_DAMAGED_STARSHIP_STRENGTH*h.Damage);g={};a.ReduceFleet(e.enemyFleetSpacePlatformDamagePending);b.ReduceFleet(f.enemyFleetSpacePlatformDamagePending);a.Owner&&(a.Owner.Points+=Astriarch.ServerController.POINTS_PER_DAMAGED_STARSHIP_STRENGTH*f.enemyFleetSpacePlatformDamagePending);b.Owner&&(b.Owner.Points+=Astriarch.ServerController.POINTS_PER_DAMAGED_STARSHIP_STRENGTH*e.enemyFleetSpacePlatformDamagePending)}a.DetermineFleetStrength(!0)>
0?c=!0:b.DetermineFleetStrength(!0)>0&&(c=!1);return c},StarshipFireWeapons:function(a,b,c,d,e,g,f){var h=[],h=h.concat(d),d=new Astriarch.Fleet.StarShipAdvantageStrengthComparer(b,c,g);h.sort(d.sortFunction);for(d=0;d<a;d+=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER){for(var i=h.length-1;i>=0;i--){var j=h[i],k={Starship:j,Damage:0};g[j.id]&&(k=g[j.id]);h[i].Strength()-k.Damage<=0&&h.splice(i,1)}if(e&&h.length==0)j=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER,Astriarch.BattleSimulator.StarshipHasAdvantageBasedOnType(c,
b,!0,Astriarch.Fleet.StarShipType.SystemDefense)?j+=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER_HALF:Astriarch.BattleSimulator.StarshipHasDisadvantageBasedOnType(c,b,!0,Astriarch.Fleet.StarShipType.SystemDefense)&&(j-=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER_HALF),j=Astriarch.NextRandom(0,j+1),f.enemyFleetSpacePlatformDamagePending+=j;else if(h.length>0)i=h[0],j=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER,Astriarch.BattleSimulator.StarshipHasAdvantageBasedOnType(c,b,!1,i.Type)?j+=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER_HALF:
Astriarch.BattleSimulator.StarshipHasDisadvantageBasedOnType(c,b,!1,i.Type)&&(j-=Astriarch.BattleSimulator.STARSHIP_WEAPON_POWER_HALF),j=Astriarch.NextRandom(0,j+1),j!=0&&(g[i.id]||(g[i.id]={Starship:i,Damage:0}),g[i.id].Damage+=j)}},StarshipHasAdvantageBasedOnType:function(a,b,c,d){if(a)return!0;else if(!c)if(b==Astriarch.Fleet.StarShipType.Scout&&d==Astriarch.Fleet.StarShipType.Battleship)return!0;else if(b==Astriarch.Fleet.StarShipType.Destroyer&&d==Astriarch.Fleet.StarShipType.Scout)return!0;
else if(b==Astriarch.Fleet.StarShipType.Cruiser&&d==Astriarch.Fleet.StarShipType.Destroyer)return!0;else if(b==Astriarch.Fleet.StarShipType.Battleship&&d==Astriarch.Fleet.StarShipType.Cruiser)return!0;return!1},StarshipHasDisadvantageBasedOnType:function(a,b,c,d){if(!a)if(c)return!0;else if(b==Astriarch.Fleet.StarShipType.Scout&&d==Astriarch.Fleet.StarShipType.Destroyer)return!0;else if(b==Astriarch.Fleet.StarShipType.Destroyer&&d==Astriarch.Fleet.StarShipType.Cruiser)return!0;else if(b==Astriarch.Fleet.StarShipType.Cruiser&&
d==Astriarch.Fleet.StarShipType.Battleship)return!0;else if(b==Astriarch.Fleet.StarShipType.Battleship&&d==Astriarch.Fleet.StarShipType.Scout)return!0;return!1}};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.AI={OnComputerSentFleet:null,ComputerTakeTurn:function(a,b){var c=b.GetOwnedPlanetsListSorted();Astriarch.AI.computerSetPlanetBuildGoals(a,b,c);Astriarch.AI.computerSubmitTrades(a,b,c);Astriarch.AI.computerBuildImprovementsAndShips(a,b,c);Astriarch.AI.computerAdjustPopulationAssignments(b);Astriarch.AI.computerSendShips(a,b,c)},computerAdjustPopulationAssignments:function(a){var b={},c={},d={},e=[],g;for(g in a.OwnedPlanets){var f=a.OwnedPlanets[g],h=new Astriarch.Planet.PopulationAssignments;
f.CountPopulationWorkerTypes(h);b[f.Id]=h.Farmers;c[f.Id]=h.Miners;d[f.Id]=h.Workers;e.push(f)}var i=a.GetTotalPopulation(),j=0,k=0,h=0;for(g in a.OwnedPlanets)f=a.OwnedPlanets[g],k+=f.Resources.FoodAmount,j+=f.ResourcesPerTurn.FoodAmountPerTurn,f.Population.length<f.MaxPopulation()&&h++;k-=i;k-=h;h=f=0;switch(a.Type){case Astriarch.Player.PlayerType.Computer_Easy:f-=i*3;h=Math.floor(i*1.5);break;case Astriarch.Player.PlayerType.Computer_Normal:f-=Math.floor(i*1.5);h=i;break;case Astriarch.Player.PlayerType.Computer_Hard:f-=
i/2,h=0}f=Astriarch.NextRandom(f,h+1);k+=f;var l=h=0;for(g in a.OwnedPlanets)f=a.OwnedPlanets[g],f.Id in a.PlanetBuildGoals&&(f=a.PlanetBuildGoals[f.Id],h+=f.OreCost,l+=f.IridiumCost);f=1;switch(a.Type){case Astriarch.Player.PlayerType.Computer_Easy:f=Astriarch.NextRandom(20,41)/10;break;case Astriarch.Player.PlayerType.Computer_Normal:f=Astriarch.NextRandom(10,21)/10}h=Math.round(h*f)-a.TotalOreAmount();a=Math.round(l*f)-a.TotalIridiumAmount();if(i>j+k){j=i-(j+k);e.sort(Astriarch.Planet.PlanetFoodProductionComparerSortFunction);
i=j;k=[];if(i>0)for(g in e)if(f=e[g],i>0&&f.ResourcesPerTurn.FoodAmountPerWorkerPerTurn()>0&&(c[f.Id]>0||d[f.Id]>0))if(k.push(f),i-=f.ResourcesPerTurn.FoodAmountPerWorkerPerTurn(),i<=0)break;for(;j>0;){i=!1;for(g in k)if(f=k[g],l=d[f.Id],f.Type==Astriarch.Planet.PlanetType.PlanetClass2&&(l=f.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length==0?0:1),c[f.Id]>=l&&c[f.Id]>0?(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],1,-1,0),b[f.Id]++,c[f.Id]--,j-=f.ResourcesPerTurn.FoodAmountPerWorkerPerTurn(),
i=!0):d[f.Id]>0&&(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],1,0,-1),b[f.Id]++,d[f.Id]--,j-=f.ResourcesPerTurn.FoodAmountPerWorkerPerTurn(),i=!0),j<=0)break;if(!i)break}}else{j=j+k-i;e.sort(Astriarch.Planet.PlanetFoodProductionComparerSortFunction);e.reverse();i=j;k=[];if(i>0)for(g in e)if(f=e[g],i>0&&i>f.ResourcesPerTurn.FoodAmountPerWorkerPerTurn()&&b[f.Id]>0&&(k.push(f),i-=f.ResourcesPerTurn.FoodAmountPerWorkerPerTurn(),i<=0))break;for(;j>0;){i=!1;for(g in k)if(f=k[g],!(j<f.ResourcesPerTurn.FoodAmountPerWorkerPerTurn())&&
((f.Type!=Astriarch.Planet.PlanetType.PlanetClass2||f.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].Count>0)&&(h>0||a>0)&&b[f.Id]>0?(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],-1,1,0),b[f.Id]--,c[f.Id]++,h-=f.ResourcesPerTurn.OreAmountPerWorkerPerTurn(),a-=f.ResourcesPerTurn.IridiumAmountPerWorkerPerTurn(),j-=f.ResourcesPerTurn.FoodAmountPerWorkerPerTurn(),i=!0):b[f.Id]>0&&(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],-1,0,1),b[f.Id]--,d[f.Id]++,j-=
f.ResourcesPerTurn.FoodAmountPerWorkerPerTurn(),i=!0),j<=0))break;if(!i)break}}if(h>0||a>0){i=h*1;k=a*1;j=[];f=new Astriarch.Planet.PlanetMineralProductionComparer(h,a);e.sort(f.sortFunction);if(i>0||k>0)for(g in e){var f=e[g],l=0,m=-1;f.Type==Astriarch.Planet.PlanetType.PlanetClass2&&(l=f.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length==0?2:1,m=0);d[f.Id]>l&&b[f.Id]>m&&(j.push(f),i-=f.ResourcesPerTurn.OreAmountPerWorkerPerTurn(),k-=f.ResourcesPerTurn.IridiumAmountPerWorkerPerTurn())}for(;h>
0||a>0;){i=!1;for(g in j)if(f=j[g],l=1,f.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length==0&&(l=2),d[f.Id]>l&&(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],0,1,-1),c[f.Id]++,d[f.Id]--,h-=f.ResourcesPerTurn.OreAmountPerWorkerPerTurn(),a-=f.ResourcesPerTurn.IridiumAmountPerWorkerPerTurn(),i=!0),h<=0&&a<=0)break;if(!i)break}}else{i=Math.abs(h*1)/2;k=Math.abs(a*1);j=[];f=new Astriarch.Planet.PlanetMineralProductionComparer(h,a);e.sort(f.sortFunction);e.reverse();if(i>
0||k>0)for(g in e)f=e[g],c[f.Id]>0&&(j.push(f),i-=f.ResourcesPerTurn.OreAmountPerWorkerPerTurn(),k-=f.ResourcesPerTurn.IridiumAmountPerWorkerPerTurn());for(;h<=0||a<=0;){i=!1;for(g in j)if(f=j[g],c[f.Id]>0&&(f.UpdatePopulationWorkerTypesByDiff(b[f.Id],c[f.Id],d[f.Id],0,-1,1),c[f.Id]--,d[f.Id]++,h+=f.ResourcesPerTurn.OreAmountPerWorkerPerTurn(),a+=f.ResourcesPerTurn.IridiumAmountPerWorkerPerTurn(),i=!0),h>0&&a>0)break;if(!i)break}}},computerSetPlanetBuildGoals:function(a,b,c){var d=[],e=[],g=[],f;
for(f in c){var h=c[f];b.PlanetBuildGoals[h.Id]||h.BuildQueue.length<=1&&(h.BuiltAndBuildQueueImprovementCount()<h.MaxImprovements?d.push(h):Astriarch.AI.countPlanetsNeedingExploration(a,b)!=0?g.push(h):h.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform].length==0?e.push(h):g.push(h))}for(f in e)h=e[f],h.BuiltAndBuildQueueImprovementTypeCount(Astriarch.Planet.PlanetImprovementType.SpacePlatform)==0&&(b.PlanetBuildGoals[h.Id]=new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.SpacePlatform));
for(f in d){var h=d[f],e=c=0,i=1;h.Type==Astriarch.Planet.PlanetType.PlanetClass2?(c=3,e=2,i=3):h.Type==Astriarch.Planet.PlanetType.PlanetClass1?i=c=2:h.Type==Astriarch.Planet.PlanetType.DeadPlanet?e=1:h.Type==Astriarch.Planet.PlanetType.AsteroidBelt&&(e=1);h.BuiltAndBuildQueueImprovementTypeCount(Astriarch.Planet.PlanetImprovementType.Farm)<c?b.PlanetBuildGoals[h.Id]=new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Farm):h.BuiltAndBuildQueueImprovementTypeCount(Astriarch.Planet.PlanetImprovementType.Mine)<
e?b.PlanetBuildGoals[h.Id]=new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Mine):h.BuiltAndBuildQueueImprovementTypeCount(Astriarch.Planet.PlanetImprovementType.Factory)==0?b.PlanetBuildGoals[h.Id]=new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Factory):h.BuiltAndBuildQueueImprovementTypeCount(Astriarch.Planet.PlanetImprovementType.Colony)==0?b.PlanetBuildGoals[h.Id]=new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Colony):
h.BuiltAndBuildQueueImprovementTypeCount(Astriarch.Planet.PlanetImprovementType.Factory)<i?b.PlanetBuildGoals[h.Id]=new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Factory):h.BuiltAndBuildQueueImprovementCount()<h.MaxImprovements&&(b.PlanetBuildGoals[h.Id]=new Astriarch.Planet.PlanetImprovement(Astriarch.Planet.PlanetImprovementType.Colony))}for(f in g)c=d=!1,b.Type==Astriarch.Player.PlayerType.Computer_Easy?(d=Astriarch.NextRandom(0,4)<=1,c=!d&&Astriarch.NextRandom(0,
4)<=1):b.Type==Astriarch.Player.PlayerType.Computer_Normal&&(d=Astriarch.NextRandom(0,4)==0,c=!d&&Astriarch.NextRandom(0,4)==0),h=g[f],h.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform].length>0&&!d?(d=Astriarch.NextRandom(4),b.PlanetBuildGoals[h.Id]=d<2?d%2==0?new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Battleship):new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Destroyer):d%2==1?new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Cruiser):
new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Destroyer)):Astriarch.AI.countPlanetsNeedingExploration(a,b)!=0?b.PlanetBuildGoals[h.Id]=new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Scout):h.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length>0&&c?b.PlanetBuildGoals[h.Id]=new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.Destroyer):a.Turn.Number%4==0&&d&&(b.PlanetBuildGoals[h.Id]=new Astriarch.Planet.StarShipInProduction(Astriarch.Fleet.StarShipType.SystemDefense))},
computerSubmitTrades:function(a,b,c){var d=b.GetTotalPopulation(),e=b.Resources.GoldAmount,g=b.TotalFoodAmount(),f=b.TotalOreAmount(),h=b.TotalIridiumAmount(),i=0,j=0,k=0,l;for(l in b.PlanetBuildGoals){var m=b.PlanetBuildGoals[l];i+=m.GoldCost;j+=m.OreCost;k+=m.IridiumCost}m=[];l=b.HomePlanet?b.HomePlanet.Id:c[0].Id;var c=0,o=Astriarch.TradingCenter.OrderType.MARKET,n=Astriarch.TradingCenter.TradeType.SELL;if(e<i)g>=d*2&&(c=Math.floor(g*0.25),m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.FOOD,
c,o,null))),f>=j*2&&(c=Math.floor(f*0.25),m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.ORE,c,o,null))),h>=k*2&&(c=Math.floor(h*0.25),m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.IRIDIUM,c,o,null)));else if(e>i*1.2)n=Astriarch.TradingCenter.TradeType.BUY,g<=d*1.2&&(c=Math.floor(d*0.25),m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.FOOD,c,o,null))),f<=j*1.2&&(c=Math.floor(j*0.25),
m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.ORE,c,o,null))),h<=k*1.2&&(c=Math.floor(k*0.25),m.push(new Astriarch.TradingCenter.Trade(b.Id,l,n,Astriarch.TradingCenter.ResourceType.IRIDIUM,c,o,null)));for(var q in m)b=m[q],b.amount>0?(console.debug("Computer Submitted a Trade: ",b),a.TradingCenter.currentTrades.push(b)):console.debug("AI Trade found with zero amount.",b)},computerBuildImprovementsAndShips:function(a,b,c){var d=b.LastTurnFoodNeededToBeShipped;
switch(b.Type){case Astriarch.Player.PlayerType.Computer_Easy:d=Astriarch.NextRandom(0,(d+1)/4);break;case Astriarch.Player.PlayerType.Computer_Normal:d=Astriarch.NextRandom(0,(d+1)/2);break;case Astriarch.Player.PlayerType.Computer_Hard:d+=Astriarch.CountObjectKeys(b.OwnedPlanets)-0.5;break;case Astriarch.Player.PlayerType.Computer_Expert:d+=Astriarch.CountObjectKeys(b.OwnedPlanets)-0.25}for(var e in c){var g=c[e];if(g.BuildQueue.length==0&&g.Id in b.PlanetBuildGoals){var f=b.PlanetBuildGoals[g.Id];
b.Resources.GoldAmount-f.GoldCost>d&&b.TotalOreAmount()-f.OreCost>=0&&b.TotalIridiumAmount()-f.IridiumCost>=0&&(g.EnqueueProductionItemAndSpendResources(a,f,b),delete b.PlanetBuildGoals[g.Id])}}},computerSendShips:function(a,b,c){var d=[],e;for(e in c){var g=c[e];if(g.PlanetaryFleet.GetPlanetaryFleetMobileStarshipCount()>0)if(b.Type==Astriarch.Player.PlayerType.Computer_Easy)d.push(g);else{var f=0;Astriarch.AI.countPlanetsNeedingExploration(a,b)!=0?f=0:g.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length>
0&&(f=Math.floor(Math.pow(g.Type,2)*4));if(b.Type==Astriarch.Player.PlayerType.Computer_Hard||b.Type==Astriarch.Player.PlayerType.Computer_Expert){var h={minDistance:0},i=Astriarch.AI.getClosestUnownedPlanet(a,b,g,h);i!=null&&(b.LastKnownPlanetFleetStrength[i.Id]?f+=b.LastKnownPlanetFleetStrength[i.Id].Fleet.DetermineFleetStrength(!1):b.KnownClientPlanets[i.Id]&&(f+=Math.floor(Math.pow(i.Type,2)*4)));i={turnsToComplete:99,starshipStrength:0};g.BuildQueueContainsMobileStarship(i)&&i.turnsToComplete<=
h.minDistance+1&&(f-=i.starshipStrength)}g.PlanetaryFleet.DetermineFleetStrength()>f&&d.push(g)}}c=[];f=[];if(d.length>0)for(e in a.Planets)g=a.Planets[e],g.Owner!=b&&!b.PlanetContainsFriendlyInboundFleet(g)&&(!b.KnownClientPlanets[g.Id]||b.Type!=Astriarch.Player.PlayerType.Computer_Easy&&b.LastKnownPlanetFleetStrength[g.Id]&&a.Turn.Number-b.LastKnownPlanetFleetStrength[g.Id].TurnLastExplored>20?c.push(g):b.GetPlanetIfOwnedByPlayer(g)||f.push(g));b.HomePlanet!=null&&(i=b.Type==Astriarch.Player.PlayerType.Computer_Easy||
b.Type==Astriarch.Player.PlayerType.Computer_Normal?new Astriarch.Planet.PlanetDistanceComparer(a,b.HomePlanet):new Astriarch.Planet.PlanetValueDistanceStrengthComparer(a,b.HomePlanet,b.LastKnownPlanetFleetStrength),f.sort(i.sortFunction),c.sort(i.sortFunction));h=[];if(b.Type==Astriarch.Player.PlayerType.Computer_Expert)for(e in b.OwnedPlanets)g=b.OwnedPlanets[e],g.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length>0&&h.push(g);for(e=f.length-1;e>=0;e--){g=f[e];b.Type==Astriarch.Player.PlayerType.Computer_Easy||
b.Type==Astriarch.Player.PlayerType.Computer_Normal?(i=new Astriarch.Planet.PlanetDistanceComparer(a,g),d.sort(i.sortFunction)):(i=new Astriarch.Planet.PlanetValueDistanceStrengthComparer(a,g,b.LastKnownPlanetFleetStrength),d.sort(i.sortFunction),d.reverse());var i=0.5,j=1;switch(b.Type){case Astriarch.Player.PlayerType.Computer_Easy:i=3;j=6;break;case Astriarch.Player.PlayerType.Computer_Normal:i=2;j=4;break;case Astriarch.Player.PlayerType.Computer_Hard:i=1,j=2}for(var k=Astriarch.NextRandom(Math.floor(i*
10),Math.floor(j*10)+1)/10,l=!1,m=d.length-1;m>=0;m--){var i=d[m],o=Math.floor(Math.pow(g.Type+1,2)*4);b.LastKnownPlanetFleetStrength[g.Id]&&(o=b.LastKnownPlanetFleetStrength[g.Id].Fleet.DetermineFleetStrength());var n=i.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Scout].length,q=i.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length,p=i.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length,r=i.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Battleship].length,
j=Astriarch.Fleet.StarShipFactoryHelper.GenerateFleetWithShipCount(b,0,n,q,p,r,i.BoundingHex);if(j.DetermineFleetStrength()>o*k){j=i.PlanetaryFleet.SplitFleet(n,q,p,r);j.SetDestination(a.GameGrid,i.BoundingHex,g.BoundingHex);i.OutgoingFleets.push(j);Astriarch.AI.OnComputerSentFleet!=null&&Astriarch.AI.OnComputerSentFleet(j);i=i.PlanetaryFleet.GetPlanetaryFleetMobileStarshipCount();i==0&&d.splice(m,1);l=!0;break}}if(!l&&h.length>0){i=new Astriarch.Planet.PlanetDistanceComparer(a,g);h.sort(i.sortFunction);
k=h[h.length-1];j=a.GameGrid.GetHexDistance(g.BoundingHex,k.BoundingHex);for(m=d.length-1;m>=0;){i=d[m];if(i.Id==k.Id)break;if(a.GameGrid.GetHexDistance(g.BoundingHex,i.BoundingHex)<j)break;n=i.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Scout].length;q=i.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length;p=i.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length;r=i.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Battleship].length;Astriarch.Fleet.StarShipFactoryHelper.GenerateFleetWithShipCount(b,
0,n,q,p,r,i.BoundingHex);j=i.PlanetaryFleet.SplitFleet(n,q,p,r);j.SetDestination(a.GameGrid,i.BoundingHex,k.BoundingHex);i.OutgoingFleets.push(j);Astriarch.AI.OnComputerSentFleet!=null&&Astriarch.AI.OnComputerSentFleet(j);i=i.PlanetaryFleet.GetPlanetaryFleetMobileStarshipCount();i==0&&d.splice(m,1);break}}if(d.length==0)break}if(d.length>0)for(e=c.length-1;e>=0;e--){g=c[e];b.Type==Astriarch.Player.PlayerType.Computer_Easy||b.Type==Astriarch.Player.PlayerType.Computer_Normal?(i=new Astriarch.Planet.PlanetDistanceComparer(a,
g),d.sort(i.sortFunction)):(i=new Astriarch.Planet.PlanetValueDistanceStrengthComparer(a,g,b.LastKnownPlanetFleetStrength),d.sort(i.sortFunction),d.reverse());for(m=d.length-1;m>=0;){i=d[m];f=c[e];j=i.PlanetaryFleet.SplitOffSmallestPossibleFleet();j.SetDestination(a.GameGrid,i.BoundingHex,f.BoundingHex);i.OutgoingFleets.push(j);Astriarch.AI.OnComputerSentFleet!=null&&Astriarch.AI.OnComputerSentFleet(j);i=i.PlanetaryFleet.GetPlanetaryFleetMobileStarshipCount();i==0&&d.splice(m,1);break}if(d.length==
0)break}},getClosestUnownedPlanet:function(a,b,c,d){d.minDistance=999;var e=null,g;for(g in a.Planets){var f=a.Planets[g];if(f.Id!=c.Id&&f.Owner!=b){var h=a.GameGrid.GetHexDistance(c.BoundingHex,f.BoundingHex);if(h<d.minDistance)d.minDistance=h,e=f}}return e},countPlanetsNeedingExploration:function(a,b){var c=0,d;for(d in a.Planets){var e=a.Planets[d];e.Owner!=b&&!b.PlanetContainsFriendlyInboundFleet(e)&&(!(e.Id in b.KnownClientPlanets)||b.Type!=Astriarch.Player.PlayerType.Computer_Easy&&e.Id in b.LastKnownPlanetFleetStrength&&
a.Turn.Number-b.LastKnownPlanetFleetStrength[e.Id].TurnLastExplored>20)&&c++}return c}};Astriarch.DrawnPlanet=jCanvas.DrawnObject.extend({init:function(a){this.ClientPlanet=a;this.planetImageBackgroundPosition=this.knownPlanetType=null;this.textBlockStrengthForeground=this.textBlockForeground="yellow";this.textBlockStrengthText="";this.fleetRectangle=new Astriarch.Rectangle(this.ClientPlanet.BoundingHex.MidPoint.X+Astriarch.Planet.Static.PLANET_SIZE/2-2,this.ClientPlanet.BoundingHex.MidPoint.Y+Astriarch.Planet.Static.PLANET_SIZE/2-2,11,11);this.drawFleetRectangle=!1;this.fleetRectangleImageData=
Astriarch.Util.starshipImageData;this.spacePlatformRectangle=new Astriarch.Rectangle(this.ClientPlanet.BoundingHex.MidPoint.X-Astriarch.Planet.Static.PLANET_SIZE/2-8,this.ClientPlanet.BoundingHex.MidPoint.Y+Astriarch.Planet.Static.PLANET_SIZE/2-2,11,11);this.drawSpacePlatformRectangle=!1;this.spacePlatformRectangleImageData=Astriarch.Util.spaceplatformImageData},draw:function(a){var b=Astriarch.Planet.Static.PLANET_SIZE,c=Astriarch.Planet.Static.PLANET_SIZE,d=this.ClientPlanet.OriginPoint.X+b/2,e=
this.ClientPlanet.OriginPoint.Y+c/2;if(this.planetImageBackgroundPosition===null){var g=b*1.33;a.beginPath();a.moveTo(d,e-c/2);a.bezierCurveTo(d-g/2,e-c/2,d-g/2,e+c/2,d,e+c/2);a.bezierCurveTo(d+g/2,e+c/2,d+g/2,e-c/2,d,e-c/2);a.lineWidth=2;a.strokeStyle="white";a.fillStyle="black";a.stroke();a.fill();a.closePath();this.drawText(a,d,e)}else{var f=new Image,h=this.ClientPlanet.OriginPoint.X-6,i=this.ClientPlanet.OriginPoint.Y-7;this.knownPlanetType==Astriarch.Planet.PlanetType.AsteroidBelt&&(h+=1);var j=
this;f.onload=function(){a.drawImage(f,0,j.planetImageBackgroundPosition,32,32,h,i,32,32);j.drawText(a,d,e)};f.src=Astriarch.View.SpriteSheetInfo.filename;if(this.drawFleetRectangle){c=a.createImageData(this.fleetRectangle.Width,this.fleetRectangle.Height);for(g in this.fleetRectangleImageData)c.data[g]=this.fleetRectangleImageData[g];a.putImageData(c,this.fleetRectangle.X,this.fleetRectangle.Y)}if(this.drawSpacePlatformRectangle){c=a.createImageData(this.spacePlatformRectangle.Width,this.spacePlatformRectangle.Height);
for(g in this.spacePlatformRectangleImageData)c.data[g]=this.spacePlatformRectangleImageData[g];a.putImageData(c,this.spacePlatformRectangle.X,this.spacePlatformRectangle.Y)}}},drawText:function(a,b,c){a.fillStyle=this.textBlockForeground;a.font="bolder 8pt Trebuchet MS,Tahoma,Verdana,Arial,sans-serif";a.textAlign="center";a.textBaseline="middle";a.fillText(this.ClientPlanet.BoundingHex.Id,b,c);a.fillStyle=this.textBlockStrengthForeground;a.font="bold 7pt Trebuchet MS,Tahoma,Verdana,Arial,sans-serif";
a.fillText(this.textBlockStrengthText,b,c-14)},isInBounds:function(){return!1},UpdatePlanetDrawingForPlayer:function(a){this.planetImageBackgroundPosition=null;if(this.knownPlanetType=a.PlanetTypeIfKnownByPlayer(this.ClientPlanet))switch(this.knownPlanetType){case Astriarch.Planet.PlanetType.PlanetClass2:this.planetImageBackgroundPosition=Astriarch.View.SpriteSheetInfo.planetClass2Y;break;case Astriarch.Planet.PlanetType.PlanetClass1:this.planetImageBackgroundPosition=Astriarch.View.SpriteSheetInfo.planetClass1Y;
break;case Astriarch.Planet.PlanetType.DeadPlanet:this.planetImageBackgroundPosition=Astriarch.View.SpriteSheetInfo.planetDeadY;break;case Astriarch.Planet.PlanetType.AsteroidBelt:this.planetImageBackgroundPosition=Astriarch.View.SpriteSheetInfo.planetAsteroidY}this.drawSpacePlatformRectangle=this.drawFleetRectangle=!1;var b=null,c=null;if(this.ClientPlanet.Id in a.LastKnownPlanetFleetStrength)b=a.LastKnownPlanetFleetStrength[this.ClientPlanet.Id],c=b.LastKnownOwner;var d=a.GetPlanetIfOwnedByPlayer(this.ClientPlanet);
if(d){this.textBlockForeground=a.Color.toString();this.textBlockStrengthForeground=a.Color.toString();if(d.PlanetaryFleet.GetPlanetaryFleetMobileStarshipCount()>0)this.drawFleetRectangle=!0,this.fleetRectangleImageData=Astriarch.Util.GetImageData(a.Color).starshipImageData;if(d.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform].length>0)this.drawSpacePlatformRectangle=!0,this.spacePlatformRectangleImageData=Astriarch.Util.GetImageData(a.Color).spaceplatformImageData;this.textBlockStrengthText=
d.PlanetaryFleet.DetermineFleetStrength()+""}else if(this.knownPlanetType&&b&&c){this.textBlockForeground=c.Color.toString();this.textBlockStrengthForeground=c.Color.toString();if(b.Fleet.GetPlanetaryFleetMobileStarshipCount()>0)this.drawFleetRectangle=!0,this.fleetRectangleImageData=Astriarch.Util.GetImageData(c.Color).starshipImageData;if(b.Fleet.HasSpacePlatform)this.drawSpacePlatformRectangle=!0,this.spacePlatformRectangleImageData=Astriarch.Util.GetImageData(c.Color).spaceplatformImageData;this.textBlockStrengthText=
b.Fleet.DetermineFleetStrength()+""}else this.textBlockForeground=this.knownPlanetType==Astriarch.Planet.PlanetType.DeadPlanet?"black":"yellow",this.textBlockStrengthForeground="yellow",this.textBlockStrengthText=this.knownPlanetType&&b?b.Fleet.DetermineFleetStrength()+"":""}});Astriarch.DrawnFleet=jCanvas.DrawnObject.extend({init:function(a){this.Fleet=a;this.Fleet.DrawnFleet=this;this.TravelETATextBlockRect=new Astriarch.Rectangle;this.TravelETATextBlockText="ETA";this.travelDistancePoint=new Astriarch.Point;this.TravelFleetRect=new Astriarch.Rectangle;this.TravelFleetRect.Height=11;this.TravelFleetRect.Width=11;this.TravelLine=new Astriarch.Line},draw:function(a){if(this.Fleet.totalTravelDistance>0){var b="green",c=Astriarch.Util.starshipImageData;if(this.Fleet.Owner)b=
this.Fleet.Owner.Color.toString(),c=Astriarch.Util.GetImageData(this.Fleet.Owner.Color).starshipImageData;a.strokeStyle=b;a.lineWidth=1.5;a.beginPath();a.moveTo(this.TravelLine.X1,this.TravelLine.Y1);a.lineTo(this.TravelLine.X2,this.TravelLine.Y2);a.closePath();a.stroke();var d=a.createImageData(this.TravelFleetRect.Width,this.TravelFleetRect.Height),e;for(e in c)d.data[e]=c[e];a.putImageData(d,this.TravelFleetRect.X,this.TravelFleetRect.Y);a.fillStyle=b;a.font="bold 8px sans-serif";a.textAlign="left";
a.textBaseline="alphabetic";a.fillText(this.TravelETATextBlockText,this.TravelETATextBlockRect.X,this.TravelETATextBlockRect.Y)}},isInBounds:function(){return!1},updateTravelLine:function(){if(this.Fleet.TurnsToDestination!=0){this.TravelLine.X2=this.Fleet.DestinationHex.MidPoint.X;this.TravelLine.Y2=this.Fleet.DestinationHex.MidPoint.Y;var a=(this.Fleet.totalTravelDistance-this.Fleet.TurnsToDestination)*1/(this.Fleet.totalTravelDistance*1);this.travelDistancePoint.X=this.Fleet.travelingFromHex.MidPoint.X-
(this.Fleet.travelingFromHex.MidPoint.X-this.TravelLine.X2)*a;this.travelDistancePoint.Y=this.Fleet.travelingFromHex.MidPoint.Y-(this.Fleet.travelingFromHex.MidPoint.Y-this.TravelLine.Y2)*a;this.TravelLine.X1=this.travelDistancePoint.X;this.TravelLine.Y1=this.travelDistancePoint.Y;this.TravelETATextBlockText=this.Fleet.TurnsToDestination+(this.Fleet.TurnsToDestination>1?" Turns":" Turn");a=8;this.TravelLine.X2>this.Fleet.travelingFromHex.MidPoint.X&&(a=this.Fleet.TurnsToDestination>9?-40:this.Fleet.TurnsToDestination==
1?-30:-35);this.TravelETATextBlockRect.X=this.travelDistancePoint.X+a;this.TravelETATextBlockRect.Y=this.travelDistancePoint.Y+4;this.TravelFleetRect.X=this.travelDistancePoint.X-5;this.TravelFleetRect.Y=this.travelDistancePoint.Y-5}else this.Fleet.totalTravelDistance=0;if(this.layer)this.layer.needsDisplay=!0}});Astriarch.Dialog=function(a,b,c,d,e,g){this.DialogResult=!1;this.okCallback=e;this.cancelCallback=g;e=[];typeof this.okCallback=="function"&&e.push({text:"Ok",click:function(){f.okClose()}});typeof this.cancelCallback=="function"&&e.push({text:"Cancel",click:function(){f.cancelClose()}});var f=this;this.dlg=$(a).dialog({autoOpen:!1,resizable:!1,title:b,width:c,height:d,modal:!0,buttons:e})};Astriarch.Dialog.prototype.open=function(){this.dlg.dialog("open")};Astriarch.Dialog.prototype.close=function(){this.dlg.dialog("close")};
Astriarch.Dialog.prototype.okClose=function(){this.DialogResult=!0;typeof this.okCallback=="function"&&this.okCallback();this.dlg.dialog("close")};Astriarch.Dialog.prototype.cancelClose=function(){this.DialogResult=!1;typeof this.cancelCallback=="function"&&this.cancelCallback();this.dlg.dialog("close")};Astriarch.Dialog.prototype.setTitle=function(a){this.dlg.dialog("option","title",a)};Astriarch.GameController={planetaryConflictMessages:[],turnTimerTimeoutId:null};
Astriarch.GameController.ResetView=function(a){$("#TurnDisplay,#OverallPlayerStatusGrid,#SelectedItemStatus,#SelectedItemPopulationPanel,#SelectedItemImprovementSlotsPanel,#SelectedItemPopulationAssignmentsPanel,#SelectedItemBuiltImprovementsGrid,#SelectedItemPlanetaryFleetGrid,#SelectedItemStatusDetails,#BottomStatusGrid,#TurnSummaryItemsListBox,#ButtonPanel").show();$("#PlanetViewButton,#SendShipsButton,#NextTurnButton,#ButtonOpenTradingCenter").show();var b=new Astriarch.Grid(615,480);Astriarch.ClientGameModel=
Astriarch.ClientModelInterface.GetClientModelFromSerializableClientModel(a,b);Astriarch.GameController.RefreshTurnDisplay();Astriarch.GameController.SetupViewFromGameModel();Astriarch.CommControl.refreshPlayerList()};
Astriarch.GameController.SetupViewFromGameModel=function(){Astriarch.View.ClearPlanetsAndFleets();Astriarch.View.audioInterface.BeginGame();Astriarch.View.TurnSummaryItemsListBox.clear();for(var a in Astriarch.ClientGameModel.GameGrid.Hexes)Astriarch.View.CanvasPlayfieldLayer.addChild(Astriarch.ClientGameModel.GameGrid.Hexes[a]);for(var b in Astriarch.ClientGameModel.ClientPlanets){a=Astriarch.ClientGameModel.ClientPlanets[b];var c=new Astriarch.DrawnPlanet(a);Astriarch.View.DrawnPlanets[a.Id]=c;
Astriarch.View.CanvasPlayfieldLayer.addChild(c)}Astriarch.View.updateCanvasForPlayer();Astriarch.ClientGameModel.GameGrid.SelectHex(Astriarch.ClientGameModel.MainPlayer.HomePlanet.BoundingHex);Astriarch.View.updateSelectedItemPanelForPlanet();Astriarch.View.updatePlayerStatusPanel()};Astriarch.GameController.NextTurn=function(){Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.END_TURN,payload:{}})};
Astriarch.GameController.HideControlsForTurnStart=function(){Astriarch.PlanetView.Close();Astriarch.SendShipsControl.Close();Astriarch.TradingControl.Close()};Astriarch.GameController.OnEndTurnMessageResponse=function(a){a.payload.allPlayersFinished&&($("#NextTurnButton").button("enable"),Astriarch.GameController.HideControlsForTurnStart(),Astriarch.GameController.OnStartTurn(a))};
Astriarch.GameController.OnPlayerDestroyed=function(a){new Astriarch.Alert(a.Name+" Destroyed",'Player: <span style="color:'+a.Color.toString()+'">'+a.Name+"</span> destroyed.")};
Astriarch.GameController.OnGameOverMessageResponse=function(a){Astriarch.View.audioInterface.EndGame();Astriarch.GameController.HideControlsForTurnStart();Astriarch.GameController.UpdateUIForEndTurnMessage(a);$("#PlanetViewButton,#SendShipsButton,#NextTurnButton,#ButtonOpenTradingCenter").hide();Astriarch.GameOverControl.show(a.payload.winningSerializablePlayer,a.payload.playerWon,a.payload.score)};
Astriarch.GameController.RefreshTurnDisplay=function(){var a=Astriarch.ClientGameModel.Turn.Number+3E3;$("#TurnDisplay").text("Turn "+Astriarch.ClientGameModel.Turn.Number+", Year "+a);var b=$("#TurnTimer");Astriarch.ClientGameModel.Options.TurnTimeLimitSeconds?(b.show(),b.stop(!0).animate({width:"100%"},500,"linear",function(){b.animate({width:"0px"},Astriarch.ClientGameModel.Options.TurnTimeLimitSeconds*1E3,"linear");Astriarch.GameController.turnTimerTimeoutId&&clearTimeout(Astriarch.GameController.turnTimerTimeoutId);
Astriarch.GameController.turnTimerTimeoutId=setTimeout(function(){Astriarch.View.NextTurn()},Astriarch.ClientGameModel.Options.TurnTimeLimitSeconds*1E3)})):b.hide()};Astriarch.GameController.OnStartTurn=function(a){if(a.payload.destroyedClientPlayers)for(var b in a.payload.destroyedClientPlayers)Astriarch.GameController.OnPlayerDestroyed(a.payload.destroyedClientPlayers[b]);Astriarch.GameController.UpdateUIForEndTurnMessage(a);Astriarch.GameController.processNextEndOfTurnPlanetaryConflictMessage()};
Astriarch.GameController.UpdateUIForEndTurnMessage=function(a){Astriarch.ClientGameModel=Astriarch.ClientModelInterface.GetClientModelFromSerializableClientModel(a.payload.gameData,Astriarch.ClientGameModel.GameGrid);Astriarch.GameController.RefreshTurnDisplay();Astriarch.CommControl.refreshPlayerList();var b=a.payload.endOfTurnMessages,a=[],c;for(c in b)a.push(Astriarch.ClientModelInterface.GetTurnEventMessageFromSerializableTurnEventMessage(b[c],Astriarch.ClientGameModel.GameGrid));Astriarch.GameController.planetaryConflictMessages=
[];if(Astriarch.PlayerGameOptions.ShowPlanetaryConflictPopups)for(var d in a)b=a[d],(b.Type==Astriarch.TurnEventMessage.TurnEventMessageType.AttackingFleetLost||b.Type==Astriarch.TurnEventMessage.TurnEventMessageType.DefendedAgainstAttackingFleet||b.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetCaptured||b.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetLost)&&b.Data!=null&&Astriarch.GameController.planetaryConflictMessages.push(b);Astriarch.View.updatePlayerStatusPanel();
Astriarch.View.updateSelectedItemPanelForPlanet();Astriarch.View.updateCanvasForPlayer();Astriarch.View.TurnSummaryItemsListBox.clear();if(a.length>0){c=[];for(d in a){b=a[d];b=new Astriarch.GameController.TurnSummaryMessageListBoxItem(b);switch(b.EventMessage.Type){case Astriarch.TurnEventMessage.TurnEventMessageType.ResourcesAutoSpent:case Astriarch.TurnEventMessage.TurnEventMessageType.PopulationGrowth:b.Foreground="blue";break;case Astriarch.TurnEventMessage.TurnEventMessageType.DefendedAgainstAttackingFleet:b.Foreground=
"purple";break;case Astriarch.TurnEventMessage.TurnEventMessageType.BuildQueueEmpty:b.Foreground="grey";break;case Astriarch.TurnEventMessage.TurnEventMessageType.CitizensProtesting:case Astriarch.TurnEventMessage.TurnEventMessageType.InsufficientFood:b.Foreground="yellow";break;case Astriarch.TurnEventMessage.TurnEventMessageType.PlanetCaptured:case Astriarch.TurnEventMessage.TurnEventMessageType.AttackingFleetLost:b.Foreground="orange";break;case Astriarch.TurnEventMessage.TurnEventMessageType.PlanetLost:case Astriarch.TurnEventMessage.TurnEventMessageType.PopulationStarvation:case Astriarch.TurnEventMessage.TurnEventMessageType.PlanetLostDueToStarvation:case Astriarch.TurnEventMessage.TurnEventMessageType.FoodShortageRiots:b.Foreground=
"red";break;default:b.Foreground="green"}c.push(b)}Astriarch.View.TurnSummaryItemsListBox.addItems(c)}if((d=Astriarch.ClientGameModel.MainPlayer.HomePlanet)&&window.tour.enabled)a=d.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length,c=d.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Colony].length,b=d.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform].length,(a==1&&window.tour.step==48||a==2&&window.tour.step==49||a==3&&window.tour.step==50||c==
1&&window.tour.step==51||b==1&&window.tour.step==68)&&window.tour.jqElm.joyride("resume"),d.PlanetaryFleet.StarShips[Astriarch.Fleet.StarShipType.Scout].length>0&&window.tour.step==54&&window.tour.jqElm.joyride("resume"),Astriarch.CountObjectKeys(Astriarch.ClientGameModel.MainPlayer.KnownClientPlanets)>=4&&window.tour.step==63&&window.tour.jqElm.joyride("resume"),Astriarch.CountObjectKeys(Astriarch.ClientGameModel.MainPlayer.OwnedPlanets)>=4&&window.tour.step==66&&window.tour.jqElm.joyride("resume")};
Astriarch.GameController.processNextEndOfTurnPlanetaryConflictMessage=function(){var a=Astriarch.GameController.planetaryConflictMessages.length-1;if(a>=0){var b=Astriarch.GameController.planetaryConflictMessages[a];Astriarch.GameController.planetaryConflictMessages.splice(a,1);Astriarch.PlayerGameOptions.ShowPlanetaryConflictPopups&&Astriarch.GameController.popupPlanetaryConflictControl(b)}};Astriarch.GameController.popupPlanetaryConflictControl=function(a){Astriarch.PlanetaryConflictControl.show(a)};
Astriarch.GameController.GameOverControlClosed=function(){Astriarch.View.updateCanvasForPlayer();Astriarch.View.updateSelectedItemPanelForPlanet();$("#MainMenuButtonGameOver").show()};
Astriarch.GameController.TurnSummaryMessageListBoxItem=JSListBox.Item.extend({init:function(a){this.value=a.Message;this.Foreground=null;this.EventMessage=a},render:function(){return'<a href="#" style="color:'+this.Foreground+'">'+this.value+"</a>"},onClick:function(){this.EventMessage!=null&&this.EventMessage.Planet!=null&&Astriarch.View.selectPlanet(this.EventMessage.Planet)},onDblClick:function(){this.EventMessage&&(this.EventMessage.Type==Astriarch.TurnEventMessage.TurnEventMessageType.AttackingFleetLost||
this.EventMessage.Type==Astriarch.TurnEventMessage.TurnEventMessageType.DefendedAgainstAttackingFleet||this.EventMessage.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetCaptured||this.EventMessage.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetLost)&&Astriarch.GameController.popupPlanetaryConflictControl(this.EventMessage)}});Astriarch.PlanetView={dialog:null,planetMain:null,population:0,farmers:0,miners:0,workers:0,farmersOrig:0,minersOrig:0,workersOrig:0,farmCount:0,mineCount:0,factoryCount:0,colonyCount:0,workingBuildQueue:[],workingResources:null,workingProductionRemainderOriginal:0,lastClicked:null,lastChanged:null,updatingGUI:!1,ItemsAvailableListBox:null,BuildQueueListBox:null,lbiFarm:null,lbiMine:null,lbiColony:null,lbiFactory:null,lbiSpacePlatform:null,lbiDefender:null,lbiScout:null,lbiDestroyer:null,lbiCruiser:null,
lbiBattleship:null,itemsAvailable:[],init:function(){$("#ButtonDemolishFarm, #ButtonDemolishMine, #ButtonDemolishFactory, #ButtonDemolishColony").button({icons:{primary:"icon-16x16-demolish"},text:!1});$("#SliderFarmers").slider({value:0,step:1,min:0,max:10,slide:Astriarch.PlanetView.SliderFarmersValueChanged});$("#SliderMiners").slider({value:0,step:1,min:0,max:10,slide:Astriarch.PlanetView.SliderMinersValueChanged});$("#SliderWorkers").slider({value:0,step:1,min:0,max:10,slide:Astriarch.PlanetView.SliderWorkersValueChanged});
$("#ButtonBuildQueueAddSelectedItem").button({icons:{primary:"icon-16x16-build-queue-add"},text:!1});$("#ButtonBuildQueueRemoveSelectedItem").button({icons:{primary:"icon-16x16-build-queue-remove"},text:!1});$("#ButtonBuildQueueMoveSelectedItemDown").button({icons:{primary:"icon-16x16-build-queue-down"},text:!1});$("#ButtonBuildQueueMoveSelectedItemUp").button({icons:{primary:"icon-16x16-build-queue-up"},text:!1});$("#ButtonBuildQueueAddSelectedItem").click(function(){Astriarch.PlanetView.addSelectedItemToQueue()});
$("#ButtonBuildQueueRemoveSelectedItem").click(function(){Astriarch.PlanetView.removeSelectedItemFromQueue()});$("#ButtonBuildQueueMoveSelectedItemDown").click(function(){Astriarch.PlanetView.moveSelectedItemInQueue(!1)});$("#ButtonBuildQueueMoveSelectedItemUp").click(function(){Astriarch.PlanetView.moveSelectedItemInQueue(!0)});$("#ButtonDemolishFarm").click(function(){Astriarch.PlanetView.addImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Farm)});$("#ButtonDemolishMine").click(function(){Astriarch.PlanetView.addImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Mine)});
$("#ButtonDemolishFactory").click(function(){Astriarch.PlanetView.addImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Factory)});$("#ButtonDemolishColony").click(function(){Astriarch.PlanetView.addImprovementToDestroy(Astriarch.Planet.PlanetImprovementType.Colony)});$("#BuildLastShipCheckBoxLabel").attr("title","If this option is checked and the build queue is empty at the end of the turn,\r\nthe ship last built on this planet will be added to the queue.\r\nIn order to build the ship, sufficient resources must exist\r\nas well as a surplus of gold to cover the amount of food shipped last turn.");
$("#BuildLastShipCheckBox").attr("checked",!0);Astriarch.PlanetView.ItemsAvailableListBox=new JSListBox({containerSelector:"ItemsAvailableListBox"});Astriarch.PlanetView.BuildQueueListBox=new JSListBox({containerSelector:"BuildQueueListBox"});Astriarch.PlanetView.lbiFarm=new Astriarch.PlanetView.AvailableImprovementListBoxItem(Astriarch.Planet.PlanetImprovementType.Farm);Astriarch.PlanetView.lbiMine=new Astriarch.PlanetView.AvailableImprovementListBoxItem(Astriarch.Planet.PlanetImprovementType.Mine);
Astriarch.PlanetView.lbiColony=new Astriarch.PlanetView.AvailableImprovementListBoxItem(Astriarch.Planet.PlanetImprovementType.Colony);Astriarch.PlanetView.lbiFactory=new Astriarch.PlanetView.AvailableImprovementListBoxItem(Astriarch.Planet.PlanetImprovementType.Factory);Astriarch.PlanetView.lbiSpacePlatform=new Astriarch.PlanetView.AvailableImprovementListBoxItem(Astriarch.Planet.PlanetImprovementType.SpacePlatform);Astriarch.PlanetView.lbiDefender=new Astriarch.PlanetView.AvailableStarShipListBoxItem(Astriarch.Fleet.StarShipType.SystemDefense);
Astriarch.PlanetView.lbiScout=new Astriarch.PlanetView.AvailableStarShipListBoxItem(Astriarch.Fleet.StarShipType.Scout);Astriarch.PlanetView.lbiDestroyer=new Astriarch.PlanetView.AvailableStarShipListBoxItem(Astriarch.Fleet.StarShipType.Destroyer);Astriarch.PlanetView.lbiCruiser=new Astriarch.PlanetView.AvailableStarShipListBoxItem(Astriarch.Fleet.StarShipType.Cruiser);Astriarch.PlanetView.lbiBattleship=new Astriarch.PlanetView.AvailableStarShipListBoxItem(Astriarch.Fleet.StarShipType.Battleship);
Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiFarm);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiMine);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiColony);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiFactory);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiSpacePlatform);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiDefender);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiScout);
Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiDestroyer);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiCruiser);Astriarch.PlanetView.itemsAvailable.push(Astriarch.PlanetView.lbiBattleship);Astriarch.PlanetView.dialog=new Astriarch.Dialog("#planetViewDialog","Planet View",568,485,Astriarch.PlanetView.OKClose,Astriarch.PlanetView.CancelClose);Astriarch.PlanetView.lastClicked=Astriarch.PlanetView.SliderValueClicked.None;Astriarch.PlanetView.lastChanged=Astriarch.PlanetView.SliderValueClicked.None},
show:function(a){Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_START,payload:{planetId:a.Id}});Astriarch.PlanetView.planetMain=a;var b=Astriarch.GameTools.PlanetTypeToClassName(a.Type);$("#PlanetImage").attr("class",b);$("#TextBlockPlanetType").text(Astriarch.GameTools.PlanetTypeToFriendlyName(a.Type));Astriarch.PlanetView.farmCount=a.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Farm].length;Astriarch.PlanetView.mineCount=a.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Mine].length;
Astriarch.PlanetView.factoryCount=a.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length;Astriarch.PlanetView.colonyCount=a.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Colony].length;$("#PlanetViewFarmCount").text(Astriarch.PlanetView.farmCount);$("#PlanetViewMineCount").text(Astriarch.PlanetView.mineCount);$("#PlanetViewFactoryCount").text(Astriarch.PlanetView.factoryCount);$("#PlanetViewColonyCount").text(Astriarch.PlanetView.colonyCount);$("#PlanetViewSpacePlatformCount").text(a.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform].length);
Astriarch.PlanetView.refreshResourcesPerTurnTextBoxes();Astriarch.PlanetView.updatePlanetStatsToolTip();b=a.GetPopulationByContentment();Astriarch.PlanetView.population=b.content.length;$("#SliderFarmers").slider("option","max",Astriarch.PlanetView.population);$("#SliderMiners").slider("option","max",Astriarch.PlanetView.population);$("#SliderWorkers").slider("option","max",Astriarch.PlanetView.population);b=new Astriarch.Planet.PopulationAssignments;a.CountPopulationWorkerTypes(b);Astriarch.PlanetView.farmers=
b.Farmers;Astriarch.PlanetView.miners=b.Miners;Astriarch.PlanetView.workers=b.Workers;Astriarch.PlanetView.farmersOrig=Astriarch.PlanetView.farmers;Astriarch.PlanetView.minersOrig=Astriarch.PlanetView.miners;Astriarch.PlanetView.workersOrig=Astriarch.PlanetView.workers;$("#SliderFarmers").slider("value",Astriarch.PlanetView.farmers);$("#TextBoxFarmers").text(Astriarch.PlanetView.farmers+"");$("#SliderMiners").slider("value",Astriarch.PlanetView.miners);$("#TextBoxMiners").text(Astriarch.PlanetView.miners+
"");$("#SliderWorkers").slider("value",Astriarch.PlanetView.workers);$("#TextBoxWorkers").text(Astriarch.PlanetView.workers+"");Astriarch.PlanetView.workingBuildQueue=[];for(var c in a.BuildQueue)Astriarch.PlanetView.workingBuildQueue.push(a.BuildQueue[c]);Astriarch.PlanetView.workingResources=new Astriarch.Model.WorkingPlayerResources(a.Owner);Astriarch.PlanetView.workingProductionRemainderOriginal=a.RemainderProduction;Astriarch.PlanetView.ItemsAvailableListBox.setSelectedItem(null);Astriarch.PlanetView.refreshItemsAvailableListBox();
Astriarch.PlanetView.refreshBuildQueueListBox();Astriarch.PlanetView.showOrHideDemolishImprovementButtons();$("#ButtonBuildQueueAddSelectedItem").button("disable");$("#ButtonBuildQueueRemoveSelectedItem").button("disable");$("#ButtonBuildQueueMoveSelectedItemDown").button("disable");$("#ButtonBuildQueueMoveSelectedItemUp").button("disable");Astriarch.PlanetView.refreshCurrentWorkingResourcesTextBoxes();Astriarch.PlanetView.planetMain.BuildLastStarShip?$("#BuildLastShipCheckBox").prop("checked",!0):
$("#BuildLastShipCheckBox").prop("checked",!1);$("#BuildLastShipCheckBoxLabel").text("Build Last Ship");$("#LastShipBuiltTextBlock").text("");Astriarch.PlanetView.planetMain.StarShipTypeLastBuilt!=null&&$("#LastShipBuiltTextBlock").text("Last Built: "+Astriarch.GameTools.StarShipTypeToFriendlyName(Astriarch.PlanetView.planetMain.StarShipTypeLastBuilt));Astriarch.PlanetView.dialog.setTitle("Planet "+a.Name+" View");Astriarch.PlanetView.dialog.open();window.tour.enabled&&(window.tour.step==27||window.tour.step==
32||window.tour.step==43)&&window.tour.jqElm.joyride("resume")},BuildQueueSelectionChanged:function(){$("#ButtonBuildQueueRemoveSelectedItem").button("disable");$("#ButtonBuildQueueMoveSelectedItemDown").button("disable");$("#ButtonBuildQueueMoveSelectedItemUp").button("disable");Astriarch.PlanetView.BuildQueueListBox.SelectedItem!=null&&($("#ButtonBuildQueueRemoveSelectedItem").button("enable"),Astriarch.PlanetView.BuildQueueListBox.SelectedIndex!=Astriarch.PlanetView.BuildQueueListBox.items.length-
1&&$("#ButtonBuildQueueMoveSelectedItemDown").button("enable"),Astriarch.PlanetView.BuildQueueListBox.SelectedIndex!=0&&$("#ButtonBuildQueueMoveSelectedItemUp").button("enable"))},ItemsAvailableSelectionChanged:function(){Astriarch.PlanetView.ItemsAvailableListBox.SelectedItem!=null&&Astriarch.PlanetView.ItemsAvailableListBox.SelectedItem.enabled?$("#ButtonBuildQueueAddSelectedItem").button("enable"):$("#ButtonBuildQueueAddSelectedItem").button("disable")},recalculateBuildQueueListItemsTurnsToCompleteEstimates:function(){var a=
Astriarch.PlanetView;a.planetMain.UpdatePopulationWorkerTypes(a.farmers,a.miners,a.workers);a.planetMain.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats();var b=a.workingProductionRemainderOriginal,c;for(c in a.BuildQueueListBox.items)a.BuildQueueListBox.items[c].ProductionItem.EstimateTurnsToComplete(a.planetMain.ResourcesPerTurn.GetProductionAmountPerTurn()+b),b=0;a.BuildQueueListBox.refresh()},refreshResourcesPerTurnTextBoxes:function(){$("#TextBlockFoodPerTurn").text(Astriarch.PlanetView.planetMain.ResourcesPerTurn.FoodAmountPerTurn);
$("#TextBlockOrePerTurn").text(Astriarch.PlanetView.planetMain.ResourcesPerTurn.OreAmountPerTurn);$("#TextBlockIridiumPerTurn").text(Astriarch.PlanetView.planetMain.ResourcesPerTurn.IridiumAmountPerTurn);$("#TextBlockProductionPerTurn").text(Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetProductionAmountPerTurn())},updatePlanetStatsToolTip:function(){var a="";a+="Base Worker Resource Generation Per Turn:\r\n";a+="Food: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.BaseFoodAmountPerWorkerPerTurn+
"\r\n";a+="Ore: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.BaseOreAmountPerWorkerPerTurn+"\r\n";a+="Iridium: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.BaseIridiumAmountPerWorkerPerTurn+"\r\n";a+="Production: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.BaseProductionPerWorkerPerTurn+"\r\n\r\n";a+="Worker Resource Generation with Improvements:\r\n";a+="Food: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetExactFoodAmountPerWorkerPerTurn()+"\r\n";a+="Ore: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetExactOreAmountPerWorkerPerTurn()+
"\r\n";a+="Iridium: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetExactIridiumAmountPerWorkerPerTurn()+"\r\n";a+="Production: "+Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetExactProductionAmountPerWorkerPerTurn()+"\r\n\r\n";a+="Food amount on planet: "+Astriarch.PlanetView.planetMain.Resources.FoodAmount+"\r\n";$("#PlanetImage").attr("title","Planet Stats:\r\n"+a)},workingQueueContainsSpacePlatform:function(){for(var a in Astriarch.PlanetView.workingBuildQueue){var b=Astriarch.PlanetView.workingBuildQueue[a];
if(b instanceof Astriarch.Planet.PlanetImprovement&&b.Type==Astriarch.Planet.PlanetImprovementType.SpacePlatform)return!0}return!1},disableOrEnableImprovementsBasedOnSlotsAvailable:function(){var a=Astriarch.PlanetView.planetMain.BuiltImprovementCount(),b;for(b in Astriarch.PlanetView.workingBuildQueue){var c=Astriarch.PlanetView.workingBuildQueue[b];c instanceof Astriarch.Planet.PlanetImprovement&&c.Type!=Astriarch.Planet.PlanetImprovementType.SpacePlatform&&a++}Astriarch.PlanetView.planetMain.MaxImprovements-
a<=0?(Astriarch.PlanetView.lbiFarm.CanBuild=!1,Astriarch.PlanetView.lbiMine.CanBuild=!1,Astriarch.PlanetView.lbiColony.CanBuild=!1,Astriarch.PlanetView.lbiFactory.CanBuild=!1):(Astriarch.PlanetView.lbiFarm.CanBuild=!0,Astriarch.PlanetView.lbiMine.CanBuild=!0,Astriarch.PlanetView.lbiColony.CanBuild=!0,Astriarch.PlanetView.lbiFactory.CanBuild=!0);Astriarch.PlanetView.lbiSpacePlatform.CanBuild=Astriarch.PlanetView.planetMain.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length==0?
!1:!0;if(Astriarch.PlanetView.planetMain.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform].length>0||Astriarch.PlanetView.workingQueueContainsSpacePlatform())Astriarch.PlanetView.lbiSpacePlatform.CanBuild=!1},disableImprovementsBasedOnResourcesAvailable:function(){for(var a in Astriarch.PlanetView.itemsAvailable){var b=Astriarch.PlanetView.itemsAvailable[a];if(b instanceof Astriarch.PlanetView.AvailableImprovementListBoxItem){if(b.CanBuild)b.CanBuildBasedOnResources=Astriarch.PlanetView.workingResources.GoldAmount<
b.AvailablePlanetImprovement.GoldCost||Astriarch.PlanetView.workingResources.IridiumAmount<b.AvailablePlanetImprovement.IridiumCost||Astriarch.PlanetView.workingResources.OreAmount<b.AvailablePlanetImprovement.OreCost?!1:!0}else if(b instanceof Astriarch.PlanetView.AvailableStarShipListBoxItem&&b.CanBuild)b.CanBuildBasedOnResources=Astriarch.PlanetView.workingResources.GoldAmount<b.AvailableStarShip.GoldCost||Astriarch.PlanetView.workingResources.IridiumAmount<b.AvailableStarShip.IridiumCost||Astriarch.PlanetView.workingResources.OreAmount<
b.AvailableStarShip.OreCost?!1:!0}if(Astriarch.PlanetView.ItemsAvailableListBox.SelectedItem!=null&&(!Astriarch.PlanetView.ItemsAvailableListBox.SelectedItem.CanBuild||!Astriarch.PlanetView.ItemsAvailableListBox.SelectedItem.CanBuildBasedOnResources))Astriarch.PlanetView.ItemsAvailableListBox.setSelectedItem(null),Astriarch.PlanetView.ItemsAvailableListBox.refresh()},refreshItemsAvailableListBox:function(){Astriarch.PlanetView.disableOrEnableImprovementsBasedOnSlotsAvailable();Astriarch.PlanetView.lbiDestroyer.CanBuild=
Astriarch.PlanetView.planetMain.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.Factory].length==0?!1:!0;Astriarch.PlanetView.planetMain.BuiltImprovements[Astriarch.Planet.PlanetImprovementType.SpacePlatform].length==0?(Astriarch.PlanetView.lbiCruiser.CanBuild=!1,Astriarch.PlanetView.lbiBattleship.CanBuild=!1):(Astriarch.PlanetView.lbiCruiser.CanBuild=!0,Astriarch.PlanetView.lbiBattleship.CanBuild=!0);Astriarch.PlanetView.disableImprovementsBasedOnResourcesAvailable();Astriarch.PlanetView.ItemsAvailableListBox.clear();
Astriarch.PlanetView.ItemsAvailableListBox.addItems(Astriarch.PlanetView.itemsAvailable)},refreshBuildQueueListBox:function(){Astriarch.PlanetView.BuildQueueListBox.clear();var a=Astriarch.PlanetView.workingProductionRemainderOriginal,b;for(b in Astriarch.PlanetView.workingBuildQueue){var c=Astriarch.PlanetView.workingBuildQueue[b];c.EstimateTurnsToComplete(Astriarch.PlanetView.planetMain.ResourcesPerTurn.GetProductionAmountPerTurn()+a);a=0;c=new Astriarch.PlanetView.BuildQueueListBoxItem(c);Astriarch.PlanetView.BuildQueueListBox.addItem(c)}},
showOrHideDemolishImprovementButtons:function(){Astriarch.PlanetView.farmCount-Astriarch.PlanetView.countDemolishImprovementsInQueueByType(Astriarch.Planet.PlanetImprovementType.Farm)>0?$("#ButtonDemolishFarm").css({visibility:"visible"}):$("#ButtonDemolishFarm").css({visibility:"hidden"});Astriarch.PlanetView.mineCount-Astriarch.PlanetView.countDemolishImprovementsInQueueByType(Astriarch.Planet.PlanetImprovementType.Mine)>0?$("#ButtonDemolishMine").css({visibility:"visible"}):$("#ButtonDemolishMine").css({visibility:"hidden"});
Astriarch.PlanetView.factoryCount-Astriarch.PlanetView.countDemolishImprovementsInQueueByType(Astriarch.Planet.PlanetImprovementType.Factory)>0?$("#ButtonDemolishFactory").css({visibility:"visible"}):$("#ButtonDemolishFactory").css({visibility:"hidden"});Astriarch.PlanetView.colonyCount-Astriarch.PlanetView.countDemolishImprovementsInQueueByType(Astriarch.Planet.PlanetImprovementType.Colony)>0?$("#ButtonDemolishColony").css({visibility:"visible"}):$("#ButtonDemolishColony").css({visibility:"hidden"})},
refreshCurrentWorkingResourcesTextBoxes:function(){$("#TextBlockCurrentGoldAmount").text(Astriarch.PlanetView.workingResources.GoldAmount);$("#TextBlockCurrentOreAmount").text(Astriarch.PlanetView.workingResources.OreAmount);$("#TextBlockCurrentIridiumAmount").text(Astriarch.PlanetView.workingResources.IridiumAmount)},countDemolishImprovementsInQueueByType:function(a){var b=0,c;for(c in Astriarch.PlanetView.workingBuildQueue){var d=Astriarch.PlanetView.workingBuildQueue[c];d instanceof Astriarch.Planet.PlanetImprovementToDestroy&&
d.TypeToDestroy==a&&b++}return b},addImprovementToDestroy:function(a){var b=new Astriarch.Planet.PlanetImprovementToDestroy(a);Astriarch.PlanetView.workingBuildQueue.push(b);Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.DEMOLISH_IMPROVEMENT,planetId:Astriarch.PlanetView.planetMain.Id,data:a}});Astriarch.PlanetView.showOrHideDemolishImprovementButtons();Astriarch.PlanetView.refreshBuildQueueListBox()},
updateSliderValues:function(a,b){var c=Astriarch.PlanetView,d=0;c.updatingGUI=!0;if(c.lastClicked!=a)c.lastChanged=Astriarch.PlanetView.SliderValueClicked.None;var e=$("#SliderFarmers").slider("value"),g=$("#SliderMiners").slider("value"),f=$("#SliderWorkers").slider("value");switch(a){case Astriarch.PlanetView.SliderValueClicked.Farmers:e=b;d=e-c.farmers;break;case Astriarch.PlanetView.SliderValueClicked.Miners:g=b;d=g-c.miners;break;case Astriarch.PlanetView.SliderValueClicked.Workers:f=b,d=f-c.workers}var h=
!1,i=!1,j=!1;if(d>0)h=c.farmers!=0,i=c.miners!=0,j=c.workers!=0;else if(d<0)h=c.farmers!=c.population,i=c.miners!=c.population,j=c.workers!=c.population;else{c.updatingGUI=!1;return}for(;d!=0;){var k=1;d<0&&(k=-1);var l=Astriarch.PlanetView.SliderValueClicked.None;switch(a){case Astriarch.PlanetView.SliderValueClicked.Farmers:l=i&&!j?Astriarch.PlanetView.SliderValueClicked.Miners:!i&&j?Astriarch.PlanetView.SliderValueClicked.Workers:g==f?c.lastChanged!=Astriarch.PlanetView.SliderValueClicked.Miners?
Astriarch.PlanetView.SliderValueClicked.Miners:Astriarch.PlanetView.SliderValueClicked.Workers:d>0?g>f?Astriarch.PlanetView.SliderValueClicked.Miners:Astriarch.PlanetView.SliderValueClicked.Workers:g<f?Astriarch.PlanetView.SliderValueClicked.Miners:Astriarch.PlanetView.SliderValueClicked.Workers;break;case Astriarch.PlanetView.SliderValueClicked.Miners:l=h&&!j?Astriarch.PlanetView.SliderValueClicked.Farmers:!h&&j?Astriarch.PlanetView.SliderValueClicked.Workers:e==f?c.lastChanged!=Astriarch.PlanetView.SliderValueClicked.Farmers?
Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Workers:d>0?e>f?Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Workers:e<f?Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Workers;break;case Astriarch.PlanetView.SliderValueClicked.Workers:l=h&&!i?Astriarch.PlanetView.SliderValueClicked.Farmers:!h&&i?Astriarch.PlanetView.SliderValueClicked.Miners:e==g?c.lastChanged!=Astriarch.PlanetView.SliderValueClicked.Farmers?
Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Miners:d>0?e>g?Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Miners:e<g?Astriarch.PlanetView.SliderValueClicked.Farmers:Astriarch.PlanetView.SliderValueClicked.Miners}switch(l){case Astriarch.PlanetView.SliderValueClicked.Farmers:e-=k;$("#SliderFarmers").slider("value",e);c.lastChanged=Astriarch.PlanetView.SliderValueClicked.Farmers;break;case Astriarch.PlanetView.SliderValueClicked.Miners:g-=
k;$("#SliderMiners").slider("value",g);c.lastChanged=Astriarch.PlanetView.SliderValueClicked.Miners;break;case Astriarch.PlanetView.SliderValueClicked.Workers:f-=k;$("#SliderWorkers").slider("value",f);c.lastChanged=Astriarch.PlanetView.SliderValueClicked.Workers;break;default:console.error("Unable to determine slider to change in PlanetViewControl!")}c.farmers=e;c.miners=g;c.workers=f;d>0?d--:d<0&&d++}c.updatingGUI=!1;c.lastClicked=a;$("#TextBoxFarmers").text(c.farmers);$("#TextBoxMiners").text(c.miners);
$("#TextBoxWorkers").text(c.workers);window.tour.enabled&&window.tour.step==20&&c.workers==3?window.tour.jqElm.joyride("nextTip"):window.tour.enabled&&window.tour.step==29&&c.miners==2?window.tour.jqElm.joyride("nextTip"):window.tour.enabled&&window.tour.step==33&&c.miners==3?window.tour.jqElm.joyride("nextTip"):window.tour.enabled&&window.tour.step==45&&c.workers==3&&window.tour.jqElm.joyride("nextTip");c.recalculateBuildQueueListItemsTurnsToCompleteEstimates();c.refreshResourcesPerTurnTextBoxes()},
SliderFarmersValueChanged:function(a,b){Astriarch.PlanetView.updatingGUI||Astriarch.PlanetView.updateSliderValues(Astriarch.PlanetView.SliderValueClicked.Farmers,b.value)},SliderMinersValueChanged:function(a,b){Astriarch.PlanetView.updatingGUI||Astriarch.PlanetView.updateSliderValues(Astriarch.PlanetView.SliderValueClicked.Miners,b.value)},SliderWorkersValueChanged:function(a,b){Astriarch.PlanetView.updatingGUI||Astriarch.PlanetView.updateSliderValues(Astriarch.PlanetView.SliderValueClicked.Workers,
b.value)},moveSelectedItemInQueue:function(a){var b=Astriarch.PlanetView.BuildQueueListBox.SelectedIndex;if(!(b==0&&a)&&(b!=Astriarch.PlanetView.BuildQueueListBox.items.length-1||a)){var c=Astriarch.PlanetView.BuildQueueListBox.items[b];Astriarch.PlanetView.BuildQueueListBox.items.splice(b,1);Astriarch.PlanetView.workingBuildQueue.splice(b,1);a?(Astriarch.PlanetView.BuildQueueListBox.items.splice(b-1,0,c),Astriarch.PlanetView.workingBuildQueue.splice(b-1,0,c.ProductionItem),Astriarch.PlanetView.BuildQueueListBox.setSelectedIndex(b-
1),Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.MOVEUP,planetId:Astriarch.PlanetView.planetMain.Id,data:b}})):(Astriarch.PlanetView.BuildQueueListBox.items.splice(b+1,0,c),Astriarch.PlanetView.workingBuildQueue.splice(b+1,0,c.ProductionItem),Astriarch.PlanetView.BuildQueueListBox.setSelectedIndex(b+1),Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,
payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.MOVEDOWN,planetId:Astriarch.PlanetView.planetMain.Id,data:b}}));Astriarch.PlanetView.BuildQueueSelectionChanged();Astriarch.PlanetView.BuildQueueListBox.refresh()}},removeSelectedItemFromQueue:function(){var a=Astriarch.PlanetView.BuildQueueListBox.SelectedItem,b=Astriarch.PlanetView.BuildQueueListBox.SelectedIndex;a!=null&&b!=null&&(a=a.ProductionItem.GetRefundAmount(),Astriarch.PlanetView.workingResources.GoldRemainder+=a.Gold,
Astriarch.PlanetView.workingResources.OreRemainder+=a.Ore,Astriarch.PlanetView.workingResources.IridiumRemainder+=a.Iridium,Astriarch.PlanetView.workingResources.AccumulateResourceRemainders(),Astriarch.PlanetView.workingBuildQueue.splice(b,1),Astriarch.PlanetView.BuildQueueListBox.removeAt(b),Astriarch.PlanetView.refreshItemsAvailableListBox(),Astriarch.PlanetView.refreshCurrentWorkingResourcesTextBoxes(),Astriarch.PlanetView.showOrHideDemolishImprovementButtons(),Astriarch.PlanetView.BuildQueueSelectionChanged(),
Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.REMOVE,planetId:Astriarch.PlanetView.planetMain.Id,data:b}}))},addSelectedItemToQueue:function(){var a=Astriarch.PlanetView.ItemsAvailableListBox.SelectedItem;if(a!=null){if(a instanceof Astriarch.PlanetView.AvailableImprovementListBoxItem){if(a.CanBuild)if(Astriarch.PlanetView.workingResources.GoldAmount>=a.AvailablePlanetImprovement.GoldCost&&
Astriarch.PlanetView.workingResources.IridiumAmount>=a.AvailablePlanetImprovement.IridiumCost&&Astriarch.PlanetView.workingResources.OreAmount>=a.AvailablePlanetImprovement.OreCost){Astriarch.PlanetView.workingResources.GoldAmount-=a.AvailablePlanetImprovement.GoldCost;Astriarch.PlanetView.workingResources.IridiumAmount-=a.AvailablePlanetImprovement.IridiumCost;Astriarch.PlanetView.workingResources.OreAmount-=a.AvailablePlanetImprovement.OreCost;var b=new Astriarch.Planet.PlanetImprovement(a.AvailablePlanetImprovement.Type);
Astriarch.PlanetView.workingBuildQueue.push(b);window.tour.enabled&&(window.tour.step==19&&Astriarch.PlanetView.workingBuildQueue.length==3&&Astriarch.PlanetView.workingBuildQueue[0].Type==Astriarch.Planet.PlanetImprovementType.Farm&&Astriarch.PlanetView.workingBuildQueue[1].Type==Astriarch.Planet.PlanetImprovementType.Farm&&Astriarch.PlanetView.workingBuildQueue[2].Type==Astriarch.Planet.PlanetImprovementType.Farm?window.tour.jqElm.joyride("nextTip"):window.tour.step==28&&Astriarch.PlanetView.workingBuildQueue.length==
2&&Astriarch.PlanetView.workingBuildQueue[0].Type==Astriarch.Planet.PlanetImprovementType.Mine&&Astriarch.PlanetView.workingBuildQueue[1].Type==Astriarch.Planet.PlanetImprovementType.Mine?window.tour.jqElm.joyride("nextTip"):window.tour.step==44&&Astriarch.PlanetView.workingBuildQueue.length==2&&Astriarch.PlanetView.workingBuildQueue[1].Type==Astriarch.Planet.PlanetImprovementType.Factory&&window.tour.jqElm.joyride("nextTip"));Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,
payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.ADD_IMPROVEMENT,planetId:Astriarch.PlanetView.planetMain.Id,data:a.AvailablePlanetImprovement.Type}})}else new Astriarch.Alert("Insufficient resources","Insufficient resources: (Gold/Ore/Iridium)\r\nRequires  ("+a.AvailablePlanetImprovement.GoldCost+" / "+a.AvailablePlanetImprovement.OreCost+" / "+a.AvailablePlanetImprovement.IridiumCost+")\r\nYou have ("+Astriarch.PlanetView.workingResources.GoldAmount+" / "+Astriarch.PlanetView.workingResources.OreAmount+
" / "+Astriarch.PlanetView.workingResources.IridiumAmount+")","Insufficient resources")}else a instanceof Astriarch.PlanetView.AvailableStarShipListBoxItem&&a.CanBuild&&(Astriarch.PlanetView.workingResources.GoldAmount>=a.AvailableStarShip.GoldCost&&Astriarch.PlanetView.workingResources.IridiumAmount>=a.AvailableStarShip.IridiumCost&&Astriarch.PlanetView.workingResources.OreAmount>=a.AvailableStarShip.OreCost?(Astriarch.PlanetView.workingResources.GoldAmount-=a.AvailableStarShip.GoldCost,Astriarch.PlanetView.workingResources.IridiumAmount-=
a.AvailableStarShip.IridiumCost,Astriarch.PlanetView.workingResources.OreAmount-=a.AvailableStarShip.OreCost,b=new Astriarch.Planet.StarShipInProduction(a.AvailableStarShip.Type),Astriarch.PlanetView.workingBuildQueue.push(b),window.tour.enabled&&Astriarch.PlanetView.workingBuildQueue.length==1&&Astriarch.PlanetView.workingBuildQueue[0].Type==Astriarch.Fleet.StarShipType.Scout&&window.tour.jqElm.joyride("resume"),Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_BUILD_QUEUE,
payload:{actionType:Astriarch.Shared.PLANET_BUILD_QUEUE_ACTION_TYPE.ADD_STARSHIP,planetId:Astriarch.PlanetView.planetMain.Id,data:a.AvailableStarShip.Type}})):new Astriarch.Alert("Insufficient resources","Insufficient resources: (Gold/Ore/Iridium)\r\nRequires  ("+a.AvailableStarShip.GoldCost+" / "+a.AvailableStarShip.OreCost+" / "+a.AvailableStarShip.IridiumCost+")\r\nYou have ("+Astriarch.PlanetView.workingResources.GoldAmount+" / "+Astriarch.PlanetView.workingResources.OreAmount+" / "+Astriarch.PlanetView.workingResources.IridiumAmount+
")","Insufficient resources"));Astriarch.PlanetView.refreshItemsAvailableListBox();Astriarch.PlanetView.refreshBuildQueueListBox();Astriarch.PlanetView.refreshCurrentWorkingResourcesTextBoxes()}},OKClose:function(){window.tour.enabled&&(window.tour.step==21||window.tour.step==30||window.tour.step==34||window.tour.step==46)&&window.tour.jqElm.joyride("nextTip");var a=Astriarch.PlanetView;a.planetMain.UpdatePopulationWorkerTypes(a.farmers,a.miners,a.workers);a.planetMain.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats();
a.planetMain.BuildQueue=[];for(var b in a.workingBuildQueue)a.planetMain.BuildQueue.push(a.workingBuildQueue[b]);b=new Astriarch.Model.WorkingPlayerResources(a.planetMain.Owner);a.planetMain.SpendResources(Astriarch.ClientGameModel,b.GoldAmount-a.workingResources.GoldAmount,0,b.OreAmount-a.workingResources.OreAmount,b.IridiumAmount-a.workingResources.IridiumAmount,a.planetMain.Owner);a.planetMain.Owner.Resources.GoldRemainder=a.workingResources.GoldRemainder;a.planetMain.Owner.Resources.OreRemainder=
a.workingResources.OreRemainder;a.planetMain.Owner.Resources.IridiumRemainder=a.workingResources.IridiumRemainder;a.planetMain.Owner.Resources.AccumulateResourceRemainders();Astriarch.PlanetView.planetMain.BuildLastStarShip=!0;if(!$("#BuildLastShipCheckBox").attr("checked"))Astriarch.PlanetView.planetMain.BuildLastStarShip=!1;Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_FINISH,payload:{OkClose:!0,planetId:a.planetMain.Id,farmers:a.farmers,miners:a.miners,workers:a.workers,
BuildLastStarShip:Astriarch.PlanetView.planetMain.BuildLastStarShip}});Astriarch.View.updateSelectedItemPanelForPlanet();Astriarch.View.updatePlayerStatusPanel()},CancelClose:function(){var a=Astriarch.PlanetView;a.planetMain.UpdatePopulationWorkerTypes(a.farmersOrig,a.minersOrig,a.workersOrig);a.planetMain.ResourcesPerTurn.UpdateResourcesPerTurnBasedOnPlanetStats();Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.UPDATE_PLANET_FINISH,payload:{OkClose:!1,planetId:a.planetMain.Id}})},
Close:function(){Astriarch.PlanetView.dialog.dlg.dialog("close")}};Astriarch.PlanetView.BuildQueueListBoxItem=JSListBox.Item.extend({ProductionItem:null,init:function(a){this.ProductionItem=a},render:function(){var a=this.ProductionItem.ToString(),b="",b=" ("+this.ProductionItem.TurnsToComplete+")";a+=" "+this.ProductionItem.ProductionCostComplete+"/"+this.ProductionItem.BaseProductionCost+b;return'<a href="#">'+a+"</a>"},onClick:function(){Astriarch.PlanetView.BuildQueueSelectionChanged()}});
Astriarch.PlanetView.AvailableImprovementListBoxItem=JSListBox.Item.extend({Tooltip:"",AvailablePlanetImprovement:null,CanBuild:!0,CanBuildBasedOnResources:!0,Foreground:"white",init:function(a){this.Tooltip=Astriarch.GameTools.PlanetImprovementTypeToHelpText(a);this.AvailablePlanetImprovement=new Astriarch.Planet.PlanetImprovement(a)},render:function(){this.enabled=!1;if(this.CanBuild)if(this.CanBuildBasedOnResources){if(this.CanBuild)this.Foreground="white",this.enabled=!0}else this.Foreground=
"yellow";else this.Foreground="darkgray";var a=Astriarch.GameTools.PlanetImprovementTypeToFriendlyName(this.AvailablePlanetImprovement.Type);a+=" ("+this.AvailablePlanetImprovement.GoldCost+" / "+this.AvailablePlanetImprovement.OreCost+" / "+this.AvailablePlanetImprovement.IridiumCost+")";return this.enabled?'<a href="#" title="'+this.Tooltip+'" style="color:'+this.Foreground+'">'+a+"</a>":'<a style="color:'+this.Foreground+'">'+a+"</a>"},onClick:function(){Astriarch.PlanetView.ItemsAvailableSelectionChanged()},
onDblClick:function(){Astriarch.PlanetView.addSelectedItemToQueue()}});
Astriarch.PlanetView.AvailableStarShipListBoxItem=JSListBox.Item.extend({Tooltip:"",AvailableStarShip:null,CanBuild:!0,CanBuildBasedOnResources:!0,Foreground:"white",init:function(a){this.Tooltip=Astriarch.GameTools.StarShipTypeToHelpText(a);this.AvailableStarShip=new Astriarch.Planet.StarShipInProduction(a)},render:function(){this.enabled=!1;if(this.CanBuild)if(this.CanBuildBasedOnResources){if(this.CanBuild)this.Foreground="white",this.enabled=!0}else this.Foreground="yellow";else this.Foreground=
"darkgray";var a=Astriarch.GameTools.StarShipTypeToFriendlyName(this.AvailableStarShip.Type);a+=" ("+this.AvailableStarShip.GoldCost+" / "+this.AvailableStarShip.OreCost+" / "+this.AvailableStarShip.IridiumCost+")";return this.enabled?'<a href="#" title="'+this.Tooltip+'" style="color:'+this.Foreground+'">'+a+"</a>":'<a style="color:'+this.Foreground+'">'+a+"</a>"},onClick:function(){Astriarch.PlanetView.ItemsAvailableSelectionChanged()},onDblClick:function(){Astriarch.PlanetView.addSelectedItemToQueue()}});
Astriarch.PlanetView.SliderValueClicked={None:0,Farmers:1,Miners:2,Workers:3};Astriarch.SendShipsControl={dialog:null,pSource:null,pDest:null,distance:null,CreatedFleet:null,init:function(){$("#SliderScouts").slider({value:0,step:1,min:0,max:10,change:Astriarch.SendShipsControl.SliderScoutsValueChanged});$("#SliderDestroyers").slider({value:0,step:1,min:0,max:10,change:Astriarch.SendShipsControl.SliderDestroyersValueChanged});$("#SliderCruisers").slider({value:0,step:1,min:0,max:10,change:Astriarch.SendShipsControl.SliderCruisersValueChanged});$("#SliderBattleships").slider({value:0,
step:1,min:0,max:10,change:Astriarch.SendShipsControl.SliderBattleshipsValueChanged});$("#ButtonSendNoShips, #ButtonSendAllShips").button();$("#ButtonSendNoShips").click(function(){Astriarch.SendShipsControl.ButtonSendNoShipsClick()});$("#ButtonSendAllShips").click(function(){Astriarch.SendShipsControl.ButtonSendAllShipsClick()});Astriarch.SendShipsControl.dialog=new Astriarch.Dialog("#sendShipsDialog","Send Ships",380,330,Astriarch.SendShipsControl.OKClose,Astriarch.SendShipsControl.CancelClose)},
show:function(a,b,c){window.tour.enabled&&window.tour.step==56&&window.tour.jqElm.joyride("resume");Astriarch.SendShipsControl.CreatedFleet=null;Astriarch.SendShipsControl.pSource=a;Astriarch.SendShipsControl.pDest=b;Astriarch.SendShipsControl.distance=c;$("#SendShipsDialogStatus").text(c+" parsecs from "+a.Name+" to "+b.Name);c=a.PlanetaryFleet;$("#SliderScouts").slider("value",0);$("#SliderScouts").slider("option","max",c.StarShips[Astriarch.Fleet.StarShipType.Scout].length);$("#SliderScouts").slider("option",
"max")>0?$("#SliderScouts").slider("enable"):$("#SliderScouts").slider("disable");$("#SliderDestroyers").slider("value",0);$("#SliderDestroyers").slider("option","max",c.StarShips[Astriarch.Fleet.StarShipType.Destroyer].length);$("#SliderDestroyers").slider("option","max")>0?$("#SliderDestroyers").slider("enable"):$("#SliderDestroyers").slider("disable");$("#SliderCruisers").slider("value",0);$("#SliderCruisers").slider("option","max",c.StarShips[Astriarch.Fleet.StarShipType.Cruiser].length);$("#SliderCruisers").slider("option",
"max")>0?$("#SliderCruisers").slider("enable"):$("#SliderCruisers").slider("disable");$("#SliderBattleships").slider("value",0);$("#SliderBattleships").slider("option","max",c.StarShips[Astriarch.Fleet.StarShipType.Battleship].length);$("#SliderBattleships").slider("option","max")>0?$("#SliderBattleships").slider("enable"):$("#SliderBattleships").slider("disable");Astriarch.SendShipsControl.dialog.setTitle("Sending Ships from "+a.Name+" to "+b.Name);Astriarch.SendShipsControl.dialog.open()},ButtonSendAllShipsClick:function(){$("#SliderScouts").slider("value",
$("#SliderScouts").slider("option","max"));$("#SliderDestroyers").slider("value",$("#SliderDestroyers").slider("option","max"));$("#SliderCruisers").slider("value",$("#SliderCruisers").slider("option","max"));$("#SliderBattleships").slider("value",$("#SliderBattleships").slider("option","max"))},ButtonSendNoShipsClick:function(){$("#SliderScouts").slider("value",0);$("#SliderDestroyers").slider("value",0);$("#SliderCruisers").slider("value",0);$("#SliderBattleships").slider("value",0)},SliderBattleshipsValueChanged:function(a,
b){$("#TextBoxBattleships").text(b.value)},SliderCruisersValueChanged:function(a,b){$("#TextBoxCruisers").text(b.value)},SliderDestroyersValueChanged:function(a,b){$("#TextBoxDestroyers").text(b.value)},SliderScoutsValueChanged:function(a,b){$("#TextBoxScouts").text(b.value);window.tour.enabled&&window.tour.step==58&&b.value>0&&window.tour.jqElm.joyride("nextTip")},OKClose:function(){var a=Astriarch.SendShipsControl,b=a.pSource.PlanetaryFleet,c=parseInt($("#TextBoxScouts").text()),d=parseInt($("#TextBoxDestroyers").text()),
e=parseInt($("#TextBoxCruisers").text()),g=parseInt($("#TextBoxBattleships").text());c!=0||d!=0||e!=0||g!=0?(a.CreatedFleet=b.SplitFleet(c,d,e,g),a.CreatedFleet.CreateDrawnFleetAndSetDestination(Astriarch.ClientGameModel.GameGrid,a.pSource.BoundingHex,a.pDest.BoundingHex),a.pSource.OutgoingFleets.push(a.CreatedFleet),Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.SEND_SHIPS,payload:{planetIdSource:a.pSource.Id,planetIdDest:a.pDest.Id,data:{scouts:c,destroyers:d,cruisers:e,battleships:g}}})):
a.CreatedFleet=null;Astriarch.View.SendShipsDialogWindowClosed(!0);window.tour.enabled&&window.tour.step==59&&window.tour.jqElm.joyride("nextTip")},CancelClose:function(){Astriarch.View.SendShipsDialogWindowClosed(!1)},Close:function(){Astriarch.SendShipsControl.dialog.dlg.dialog("close")}};Astriarch.PlanetaryConflictControl={dialog:null,planetaryConflictMessage:null,init:function(){Astriarch.PlanetaryConflictControl.dialog=new Astriarch.Dialog("#planetaryConflictDialog","Planetary Conflict",424,323,Astriarch.PlanetaryConflictControl.OKClose,Astriarch.PlanetaryConflictControl.CancelClose);$("#NeverShowPlanetaryConflictPopupsCheckbox").change(function(){window.tour.enabled&&window.tour.step==61&&this.checked&&window.tour.jqElm.joyride("nextTip")})},show:function(a){window.tour.enabled&&
window.tour.step==59&&window.tour.jqElm.joyride("resume");Astriarch.PlanetaryConflictControl.planetaryConflictMessage=a;var b="";b+=a.Message+"<br />";var c="";if(a.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetCaptured||a.Type==Astriarch.TurnEventMessage.TurnEventMessageType.PlanetLost)if(c="No Resources Looted.",a.Data.FoodAmountLooted!=0||a.Data.GoldAmountLooted!=0||a.Data.OreAmountLooted!=0||a.Data.IridiumAmountLooted!=0)c="",c+=a.Data.FoodAmountLooted!=0?a.Data.FoodAmountLooted+
" Food":"",c+=a.Data.GoldAmountLooted!=0?(c?", ":"")+a.Data.GoldAmountLooted+" Gold":"",c+=a.Data.OreAmountLooted!=0?(c?", ":"")+a.Data.OreAmountLooted+" Ore":"",c+=a.Data.IridiumAmountLooted!=0?(c?", ":"")+a.Data.IridiumAmountLooted+" Iridium":"",c="Resources looted: "+c;b+=c+"<br />";c=a.Data.AttackingFleet.DetermineFleetStrength();b+="Attacking Fleet (strength "+c+", Chance to Win: "+a.Data.AttackingFleetChances+"%): <br />";b+=a.Data.AttackingFleet.ToString()+"<br /><br />";c=a.Data.DefendingFleet.DetermineFleetStrength();
b+="Defending Fleet (strength "+c+"): <br />";b+=a.Data.DefendingFleet.ToString()+"<br /><br />";b+="Ships Remaining: <br />";b+=a.Data.WinningFleet.ToString()+"<br />";Astriarch.PlayerGameOptions.ShowPlanetaryConflictPopups?$("#NeverShowPlanetaryConflictPopupsCheckbox").prop("checked",!1):$("#NeverShowPlanetaryConflictPopupsCheckbox").prop("checked",!0);$("#PlanetaryConflictSummary").html(b);b=a.Data.AttackingPlayer.Name;c=Astriarch.GameTools.PlanetOwnerToFriendlyName(a.Planet.Type,a.Data.DefendingPlayer);
Astriarch.PlanetaryConflictControl.dialog.setTitle(b+" Attacked "+c+" at Planet: "+a.Planet.Name);Astriarch.PlanetaryConflictControl.dialog.open()},OKClose:function(){Astriarch.PlayerGameOptions.ShowPlanetaryConflictPopups=!0;if($("#NeverShowPlanetaryConflictPopupsCheckbox").attr("checked"))Astriarch.PlayerGameOptions.ShowPlanetaryConflictPopups=!1;setTimeout(function(){Astriarch.GameController.processNextEndOfTurnPlanetaryConflictMessage()},100);window.tour.enabled&&window.tour.step==62&&window.tour.jqElm.joyride("nextTip")},
CancelClose:function(){setTimeout(function(){Astriarch.GameController.processNextEndOfTurnPlanetaryConflictMessage()},100)}};Astriarch.GameOverControl={dialog:null,winningSerializablePlayer:null,init:function(){Astriarch.GameOverControl.dialog=new Astriarch.Dialog("#gameOverDialog","Game Over",424,313,Astriarch.GameOverControl.OKClose,Astriarch.GameOverControl.CancelClose)},show:function(a,b,c){Astriarch.GameOverControl.winningSerializablePlayer=a;var d="";d+=b?"You conquered all of your enemies and reign supreme over the known universe!<br />You will be known as the first Astriarch - Ruler of the Stars.<br />":"You lost control over all your fleets and planets and have been crushed by the power of your enemies!<br />";
d+="In "+Astriarch.ClientGameModel.Turn.Number+" turns.<br />";a?(d+=a.Name+" won the game with "+a.OwnedPlanetIds.length+" planets.<br />",Astriarch.GameOverControl.dialog.setTitle("Game Over, Player: "+a.Name+" Wins!")):(d+="Other Players are still battling it out to earn the title of Astriarch.<br />",Astriarch.GameOverControl.dialog.setTitle("Game Over, Other Players Still Fighting!"));d+="<br />Your points: "+c;AstriarchExtern.OnGameOver({PlayerWon:b,Turns:Astriarch.ClientGameModel.Turn.Number,
Score:c});$("#GameOverSummary").html(d);Astriarch.GameOverControl.dialog.open()},OKClose:function(){Astriarch.GameController.GameOverControlClosed()},CancelClose:function(){Astriarch.GameController.GameOverControlClosed()}};Astriarch.Alert=function(a,b){$("#AstriarchAlertBox").html(b);this.dlg=$("#AstriarchAlertBox").dialog({autoOpen:!0,title:a,width:200,height:100,modal:!0})};Astriarch.TradingControl={dialog:null,planet:null,tradesSubmittedListBox:null,playerResourceAmountsAfterTrades:{food:0,ore:0,iridium:0},jqElm:{tradeResourceAmount:null,tradeResourceEstimatedPrice:null},init:function(){Astriarch.TradingControl.jqElm.tradeResourceAmount=$("#TradeResourceAmount");Astriarch.TradingControl.jqElm.tradeResourceEstimatedPrice=$("#TradeResourceEstimatedPrice");Astriarch.TradingControl.jqElm.buttonSubmitTrade=$("#ButtonSubmitTrade");$("#SliderTradeResourceAmount").slider({value:0,
step:1,min:0,max:10,slide:Astriarch.TradingControl.SliderTradeResourceAmountValueChanged});$("#ButtonTradesSubmittedRetractSelectedTrade").button({icons:{primary:"icon-16x16-build-queue-remove"},text:!1});$("#ButtonTradesSubmittedRetractSelectedTrade").button("disable");$("#ButtonTradesSubmittedRetractSelectedTrade").click(function(){Astriarch.TradingControl.ButtonRetractSelectedTradeClick()});$("#TradeTypeRadio").buttonset();$("#TradeResourceRadioFood").button({icons:{primary:"icon-16x16-food"}});
$("#TradeResourceRadioOre").button({icons:{primary:"icon-16x16-ore"}});$("#TradeResourceRadioIridium").button({icons:{primary:"icon-16x16-iridium"}});$("#TradeResourceRadio").buttonset();Astriarch.TradingControl.jqElm.buttonSubmitTrade.button();Astriarch.TradingControl.jqElm.buttonSubmitTrade.button("disable");Astriarch.TradingControl.jqElm.buttonSubmitTrade.click(function(){window.tour.enabled&&window.tour.step==38&&window.tour.jqElm.joyride("nextTip");Astriarch.TradingControl.ButtonSubmitTradeClick()});
$("input[name=TradeTypeRadioGroup]:radio").change(function(){Astriarch.TradingControl.setSliderPropertiesBasedOnNewTradeOptions()});$("input[name=TradeResourceRadioGroup]:radio").change(function(){Astriarch.TradingControl.setSliderPropertiesBasedOnNewTradeOptions()});Astriarch.TradingControl.tradesSubmittedListBox=new JSListBox({containerSelector:"TradesSubmittedListBox"});Astriarch.TradingControl.dialog=new Astriarch.Dialog("#tradingControlDialog","Galactic Trading Center",470,425,Astriarch.TradingControl.OKClose,
Astriarch.TradingControl.CancelClose)},show:function(a){Astriarch.TradingControl.planet=a;Astriarch.TradingControl.dialog.setTitle("Galactic Trading Center, Trading from: "+a.Name);Astriarch.TradingControl.dialog.open();this.refreshTradesSubmittedListBox();this.setSliderPropertiesBasedOnNewTradeOptions()},refreshStatsFromClientTradingCenter:function(){var a=Astriarch.ClientGameModel.ClientTradingCenter;$("#tcdStockpilePriceFood").text(a.foodResource.currentPrice.toFixed(2));$("#tcdTradingCenterAmtFood").text(a.foodResource.amount);
$("#tcdStockpileAmtFood").text(this.playerResourceAmountsAfterTrades.food);$("#tcdStockpilePriceOre").text(a.oreResource.currentPrice.toFixed(2));$("#tcdTradingCenterAmtOre").text(a.oreResource.amount);$("#tcdStockpileAmtOre").text(this.playerResourceAmountsAfterTrades.ore);$("#tcdStockpilePriceIridium").text(a.iridiumResource.currentPrice.toFixed(2));$("#tcdTradingCenterAmtIridium").text(a.iridiumResource.amount);$("#tcdStockpileAmtIridium").text(this.playerResourceAmountsAfterTrades.iridium)},refreshTradesSubmittedListBox:function(){Astriarch.TradingControl.setPlayerResourceAmountAfterCurrentTrades();
Astriarch.TradingControl.tradesSubmittedListBox.clear();for(var a in Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades){var b=new Astriarch.TradingControl.TradeListBoxItem(Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades[a]);Astriarch.TradingControl.tradesSubmittedListBox.addItem(b)}},setSliderPropertiesBasedOnNewTradeOptions:function(){var a=this.getSubmitTradeRadioButtonOptions(),b=0,b=Astriarch.ClientGameModel.ClientTradingCenter,b=a.tradeType==Astriarch.TradingCenter.TradeType.BUY?
a.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?b.foodResource.amount:a.resourceType==Astriarch.TradingCenter.ResourceType.ORE?b.oreResource.amount:b.iridiumResource.amount:a.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?this.playerResourceAmountsAfterTrades.food:a.resourceType==Astriarch.TradingCenter.ResourceType.ORE?this.playerResourceAmountsAfterTrades.ore:this.playerResourceAmountsAfterTrades.iridium;this.jqElm.tradeResourceAmount.text(0);this.jqElm.tradeResourceEstimatedPrice.text(0);
Astriarch.TradingControl.jqElm.buttonSubmitTrade.button("disable");$("#SliderTradeResourceAmount").slider("value",0);$("#SliderTradeResourceAmount").slider("option","max",b)},setPlayerResourceAmountAfterCurrentTrades:function(){var a=Astriarch.ClientGameModel.MainPlayer;this.playerResourceAmountsAfterTrades={food:a.TotalFoodAmount(),ore:a.TotalOreAmount(),iridium:a.TotalIridiumAmount()};for(var b in Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades){var a=Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades[b],
c=a.tradeType==Astriarch.TradingCenter.TradeType.BUY?a.amount:-1*a.amount;a.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?this.playerResourceAmountsAfterTrades.food+=c:a.resourceType==Astriarch.TradingCenter.ResourceType.ORE?this.playerResourceAmountsAfterTrades.ore+=c:this.playerResourceAmountsAfterTrades.iridium+=c}this.refreshStatsFromClientTradingCenter()},SliderTradeResourceAmountValueChanged:function(a,b){var c=b.value;Astriarch.TradingControl.jqElm.tradeResourceAmount.text(c);c==
0?Astriarch.TradingControl.jqElm.buttonSubmitTrade.button("disable"):Astriarch.TradingControl.jqElm.buttonSubmitTrade.button("enable");var d=0,d=Astriarch.TradingControl.getSubmitTradeRadioButtonOptions(),e=Astriarch.ClientGameModel.ClientTradingCenter,d=d.resourceType==Astriarch.TradingCenter.ResourceType.FOOD?e.foodResource.currentPrice*c:d.resourceType==Astriarch.TradingCenter.ResourceType.ORE?e.oreResource.currentPrice*c:e.iridiumResource.currentPrice*c;Astriarch.TradingControl.jqElm.tradeResourceEstimatedPrice.text(d.toFixed(2))},
ButtonSubmitTradeClick:function(){var a=this.getSubmitTradeRadioButtonOptions(),b=parseInt(this.jqElm.tradeResourceAmount.text()),a=new Astriarch.TradingCenter.Trade(-1,this.planet.Id,a.tradeType,a.resourceType,b,Astriarch.TradingCenter.OrderType.MARKET,null);Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.SUBMIT_TRADE,payload:{trade:a}});Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades.push(a);this.refreshTradesSubmittedListBox()},ButtonRetractSelectedTradeClick:function(){var a=
Astriarch.TradingControl.tradesSubmittedListBox.SelectedIndex;Astriarch.TradingControl.tradesSubmittedListBox.SelectedItem!=null&&a!=null&&(Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CANCEL_TRADE,payload:{tradeIndex:a,planetId:this.planet.Id}}),Astriarch.ClientGameModel.ClientTradingCenter.clientPlayerTrades.splice(a,1),this.refreshTradesSubmittedListBox())},getSubmitTradeRadioButtonOptions:function(){var a={tradeType:null,resourceType:null};a.tradeType=$("input:radio[name=TradeTypeRadioGroup]:checked").val();
a.tradeType=a.tradeType=="buy"?Astriarch.TradingCenter.TradeType.BUY:Astriarch.TradingCenter.TradeType.SELL;a.resourceType=$("input:radio[name=TradeResourceRadioGroup]:checked").val();a.resourceType=a.resourceType=="food"?Astriarch.TradingCenter.ResourceType.FOOD:a.resourceType=="ore"?Astriarch.TradingCenter.ResourceType.ORE:Astriarch.TradingCenter.ResourceType.IRIDIUM;return a},TradesSubmittedSelectionChanged:function(){$("#ButtonTradesSubmittedRetractSelectedTrade").button("disable");Astriarch.TradingControl.tradesSubmittedListBox.SelectedItem!=
null&&$("#ButtonTradesSubmittedRetractSelectedTrade").button("enable")},OKClose:function(){window.tour.enabled&&window.tour.step==39&&window.tour.jqElm.joyride("nextTip")},CancelClose:function(){},Close:function(){Astriarch.TradingControl.dialog.dlg.dialog("close")}};Astriarch.TradingControl.TradeListBoxItem=JSListBox.Item.extend({Trade:null,init:function(a){this.Trade=a},render:function(){return'<a href="#">'+Astriarch.TradingCenter.TradeToString(this.Trade)+"</a>"},onClick:function(){Astriarch.TradingControl.TradesSubmittedSelectionChanged()}});Astriarch=Astriarch||require("./astriarch_base");Astriarch.LocalStorageInterface={Prefs:{gameName:"New Game",playerName:"Player"},Key:"astriarch_prefs"};Astriarch.LocalStorageInterface.savePrefs=function(){if(localStorage){var a=JSON.stringify(Astriarch.LocalStorageInterface.Prefs);a!=null&&localStorage.setItem(Astriarch.LocalStorageInterface.Key,a)}};
Astriarch.LocalStorageInterface.loadPrefs=function(){var a=Astriarch.LocalStorageInterface.Prefs;if(localStorage){var b=localStorage.getItem(Astriarch.LocalStorageInterface.Key);if(b!=null)try{var c=JSON.parse(b);if(c)Astriarch.LocalStorageInterface.Prefs=c}catch(d){}}return a};Astriarch.LocalStorageInterface.loadPrefs();var Astriarch=Astriarch||require("./astriarch_base"),require=require||function(){},extend=typeof jQuery!="undefined"?jQuery.extend:require("extend");Astriarch.SavedGameInterface={};Astriarch.SavedGameInterface.findCircularReferences=function(a,b,c,d){d||(d=[]);if(!(a==null||typeof a!="object"))for(var e in d.indexOf(a)==-1?d.push(a):alert("found circular reference: "+c+"."+b),a)Astriarch.SavedGameInterface.findCircularReferences(a[e],e,b,d)};
Astriarch.SavedGameInterface.getModelFromSerializableModel=function(a){var b=[],c=new Astriarch.Model(b,{systemsToGenerate:a.SystemsToGenerate,planetsPerSystem:a.PlanetsPerSystem,distributePlanetsEvenly:a.DistributePlanetsEvenly,turnTimeLimitSeconds:a.TurnTimeLimitSeconds},!0);c.ShowUnexploredPlanetsAndEnemyPlayerStats=a.ShowUnexploredPlanetsAndEnemyPlayerStats;c.Turn=extend(!0,c.Turn,a.Turn);c.TradingCenter=new Astriarch.TradingCenter;c.TradingCenter.goldAmount=a.TradingCenter.goldAmount;c.TradingCenter.currentTrades=
a.TradingCenter.currentTrades;c.TradingCenter.foodResource=Astriarch.SavedGameInterface.getTradingCenterResourceFromSerializableTradingCenterResource(a.TradingCenter.foodResource);c.TradingCenter.oreResource=Astriarch.SavedGameInterface.getTradingCenterResourceFromSerializableTradingCenterResource(a.TradingCenter.oreResource);c.TradingCenter.iridiumResource=Astriarch.SavedGameInterface.getTradingCenterResourceFromSerializableTradingCenterResource(a.TradingCenter.iridiumResource);var d=[],e={},g;for(g in a.SerializablePlanets){var f=
a.SerializablePlanets[g],h=Astriarch.SavedGameInterface.getPlanetFromSerializedPlanet(f,c.GameGrid);d.push(h);e[h.Id]=h}for(g in a.SerializablePlayers)b.push(Astriarch.SavedGameInterface.getPlayerFromSerializedPlayer(c.GameGrid,a.SerializablePlayers[g],e));var i={},j={};for(g in b)f=b[g],i[f.Id]=f,j[f.Id]=new Astriarch.ClientPlayer(f.Id,f.Type,f.Name,f.Color,f.Points);for(g in a.SerializablePlayersDestroyed)f=a.SerializablePlayersDestroyed[g],f=Astriarch.SavedGameInterface.getPlayerFromSerializedPlayer(c.GameGrid,
f,e),c.PlayersDestroyed.push(f),i[f.Id]=f,j[f.Id]=new Astriarch.ClientPlayer(f.Id,f.Type,f.Name,f.Color,f.Points);for(g in a.SerializablePlayers)f=a.SerializablePlayers[g],h=i[f.Id],Astriarch.SavedGameInterface.setPlayerLastKnownPlanetFleetStrength(h,f,c.GameGrid,j);c.Planets=d;return c};Astriarch.SavedGameInterface.getTradingCenterResourceFromSerializableTradingCenterResource=function(a){return new Astriarch.TradingCenter.Resource(a.type,a.amount,a.desiredAmount,a.priceMin,a.priceMax)};
Astriarch.SavedGameInterface.setPlayerLastKnownPlanetFleetStrength=function(a,b,c,d){for(var e in b.LastKnownPlanetSerializableFleetStrength){var g=b.LastKnownPlanetSerializableFleetStrength[e],f=null;g.LastKnownOwnerId&&(f=d[g.LastKnownOwnerId]);var h=Astriarch.SavedGameInterface.getFleetFromSerializableFleet(f,g.SerializableFleet,c),f=new Astriarch.Fleet.LastKnownFleet(h,f);f.TurnLastExplored=g.TurnLastExplored;a.LastKnownPlanetFleetStrength[e]=f}};
Astriarch.SavedGameInterface.getPlanetFromSerializedPlanet=function(a,b){var c=b.GetHexAt(a.OriginPoint),c=new Astriarch.Planet(a.Type,a.Name,c,null);c.Id=a.Id;c.Population=a.Population;c.RemainderProduction=a.RemainderProduction;for(var d in a.BuildQueue){var e=a.BuildQueue[d];e&&(e=Astriarch.SavedGameInterface.getPlanetProductionItemFromSerializedPlanetProductionItem(e),c.BuildQueue.push(e))}c.BuiltImprovements=a.BuiltImprovements;c.MaxImprovements=a.MaxImprovements;c.Resources=extend(!0,c.Resources,
a.Resources);c.OriginPoint=a.OriginPoint;c.PlanetaryFleet=Astriarch.SavedGameInterface.getFleetFromSerializableFleet(null,a.PlanetarySerializableFleet,b);for(d in a.OutgoingSerializableFleets)c.OutgoingFleets.push(Astriarch.SavedGameInterface.getFleetFromSerializableFleet(null,a.OutgoingSerializableFleets[d],b));c.PlanetHappiness=a.PlanetHappiness;c.StarShipTypeLastBuilt=a.StarShipTypeLastBuilt;c.BuildLastStarShip=a.BuildLastStarShip;c.ResourcesPerTurn=new Astriarch.Planet.PlanetPerTurnResourceGeneration(c,
c.Type);c.maxPopulation=c.MaxImprovements;return c};
Astriarch.SavedGameInterface.getPlayerFromSerializedPlayer=function(a,b,c,d){var e=new Astriarch.Player(b.Type,b.Name);e.Id=b.Id;e.Resources=extend(!0,e.Resources,b.Resources);b.Color=extend(!0,new Astriarch.Util.ColorRGBA(0,0,0,0),b.Color);e.Type==Astriarch.Player.PlayerType.Human?e.Color=b.Color:e.SetColor(b.Color);e.LastTurnFoodNeededToBeShipped=b.LastTurnFoodNeededToBeShipped;e.Options=b.Options;for(var g in b.OwnedPlanetIds){var f=c[b.OwnedPlanetIds[g]];f.SetPlanetOwner(e);f.PlanetaryFleet.Owner=
e;for(var h in f.OutgoingFleets)f.OutgoingFleets[h].Owner=e}for(g in b.KnownPlanetIds)f=b.KnownPlanetIds[g],e.KnownClientPlanets[f]=f in c?c[f].GetClientPlanet():d[f];for(g in b.PlanetBuildGoals)if(d=b.PlanetBuildGoals[g])d=Astriarch.SavedGameInterface.getPlanetProductionItemFromSerializedPlanetProductionItem(d),e.PlanetBuildGoals[g]=d;e.HomePlanet=null;if(b.HomePlanetId)e.HomePlanet=c[b.HomePlanetId];e.Points=b.Points;for(g in b.SerializableFleetsInTransit)e.FleetsInTransit.push(Astriarch.SavedGameInterface.getFleetFromSerializableFleet(e,
b.SerializableFleetsInTransit[g],a));return e};
Astriarch.SavedGameInterface.getPlanetProductionItemFromSerializedPlanetProductionItem=function(a){var b=null;a.PlanetProductionItemType==Astriarch.Planet.PlanetProductionItemType.PlanetImprovement?b=new Astriarch.Planet.PlanetImprovement(a.Type):a.PlanetProductionItemType==Astriarch.Planet.PlanetProductionItemType.StarShipInProduction?b=new Astriarch.Planet.StarShipInProduction(a.Type):a.PlanetProductionItemType==Astriarch.Planet.PlanetProductionItemType.PlanetImprovementToDestroy&&(b=new Astriarch.Planet.PlanetImprovementToDestroy(a.Type));
return extend(!0,b,a)};
Astriarch.SavedGameInterface.getFleetFromSerializableFleet=function(a,b,c){a=new Astriarch.Fleet(a);a.HasSpacePlatform=b.HasSpacePlatform;a.SpacePlatformDamage=b.SpacePlatformDamage;for(var d in b.StarShips[Astriarch.Fleet.StarShipType.SystemDefense]){var e=extend(!0,new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.SystemDefense),b.StarShips[Astriarch.Fleet.StarShipType.SystemDefense][d]);a.StarShips[Astriarch.Fleet.StarShipType.SystemDefense].push(e)}for(d in b.StarShips[Astriarch.Fleet.StarShipType.Scout])e=extend(!0,
new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Scout),b.StarShips[Astriarch.Fleet.StarShipType.Scout][d]),a.StarShips[Astriarch.Fleet.StarShipType.Scout].push(e);for(d in b.StarShips[Astriarch.Fleet.StarShipType.Destroyer])e=extend(!0,new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Destroyer),b.StarShips[Astriarch.Fleet.StarShipType.Destroyer][d]),a.StarShips[Astriarch.Fleet.StarShipType.Destroyer].push(e);for(d in b.StarShips[Astriarch.Fleet.StarShipType.Cruiser])e=extend(!0,
new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Cruiser),b.StarShips[Astriarch.Fleet.StarShipType.Cruiser][d]),a.StarShips[Astriarch.Fleet.StarShipType.Cruiser].push(e);for(d in b.StarShips[Astriarch.Fleet.StarShipType.Battleship])e=extend(!0,new Astriarch.Fleet.StarShip(Astriarch.Fleet.StarShipType.Battleship),b.StarShips[Astriarch.Fleet.StarShipType.Battleship][d]),a.StarShips[Astriarch.Fleet.StarShipType.Battleship].push(e);a.LocationHex=null;if(b.LocationHexMidPoint)a.LocationHex=c.GetHexAt(b.LocationHexMidPoint);
if(b.travelingFromHexMidPoint){d=c.GetHexAt(b.travelingFromHexMidPoint);var e=c.GetHexAt(b.DestinationHexMidPoint),g=c.GetHexDistance(d,e);a.SetDestination(c,d,e,b.TurnsToDestination,g)}return a};
Astriarch.SerializableModel=function(a){this.ShowUnexploredPlanetsAndEnemyPlayerStats=a.ShowUnexploredPlanetsAndEnemyPlayerStats;this.SystemsToGenerate=a.SystemsToGenerate;this.PlanetsPerSystem=a.PlanetsPerSystem;this.DistributePlanetsEvenly=a.DistributePlanetsEvenly;this.TurnTimeLimitSeconds=a.TurnTimeLimitSeconds;this.Turn=a.Turn;this.TradingCenter=a.TradingCenter;this.SerializablePlayers=[];for(var b in a.Players)this.SerializablePlayers.push(new Astriarch.SerializablePlayer(a.Players[b]));this.SerializablePlayersDestroyed=
[];for(b in a.PlayersDestroyed)this.SerializablePlayersDestroyed.push(new Astriarch.SerializablePlayer(a.PlayersDestroyed[b]));this.SerializablePlanets=[];for(b in a.Planets)this.SerializablePlanets.push(new Astriarch.SerializablePlanet(a.Planets[b]));this.Version=Astriarch.Version};
Astriarch.SerializablePlayer=function(a){this.Id=a.Id;this.Type=a.Type;this.Name=a.Name;this.Resources=a.Resources;this.Color=a.Color;this.LastTurnFoodNeededToBeShipped=a.LastTurnFoodNeededToBeShipped;this.Options=a.Options;this.OwnedPlanetIds=[];for(var b in a.OwnedPlanets)this.OwnedPlanetIds.push(a.OwnedPlanets[b].Id);this.KnownPlanetIds=[];for(b in a.KnownClientPlanets)this.KnownPlanetIds.push(a.KnownClientPlanets[b].Id);this.LastKnownPlanetSerializableFleetStrength={};for(b in a.LastKnownPlanetFleetStrength)this.LastKnownPlanetSerializableFleetStrength[b]=
new Astriarch.Fleet.SerializableLastKnownFleet(a.LastKnownPlanetFleetStrength[b]);this.PlanetBuildGoals=a.PlanetBuildGoals;for(b in this.PlanetBuildGoals)Astriarch.SavedGameInterface.makePlanetProductionItemSerializable(this.PlanetBuildGoals[b]);this.HomePlanetId=null;if(a.HomePlanet)this.HomePlanetId=a.HomePlanet.Id;this.Points=a.Points;this.SerializableFleetsInTransit=[];for(b in a.FleetsInTransit)this.SerializableFleetsInTransit.push(new Astriarch.SerializableFleet(a.FleetsInTransit[b],this.Type==
Astriarch.Player.PlayerType.Human))};Astriarch.SerializableFleet=function(a){this.StarShips=a.StarShips;this.HasSpacePlatform=a.HasSpacePlatform;this.SpacePlatformDamage=a.SpacePlatformDamage;this.LocationHexMidPoint=null;if(a.LocationHex)this.LocationHexMidPoint=a.LocationHex.MidPoint;if(a.travelingFromHex&&a.DestinationHex)this.travelingFromHexMidPoint=a.travelingFromHex.MidPoint,this.DestinationHexMidPoint=a.DestinationHex.MidPoint,this.TurnsToDestination=a.TurnsToDestination};
Astriarch.Fleet.SerializableLastKnownFleet=function(a){this.TurnLastExplored=a.TurnLastExplored;this.SerializableFleet=new Astriarch.SerializableFleet(a.Fleet,!1);if(a.LastKnownOwner)this.LastKnownOwnerId=a.LastKnownOwner.Id};
Astriarch.SerializablePlanet=function(a){this.Id=a.Id;this.Name=a.Name;this.Type=a.Type;this.Population=a.Population;this.RemainderProduction=a.RemainderProduction;this.BuildQueue=a.BuildQueue;for(var b in this.BuildQueue)Astriarch.SavedGameInterface.makePlanetProductionItemSerializable(this.BuildQueue[b]);this.BuiltImprovements=a.BuiltImprovements;this.MaxImprovements=a.MaxImprovements;this.Resources=a.Resources;this.OriginPoint=a.OriginPoint;this.PlanetarySerializableFleet=new Astriarch.SerializableFleet(a.PlanetaryFleet,
!1);this.OutgoingSerializableFleets=[];for(b in a.OutgoingFleets)this.OutgoingSerializableFleets.push(new Astriarch.SerializableFleet(a.OutgoingFleets[b],a.Owner.Type==Astriarch.Player.PlayerType.Human));this.PlanetHappiness=a.PlanetHappiness;this.BuiltImprovements=a.BuiltImprovements;this.StarShipTypeLastBuilt=a.StarShipTypeLastBuilt;this.BuildLastStarShip=a.BuildLastStarShip};Astriarch.Planet.PlanetProductionItemType={Unknown:0,PlanetImprovement:1,StarShipInProduction:2,PlanetImprovementToDestroy:3};
Astriarch.SavedGameInterface.makePlanetProductionItemSerializable=function(a){a.PlanetProductionItemType=Astriarch.Planet.PlanetProductionItemType.Unknown;if(a instanceof Astriarch.Planet.PlanetImprovement)a.PlanetProductionItemType=Astriarch.Planet.PlanetProductionItemType.PlanetImprovement;else if(a instanceof Astriarch.Planet.StarShipInProduction)a.PlanetProductionItemType=Astriarch.Planet.PlanetProductionItemType.StarShipInProduction;else if(a instanceof Astriarch.Planet.PlanetImprovementToDestroy)a.PlanetProductionItemType=
Astriarch.Planet.PlanetProductionItemType.PlanetImprovementToDestroy;return a};Astriarch.CommControl={chatLog:null,chatRoomInfo:null,inputTextBox:null,playerNameTextBox:null,chatLogPlayerNameDiv:null,playerName:null,playerNumber:null,playerSessions:null,init:function(){this.chatLog=$("#chatLog");this.chatRoomInfo=$("#chatRoomInfo");this.inputTextBox=$("#chatInputTextBox");this.inputTextBox.keyup(function(a){a.keyCode==13&&Astriarch.CommControl.sendTextMessage()});this.playerNameTextBox=$("#chatPlayerNameTextBox");this.playerNameTextBox.keyup(function(a){a.keyCode==13&&Astriarch.CommControl.submitPlayerNameChange()});
this.playerNameTextBox.change(function(){Astriarch.CommControl.submitPlayerNameChange()});this.chatLogPlayerNameDiv=$("#chatLogPlayerName");this.chatLogPlayerNameDiv.text(Astriarch.LocalStorageInterface.Prefs.playerName);this.chatLogPlayerNameDiv.click(function(){Astriarch.CommControl.playerNumber||(Astriarch.CommControl.playerNameTextBox.val(Astriarch.LocalStorageInterface.Prefs.playerName),Astriarch.CommControl.chatLogPlayerNameDiv.hide(),Astriarch.CommControl.playerNameTextBox.show(),Astriarch.CommControl.playerNameTextBox.select())});
Astriarch.CommControl.joinChatRoom(Astriarch.LocalStorageInterface.Prefs.playerName,null);$("#chatArea").show()},submitPlayerNameChange:function(){Astriarch.CommControl.playerName=Astriarch.CommControl.playerNameTextBox.val();Astriarch.LocalStorageInterface.Prefs.playerName=Astriarch.CommControl.playerName;Astriarch.LocalStorageInterface.savePrefs();Astriarch.CommControl.joinChatRoom(Astriarch.CommControl.playerName,Astriarch.CommControl.playerNumber);Astriarch.CommControl.chatLogPlayerNameDiv.text(Astriarch.CommControl.playerName);
Astriarch.CommControl.playerNameTextBox.hide();Astriarch.CommControl.chatLogPlayerNameDiv.show()},sendTextMessage:function(){var a=this.inputTextBox.val();a&&a.trim()&&(this.inputTextBox.val(""),a={messageType:Astriarch.Shared.CHAT_MESSAGE_TYPE.TEXT_MESSAGE,text:a,sentByPlayerName:this.playerName,sentByPlayerNumber:this.playerNumber},Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CHAT_MESSAGE,payload:a}),this.appendMessages([a]))},joinChatRoom:function(a,b){this.playerName=
a;this.playerNumber=b;Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CHAT_MESSAGE,payload:{messageType:Astriarch.Shared.CHAT_MESSAGE_TYPE.PLAYER_ENTER,sentByPlayerName:a,sentByPlayerNumber:b}});this.chatLog.html("")},setPlayerSessions:function(a){Astriarch.CommControl.playerSessions=a;Astriarch.CommControl.refreshPlayerList()},refreshPlayerList:function(){var a="";if(Astriarch.GameId&&Astriarch.ClientGameModel&&Astriarch.ClientGameModel.ClientPlayers)for(var b=0;b<Astriarch.ClientGameModel.ClientPlayers.length;b++){var c=
Astriarch.ClientGameModel.ClientPlayers[b],d="messagePlayer"+(b+1);a+='<div class="'+d+'">'+c.Name+(c.Points!=null?" ("+Math.floor(c.Points)+")":"")+"</div>"}else for(b=0;b<Astriarch.CommControl.playerSessions.length;b++)c=Astriarch.CommControl.playerSessions[b],d=c.playerNumber?"messagePlayer"+c.playerNumber:"messagePlayerLobby",a+='<div class="'+d+'">'+c.playerName+"</div>";this.chatRoomInfo.html(a)},appendMessages:function(a){for(var b="",c=0;c<a.length;c++){var d=a[c],e=d.sentByPlayerNumber?"messagePlayer"+
d.sentByPlayerNumber:"messagePlayerLobby";b+=d.messageType==Astriarch.Shared.CHAT_MESSAGE_TYPE.TEXT_MESSAGE?'<div class="chatLogMessage"><span class="'+e+'">'+d.sentByPlayerName+": </span>"+d.text+"</div>":'<div class="chatLogMessage"><span class="messageSystem">'+d.sentByPlayerName+(d.messageType==Astriarch.Shared.CHAT_MESSAGE_TYPE.PLAYER_ENTER?" Arrived":d.messageType==Astriarch.Shared.CHAT_MESSAGE_TYPE.PLAYER_DISCONNECT?" Disconnected":" Left")+"</span></div>"}this.chatLog.append(b);this.chatLog.animate({scrollTop:this.chatLog[0].scrollHeight},
1E3)}};Astriarch.LobbyControl={GamesAvailableListBox:null,init:function(){$("#NewSkirmishGameButton").button();$("#NewSkirmishGameButton").click(function(){window.tour.enabled&&window.tour.jqElm.joyride("nextTip");Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CREATE_GAME,payload:{name:Astriarch.LocalStorageInterface.Prefs.gameName,playerName:Astriarch.LocalStorageInterface.Prefs.playerName}})});this.GamesAvailableListBox=new JSListBox({containerSelector:"GamesAvailableListBox",stylemap:{border:"none",
background:"none"}});$("#GameSelectedPanel").hide();$("#JoinGameButton").button();$("#JoinGameButton").button("disable");$("#JoinGameButton").click(function(){var a=Astriarch.LobbyControl.GamesAvailableListBox.SelectedItem;if(a)Astriarch.GameId=a.GameInfo._id,a.GameInfo.started?Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.RESUME_GAME}):Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.JOIN_GAME,payload:{playerName:Astriarch.LocalStorageInterface.Prefs.playerName}})})},
OnGameResumeMessageResponse:function(a){Astriarch.CommControl.joinChatRoom(Astriarch.LocalStorageInterface.Prefs.playerName,a.payload.playerPosition+1);$("#mainMenu").hide();Astriarch.GameController.ResetView(a.payload.gameData)},OnGameJoinMessageResponse:function(a){Astriarch.GameId=a.payload._id;a.payload.playerPosition?Astriarch.NewGameControl.joinGame(a):Astriarch.NewGameControl.newGame();$("#mainMenu").hide();Astriarch.View.ShowNewGameOptions()},OnGameCreateMessageResponse:function(a){Astriarch.GameId=
a.payload;Astriarch.NewGameControl.newGame();$("#mainMenu").hide();Astriarch.View.ShowNewGameOptions()},refreshGameList:function(a){Astriarch.LobbyControl.GamesAvailableListBox.clear();var b=[];if(a.payload&&a.payload.length)for(var c in a.payload){var d=new Astriarch.LobbyControl.GamesAvailableListBoxItem(a.payload[c]);b.push(d)}Astriarch.LobbyControl.GamesAvailableListBox.addItems(b)},updateGameList:function(a){for(var b=!1,c=0;c<Astriarch.LobbyControl.GamesAvailableListBox.items.length;c++){var d=
Astriarch.LobbyControl.GamesAvailableListBox.items[c];if(d.GameInfo._id==a.payload._id){d.GameInfo=a.payload;d.value=a.payload.name;Astriarch.LobbyControl.GamesAvailableListBox.refresh();b=!0;break}}b||Astriarch.LobbyControl.GamesAvailableListBox.addItem(new Astriarch.LobbyControl.GamesAvailableListBoxItem(a.payload))},GamesAvailableSelectionChanged:function(){if(Astriarch.LobbyControl.GamesAvailableListBox.SelectedItem){$("#JoinGameButton").button("enable");$("#GameSelectedPanel").show();var a=Astriarch.LobbyControl.GamesAvailableListBox.SelectedItem.GameInfo,
b=a.gameOptions;$("#GameSelectedName").text(a.name);$("#GameSelectedHostName").text("Host: "+b.mainPlayerName);$("#GameSelectedPlayerSummary").text(a.players.length+"/"+b.systemsToGenerate+" Players");$("#GameSelectedPlayer2Details").text(Astriarch.LobbyControl.GetOpponentSummaryText(b.opponentOptions[0]));$("#GameSelectedPlayer3Details").text(Astriarch.LobbyControl.GetOpponentSummaryText(b.opponentOptions[1]));$("#GameSelectedPlayer4Details").text(Astriarch.LobbyControl.GetOpponentSummaryText(b.opponentOptions[2]));
$("#GameSelectedNumberOfSystems").text(b.systemsToGenerate+" Systems");$("#GameSelectedPlanetsPerSystem").text(b.planetsPerSystem+" Planets per System");$("#GameSelectedDateCreated").text("Created At: "+(new Date(a.dateCreated)).toLocaleString());$("#GameSelectedDateLastPlayed").text("Last Played: "+(new Date(a.dateLastPlayed)).toLocaleString());a.started?$("#JoinGameButton").button("option","label","Resume Game"):$("#JoinGameButton").button("option","label","Join Game")}else $("#GameSelectedPanel").hide(),
$("#JoinGameButton").button("disable")},GetOpponentSummaryText:function(a){return Astriarch.GameTools.OpponentOptionToFriendlyString(a)}};Astriarch.LobbyControl.GamesAvailableListBoxItem=JSListBox.Item.extend({init:function(a){this.value=a.name;this.Foreground=null;this.GameInfo=a},render:function(){return'<a href="#" style="color:'+this.Foreground+'">'+this.value+"</a>"},onClick:function(){Astriarch.LobbyControl.GamesAvailableSelectionChanged()},onDblClick:function(){}});Astriarch.NewGameControl={GameCreator:!0,StarfieldCanvas:null,StarfieldCanvasContext:null,StarfieldCanvasSize:{w:200,h:170},init:function(){this.StarfieldCanvas=document.getElementById("newGameControlStarfieldCanvas");this.StarfieldCanvasContext=this.StarfieldCanvas.getContext("2d");$("#GameNameTextBox").val(Astriarch.LocalStorageInterface.Prefs.gameName);$("#GameNameTextBox").change(function(){var a=$("#GameNameTextBox").val();Astriarch.LocalStorageInterface.Prefs.gameName=a;Astriarch.LocalStorageInterface.savePrefs();
Astriarch.NewGameControl.changedGameOptions()});$("#PlayerNameTextBox").val(Astriarch.LocalStorageInterface.Prefs.playerName);$("#PlayerNameTextBox").change(function(){var a=$(this).val();Astriarch.LocalStorageInterface.Prefs.playerName=a;Astriarch.LocalStorageInterface.savePrefs();Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CHANGE_PLAYER_NAME,payload:{playerName:a}})});$("select#NumberOfSystemsComboBox").selectmenu({style:"popup",width:55,change:function(){Astriarch.NewGameControl.UpdateStartupOptionsBasedOnOpponentCount();
Astriarch.NewGameControl.changedGameOptions()}});$("select#PlanetsPerSystemComboBox").selectmenu({style:"popup",width:55,change:function(){Astriarch.NewGameControl.changedGameOptions()}});$("input#DistributePlanetsEvenlyCheckBox").change(function(){Astriarch.NewGameControl.changedGameOptions()});$("select#TurnTimeLimitComboBox").selectmenu({style:"popup",width:120,change:function(){Astriarch.NewGameControl.changedGameOptions()}});this.buildPlayerComboBoxes();$("#StartGameOptionsOkButton").button();
$("#StartGameOptionsOkButton").click(function(){window.tour.enabled&&window.tour.jqElm.joyride("nextTip");Astriarch.NewGameControl.SetupNewGame()});this.drawGameOptionsRepresentationOnCanvas(this.getSelectedGameOptions())},buildPlayerComboBoxes:function(a){$("#Player2OptionsBox").html('<select id="Player2ComboBox"><option value="-1" selected="">Open</option>'+(a&&a.opponentOptions[0].type==0?'<option value="0" disabled="disabled">Human</option>':"")+'<option value="1">Easy Computer</option><option value="2">Normal Computer</option><option value="3">Hard Computer</option><option value="4">Expert Computer</option></select>');
$("#Player3OptionsBox").html('<select id="Player3ComboBox"><option value="-2">Closed</option><option value="-1" selected="">Open</option>'+(a&&a.opponentOptions[1].type==0?'<option value="0" disabled="disabled">Human</option>':"")+'<option value="1">Easy Computer</option><option value="2">Normal Computer</option><option value="3">Hard Computer</option><option value="4">Expert Computer</option></select>');$("#Player4OptionsBox").html('<select id="Player4ComboBox"><option value="-2">Closed</option><option value="-1" selected="">Open</option>'+
(a&&a.opponentOptions[2].type==0?'<option value="0" disabled="disabled">Human</option>':"")+'<option value="1">Easy Computer</option><option value="2">Normal Computer</option><option value="3">Hard Computer</option><option value="4">Expert Computer</option></select>');$("select#Player2ComboBox").selectmenu({style:"popup",width:150,change:function(){Astriarch.NewGameControl.changedGameOptions()}});$("select#Player3ComboBox").selectmenu({style:"popup",width:150,change:function(){Astriarch.NewGameControl.changedGameOptions()}});
$("select#Player4ComboBox").selectmenu({style:"popup",width:150,change:function(){Astriarch.NewGameControl.changedGameOptions()}})},UpdateStartupOptionsBasedOnOpponentCount:function(){var a=Number($("select#NumberOfSystemsComboBox").selectmenu("value"));$(".Player3Panel").hide();$(".Player4Panel").hide();a>=3?$(".Player3Panel").show():$("select#Player3ComboBox").selectmenu("value","-2");a>=4?$(".Player4Panel").show():$("select#Player4ComboBox").selectmenu("value","-2")},newGame:function(){Astriarch.CommControl.joinChatRoom(Astriarch.LocalStorageInterface.Prefs.playerName,
1)},joinGame:function(a){Astriarch.NewGameControl.GameCreator=!1;$("#GameNameTextBox").parent().html('<span id="GameNameValue"></span>');$("select#NumberOfSystemsComboBox").parent().html('<span id="NumberOfSystemsValue"></span>');$("select#PlanetsPerSystemComboBox").parent().html('<span id="PlanetsPerSystemValue"></span>');$("input#DistributePlanetsEvenlyCheckBox").parent().html('<span id="DistributePlanetsEvenlyValue"></span>');$("select#TurnTimeLimitComboBox").parent().html('<span id="TurnTimeLimitValue"></span>');
$("select#Player2ComboBox").parent().html('<span id="Player2NamePanel"></span>');$("select#Player3ComboBox").parent().html('<span id="Player3NamePanel"></span>');$("select#Player4ComboBox").parent().html('<span id="Player4NamePanel"></span>');$("#StartGameOptionsOkButton").remove();Astriarch.NewGameControl.OnGameOptionsChanged(a);Astriarch.CommControl.joinChatRoom(Astriarch.LocalStorageInterface.Prefs.playerName,a.payload.playerPosition+1)},changedGameOptions:function(){var a=this.getSelectedGameOptions(),
b=$("#GameNameTextBox").val();this.drawGameOptionsRepresentationOnCanvas(a);Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.CHANGE_GAME_OPTIONS,payload:{gameOptions:a,name:b}});window.tour.enabled&&(a.systemsToGenerate==2&&window.tour.step==3||a.opponentOptions[0].type==1&&window.tour.step==4)&&window.tour.jqElm.joyride("nextTip")},OnGameOptionsChanged:function(a){var b=a.payload.gameOptions;this.drawGameOptionsRepresentationOnCanvas(b);if(Astriarch.NewGameControl.GameCreator){Astriarch.NewGameControl.buildPlayerComboBoxes(b);
for(a=0;a<b.opponentOptions.length;a++){var c=b.opponentOptions[a];c.type==0&&($("select#Player"+(a+2)+"ComboBox").selectmenu("value","0"),$("#Player"+(a+2)+"OptionsBox").hide(),$("#Player"+(a+2)+"NamePanel").text(c.name))}}else $("#GameNameValue").text(a.payload.name),$("#NumberOfSystemsValue").text(b.systemsToGenerate),$("#PlanetsPerSystemValue").text(b.planetsPerSystem),$("#DistributePlanetsEvenlyValue").text("Distribute Planets Evenly: "+b.distributePlanetsEvenly),a=b.turnTimeLimitSeconds/60,
$("#TurnTimeLimitValue").text("Turn Time Limit: "+(a==0?"None":a==1?"1 Minute":a+" Minutes")),$("#Player1NamePanel").text(b.mainPlayerName),$("#Player2NamePanel").text(Astriarch.GameTools.OpponentOptionToFriendlyString(b.opponentOptions[0])),$("#Player3NamePanel").text(Astriarch.GameTools.OpponentOptionToFriendlyString(b.opponentOptions[1])),$("#Player4NamePanel").text(Astriarch.GameTools.OpponentOptionToFriendlyString(b.opponentOptions[2]));c=[{playerName:b.mainPlayerName,playerNumber:1,dateJoined:new Date}];
for(a=0;a<b.opponentOptions.length;a++)b.opponentOptions[a].type>=0&&c.push({playerName:b.opponentOptions[a].name,playerNumber:a+2,dateJoined:new Date});Astriarch.CommControl.setPlayerSessions(c)},getSelectedGameOptions:function(){var a=[],b=$("#PlayerNameTextBox").val();if(b==null||$.trim(b)=="")b="Player";a.push({name:$("#Player2NamePanel").text(),type:Number($("select#Player2ComboBox").selectmenu("value"))});a.push({name:$("#Player3NamePanel").text(),type:Number($("select#Player3ComboBox").selectmenu("value"))});
a.push({name:$("#Player4NamePanel").text(),type:Number($("select#Player4ComboBox").selectmenu("value"))});var c=Number($("select#NumberOfSystemsComboBox").selectmenu("value")),d=Number($("select#PlanetsPerSystemComboBox").selectmenu("value")),e=!0;$("#DistributePlanetsEvenlyCheckBox").attr("checked")||(e=!1);var g=Number($("select#TurnTimeLimitComboBox").selectmenu("value"));return{mainPlayerName:b,opponentOptions:a,systemsToGenerate:c,planetsPerSystem:d,distributePlanetsEvenly:e,turnTimeLimitSeconds:g}},
SetupNewGame:function(){var a=this.getSelectedGameOptions(),b=1,c;for(c in a.opponentOptions)a.opponentOptions[c].type>=0&&b++;AstriarchExtern.OnGameStart({Players:b,PlanetsPerSystem:a.planetsPerSystem,Systems:a.systemsToGenerate});Astriarch.server_comm.sendMessage({type:Astriarch.Shared.MESSAGE_TYPE.START_GAME,payload:a})},OnGameStartMessageResponse:function(a){$("#startGameOptionsContainer").hide();Astriarch.GameController.ResetView(a.payload)},drawGameOptionsRepresentationOnCanvas:function(a){var b=
this.StarfieldCanvasSize.w,c=b/2,d=this.StarfieldCanvasSize.h,e=d/2;this.StarfieldCanvasContext.clearRect(0,0,b,d);for(d=0;d<a.systemsToGenerate;d++){var g=0,f=0;a.systemsToGenerate==2&&d==1||a.systemsToGenerate==4&&d==3?(g=c,f=e):(a.systemsToGenerate==3||a.systemsToGenerate==4)&&d==1?g=c:a.systemsToGenerate==3&&d==2?(g=b/4,f=e):a.systemsToGenerate==4&&d==2&&(f=e);var h=this.StarfieldCanvasContext.createRadialGradient(g+c/2,f+e/2,0,g+c/2,f+e/2,this.StarfieldCanvasSize.h/4),i=Astriarch.View.Colors[0];
if(d==0||a.opponentOptions[d-1].type>=0)i=Astriarch.Model.PlayerColors[d];h.addColorStop(0,"rgba(0, 0, 0, 0)");h.addColorStop(0.9,i);h.addColorStop(1,"rgba(0, 0, 0, 0)");this.StarfieldCanvasContext.fillStyle=h;this.StarfieldCanvasContext.fillRect(g,f,c,e)}}};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.ClientModelInterface={GetClientModelFromSerializableClientModel:function(a,b){var c={},d;for(d in a.MainPlayerOwnedSerializablePlanets){var e=Astriarch.SavedGameInterface.getPlanetFromSerializedPlanet(a.MainPlayerOwnedSerializablePlanets[d],b);c[e.Id]=e}d={};var e=[],g;for(g in a.SerializableClientPlayers){var f=this.GetClientPlayerFromSerializableClientPlayer(a.SerializableClientPlayers[g]);e.push(f);d[f.Id]=f}f={};g=[];for(var h in a.SerializableClientPlanets){var i=this.GetClientPlanetFromSerializableClientPlanet(a.SerializableClientPlanets[h],
b);g.push(i);f[i.Id]=i}c=Astriarch.SavedGameInterface.getPlayerFromSerializedPlayer(b,a.SerializableMainPlayer,c,f);Astriarch.SavedGameInterface.setPlayerLastKnownPlanetFleetStrength(c,a.SerializableMainPlayer,b,d);return new Astriarch.ClientModel(a.TurnNumber,c,e,g,a.ClientTradingCenter,b,a.Options)},GetClientPlayerFromSerializableClientPlayer:function(a){var b=new Astriarch.Util.ColorRGBA(a.Color.r,a.Color.g,a.Color.b,a.Color.a);return new Astriarch.ClientPlayer(a.Id,a.Type,a.Name,b,a.Points)},
GetClientPlanetFromSerializableClientPlanet:function(a,b){return new Astriarch.ClientPlanet(a.Id,a.Name,a.OriginPoint,b,null,a.Type)},GetTurnEventMessageFromSerializableTurnEventMessage:function(a,b){var c=null;a.SerializableClientPlanet&&(c=Astriarch.ClientModelInterface.GetClientPlanetFromSerializableClientPlanet(a.SerializableClientPlanet,b));c=new Astriarch.TurnEventMessage(a.Type,c,a.Message);if(a.Data){console.log("GetTurnEventMessageFromSerializableTurnEventMessage:",a.Data);var d=null;a.Data.DefendingSerializableClientPlayer&&
(d=Astriarch.ClientModelInterface.GetClientPlayerFromSerializableClientPlayer(a.Data.DefendingSerializableClientPlayer));var e=Astriarch.SavedGameInterface.getFleetFromSerializableFleet(d,a.Data.DefendingSerializableFleet,b),g=Astriarch.ClientModelInterface.GetClientPlayerFromSerializableClientPlayer(a.Data.AttackingSerializableClientPlayer),f=Astriarch.SavedGameInterface.getFleetFromSerializableFleet(g,a.Data.AttackingSerializableFleet,b);c.Data=new Astriarch.TurnEventMessage.PlanetaryConflictData(d,
e,g,f);c.Data.WinningFleet=Astriarch.SavedGameInterface.getFleetFromSerializableFleet(null,a.Data.WinningSerializableFleet,b);c.Data.AttackingFleetChances=a.Data.AttackingFleetChances;c.Data.GoldAmountLooted=a.Data.GoldAmountLooted;c.Data.OreAmountLooted=a.Data.OreAmountLooted;c.Data.IridiumAmountLooted=a.Data.IridiumAmountLooted;c.Data.FoodAmountLooted=a.Data.FoodAmountLooted}return c}};
Astriarch.ClientModel=function(a,b,c,d,e,g,f){this.Turn=new Astriarch.Model.Turn;this.Turn.Number=a;this.MainPlayer=b;this.ClientPlayers=c;this.ClientPlanets=d;this.ClientTradingCenter=e;this.GameGrid=g;this.Options=f||{TurnTimeLimitSeconds:0}};Astriarch.ClientPlayer=function(a,b,c,d,e){this.Id=a;this.Type=b;this.Name=c;this.Color=d;this.Points=e};
Astriarch.ClientPlanet=function(a,b,c,d,e,g){this.Id=a;this.Name=b;this.OriginPoint=c;this.BoundingHex=d?d.GetHexAt(c):e;this.BoundingHex.ClientPlanetContainedInHex=this;this.Type=g};Astriarch.ClientTradingCenter=function(a,b,c,d,e){this.goldAmount=a;this.foodResource=b;this.oreResource=c;this.iridiumResource=d;this.clientPlayerTrades=e};
Astriarch.SerializableClientModel=function(a,b,c,d,e,g,f){this.TurnNumber=a;this.SerializableMainPlayer=b;this.SerializableClientPlayers=c;this.SerializableClientPlanets=d;this.MainPlayerOwnedSerializablePlanets=e;this.ClientTradingCenter=g;this.Options=f||{TurnTimeLimitSeconds:0}};Astriarch.SerializableClientPlayer=function(a,b,c,d,e){this.Id=a;this.Type=b;this.Name=c;this.Color=d;this.Points=e};
Astriarch.SerializableClientPlanet=function(a,b,c,d){this.Id=a;this.Name=b;this.OriginPoint=c;this.Type=d};Astriarch=Astriarch||require("./astriarch_base");
Astriarch.Shared={MESSAGE_TYPE:{ERROR:-1,NOOP:0,PING:1,CHAT_ROOM_SESSIONS_UPDATED:2,LOGOUT:3,LIST_GAMES:4,GAME_LIST_UPDATED:5,CHANGE_GAME_OPTIONS:6,CHANGE_PLAYER_NAME:7,CREATE_GAME:8,JOIN_GAME:9,RESUME_GAME:10,START_GAME:11,END_TURN:12,UPDATE_PLANET_START:13,UPDATE_PLANET_FINISH:14,UPDATE_PLANET_BUILD_QUEUE:15,SEND_SHIPS:16,GAME_OVER:17,SUBMIT_TRADE:18,CANCEL_TRADE:19,CHAT_MESSAGE:20},ERROR_TYPE:{UNKNOWN:0,INVALID_GAME_OPTIONS:1},PLANET_BUILD_QUEUE_ACTION_TYPE:{ADD_IMPROVEMENT:1,ADD_STARSHIP:2,REMOVE:3,
MOVEUP:4,MOVEDOWN:5,DEMOLISH_IMPROVEMENT:6},CHAT_MESSAGE_TYPE:{TEXT_MESSAGE:1,PLAYER_ENTER:2,PLAYER_EXIT:3,PLAYER_DISCONNECT:4},Message:function(a,b){this.type=a||0;this.payload=b||{}}};
